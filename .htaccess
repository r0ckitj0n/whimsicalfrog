# No rewrites; host-safe routing via ErrorDocument
# Disable MultiViews so hashed Vite asset filenames (e.g., app.js-<hash>.js) are served exactly
<IfModule mod_negotiation.c>
  Options -MultiViews
</IfModule>
# Canonicalize .php to extensionless for core pages (SEO-friendly)
RedirectMatch 301 ^/(shop|about|contact|login|register|cart|room_main)\.php$ /$1
DirectoryIndex index.php
ErrorDocument 404 /router.php
ErrorDocument 403 /router.php

<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  # Ensure /dist/* requests are never rewritten to index.php.
  # This lets Apache 404 missing hashed chunks so ErrorDocument routes to router.php,
  # which returns a plain-text 404 instead of HTML, avoiding MIME mismatches.
  RewriteRule ^dist/ - [L]
  # Serve Vite-built assets from /dist/assets when requested at /assets
  RewriteRule ^assets/(.*)$ /dist/assets/$1 [L]
  # Serve existing files or directories directly
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]
  # Route all other requests to index.php (clean URLs like /shop)
  RewriteRule ^ index.php [L]
</IfModule>

# --- Security: deny access to sensitive files ---
<IfModule mod_authz_core.c>
  <FilesMatch "^(\.env|composer\.(json|lock)|phpunit\.xml(\.dist)?|.*\.sql)$">
    Require all denied
  </FilesMatch>
  # Explicitly protect filesystem secret key
  <Files "secret.key">
    Require all denied
  </Files>
</IfModule>

# Legacy Apache (2.2) fallback
<IfModule !mod_authz_core.c>
  <FilesMatch "^(\.env|composer\.(json|lock)|phpunit\.xml(\.dist)?|.*\.sql)$">
    Order allow,deny
    Deny from all
  </FilesMatch>
  <Files "secret.key">
    Order allow,deny
    Deny from all
  </Files>
</IfModule>
