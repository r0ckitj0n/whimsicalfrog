<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /

    # Set dist/index.html as the primary directory index
    DirectoryIndex dist/index.html

    # Redirect to non-www
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

    # If the file or directory exists, serve it directly and STOP
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # If a hashed dist asset is missing, return 404 (do not fall through to HTML)
    RewriteCond %{REQUEST_URI} ^/dist/assets/.+\.(js|mjs|css|map)$ [NC]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ - [R=404,L]

    # Rewrite /assets/ to /dist/assets/ (for legacy support or internal consistency)
    RewriteRule ^assets/(.*)$ /dist/assets/$1 [L]

    # Block sensitive directories from being served directly
    RewriteRule ^(\.git|\.github|\.vscode|brain|includes|config|logs|node_modules|scripts|src|tmp|vendor)/ - [F,L]

    # Block sensitive files
    <FilesMatch "^(\.env|composer\.(json|lock)|package(-lock)?\.json|tsconfig\.json|phpunit\.xml(\.dist)?|.*\.sql|.*\.sqlite|.*\.db|.*\.log|.*\.sh)$">
        Require all denied
    </FilesMatch>

    # Forward all other requests to current React build entry
    RewriteRule . /dist/index.html [L]
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Performance: Gzip Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/x-javascript application/json application/xml application/rss+xml font/opentype font/otf font/ttf image/svg+xml image/x-icon
</IfModule>

# Performance: Caching for fingerprinted Vite assets
<IfModule mod_expires.c>
    ExpiresActive On
    # Fingerprinted assets in dist/assets can be cached for a long time (1 year)
    <FilesMatch "\.(js|css|woff2?|eot|ttf|otf)$">
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
</IfModule>
