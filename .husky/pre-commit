# Use lint-staged to process only staged files (concurrent for speed)
# Guard against accidental duplicate-suffixed files/dirs being committed
# Examples blocked: "image 2.png", "logo 3.webp", "css/core 2/"

# Collect staged paths
STAGED=$(git diff --cached --name-only -z)
# Block duplicate-suffixed names except when they are already quarantined under backups/duplicates/
if printf "%s" "$STAGED" | tr '\0' '\n' | awk '
  {
    path=$0;
    # Skip empty lines
    if (length(path)==0) next;
    # Allow anything under backups/duplicates/
    if (path ~ /^backups\/duplicates\//) next;
    # If path contains a segment ending with space + digit (e.g., " 2"), flag it
    if (path ~ /(^|\/).+ [0-9]($|\/|\.)/) { print path; exit 1 }
  }
'; then
  : # OK
else
  echo "\033[0;31m✖ Commit blocked: staged changes include files or directories with a trailing space-number outside backups/duplicates/ (e.g., 'file 2.png', 'dir 3/').\033[0m" >&2
  echo "\033[1;33m→ Please quarantine duplicates to backups/duplicates/ or rename/remove them.\033[0m" >&2
  exit 1
fi

npx lint-staged --concurrent=true
