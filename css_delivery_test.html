<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç CSS Delivery Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #dc2626;
            border-radius: 8px;
            background: #fef2f2;
        }
        
        .test-section h3 {
            color: #dc2626;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        
        .status.warning {
            background: #fefcbf;
            color: #744210;
            border: 1px solid #f6e05e;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        
        .test-button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        
        .test-button:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            margin: 15px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .iframe-container {
            border: 3px solid #dc2626;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
            height: 400px;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç CSS Delivery & Application Test</h1>
        <p style="text-align: center; color: #718096; margin-bottom: 30px;">
            <strong>Verifying CSS bundle delivery and actual rule application</strong>
        </p>

        <div class="test-section">
            <h3>üì¶ CSS Bundle Delivery Test</h3>
            <p>Testing if the updated CSS bundle is being delivered to the browser.</p>
            <button class="test-button" onclick="testCSSDelivery()">Test CSS Delivery</button>
            <div id="delivery-results"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Live Shop Page CSS Application Test</h3>
            <p>Testing actual CSS rule application on the live shop page.</p>
            <button class="test-button" onclick="testLiveCSS()">Test Live CSS Application</button>
            <div id="live-results"></div>
            <div id="shop-iframe-container"></div>
        </div>

        <div class="test-section">
            <h3>üîß Emergency CSS Injection Test</h3>
            <p>If bundle delivery fails, test direct CSS injection.</p>
            <button class="test-button" onclick="testEmergencyCSS()">Test Emergency CSS</button>
            <div id="emergency-results"></div>
        </div>
    </div>

    <script>
        async function testCSSDelivery() {
            const resultsDiv = document.getElementById('delivery-results');
            resultsDiv.innerHTML = '<div class="status warning">Testing CSS bundle delivery...</div>';
            
            try {
                // Test CSS bundle fetch
                const response = await fetch(`/css/bundle.css?v=${Date.now()}`);
                const cssText = await response.text();
                
                let deliveryReport = '<h4>üì¶ CSS Bundle Delivery Report</h4>';
                deliveryReport += '<div class="code-block">';
                
                deliveryReport += `Response Status: ${response.status} ${response.statusText}\n`;
                deliveryReport += `Content Length: ${cssText.length} characters\n`;
                deliveryReport += `Last Modified: ${response.headers.get('last-modified') || 'Not provided'}\n`;
                deliveryReport += `Cache Control: ${response.headers.get('cache-control') || 'Not set'}\n\n`;
                
                // Check for our specific CSS rules
                const hasBackgroundFix = cssText.includes('CRITICAL FIX: Background Tiling Issue');
                const hasFullWidthFix = cssText.includes('CRITICAL FIX: Shop Page Container');
                const hasScrollbarFix = cssText.includes('CRITICAL FIX: GLOBAL SCROLLBAR STYLING');
                
                deliveryReport += `Background Fix Present: ${hasBackgroundFix ? 'YES ‚úÖ' : 'NO ‚ùå'}\n`;
                deliveryReport += `Full Width Fix Present: ${hasFullWidthFix ? 'YES ‚úÖ' : 'NO ‚ùå'}\n`;
                deliveryReport += `Scrollbar Fix Present: ${hasScrollbarFix ? 'YES ‚úÖ' : 'NO ‚ùå'}\n\n`;
                
                if (hasBackgroundFix) {
                    const backgroundMatch = cssText.match(/CRITICAL FIX: Background Tiling Issue[\s\S]{0,500}/);
                    if (backgroundMatch) {
                        deliveryReport += `Background Fix CSS:\n${backgroundMatch[0]}...\n\n`;
                    }
                }
                
                deliveryReport += '</div>';
                
                let status = '';
                if (hasBackgroundFix && hasFullWidthFix && hasScrollbarFix) {
                    status = '<div class="status success">‚úÖ All CSS fixes are present in the delivered bundle</div>';
                } else {
                    status = '<div class="status error">‚ùå Some CSS fixes are missing from the delivered bundle</div>';
                }
                
                resultsDiv.innerHTML = status + deliveryReport;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error fetching CSS bundle: ${error.message}</div>`;
            }
        }

        async function testLiveCSS() {
            const resultsDiv = document.getElementById('live-results');
            const iframeContainer = document.getElementById('shop-iframe-container');
            
            resultsDiv.innerHTML = '<div class="status warning">Testing live CSS application...</div>';
            
            try {
                // Create iframe to load shop page
                const iframe = document.createElement('iframe');
                iframe.src = `/?page=shop&css_test=1&v=${Date.now()}`;
                
                iframeContainer.innerHTML = '<div class="iframe-container"></div>';
                iframeContainer.querySelector('.iframe-container').appendChild(iframe);
                
                iframe.onload = function() {
                    setTimeout(() => {
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const iframeWindow = iframe.contentWindow;
                            
                            let liveReport = '<h4>üéØ Live CSS Application Report</h4>';
                            liveReport += '<div class="code-block">';
                            
                            // Test main.page-content
                            const mainContent = iframeDoc.querySelector('main.page-content');
                            if (mainContent) {
                                const mainStyles = iframeWindow.getComputedStyle(mainContent);
                                liveReport += `MAIN.PAGE-CONTENT COMPUTED STYLES:\n`;
                                liveReport += `Background Size: ${mainStyles.backgroundSize}\n`;
                                liveReport += `Background Repeat: ${mainStyles.backgroundRepeat}\n`;
                                liveReport += `Background Position: ${mainStyles.backgroundPosition}\n`;
                                liveReport += `Background Image: ${mainStyles.backgroundImage.substring(0, 100)}...\n`;
                                liveReport += `Padding: ${mainStyles.padding}\n`;
                                liveReport += `Margin Top: ${mainStyles.marginTop}\n\n`;
                            } else {
                                liveReport += `MAIN.PAGE-CONTENT: NOT FOUND!\n\n`;
                            }
                            
                            // Test #shopPage
                            const shopPage = iframeDoc.querySelector('#shopPage');
                            if (shopPage) {
                                const shopStyles = iframeWindow.getComputedStyle(shopPage);
                                liveReport += `#SHOPPAGE COMPUTED STYLES:\n`;
                                liveReport += `Position: ${shopStyles.position}\n`;
                                liveReport += `Left: ${shopStyles.left}\n`;
                                liveReport += `Right: ${shopStyles.right}\n`;
                                liveReport += `Margin Left: ${shopStyles.marginLeft}\n`;
                                liveReport += `Margin Right: ${shopStyles.marginRight}\n`;
                                liveReport += `Width: ${shopStyles.width}\n`;
                                liveReport += `Max Width: ${shopStyles.maxWidth}\n\n`;
                            } else {
                                liveReport += `#SHOPPAGE: NOT FOUND!\n\n`;
                            }
                            
                            // Test body classes and scrollbar
                            const body = iframeDoc.body;
                            const bodyStyles = iframeWindow.getComputedStyle(body);
                            liveReport += `BODY ELEMENT:\n`;
                            liveReport += `Class: "${body.className}"\n`;
                            liveReport += `Scrollbar Width: ${bodyStyles.getPropertyValue('scrollbar-width')}\n`;
                            liveReport += `Scrollbar Color: ${bodyStyles.getPropertyValue('scrollbar-color')}\n\n`;
                            
                            // Check CSS rules that should be applied
                            const hasCorrectBackground = mainContent && mainStyles.backgroundSize === 'cover' && mainStyles.backgroundRepeat === 'no-repeat';
                            const hasCorrectWidth = shopPage && parseInt(shopStyles.width) > 1000;
                            const hasCorrectScrollbar = bodyStyles.getPropertyValue('scrollbar-width') === 'thin';
                            
                            liveReport += `RULE APPLICATION STATUS:\n`;
                            liveReport += `Background Fix Applied: ${hasCorrectBackground ? 'YES ‚úÖ' : 'NO ‚ùå'}\n`;
                            liveReport += `Full Width Fix Applied: ${hasCorrectWidth ? 'YES ‚úÖ' : 'NO ‚ùå'}\n`;
                            liveReport += `Scrollbar Fix Applied: ${hasCorrectScrollbar ? 'YES ‚úÖ' : 'NO ‚ùå'}\n`;
                            
                            liveReport += '</div>';
                            
                            let status = '';
                            if (hasCorrectBackground && hasCorrectWidth && hasCorrectScrollbar) {
                                status = '<div class="status success">‚úÖ All CSS fixes are being applied correctly</div>';
                            } else {
                                status = '<div class="status error">‚ùå CSS fixes are not being applied despite being in the bundle</div>';
                            }
                            
                            resultsDiv.innerHTML = status + liveReport;
                            
                        } catch (error) {
                            resultsDiv.innerHTML = `<div class="status error">‚ùå Error testing live CSS: ${error.message}</div>`;
                        }
                    }, 2000);
                };
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testEmergencyCSS() {
            const resultsDiv = document.getElementById('emergency-results');
            resultsDiv.innerHTML = '<div class="status warning">Testing emergency CSS injection...</div>';
            
            try {
                // Open shop page in new window and inject CSS directly
                const shopWindow = window.open('/?page=shop&emergency=1', '_blank', 'width=1200,height=800');
                
                setTimeout(() => {
                    try {
                        // Inject emergency CSS directly
                        const emergencyCSS = `
                            <style id="emergency-css">
                            /* EMERGENCY CSS INJECTION */
                            body.shop-page main.page-content,
                            main.page-content {
                                background-size: cover !important;
                                background-repeat: no-repeat !important;
                                background-position: center center !important;
                                min-height: calc(100vh - 90px) !important;
                            }
                            
                            body.shop-page #shopPage,
                            #shopPage {
                                position: relative !important;
                                left: 50% !important;
                                margin-left: -50vw !important;
                                width: 100vw !important;
                                max-width: none !important;
                            }
                            
                            body.shop-page,
                            body.shop-page * {
                                scrollbar-width: thin !important;
                                scrollbar-color: #87ac3a rgba(135, 172, 58, 0.3) !important;
                            }
                            
                            body.shop-page::-webkit-scrollbar,
                            body.shop-page *::-webkit-scrollbar {
                                width: 16px !important;
                                background: rgba(135, 172, 58, 0.1) !important;
                            }
                            
                            body.shop-page::-webkit-scrollbar-thumb,
                            body.shop-page *::-webkit-scrollbar-thumb {
                                background: #87ac3a !important;
                                border-radius: 8px !important;
                            }
                            </style>
                        `;
                        
                        shopWindow.document.head.insertAdjacentHTML('beforeend', emergencyCSS);
                        
                        resultsDiv.innerHTML = '<div class="status success">‚úÖ Emergency CSS injected directly into shop page</div><div class="status info">Check the opened shop page window to see if the fixes are now visible</div>';
                        
                    } catch (error) {
                        resultsDiv.innerHTML = `<div class="status error">‚ùå Error injecting emergency CSS: ${error.message}</div>`;
                        shopWindow.close();
                    }
                }, 2000);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-run delivery test on page load
        window.addEventListener('load', function() {
            setTimeout(testCSSDelivery, 500);
        });
    </script>
</body>
</html>
