class d{constructor(){this.currentItemSku=null,this.items=[],this.categories=[],this.costBreakdown={materials:{},labor:{},energy:{},equipment:{},totals:{}},this.currentEditCostItem=null,this.tooltipTimeout=null,this.currentTooltip=null,this.loadData(),this.bindEvents(),this.init()}loadData(){const e=document.getElementById("inventory-data");if(e)try{const t=JSON.parse(e.textContent);this.currentItemSku=t.currentItemSku,this.items=t.items||[],this.categories=t.categories||[],t.costBreakdown&&(this.costBreakdown={materials:t.costBreakdown.materials||{},labor:t.costBreakdown.labor||{},energy:t.costBreakdown.energy||{},equipment:t.costBreakdown.equipment||{},totals:t.costBreakdown.totals||{}})}catch(t){console.error("Error parsing inventory data:",t)}}init(){this.renderCostList("materials"),this.renderCostList("labor"),this.renderCostList("energy"),this.renderCostList("equipment"),this.updateTotalsDisplay(),this.loadExistingPriceSuggestion(this.currentItemSku),this.loadExistingMarketingSuggestion(this.currentItemSku),this.updateCategoryDropdown()}bindEvents(){document.body.addEventListener("click",this.handleDelegatedClick.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this));const e=document.getElementById("imageUpload");e&&e.addEventListener("change",this.handleImageUpload.bind(this))}handleKeyDown(e){e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||(e.key==="ArrowRight"?this.navigateToItem("next"):e.key==="ArrowLeft"&&this.navigateToItem("prev"))}handleDelegatedClick(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action,s=t.dataset.id,n=t.dataset.category;switch(t.tagName==="BUTTON"&&e.preventDefault(),o){case"navigate-item":this.navigateToItem(t.dataset.direction);break;case"set-primary-image":this.setPrimaryImage(s);break;case"delete-image":this.confirmDeleteImage(s);break;case"trigger-upload":document.getElementById("imageUpload").click();break;case"process-images-ai":this.processExistingImagesWithAI();break;case"open-cost-modal":this.openCostModal(n,s);break;case"close-cost-modal":this.closeCostModal();break;case"save-cost-item":this.saveCostItem();break;case"delete-cost-item":this.confirmDeleteCostItem(n,s);break;case"clear-cost-breakdown":this.confirmClearCostBreakdown();break;case"get-cost-suggestion":this.getCostSuggestion();break;case"get-price-suggestion":this.getPriceSuggestion();break;case"apply-price-suggestion":this.applyPriceSuggestion();break;case"clear-price-suggestion":this.clearPriceSuggestion();break;case"generate-marketing-copy":this.generateMarketingCopy();break;case"apply-cost-suggestion-to-cost":this.applyCostSuggestionToCost();break;case"apply-suggested-cost-to-cost-field":this.applySuggestedCostToCostField(t);break;case"populate-cost-breakdown-from-suggestion":this.populateCostBreakdownFromSuggestion(JSON.parse(t.getAttribute("data-suggestion").replace(/&quot;/g,'"').replace(/&#39;/g,"'"))),this.closeCostSuggestionChoiceDialog();break;case"close-cost-suggestion-choice-dialog":this.closeCostSuggestionChoiceDialog();break;case"refresh-categories":this.refreshCategoryDropdown();break}}navigateToItem(e){if(!this.currentItemSku||this.items.length===0)return;const t=this.items.findIndex(r=>r.sku===this.currentItemSku);if(t===-1)return;let o;e==="next"?o=(t+1)%this.items.length:o=(t-1+this.items.length)%this.items.length;const s=this.items[o].sku,n=new URL(window.location.href);n.searchParams.set("edit",s),n.searchParams.delete("view"),window.location.href=n.toString()}async setPrimaryImage(e){try{const o=await(await fetch("/api/set_primary_image.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:this.currentItemSku,image_id:e})})).json();o.success?(this.showSuccess("Primary image updated!"),document.querySelectorAll(".image-card").forEach(s=>s.classList.remove("border-green-500","border-4")),document.querySelector(`.image-card[data-id='${e}']`).classList.add("border-green-500","border-4")):this.showError(o.error||"Failed to set primary image.")}catch(t){this.showError("An error occurred. Please try again."),console.error("Set primary image error:",t)}}confirmDeleteImage(e){this.showConfirmationModal("Delete Image","Are you sure you want to delete this image? This action cannot be undone.",()=>this.deleteImage(e))}async deleteImage(e){try{const o=await(await fetch("/api/delete_item_image.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_id:e})})).json();if(o.success){this.showSuccess("Image deleted successfully!");const s=document.querySelector(`.image-card[data-id='${e}']`);s&&s.remove()}else this.showError(o.error||"Failed to delete image.")}catch(t){this.showError("An error occurred. Please try again."),console.error("Delete image error:",t)}}async handleImageUpload(e){const t=e.target.files;if(t.length===0)return;const o=new FormData;o.append("sku",this.currentItemSku);for(let n=0;n<t.length;n++)o.append("images[]",t[n]);const s=document.getElementById("uploadIndicator");s.classList.remove("hidden");try{const r=await(await fetch("/api/upload_item_images.php",{method:"POST",body:o})).json();r.success?(this.showSuccess("Images uploaded successfully! Refreshing..."),setTimeout(()=>window.location.reload(),1500)):this.showError(r.error||"An error occurred during upload.")}catch(n){this.showError("Upload failed. Please check the console for details."),console.error("Upload error:",n)}finally{s.classList.add("hidden")}}async processExistingImagesWithAI(){this.showConfirmationModal("Process Images with AI","This will analyze existing images to improve product data. This may take a moment. Continue?",async()=>{const e=document.querySelector('[data-action="process-images-ai"]'),t=e.innerHTML;e.innerHTML="Processing...",e.disabled=!0;try{const s=await(await fetch(`/api/run_image_analysis.php?sku=${this.currentItemSku}`)).json();s.success?(this.showSuccess("AI processing complete! The page will now reload."),setTimeout(()=>window.location.reload(),2e3)):this.showError(s.error||"AI processing failed.")}catch(o){this.showError("An error occurred during AI processing."),console.error("AI processing error:",o)}finally{e.innerHTML=t,e.disabled=!1}})}openCostModal(e,t=null){this.currentEditCostItem={category:e,id:t};const o=document.getElementById("costItemModal"),s=document.getElementById("costItemModalTitle"),n=document.getElementById("costName"),r=document.getElementById("costValue");if(s.textContent=t?`Edit ${e} Item`:`Add ${e} Item`,t&&this.costBreakdown[e]&&this.costBreakdown[e][t]){const i=this.costBreakdown[e][t];n.value=i.name,r.value=i.cost}else n.value="",r.value="";o.classList.remove("hidden")}closeCostModal(){document.getElementById("costItemModal").classList.add("hidden"),this.currentEditCostItem=null}async saveCostItem(){if(!this.currentEditCostItem)return;const{category:e,id:t}=this.currentEditCostItem,o=document.getElementById("costName").value.trim(),s=parseFloat(document.getElementById("costValue").value);if(!o||isNaN(s)){this.showError("Please enter a valid name and cost.");return}const n=t||`${e}_${Date.now()}`,r={name:o,cost:s};this.costBreakdown[e]||(this.costBreakdown[e]={}),this.costBreakdown[e][n]=r,this.renderCostList(e),this.updateTotalsDisplay(),this.closeCostModal();try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t?"update":"add",inventory_id:this.currentItemSku,category:e,item_id:n,data:r})})).json()).success||(this.showError("Failed to save item. Reverting changes."),delete this.costBreakdown[e][n],this.renderCostList(e),this.updateTotalsDisplay())}catch(i){this.showError("An error occurred while saving."),console.error("Save cost item error:",i)}}confirmDeleteCostItem(e,t){this.showConfirmationModal("Delete Cost Item","Are you sure you want to delete this item?",()=>this.deleteCostItem(e,t))}async deleteCostItem(e,t){this.costBreakdown[e]&&this.costBreakdown[e][t]&&(delete this.costBreakdown[e][t],this.renderCostList(e),this.updateTotalsDisplay());try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"delete",inventory_id:this.currentItemSku,category:e,item_id:t})})).json()).success||this.showError("Failed to delete item from server.")}catch(o){this.showError("An error occurred while deleting."),console.error("Delete cost item error:",o)}}renderCostList(e){const t=document.getElementById(`${e}List`);if(!t)return;t.innerHTML="";const o=this.costBreakdown[e],s=Object.keys(o||{});if(s.length===0){t.innerHTML='<p class="text-gray-500 text-xs italic">No items added yet.</p>';return}s.forEach(n=>{const r=o[n],i=document.createElement("div");i.className="cost-item-row flex justify-between items-center p-2 rounded hover:bg-gray-100",i.innerHTML=`
                <span>${this.escapeHtml(r.name)}</span>
                <div class="flex items-center">
                    <span class="mr-4 font-medium">$${parseFloat(r.cost).toFixed(2)}</span>
                    <button data-action="open-cost-modal" data-category="${e}" data-id="${n}" class="text-blue-500 hover:text-blue-700 mr-2">Edit</button>
                    <button data-action="delete-cost-item" data-category="${e}" data-id="${n}" class="text-red-500 hover:text-red-700">Delete</button>
                </div>
            `,t.appendChild(i)})}updateTotalsDisplay(){let e=0,t=0,o=0,s=0;for(const i in this.costBreakdown.materials)e+=parseFloat(this.costBreakdown.materials[i].cost);for(const i in this.costBreakdown.labor)t+=parseFloat(this.costBreakdown.labor[i].cost);for(const i in this.costBreakdown.energy)o+=parseFloat(this.costBreakdown.energy[i].cost);for(const i in this.costBreakdown.equipment)s+=parseFloat(this.costBreakdown.equipment[i].cost);const n=e+t+o+s;this.costBreakdown.totals={materialTotal:e,laborTotal:t,energyTotal:o,equipmentTotal:s,totalCost:n},document.getElementById("materialTotal").textContent=`$${e.toFixed(2)}`,document.getElementById("laborTotal").textContent=`$${t.toFixed(2)}`,document.getElementById("energyTotal").textContent=`$${o.toFixed(2)}`,document.getElementById("equipmentTotal").textContent=`$${s.toFixed(2)}`,document.getElementById("totalCost").textContent=`$${n.toFixed(2)}`;const r=document.getElementById("suggestedCostDisplay");r&&(r.textContent=`$${n.toFixed(2)}`)}confirmClearCostBreakdown(){this.showConfirmationModal("Clear Cost Breakdown","Are you sure you want to delete all cost items? This is irreversible.",()=>this.clearCostBreakdownCompletely())}async clearCostBreakdownCompletely(){this.costBreakdown={materials:{},labor:{},energy:{},equipment:{},totals:{}},["materials","labor","energy","equipment"].forEach(e=>this.renderCostList(e)),this.updateTotalsDisplay();try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"clear_all",inventory_id:this.currentItemSku})})).json()).success?this.showSuccess("Cost breakdown cleared."):this.showError("Failed to clear breakdown on server.")}catch(e){this.showError("An error occurred while clearing the breakdown."),console.error("Clear breakdown error:",e)}}async getCostSuggestion(){const e=document.querySelector('[data-action="get-cost-suggestion"]'),t=e.innerHTML;e.innerHTML="Analyzing...",e.disabled=!0;try{const s=await(await fetch(`/api/suggest_cost.php?sku=${this.currentItemSku}`)).json();s.success?this.showCostSuggestionChoiceDialog(s.suggestions):this.showError(s.error||"Failed to get cost suggestion.")}catch(o){this.showError("Failed to connect to cost suggestion service."),console.error("Get cost suggestion error:",o)}finally{e.innerHTML=t,e.disabled=!1}}async getPriceSuggestion(){const e=document.querySelector('[data-action="get-price-suggestion"]'),t=e.innerHTML;e.innerHTML="Analyzing...",e.disabled=!0;const o={name:document.getElementById("name").value,description:document.getElementById("description").value,category:document.getElementById("category").value,costPrice:document.getElementById("costPrice").value,sku:this.currentItemSku,useImages:!0};try{const n=await(await fetch("/api/suggest_price.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json();n.success?(this.displayPriceSuggestion(n),this.showSuccess("Price suggestion generated!")):this.showError(n.error||"Failed to get price suggestion.")}catch(s){this.showError("Failed to connect to pricing service."),console.error("Get price suggestion error:",s)}finally{e.innerHTML=t,e.disabled=!1}}displayPriceSuggestion(e){const t=document.getElementById("priceSuggestionDisplay"),o=document.getElementById("priceSuggestionPlaceholder");if(!t||!o)return;o.classList.add("hidden"),t.classList.remove("hidden"),document.getElementById("displaySuggestedPrice").textContent=`$${parseFloat(e.suggestedPrice).toFixed(2)}`,document.getElementById("displayConfidence").textContent=`${e.confidence||"N/A"}`,document.getElementById("displayTimestamp").textContent=new Date(e.createdAt).toLocaleString(),t.dataset.suggestedPrice=e.suggestedPrice;const s=document.getElementById("reasoningList");s.innerHTML="",e.reasoning&&e.reasoning.split("•").filter(r=>r.trim()).forEach(r=>{const i=document.createElement("li");i.textContent=r.trim(),s.appendChild(i)})}applyPriceSuggestion(){const e=document.getElementById("priceSuggestionDisplay"),t=document.getElementById("retailPrice"),o=e.dataset.suggestedPrice;o&&(t.value=parseFloat(o).toFixed(2),t.style.backgroundColor="#dcfce7",setTimeout(()=>{t.style.backgroundColor=""},2e3),this.showSuccess("Suggested price applied!"))}clearPriceSuggestion(){const e=document.getElementById("priceSuggestionDisplay"),t=document.getElementById("priceSuggestionPlaceholder");e.classList.add("hidden"),t.classList.remove("hidden"),e.dataset.suggestedPrice=""}async loadExistingPriceSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_price_suggestion.php?sku=${e}`)).json();o.success&&o.suggestedPrice&&this.displayPriceSuggestion(o)}catch(t){console.error("Error loading existing price suggestion:",t)}}async loadExistingMarketingSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_marketing_suggestion.php?sku=${e}`)).json();if(o.success&&o.exists){const s=document.querySelector('[data-action="generate-marketing-copy"]');if(!s)return;const n=document.createElement("span");n.className="suggestion-indicator ml-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full",n.textContent="💾 Previous",n.title="Previous AI analysis available",s.appendChild(n)}}catch(t){console.error("Error loading existing marketing suggestion:",t)}}async generateMarketingCopy(){this.showError("generateMarketingCopy not fully implemented yet.")}showConfirmationModal(e,t,o){const s=document.getElementById("confirmationModal");document.getElementById("confirmationModalTitle").textContent=e,document.getElementById("confirmationModalMessage").textContent=t;const n=document.getElementById("confirmationModalConfirm"),r=document.getElementById("confirmationModalCancel"),i=()=>{this.closeConfirmationModal(),o()},a=n.cloneNode(!0);n.parentNode.replaceChild(a,n),a.addEventListener("click",i);const c=r.cloneNode(!0);r.parentNode.replaceChild(c,r),c.addEventListener("click",this.closeConfirmationModal.bind(this)),s.classList.remove("hidden")}closeConfirmationModal(){document.getElementById("confirmationModal").classList.add("hidden")}showCostSuggestionChoiceDialog(e){const t=document.getElementById("costSuggestionChoiceDialog"),o=document.getElementById("costSuggestionChoices");o.innerHTML="",!e||e.length===0?o.innerHTML="<p>No suggestions available.</p>":e.forEach(s=>{const n=document.createElement("div");n.className="suggestion-card p-4 border rounded-lg hover:bg-gray-50",n.innerHTML=`
                    <h4 class="font-bold text-lg">${this.escapeHtml(s.model)}</h4>
                    <p class="text-2xl font-light my-2">$${parseFloat(s.suggestedCost).toFixed(2)}</p>
                    <p class="text-sm text-gray-600">Confidence: ${this.escapeHtml(s.confidence)}</p>
                    <p class="text-xs italic text-gray-500 mt-2">${this.escapeHtml(s.reasoning)}</p>
                    <div class="mt-4 flex gap-2">
                        <button data-action="populate-cost-breakdown-from-suggestion" data-suggestion='${this.escapeHtml(JSON.stringify(s))}' class="btn btn-primary flex-1">Apply Breakdown</button>
                        <button data-action="apply-suggested-cost-to-cost-field" data-suggestion='${this.escapeHtml(JSON.stringify(s))}' class="btn btn-secondary flex-1">Apply to Field</button>
                    </div>
                `,o.appendChild(n)}),t.classList.remove("hidden")}closeCostSuggestionChoiceDialog(){document.getElementById("costSuggestionChoiceDialog").classList.add("hidden")}applyCostSuggestionToCost(){const e=document.getElementById("suggestedCostDisplay"),t=document.getElementById("costPrice");if(e&&t){const o=e.textContent.replace("$",""),s=parseFloat(o)||0;s>0?(t.value=s.toFixed(2),t.style.backgroundColor="#dbeafe",setTimeout(()=>{t.style.backgroundColor=""},2e3),this.showSuccess("Suggested cost applied to Cost Price field!")):this.showError("No suggested cost available.")}}applySuggestedCostToCostField(e){try{const t=JSON.parse(e.getAttribute("data-suggestion").replace(/&quot;/g,'"').replace(/&#39;/g,"'")),o=document.getElementById("costPrice");if(o){const s=parseFloat(t.suggestedCost)||0;o.value=s.toFixed(2),o.style.backgroundColor="#dcfce7",setTimeout(()=>{o.style.backgroundColor=""},3e3),this.closeCostSuggestionChoiceDialog(),this.showSuccess(`AI suggested cost of $${s.toFixed(2)} applied!`)}}catch(t){console.error("Error applying suggested cost:",t),this.showError("Error applying suggested cost.")}}async populateCostBreakdownFromSuggestion(e){await this.clearCostBreakdownCompletely();const t=e.breakdown,o=["materials","labor","energy","equipment"];for(const s of o)if(t[s]>0){const n=`${s}_${Date.now()}`,r={name:`Suggested ${s}`,cost:t[s]};this.costBreakdown[s][n]=r,await this.saveCostItemToDatabase(s,r,n)}this.init(),this.showSuccess("AI cost breakdown has been applied and saved.")}async saveCostItemToDatabase(e,t,o){try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"add",inventory_id:this.currentItemSku,category:e,item_id:o,data:t})})).json()).success||this.showError(`Failed to save ${e} item.`)}catch{this.showError(`An error occurred while saving ${e}.`)}}async refreshCategoryDropdown(){try{const t=await(await fetch("/api/get_categories.php")).json();this.categories=t,this.updateCategoryDropdown(),this.showSuccess("Categories updated!")}catch(e){this.showError("Failed to refresh categories."),console.error("Refresh categories error:",e)}}updateCategoryDropdown(){const e=document.getElementById("category");if(!e)return;const t=e.value;e.innerHTML="",this.categories.forEach(o=>{const s=document.createElement("option");s.value=o.id,s.textContent=o.name,e.appendChild(s)}),e.value=t}escapeHtml(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}showToast(e,t="info"){const o=document.getElementById("toast-container");if(!o)return;const s=document.createElement("div"),n={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500"};s.className=`toast ${n[t]} text-white p-4 rounded-lg shadow-lg mb-2`,s.textContent=e,o.appendChild(s),setTimeout(()=>{s.style.opacity="0",setTimeout(()=>s.remove(),500)},3e3)}showSuccess(e){this.showToast(e,"success")}showError(e){this.showToast(e,"error")}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("inventory-data")&&document.getElementById("admin-inventory-container")&&new d});
