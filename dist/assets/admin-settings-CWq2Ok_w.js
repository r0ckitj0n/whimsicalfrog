async function ne(e,o,n={}){const{resultEl:i=null,startText:l=null,successText:c=null,errorText:m=null,infoClass:h="status status--info",okClass:f="status status--ok",errorClass:v="status status--error",onStart:g=null,onSuccess:x=null,onError:C=null}=n;try{if(e&&(e.classList.add("is-loading"),e.setAttribute("aria-busy","true"),e.disabled=!0),i&&(l&&(i.textContent=l),h&&(i.className=h)),typeof g=="function")try{g()}catch{}const _=typeof o=="function"?o():o,D=_&&typeof _.then=="function"?await _:await new Promise(M=>setTimeout(()=>M(void 0),600));if(e&&(e.classList.remove("is-loading"),e.removeAttribute("aria-busy"),e.disabled=!1),i&&(c&&(i.textContent=c),f&&(i.className=f)),typeof x=="function")try{x(D)}catch{}return D}catch(_){if(e&&(e.classList.remove("is-loading"),e.removeAttribute("aria-busy"),e.disabled=!1),i&&(m&&(i.textContent=m),v&&(i.className=v)),typeof C=="function")try{C(_)}catch{}throw _}}let L=[],k=[],de=new Set,re=new Set;async function le(){try{const o=await(await fetch("/api/content_tone_options.php?action=get_active&admin_token=whimsical_admin_2024")).json();o.success&&Array.isArray(o.options)&&o.options.length>0?(L=o.options.map(n=>({id:n.value,name:n.label,description:n.description})),de=new Set(L.map(n=>n.id)),$e()):await Go()}catch(e){console.error("Error loading content tone options:",e.message),Ie()}}async function Go(){try{(await(await fetch("/api/content_tone_options.php?action=initialize_defaults&admin_token=whimsical_admin_2024",{method:"POST"})).json()).success?await le():Ie()}catch(e){console.error("Error initializing default content tone options:",e.message),Ie()}}function Ie(){L=[{id:"professional",name:"Professional",description:"Formal, business-focused tone"},{id:"friendly",name:"Friendly",description:"Warm and approachable"},{id:"casual",name:"Casual",description:"Relaxed and informal"},{id:"energetic",name:"Energetic",description:"Enthusiastic and dynamic"},{id:"sophisticated",name:"Sophisticated",description:"Elegant and refined"},{id:"playful",name:"Playful",description:"Fun and lighthearted"},{id:"authoritative",name:"Authoritative",description:"Expert and confident"},{id:"conversational",name:"Conversational",description:"Natural and engaging"},{id:"inspiring",name:"Inspiring",description:"Motivational and uplifting"},{id:"trustworthy",name:"Trustworthy",description:"Reliable and credible"},{id:"innovative",name:"Innovative",description:"Forward-thinking and creative"},{id:"luxurious",name:"Luxurious",description:"Premium and exclusive"}],de=new Set(L.map(e=>e.id)),$e()}function $e(){const e=document.getElementById("ai_content_tone");if(!e)return;const o=e.value;e.innerHTML='<option value="">Select content tone...</option>',L.forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.name,n.description&&(i.title=n.description),e.appendChild(i)}),o&&(e.value=o)}function nt(){Wo()}function Wo(){const e=document.getElementById("contentToneModal");e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`
    <div id="contentToneModal" class="admin-modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-action="overlay-close">
      <div class="admin-modal bg-white rounded-lg w-full max-w-2xl max-h-[90vh] flex flex-col" role="dialog" aria-modal="true" aria-labelledby="contentToneTitle">
        <div class="flex justify-between items-center border-b p-4">
          <h3 id="contentToneTitle" class="text-lg font-semibold text-gray-800">Manage Content Tone Options</h3>
          <button type="button" class="text-gray-500 hover:text-gray-700 text-xl" data-action="content-tone-close" aria-label="Close">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <p class="text-sm text-gray-600">Manage the content tone options available for AI content generation.</p>
              <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white rounded text-sm px-3 py-1" data-action="content-tone-add">Add Option</button>
            </div>
            <div id="contentToneList" class="space-y-2"></div>
          </div>
        </div>
        <div class="border-t flex justify-end space-x-2 p-3">
          <button type="button" class="text-gray-600 hover:text-gray-800 px-3 py-1" data-action="content-tone-close">Cancel</button>
          <button type="button" class="btn btn-primary px-3 py-1" data-action="content-tone-save">Save Changes</button>
        </div>
      </div>
    </div>`),Pe()}function Be(){const e=document.getElementById("contentToneModal");e&&e.remove()}function Pe(){const e=document.getElementById("contentToneList");e&&(e.innerHTML="",L.forEach((o,n)=>{const i=document.createElement("div");i.className="flex items-center space-x-3 bg-gray-50 rounded-lg p-2",i.innerHTML=`
      <input type="text" value="${o.name||""}" class="flex-1 border border-gray-300 rounded text-sm px-2 py-1"
             data-action="content-tone-update" data-index="${n}" data-field="name" placeholder="Name">
      <input type="text" value="${o.description||""}" class="flex-1 border border-gray-300 rounded text-sm px-2 py-1"
             data-action="content-tone-update" data-index="${n}" data-field="description" placeholder="Description (optional)">
      <button type="button" class="text-red-500 hover:text-red-700" data-action="content-tone-remove" data-index="${n}" aria-label="Remove">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
      </button>`,e.appendChild(i)}))}function at(){L.push({id:"custom_"+Date.now(),name:"New Tone",description:"Custom content tone"}),Pe()}function H(e,o,n){L[e]&&(L[e][o]=n,o==="name"&&(L[e]._originalId||(L[e]._originalId=L[e].id),L[e].id=(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")))}function it(e){!isNaN(e)&&e>=0&&e<L.length&&confirm("Are you sure you want to remove this content tone option?")&&(L.splice(e,1),Pe())}async function st(){try{const e=new Set(L.map(i=>i.id)),o=new Set;for(const i of L)i._originalId&&i._originalId!==i.id&&o.add(i._originalId);const n=Array.from(de).filter(i=>!e.has(i)&&!o.has(i));for(const i of L)i._originalId&&i._originalId!==i.id&&de.has(i._originalId)?(await dt(i._originalId),await Ce(i,!0)):de.has(i.id)?await Ce(i,!1):await Ce(i,!0);for(const i of n)await dt(i);await le(),$e();try{showNotification("Content Tone Options","Options saved!","success")}catch{}Be()}catch(e){try{showNotification("Content Tone Options","Error saving options: "+e.message,"error")}catch{}}}async function Ce(e,o=!1){try{const l=await(await fetch(`/api/content_tone_options.php?action=${o?"add":"update"}&admin_token=whimsical_admin_2024`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,value:e.value||e.id,label:e.name,description:e.description})})).json();if(!l.success)try{showNotification("Content Tone Options","Failed to save option: "+l.error,"error")}catch{}return!!l.success}catch(n){try{showNotification("Content Tone Options","Error saving option: "+n.message,"error")}catch{}return!1}}async function dt(e){try{const n=await(await fetch(`/api/content_tone_options.php?action=delete&id=${e}&admin_token=whimsical_admin_2024`,{method:"DELETE"})).json();if(!n.success)try{showNotification("Content Tone Options","Failed to delete option: "+n.error,"error")}catch{}return!!n.success}catch(o){try{showNotification("Content Tone Options","Error deleting option: "+o.message,"error")}catch{}return!1}}async function ce(){try{const o=await(await fetch("/api/brand_voice_options.php?action=get_active&admin_token=whimsical_admin_2024")).json();o.success&&Array.isArray(o.options)&&o.options.length>0?(k=o.options.map(n=>({id:n.value,name:n.label,description:n.description})),re=new Set(k.map(n=>n.id)),Ne()):await Ko()}catch(e){console.error("Error loading brand voice options:",e.message),De()}}async function Ko(){try{(await(await fetch("/api/brand_voice_options.php?action=initialize_defaults&admin_token=whimsical_admin_2024",{method:"POST"})).json()).success?await ce():De()}catch(e){console.error("Error initializing default brand voice options:",e.message),De()}}function De(){k=[{id:"friendly_approachable",name:"Friendly & Approachable",description:"Warm, welcoming, and easy to connect with"},{id:"professional_trustworthy",name:"Professional & Trustworthy",description:"Business-focused, reliable, and credible"},{id:"playful_fun",name:"Playful & Fun",description:"Lighthearted, entertaining, and engaging"},{id:"luxurious_premium",name:"Luxurious & Premium",description:"High-end, sophisticated, and exclusive"},{id:"casual_relaxed",name:"Casual & Relaxed",description:"Laid-back, informal, and comfortable"},{id:"authoritative_expert",name:"Authoritative & Expert",description:"Knowledgeable, confident, and commanding"},{id:"warm_personal",name:"Warm & Personal",description:"Intimate, caring, and heartfelt"},{id:"innovative_forward_thinking",name:"Innovative & Forward-Thinking",description:"Creative, cutting-edge, and progressive"},{id:"energetic_dynamic",name:"Energetic & Dynamic",description:"Enthusiastic, vibrant, and exciting"},{id:"sophisticated_elegant",name:"Sophisticated & Elegant",description:"Refined, polished, and tasteful"},{id:"conversational_natural",name:"Conversational & Natural",description:"Dialogue-like, personal, and engaging"},{id:"inspiring_motivational",name:"Inspiring & Motivational",description:"Uplifting, encouraging, and empowering"}],re=new Set(k.map(e=>e.id)),Ne()}function Ne(){const e=document.getElementById("ai_brand_voice");if(!e)return;const o=e.value;e.innerHTML='<option value="">Select brand voice...</option>',k.forEach(n=>{const i=document.createElement("option");i.value=n.id,i.textContent=n.name,n.description&&(i.title=n.description),e.appendChild(i)}),o&&(e.value=o)}function rt(){Qo()}function Qo(){const e=document.getElementById("brandVoiceModal");e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`
    <div id="brandVoiceModal" class="admin-modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-action="overlay-close">
      <div class="admin-modal bg-white rounded-lg w-full max-w-2xl max-h-[90vh] flex flex-col" role="dialog" aria-modal="true" aria-labelledby="brandVoiceTitle">
        <div class="flex justify-between items-center border-b p-4">
          <h3 id="brandVoiceTitle" class="text-lg font-semibold text-gray-800">Manage Brand Voice Options</h3>
          <button type="button" class="text-gray-500 hover:text-gray-700 text-xl" data-action="brand-voice-close" aria-label="Close">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
          <div class="space-y-4">
            <div class="flex justify-between items-center">
              <p class="text-sm text-gray-600">Manage the brand voice options available for AI content generation.</p>
              <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white rounded text-sm px-3 py-1" data-action="brand-voice-add">Add Option</button>
            </div>
            <div id="brandVoiceList" class="space-y-2"></div>
          </div>
        </div>
        <div class="border-t flex justify-end space-x-2 p-3">
          <button type="button" class="text-gray-600 hover:text-gray-800 px-3 py-1" data-action="brand-voice-close">Cancel</button>
          <button type="button" class="btn btn-primary px-3 py-1" data-action="brand-voice-save">Save Changes</button>
        </div>
      </div>
    </div>`),Re()}function Le(){const e=document.getElementById("brandVoiceModal");e&&e.remove()}function Re(){const e=document.getElementById("brandVoiceList");e&&(e.innerHTML="",k.forEach((o,n)=>{const i=document.createElement("div");i.className="flex items-center space-x-3 bg-gray-50 rounded-lg p-2",i.innerHTML=`
      <input type="text" value="${o.name||""}" class="flex-1 border border-gray-300 rounded text-sm px-2 py-1"
             data-action="brand-voice-update" data-index="${n}" data-field="name" placeholder="Name">
      <input type="text" value="${o.description||""}" class="flex-1 border border-gray-300 rounded text-sm px-2 py-1"
             data-action="brand-voice-update" data-index="${n}" data-field="description" placeholder="Description (optional)">
      <button type="button" class="text-red-500 hover:text-red-700" data-action="brand-voice-remove" data-index="${n}" aria-label="Remove">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
      </button>`,e.appendChild(i)}))}function lt(){k.push({id:"custom_"+Date.now(),name:"New Voice",description:"Custom brand voice"}),Re()}function q(e,o,n){k[e]&&(k[e][o]=n,o==="name"&&(k[e]._originalId||(k[e]._originalId=k[e].id),k[e].id=(n||"").toLowerCase().replace(/[^a-z0-9]/g,"_")))}function ct(e){!isNaN(e)&&e>=0&&e<k.length&&confirm("Are you sure you want to remove this brand voice option?")&&(k.splice(e,1),Re())}async function ft(){try{const e=new Set(k.map(i=>i.id)),o=new Set;for(const i of k)i._originalId&&i._originalId!==i.id&&o.add(i._originalId);const n=Array.from(re).filter(i=>!e.has(i)&&!o.has(i));for(const i of k)i._originalId&&i._originalId!==i.id&&re.has(i._originalId)?(await ut(i._originalId),await Me(i,!0)):re.has(i.id)?await Me(i,!1):await Me(i,!0);for(const i of n)await ut(i);await ce(),Ne();try{showNotification("Brand Voice Options","Options saved!","success")}catch{}Le()}catch(e){try{showNotification("Brand Voice Options","Error saving options: "+e.message,"error")}catch{}}}async function Me(e,o=!1){try{const l=await(await fetch(`/api/brand_voice_options.php?action=${o?"add":"update"}&admin_token=whimsical_admin_2024`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e.id,value:e.value||e.id,label:e.name,description:e.description})})).json();if(!l.success)try{showNotification("Brand Voice Options","Failed to save option: "+l.error,"error")}catch{}return!!l.success}catch(n){try{showNotification("Brand Voice Options","Error saving option: "+n.message,"error")}catch{}return!1}}async function ut(e){try{const n=await(await fetch(`/api/brand_voice_options.php?action=delete&id=${e}&admin_token=whimsical_admin_2024`,{method:"DELETE"})).json();if(!n.success)try{showNotification("Brand Voice Options","Failed to delete option: "+n.error,"error")}catch{}return!!n.success}catch(o){try{showNotification("Brand Voice Options","Error deleting option: "+o.message,"error")}catch{}return!1}}function Cn(){const e=document.getElementById("aiSettingsModal");if(e){e.classList.remove("hidden");try{typeof loadAISettings=="function"&&loadAISettings()}catch{}try{Yo()}catch{}try{typeof le=="function"&&le()}catch{}try{typeof ce=="function"&&ce()}catch{}}}function Jo(){const e=document.getElementById("aiSettingsModal");e&&e.classList.add("hidden")}async function Yo(){try{const o=await(await fetch("/api/ai_settings.php?action=get_providers")).json();o.success?Zo(o.providers):console.error("Failed to load AI providers:",o.error)}catch(e){console.error("Error loading AI providers:",e.message)}}function Zo(e){try{window.aiProviders=e}catch{}}function Mn(e){if(!e)return;const o=document.getElementById(`${e}-content`),n=document.getElementById(`${e}-icon`);o&&o.classList.toggle("hidden"),n&&o&&(n.textContent=o.classList.contains("hidden")?"▶":"▼")}function pt(){const e=document.querySelector('input[name="ai_provider"]:checked'),o=(e&&typeof e.value<"u"?e.value:"")||ve();["openai","anthropic","google","meta"].forEach(i=>{const l=document.getElementById(`${i}_section`);l&&(o==="jons_ai"?l.classList.add("hidden"):i===o?l.classList.remove("hidden"):l.classList.add("hidden"))});try{typeof window.aiSettings<"u"&&window.aiSettings?en(window.aiSettings):o&&o!=="jons_ai"&&ke(o)}catch{}}async function mt(){const e=document.querySelector('input[name="ai_provider"]:checked'),o=document.getElementById("openai_api_key"),n=document.getElementById("openai_model"),i=document.getElementById("anthropic_api_key"),l=document.getElementById("anthropic_model"),c=document.getElementById("google_api_key"),m=document.getElementById("google_model"),h=document.getElementById("meta_api_key"),f=document.getElementById("meta_model"),v=document.getElementById("ai_temperature"),g=document.getElementById("ai_max_tokens"),x=document.getElementById("ai_timeout"),C=document.getElementById("fallback_to_local"),_=document.getElementById("ai_brand_voice"),D=document.getElementById("ai_content_tone"),M=document.getElementById("ai_cost_temperature"),B=document.getElementById("ai_price_temperature"),a=document.getElementById("ai_cost_multiplier_base"),d=document.getElementById("ai_price_multiplier_base"),u=document.getElementById("ai_conservative_mode"),p=document.getElementById("ai_market_research_weight"),s=document.getElementById("ai_cost_plus_weight"),b=document.getElementById("ai_value_based_weight"),y={ai_provider:e&&e.value||ve(),openai_api_key:o&&o.value||"",openai_model:n&&n.value||"gpt-3.5-turbo",anthropic_api_key:i&&i.value||"",anthropic_model:l&&l.value||"claude-3-haiku-20240307",google_api_key:c&&c.value||"",google_model:m&&m.value||"gemini-pro",meta_api_key:h&&h.value||"",meta_model:f&&f.value||"meta-llama/llama-3.1-70b-instruct",ai_temperature:parseFloat(v&&v.value||.7),ai_max_tokens:parseInt(g&&g.value||1e3,10),ai_timeout:parseInt(x&&x.value||30,10),fallback_to_local:!!(C&&C.checked),ai_brand_voice:_&&_.value||"",ai_content_tone:D&&D.value||"professional",ai_cost_temperature:parseFloat(M&&M.value||.7),ai_price_temperature:parseFloat(B&&B.value||.7),ai_cost_multiplier_base:parseFloat(a&&a.value||1),ai_price_multiplier_base:parseFloat(d&&d.value||1),ai_conservative_mode:!!(u&&u.checked),ai_market_research_weight:parseFloat(p&&p.value||.3),ai_cost_plus_weight:parseFloat(s&&s.value||.4),ai_value_based_weight:parseFloat(b&&b.value||.3)};try{const T=await(await fetch("/api/ai_settings.php?action=update_settings",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)})).json();T.success?Xo("AI settings saved successfully!"):wt("Failed to save AI settings: "+T.error)}catch(I){wt("Error saving AI settings: "+I.message)}}function Xo(e){try{showNotification("AI Settings Saved",e,"success")}catch{console.log(e)}setTimeout(()=>{try{Jo()}catch{}},1500)}function wt(e){try{showNotification("AI Settings Error",e,"error")}catch{console.error(e)}}async function yt(){const e=document.querySelector('input[name="ai_provider"]:checked'),o=e&&e.value||ve();try{try{showNotification("Testing AI Provider",`Testing ${o} provider...`,"info")}catch{}const i=await(await fetch(`/api/ai_settings.php?action=test_provider&provider=${o}`)).json();if(i.success)try{showNotification("AI Provider Test",`✅ ${o} provider test successful!`,"success")}catch{}else try{showNotification("AI Provider Test",`❌ ${o} provider test failed: ${i.message}`,"error")}catch{}}catch(n){try{showNotification("AI Provider Test",`❌ Test failed: ${n.message}`,"error")}catch{console.error(n)}}}let A={};async function In(){try{const o=await(await fetch("/api/get_ai_models.php?provider=all")).json();o.success?(A=o.models,O("openai",A.openai),O("anthropic",A.anthropic),O("google",A.google),O("meta",A.meta)):(console.error("❌ Failed to load AI models:",o.error),gt())}catch(e){console.error("❌ Error loading AI models:",e.message),gt()}}async function Bn(e){try{const n=await(await fetch("/api/get_ai_models.php?provider=all")).json();n.success?(A=n.models,F("openai",A.openai,e.openai_model),F("anthropic",A.anthropic,e.anthropic_model),F("google",A.google,e.google_model),F("meta",A.meta,e.meta_model)):(console.error("❌ Failed to load AI models:",n.error),ht(e))}catch(o){console.error("❌ Error loading AI models:",o.message),ht(e)}}function ve(){if(typeof window.aiSettings<"u"&&window.aiSettings){const e=["jons_ai","openai","anthropic","google","meta"];for(const o of e)if(window.aiSettings[`${o}_api_key`])return o}return"jons_ai"}async function en(e){const o=e.ai_provider||ve();if(o!=="jons_ai")try{const i=await(await fetch(`/api/get_ai_models.php?provider=${o}&admin_token=whimsical_admin_2024`)).json();if(i.success){A[o]=i.models;const l=`${o}_model`;F(o,i.models,e[l])}else console.error(`❌ Failed to load ${o} models:`,i.error),bt(o,e)}catch(n){console.error(`❌ Error loading ${o} models:`,n.message),bt(o,e)}}async function ke(e){try{try{showNotification("Refreshing Models",`Loading ${e} models...`,"info")}catch{}const n=await(await fetch(`/api/get_ai_models.php?provider=${e}&admin_token=whimsical_admin_2024`)).json();if(n.success){A[e]=n.models,O(e,n.models);try{showNotification("Models Refreshed",`✅ ${e} models updated`,"success")}catch{}}else{try{showNotification("Models Error",`❌ Failed to load ${e} models: ${n.error}`,"error")}catch{}vt(e)}}catch(o){try{showNotification("Models Error",`❌ Error loading ${e} models: ${o.message}`,"error")}catch{}vt(e)}}function O(e,o){const n=document.getElementById(`${e}_model`);if(!n)return;const i=n.value;if(n.innerHTML="",!o||o.length===0){n.innerHTML='<option value="">No models available</option>';return}o.forEach(l=>{const c=document.createElement("option");c.value=l.id,c.textContent=`${l.name} - ${l.description}`,c.title=l.description,n.appendChild(c)}),i&&n.querySelector(`option[value="${i}"]`)?n.value=i:n.selectedIndex=0}function F(e,o,n){const i=document.getElementById(`${e}_model`);if(i){if(i.innerHTML="",!o||o.length===0){i.innerHTML='<option value="">No models available</option>';return}o.forEach(l=>{const c=document.createElement("option");c.value=l.id,c.textContent=`${l.name} - ${l.description}`,c.title=l.description,l.id===n&&(c.selected=!0),i.appendChild(c)}),(!n||!i.querySelector(`option[value="${n}"]`))&&(i.selectedIndex=0)}}function gt(){const e={openai:[{id:"gpt-4o",name:"GPT-4o",description:"Latest and most capable model"},{id:"gpt-4-turbo",name:"GPT-4 Turbo",description:"Fast and capable"},{id:"gpt-4",name:"GPT-4",description:"Highly capable model"},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",description:"Fast and affordable"}],anthropic:[{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",description:"Most intelligent model"},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",description:"Fastest model"},{id:"claude-3-opus-20240229",name:"Claude 3 Opus",description:"Most capable for reasoning"},{id:"claude-3-sonnet-20240229",name:"Claude 3 Sonnet",description:"Balanced performance"},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",description:"Fast and affordable"}],google:[{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",description:"Most capable Gemini model"},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash",description:"Fast and efficient"},{id:"gemini-pro",name:"Gemini Pro",description:"Balanced performance"},{id:"gemini-pro-vision",name:"Gemini Pro Vision",description:"Multimodal capabilities"}],meta:[{id:"meta-llama/llama-3.1-405b-instruct",name:"Llama 3.1 405B",description:"Most capable model"},{id:"meta-llama/llama-3.1-70b-instruct",name:"Llama 3.1 70B",description:"Balanced performance"},{id:"meta-llama/llama-3.1-8b-instruct",name:"Llama 3.1 8B",description:"Fast and affordable"},{id:"meta-llama/llama-3-70b-instruct",name:"Llama 3 70B",description:"Previous generation"},{id:"meta-llama/llama-3-8b-instruct",name:"Llama 3 8B",description:"Lightweight"}]};A=e,O("openai",e.openai),O("anthropic",e.anthropic),O("google",e.google),O("meta",e.meta)}function vt(e){const o={openai:[{id:"gpt-4o",name:"GPT-4o",description:"Latest and most capable model"},{id:"gpt-4-turbo",name:"GPT-4 Turbo",description:"Fast and capable"},{id:"gpt-4",name:"GPT-4",description:"Highly capable model"},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",description:"Fast and affordable"}],anthropic:[{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",description:"Most intelligent model"},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",description:"Fastest model"},{id:"claude-3-opus-20240229",name:"Claude 3 Opus",description:"Most capable for reasoning"},{id:"claude-3-sonnet-20240229",name:"Claude 3 Sonnet",description:"Balanced performance"},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",description:"Fast and affordable"}],google:[{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",description:"Most capable Gemini model"},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash",description:"Fast and efficient"},{id:"gemini-pro",name:"Gemini Pro",description:"Balanced performance"},{id:"gemini-pro-vision",name:"Gemini Pro Vision",description:"Multimodal capabilities"}]};o[e]&&(A[e]=o[e],O(e,o[e]))}function ht(e){const o={openai:[{id:"gpt-4o",name:"GPT-4o",description:"Latest and most capable model"},{id:"gpt-4-turbo",name:"GPT-4 Turbo",description:"Fast and capable"},{id:"gpt-4",name:"GPT-4",description:"Highly capable model"},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",description:"Fast and affordable"}],anthropic:[{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",description:"Most intelligent model"},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",description:"Fastest model"},{id:"claude-3-opus-20240229",name:"Claude 3 Opus",description:"Most capable for reasoning"},{id:"claude-3-sonnet-20240229",name:"Claude 3 Sonnet",description:"Balanced performance"},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",description:"Fast and affordable"}],google:[{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",description:"Most capable Gemini model"},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash",description:"Fast and efficient"},{id:"gemini-pro",name:"Gemini Pro",description:"Balanced performance"},{id:"gemini-pro-vision",name:"Gemini Pro Vision",description:"Multimodal capabilities"}],meta:[{id:"meta-llama/llama-3.1-405b-instruct",name:"Llama 3.1 405B",description:"Most capable model"},{id:"meta-llama/llama-3.1-70b-instruct",name:"Llama 3.1 70B",description:"Balanced performance"},{id:"meta-llama/llama-3.1-8b-instruct",name:"Llama 3.1 8B",description:"Fast and affordable"},{id:"meta-llama/llama-3-70b-instruct",name:"Llama 3 70B",description:"Previous generation"},{id:"meta-llama/llama-3-8b-instruct",name:"Llama 3 8B",description:"Lightweight"}]};A=o,F("openai",o.openai,e.openai_model),F("anthropic",o.anthropic,e.anthropic_model),F("google",o.google,e.google_model),F("meta",o.meta,e.meta_model)}function bt(e,o){const n={openai:[{id:"gpt-4o",name:"GPT-4o",description:"Latest and most capable model"},{id:"gpt-4-turbo",name:"GPT-4 Turbo",description:"Fast and capable"},{id:"gpt-4",name:"GPT-4",description:"Highly capable model"},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",description:"Fast and affordable"}],anthropic:[{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",description:"Most intelligent model"},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",description:"Fastest model"},{id:"claude-3-opus-20240229",name:"Claude 3 Opus",description:"Most capable for reasoning"},{id:"claude-3-sonnet-20240229",name:"Claude 3 Sonnet",description:"Balanced performance"},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",description:"Fast and affordable"}],google:[{id:"gemini-1.5-pro",name:"Gemini 1.5 Pro",description:"Most capable Gemini model"},{id:"gemini-1.5-flash",name:"Gemini 1.5 Flash",description:"Fast and efficient"},{id:"gemini-pro",name:"Gemini Pro",description:"Balanced performance"},{id:"gemini-pro-vision",name:"Gemini Pro Vision",description:"Multimodal capabilities"}],meta:[{id:"meta-llama/llama-3.1-405b-instruct",name:"Llama 3.1 405B",description:"Most capable model"},{id:"meta-llama/llama-3.1-70b-instruct",name:"Llama 3.1 70B",description:"Balanced performance"},{id:"meta-llama/llama-3.1-8b-instruct",name:"Llama 3.1 8B",description:"Fast and affordable"},{id:"meta-llama/llama-3-70b-instruct",name:"Llama 3 70B",description:"Previous generation"},{id:"meta-llama/llama-3-8b-instruct",name:"Llama 3 8B",description:"Lightweight"}]};if(n[e]){A[e]=n[e];const i=`${e}_model`;F(e,n[e],o[i])}}async function Po(){const e=document.getElementById("systemConfigLoading"),o=document.getElementById("systemConfigContent");e&&e.classList&&e.classList.remove("hidden");try{const i=await(await fetch("/api/get_system_config.php")).json();if(i.success){const l=i.data;e&&e.classList&&e.classList.add("hidden"),o.innerHTML=Dn(l)}else throw new Error(i.error||"Failed to load system configuration")}catch(n){console.error("Error loading system configuration:",n),e.innerHTML=`
            <div class="modal-loading">
                <div class="text-red-500">⚠️</div>
                <p class="text-red-600">Failed to load system configuration</p>
                <p class="text-sm text-gray-500">${n.message}</p>
                <button type="button" data-action="retry-load-system-config" class="bg-orange-500 text-white rounded hover:bg-orange-600">
                    Retry
                </button>
            </div>
        `}}function Dn(e){return e.statistics.last_order_date&&new Date(e.statistics.last_order_date).toLocaleDateString(),`
        <!-- Current System Architecture -->
        <div class="bg-green-50 border-l-4 border-green-400">
            <h4 class="font-semibold text-green-800 flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 01-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15 13.586V12a1 1 0 011-1z" clip-rule="evenodd"></path>
                </svg>
                Current System Architecture (Live Data)
            </h4>
            <div class="space-y-3 text-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h5 class="font-semibold text-green-700">🎯 Primary Identifier</h5>
                        <p class="text-green-600"><strong>${e.system_info.primary_identifier}</strong> - Human-readable codes</p>
                        <p class="text-xs text-green-600">Format: ${e.system_info.sku_format}</p>
                        <p class="text-xs text-green-600">Examples: ${e.sample_skus.slice(0,3).join(", ")}</p>
                    </div>
                    <div>
                        <h5 class="font-semibold text-green-700">🏷️ Main Entity</h5>
                        <p class="text-green-600"><strong>${e.system_info.main_entity}</strong></p>
                        <p class="text-xs text-green-600">All inventory and shop items</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comprehensive SKU Methodology Documentation -->
        <div class="bg-blue-50 border-l-4 border-blue-400">
            <h4 class="font-semibold text-blue-800 flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" clip-rule="evenodd"></path>
                </svg>
                📖 Complete SKU & ID Methodology Documentation
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="space-y-3">
                    <div class="bg-white rounded border">
                        <h5 class="font-semibold text-blue-700">🏷️ SKU System Overview</h5>
                        <div class="text-xs text-blue-600 space-y-1">
                            <p>• <strong>Primary Format:</strong> WF-[CATEGORY]-[NUMBER]</p>
                            <p>• <strong>Enhanced Format:</strong> WF-[CAT]-[GENDER]-[SIZE]-[COLOR]-[NUM]</p>
                            <p>• <strong>Database:</strong> SKU-only system (no legacy IDs)</p>
                            <p>• <strong>Generation:</strong> Automatic via API with sequential numbering</p>
                            <p>• <strong>Usage:</strong> Primary key across all tables</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded border">
                        <h5 class="font-semibold text-blue-700">🔄 Migration History</h5>
                        <div class="text-xs text-blue-600 space-y-1">
                            <p>✅ <strong>Phase 1:</strong> Eliminated dual itemId/SKU system</p>
                            <p>✅ <strong>Phase 2:</strong> Migrated "products" → "items" terminology</p>
                            <p>✅ <strong>Phase 3:</strong> Fixed order ID generation (sequence-based)</p>
                            <p>✅ <strong>Phase 4:</strong> Implemented global color/size management</p>
                            <p>✅ <strong>Current:</strong> Pure SKU-only architecture</p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-white rounded border">
                        <h5 class="font-semibold text-blue-700">🛠️ API Endpoints</h5>
                        <div class="text-xs text-blue-600 space-y-1">
                            <p>• <code>/api/next_sku.php</code> - Generate new SKUs</p>
                            <p>• <code>/api/get_items.php</code> - Retrieve items by SKU</p>
                            <p>• <code>/api/get_item_images.php</code> - Item images</p>
                            <p>• <code>/api/add-order.php</code> - Create orders (fixed)</p>
                            <p>• <code>/api/update-inventory-field.php</code> - SKU updates</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded border">
                        <h5 class="font-semibold text-blue-700">📊 Current Statistics</h5>
                        <div class="text-xs text-blue-600 space-y-1">
                            <p>• <strong>Items:</strong> ${e.statistics.total_items} (${e.statistics.total_images} images)</p>
                            <p>• <strong>Orders:</strong> ${e.statistics.total_orders} (${e.statistics.total_order_items} items)</p>
                            <p>• <strong>Categories:</strong> ${e.statistics.categories_count} active</p>
                            <p>• <strong>Last Order:</strong> ${e.statistics.last_order_date?new Date(e.statistics.last_order_date).toLocaleDateString():"None"}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SKU Categories -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400">
            <h4 class="font-semibold text-yellow-800 flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                </svg>
                Active Categories & SKU Codes
            </h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                ${Object.entries(e.category_codes).map(([o,n])=>{const i=e.categories.includes(o);return`
                        <div class="text-center ${i?"bg-yellow-100":"bg-gray-100"} rounded">
                            <div class="font-semibold ${i?"text-yellow-700":"text-gray-500"}">${n}</div>
                            <div class="text-xs ${i?"text-yellow-600":"text-gray-400"}">${o}</div>
                            ${i?'<div class="text-xs text-green-600">✅ Active</div>':'<div class="text-xs text-gray-400">Inactive</div>'}
                        </div>
                    `}).join("")}
            </div>
        </div>



        <!-- ID Number Legend -->
        <div class="bg-orange-50 border-l-4 border-orange-400">
            <h4 class="font-semibold text-orange-800 flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                ID Number Legend & Formats
            </h4>
            <div class="space-y-4">
                <!-- Customer IDs -->
                <div class="bg-white rounded-lg border border-orange-200">
                    <h5 class="font-semibold text-orange-700 flex items-center text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                        Customer IDs
                    </h5>
                    <div class="text-xs text-orange-600 space-y-1">
                        <p><strong>Format:</strong> [MonthLetter][Day][SequenceNumber]</p>
                        ${e.id_formats.recent_customers.length>0?`<p><strong>Recent Examples:</strong> ${e.id_formats.recent_customers.map(o=>`<code class="bg-orange-100 py-0.5 rounded">${o.id}</code> (${o.username||"No username"})`).join(", ")}</p>`:'<p><strong>Example:</strong> <code class="bg-orange-100 py-0.5 rounded">F14004</code></p>'}
                        <div class="text-xs text-orange-500">
                            <p>• <strong>F</strong> = June (A=Jan, B=Feb, C=Mar, D=Apr, E=May, F=Jun, G=Jul, H=Aug, I=Sep, J=Oct, K=Nov, L=Dec)</p>
                            <p>• <strong>14</strong> = 14th day of the month</p>
                            <p>• <strong>004</strong> = 4th customer registered</p>
                        </div>
                    </div>
                </div>

                <!-- Order IDs - Updated with Sequence Fix -->
                <div class="bg-white rounded-lg border border-orange-200">
                    <h5 class="font-semibold text-orange-700 flex items-center text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2L3 7v11a1 1 0 001 1h12a1 1 0 001-1V7l-7-5zM8 15v-3h4v3H8z" clip-rule="evenodd"></path>
                        </svg>
                        Order IDs - Sequence-Based System ✅
                    </h5>
                    <div class="text-xs text-orange-600 space-y-1">
                        <p><strong>Format:</strong> [CustomerNum][MonthLetter][Day][ShippingCode][SequenceNum]</p>
                        ${e.id_formats.recent_orders.length>0?`<p><strong>Recent Examples:</strong> ${e.id_formats.recent_orders.map(o=>`<code class="bg-orange-100 py-0.5 rounded">${o}</code>`).join(", ")}</p>`:'<p><strong>Example:</strong> <code class="bg-orange-100 py-0.5 rounded">01F30P75</code></p>'}
                        <div class="text-xs text-orange-500">
                            <p>• <strong>01</strong> = Last 2 digits of customer number</p>
                            <p>• <strong>F30</strong> = June 30th (order date)</p>
                            <p>• <strong>P</strong> = Pickup (P=Pickup, L=Local, U=USPS, F=FedEx, X=UPS)</p>
                            <p>• <strong>75</strong> = Sequential number (eliminates duplicates)</p>
                        </div>
                        
                        <!-- Recent Fix Notice -->
                        <div class="bg-green-50 rounded">
                            <p class="font-medium text-green-700">🔧 Recent Fix Applied:</p>
                            <p class="text-xs text-green-600">• Replaced random number with sequence-based system</p>
                            <p class="text-xs text-green-600">• Eliminates "Duplicate entry" constraint violations</p>
                            <p class="text-xs text-green-600">• Sequential: 17F30P75 → 17F30P76 → 17F30P77</p>
                            <p class="text-xs text-green-600">• Robust for concurrent checkout processing</p>
                        </div>
                        
                        <!-- Shipping Codes -->
                        <div class="bg-blue-50 rounded">
                            <p class="font-medium text-blue-700">📦 Shipping Method Codes:</p>
                            <p class="text-xs text-blue-600">• <strong>P</strong> = Customer Pickup • <strong>L</strong> = Local Delivery</p>
                            <p class="text-xs text-blue-600">• <strong>U</strong> = USPS • <strong>F</strong> = FedEx • <strong>X</strong> = UPS</p>
                        </div>
                    </div>
                </div>

                <!-- Product/Inventory IDs (SKUs) - Enhanced Documentation -->
                <div class="bg-white rounded-lg border border-orange-200">
                    <h5 class="font-semibold text-orange-700 flex items-center text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                        </svg>
                        Product & Inventory IDs (SKUs) - Complete System
                    </h5>
                    <div class="text-xs text-orange-600 space-y-1">
                        <p><strong>Primary Format:</strong> ${e.system_info.sku_format}</p>
                        ${e.sample_skus.length>0?`<p><strong>Current Examples:</strong> ${e.sample_skus.slice(0,5).map(o=>`<code class="bg-orange-100 py-0.5 rounded">${o}</code>`).join(", ")}</p>`:'<p><strong>Examples:</strong> <code class="bg-orange-100 py-0.5 rounded">WF-TS-001</code>, <code class="bg-orange-100 py-0.5 rounded">WF-TU-002</code></p>'}
                        
                        <!-- Enhanced SKU Format -->
                        <div class="bg-orange-50 rounded">
                            <p class="font-medium text-orange-700">Enhanced SKU Format (Optional):</p>
                            <p><strong>WF-[CATEGORY]-[GENDER]-[SIZE]-[COLOR]-[NUMBER]</strong></p>
                            <p class="text-xs">Example: <code class="bg-orange-100 py-0.5 rounded">WF-TS-M-L-BLK-001</code> = WhimsicalFrog T-Shirt, Men's Large, Black, #001</p>
                        </div>
                        
                        <!-- Category Codes -->
                        <div class="text-xs text-orange-500">
                            <p class="font-medium">Category Codes:</p>
                            ${Object.entries(e.category_codes).map(([o,n])=>`<p>• <strong>${n}</strong> = ${o}</p>`).join("")}
                        </div>
                        
                        <!-- SKU Generation -->
                        <div class="bg-green-50 rounded">
                            <p class="font-medium text-green-700">🔄 Auto-Generation:</p>
                            <p class="text-xs text-green-600">• SKUs are automatically generated with sequential numbering</p>
                            <p class="text-xs text-green-600">• API: <code>/api/next_sku.php?cat=[CATEGORY]</code></p>
                            <p class="text-xs text-green-600">• Enhanced: <code>&gender=M&size=L&color=Black&enhanced=true</code></p>
                        </div>
                        
                        <!-- Database Integration -->
                        <div class="bg-blue-50 rounded">
                            <p class="font-medium text-blue-700">🗄️ Database Integration:</p>
                            <p class="text-xs text-blue-600">• Primary table: <code>items</code> (SKU as primary key)</p>
                            <p class="text-xs text-blue-600">• Images: <code>item_images</code> (linked via SKU)</p>
                            <p class="text-xs text-blue-600">• Orders: <code>order_items</code> (references SKU)</p>
                            <p class="text-xs text-blue-600">• Migration complete: No legacy ID columns</p>
                        </div>
                    </div>
                </div>

                <!-- Order Item IDs -->
                <div class="bg-white rounded-lg border border-orange-200">
                    <h5 class="font-semibold text-orange-700 flex items-center text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                        </svg>
                        Order Item IDs
                    </h5>
                    <div class="text-xs text-orange-600 space-y-1">
                        <p><strong>Format:</strong> OI[SequentialNumber]</p>
                        ${e.id_formats.recent_order_items.length>0?`<p><strong>Recent Examples:</strong> ${e.id_formats.recent_order_items.map(o=>`<code class="bg-orange-100 py-0.5 rounded">${o}</code>`).join(", ")}</p>`:'<p><strong>Example:</strong> <code class="bg-orange-100 py-0.5 rounded">OI001</code></p>'}
                        <div class="text-xs text-orange-500">
                            <p>• <strong>OI</strong> = Order Item prefix</p>
                            <p>• <strong>001</strong> = Sequential 3-digit number (001, 002, 003, etc.)</p>
                            <p class="italic">Simple, clean, and easy to reference!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    `}window.openDatabaseMaintenanceModal=function(){console.log("openDatabaseMaintenanceModal called");const o=document.getElementById("databaseMaintenanceModal");if(!o){console.error("databaseMaintenanceModal element not found!"),window.showError?window.showError("Database Maintenance modal not found. Please refresh the page."):alert("Database Maintenance modal not found. Please refresh the page.");return}console.log("Opening database maintenance modal..."),typeof window.openModal=="function"?window.openModal("databaseMaintenanceModal"):(o.classList.remove("hidden"),o.classList.add("show"));const n=document.getElementById("databaseMaintenanceLoading");n&&n.classList&&n.classList.add("hidden"),switchDatabaseTab(document.querySelector('[data-tab="connection"]'),"connection"),loadCurrentDatabaseConfig()};async function No(){const e=document.getElementById("databaseMaintenanceLoading"),o=document.getElementById("databaseMaintenanceContent");e&&e.classList&&e.classList.remove("hidden");try{const i=await(await fetch("/api/get_database_info.php")).json();if(i.success){const l=i.data;e&&e.classList&&e.classList.add("hidden"),o.innerHTML=Ln(l)}else throw new Error(i.error||"Failed to load database information")}catch(n){console.error("Error loading database information:",n),e.innerHTML=`
            <div class="modal-loading">
                <div class="text-red-500">⚠️</div>
                <p class="text-red-600">Failed to load database information</p>
                <p class="text-sm text-gray-500">${n.message}</p>
                <button type="button" data-action="retry-load-db-info" class="bg-red-500 text-white rounded hover:bg-red-600">
                    Retry
                </button>
            </div>
        `}}function Ln(e){return`
        <!-- Database Schema -->
        <div class="bg-purple-50 border-l-4 border-purple-400">
            <h4 class="font-semibold text-purple-800 flex items-center">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2h-2.22l.123.489.804.804A1 1 0 0113 18H7a1 1 0 01-.707-1.707l.804-.804L7.22 15H5a2 2 0 01-2-2V5zm5.771 7H5V5h10v7H8.771z" clip-rule="evenodd"></path>
                </svg>
                Database Tables & Structure (${e.total_active} Active + ${e.total_backup} Backup)
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                ${Object.entries(e.organized||{}).map(([o,n])=>`
                        <div class="bg-white rounded border border-purple-200 p-3">
                            <h5 class="font-semibold text-purple-700">${{core_ecommerce:"🛒 Core E-commerce",user_management:"👥 User Management",inventory_cost:"💰 Inventory & Cost",product_categories:"🏷️ Product Categories",room_management:"🏠 Room Management",email_system:"📧 Email System",business_config:"⚙️ Business Config",system_logs:"📄 System Logs",backup_tables:"🗄️ Backup Tables"}[o]||`❓ Unknown Category: ${o}`}</h5>
                            <ul class="text-xs text-purple-600 mt-2 space-y-1">
                                ${n.map(c=>`
                                    <li class="flex justify-between items-center">
                                        <span>${c.name}</span>
                                        <span class="text-purple-500 font-mono">${c.rows} rows</span>
                                    </li>
                                `).join("")}
                            </ul>
                        </div>
                    `).join("")}
            </div>
        </div>
    `}function kn(e){return e||(typeof window<"u"?window.event:void 0)}async function tn(e){resultsDiv&&(resultsDiv.className="mt-3 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm",resultsDiv.innerHTML="⏳ Scanning PHP files for database connections...",resultsDiv.classList.remove("hidden"));try{const n=await(await fetch("/api/convert_to_centralized_db.php?action=scan&format=json&admin_token=whimsical_admin_2024")).json();if(n.success)n.needs_conversion>0?resultsDiv&&(resultsDiv.className="mt-3 px-3 py-2 bg-yellow-50 border border-yellow-200 rounded text-sm",resultsDiv.innerHTML=`
                        <div class="font-medium text-yellow-800">⚠️ Files Need Conversion</div>
                        <div class="text-xs space-y-1 text-yellow-700">
                            <div>Total PHP files: ${n.total_files}</div>
                            <div>Files needing conversion: ${n.needs_conversion}</div>
                            <div class="">Files with direct PDO connections:</div>
                            <ul class="list-disc list-inside">
                                ${n.files.slice(0,10).map(i=>`<li>${i}</li>`).join("")}
                                ${n.files.length>10?`<li>... and ${n.files.length-10} more</li>`:""}
                            </ul>
                        </div>
                    `):resultsDiv&&(resultsDiv.className="mt-3 px-3 py-2 bg-green-50 border border-green-200 rounded text-sm",resultsDiv.innerHTML=`
                        <div class="font-medium text-green-800">✅ All Files Use Centralized Database!</div>
                        <div class="text-xs text-green-700">Scanned ${n.total_files} PHP files - no conversion needed</div>
                    `);else throw new Error(n.message||"Scan failed")}catch(o){resultsDiv&&(resultsDiv.className="mt-3 px-3 py-2 bg-red-50 border border-red-200 rounded text-sm",resultsDiv.innerHTML=`<div class="text-red-800">❌ Scan failed: ${o.message}</div>`)}finally{button&&(button.disabled=!1,button.textContent="📊 Scan Files")}}async function on(e){const o=kn(e),n=o&&o.target?o.target:document.querySelector('[data-action="convert-db"], #convertDatabaseConnectionsBtn'),i=document.getElementById("conversionResults");if(confirm("This will modify files with direct PDO connections and create backups. Continue?")){n&&(n.disabled=!0,n.textContent="🔄 Converting..."),i&&(i.className="mt-3 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm",i.innerHTML="⏳ Converting files to use centralized database connections...",i.classList.remove("hidden"));try{const c=await(await fetch("/api/convert_to_centralized_db.php?action=convert&format=json&admin_token=whimsical_admin_2024")).json();if(c.success)c.converted>0?i&&(i.className="mt-3 px-3 py-2 bg-green-50 border border-green-200 rounded text-sm",i.innerHTML=`
                        <div class="font-medium text-green-800">🎉 Conversion Completed!</div>
                        <div class="text-xs space-y-1 text-green-700">
                            <div>Files converted: ${c.converted}</div>
                            <div>Conversion failures: ${c.failed}</div>
                            <div class="">💾 Backups were created for all modified files</div>
                            <div class="text-yellow-700">⚠️ Please test your application to ensure everything works correctly</div>
                        </div>
                        ${c.results.filter(m=>m.status==="converted").length>0?`
                            <details class="">
                                <summary class="cursor-pointer text-green-700 hover:text-green-900">View converted files</summary>
                                <ul class="list-disc list-inside text-xs">
                                    ${c.results.filter(m=>m.status==="converted").map(m=>`<li>${m.file} (${m.changes} changes)</li>`).join("")}
                                </ul>
                            </details>
                        `:""}
                    `):i&&(i.className="mt-3 px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm",i.innerHTML=`
                        <div class="font-medium text-blue-800">ℹ️ No Files Needed Conversion</div>
                        <div class="text-xs text-blue-700">All files are already using centralized database connections</div>
                    `);else throw new Error(c.message||"Conversion failed")}catch(l){i&&(i.className="mt-3 px-3 py-2 bg-red-50 border border-red-200 rounded text-sm",i.innerHTML=`<div class="text-red-800">❌ Conversion failed: ${l.message}</div>`)}finally{n&&(n.disabled=!1,n.textContent="🔄 Convert All")}}}function nn(){window.open("/api/convert_to_centralized_db.php?admin_token=whimsical_admin_2024","_blank")}function an(){const e=document.getElementById("databaseBackupTablesContainer"),o=document.getElementById("databaseBackupToggleIcon");!e||!o||(e.classList.contains("hidden")?(e.classList.remove("hidden"),o.textContent="▼"):(e.classList.add("hidden"),o.textContent="▶"))}async function sn(e){try{const o=document.getElementById("tableViewModal"),n=document.getElementById("tableViewTitle"),i=document.getElementById("tableViewContent");n&&(n.textContent=`Loading ${e}...`),i&&(i.innerHTML='<div class="text-center"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>'),typeof window.openModal=="function"?window.openModal("tableViewModal"):o&&(o.classList.remove("hidden"),o.classList.add("show"));const c=await(await fetch("/api/db_manager.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"query",sql:`SELECT * FROM \`${e}\` LIMIT 100`})})).json();if(c.success&&c.data){if(n&&(n.textContent=`Table: ${e} (${c.row_count} records shown, max 100)`),!Array.isArray(c.data)||c.data.length===0){i&&(i.innerHTML='<div class="text-center text-gray-500">Table is empty</div>');return}const m=Object.keys(c.data[0]),h=`
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full bg-white border border-gray-200 text-xs">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                ${m.map(f=>`<th class="border-b text-left font-semibold text-gray-700">${f}</th>`).join("")}
                            </tr>
                        </thead>
                        <tbody>
                            ${c.data.map(f=>`
                                <tr class="hover:bg-gray-50">
                                    ${m.map(v=>{let g=f[v];return g===null?g='<span class="text-gray-400">NULL</span>':typeof g=="string"&&g.length>50&&(g=g.substring(0,50)+"..."),`<td class="border-b">${g}</td>`}).join("")}
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                </div>
            `;i&&(i.innerHTML=h)}else n&&(n.textContent=`Error loading ${e}`),i&&(i.innerHTML=`<div class="text-red-600">Error: ${c.error||"Failed to load table data"}</div>`)}catch(o){console.error("Error viewing table:",o);const n=document.getElementById("tableViewTitle"),i=document.getElementById("tableViewContent");n&&(n.textContent=`Error loading ${e}`),i&&(i.innerHTML=`<div class="text-red-600">Error: ${o.message}</div>`)}}function dn(){if(typeof window.closeModal=="function")window.closeModal("tableViewModal");else{const e=document.getElementById("tableViewModal");e&&(e.classList.remove("show"),e.classList.add("hidden"))}}async function An(){try{const o=await(await fetch("/api/get_database_info.php")).json();return o.success&&o.data&&o.data.total_active||"several"}catch{return"several"}}async function rn(){const e=await An();if(!await(window.showConfirmationModal?window.showConfirmationModal({title:"Database Compact & Repair",subtitle:"Optimize and repair your database for better performance",message:"This operation will create a safety backup first, then optimize and repair all database tables to improve performance and fix any corruption issues.",details:`
            <ul>
                <li>✅ Create automatic safety backup before optimization</li>
                <li>🔧 Optimize ${e} database tables for better performance</li>
                <li>🛠️ Repair any table corruption or fragmentation issues</li>
                <li>⚡ Improve database speed and efficiency</li>
                <li>⏱️ Process typically takes 2-3 minutes</li>
            </ul>
        `,icon:"🔧",iconType:"info",confirmText:"Start Optimization",cancelText:"Cancel"}):Promise.resolve(confirm("Create a safety backup, then optimize and repair all database tables?"))))return;typeof window.showBackupProgressModal=="function"&&window.showBackupProgressModal("🔧 Database Compact & Repair","database-repair");const n=document.getElementById("backupProgressSteps"),i=document.getElementById("backupProgressTitle"),l=document.getElementById("backupProgressSubtitle");i&&(i.textContent="🔧 Database Compact & Repair"),l&&(l.textContent="Optimizing and repairing database tables...");try{n&&(n.innerHTML=`
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Creating safety backup...</p>
                        <p class="text-xs text-gray-500">Backing up database before optimization</p>
                    </div>
                </div>
            `);const m=await(await fetch("/api/backup_database.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({destination:"cloud"})})).json();if(!m.success)throw new Error("Failed to create safety backup: "+(m.error||"Unknown error"));n&&(n.innerHTML=`
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Safety backup created</p>
                        <p class="text-xs text-gray-500">Database backed up successfully</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Optimizing database tables...</p>
                        <p class="text-xs text-gray-500">Running OPTIMIZE and REPAIR operations</p>
                    </div>
                </div>
            `);const f=await(await fetch("/api/compact_repair_database.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({})})).json();if(!f.success)throw new Error("Database optimization failed: "+(f.error||"Unknown error"));n&&(n.innerHTML=`
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Safety backup created</p>
                        <p class="text-xs text-gray-500">Database backed up successfully</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Database optimization complete</p>
                        <p class="text-xs text-gray-500">${f.tables_processed||0} tables optimized and repaired</p>
                    </div>
                </div>
            `),typeof window.showBackupCompletionDetails=="function"&&window.showBackupCompletionDetails({success:!0,filename:m.filename,filepath:m.filepath,size:m.size,timestamp:m.timestamp,destinations:["Server"],tables_optimized:f.tables_processed||0,operation_type:"Database Compact & Repair"})}catch(c){console.error("Database optimization error:",c),typeof window.showError=="function"?window.showError(c.message||"Database optimization failed"):alert(c.message||"Database optimization failed")}}function R(e,o,n){if(!e)return;const i="px-3 py-2 border rounded text-sm";o?e.className=`${i} bg-green-50 border-green-200`:e.className=`${i} bg-red-50 border-red-200`,e.innerHTML=n,e.classList.remove("hidden")}async function ln(e){try{const o=document.getElementById("credentialsUpdateResult"),n=e&&e.target?e.target:document.activeElement,i={host:document.getElementById("newHost")&&document.getElementById("newHost").value||"",database:document.getElementById("newDatabase")&&document.getElementById("newDatabase").value||"",username:document.getElementById("newUsername")&&document.getElementById("newUsername").value||"",password:document.getElementById("newPassword")&&document.getElementById("newPassword").value||"",environment:document.getElementById("environmentSelect")&&document.getElementById("environmentSelect").value||"",ssl_enabled:!!(document.getElementById("sslEnabled")&&document.getElementById("sslEnabled").checked),ssl_cert:document.getElementById("sslCertPath")&&document.getElementById("sslCertPath").value||""};if(!i.host||!i.database||!i.username){R(o,!1,"Please fill in all required fields");return}const l=async()=>{n&&(n.disabled=!0,n.textContent="💾 Updating..."),o&&(o.className="px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm",o.innerHTML="⏳ Updating configuration...",o.classList.remove("hidden"));try{const m=await(await fetch("/api/database_maintenance.php?action=update_config&admin_token=whimsical_admin_2024",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();m.success?(R(o,!0,`
                        <div class="font-medium text-green-800">✅ Configuration Updated!</div>
                        <div class="text-xs text-green-700">Backup created: ${m.backup_created}</div>
                        <div class="text-xs text-yellow-700">⚠️ Please refresh the page to use new settings</div>
                    `),setTimeout(()=>{try{loadCurrentDatabaseConfig()}catch{}},2e3)):R(o,!1,`Update failed: ${m.message}`)}catch(c){R(o,!1,`Network error: ${c.message}`)}finally{n&&(n.disabled=!1,n.textContent="💾 Update Credentials")}};typeof window.showConfirmationModal=="function"?window.showConfirmationModal({title:"Update database credentials?",message:`A backup will be created automatically for ${i.environment} environment(s).`,confirmText:"Yes, Update",cancelText:"Cancel",onConfirm:l}):confirm(`Are you sure you want to update database credentials for ${i.environment} environment(s)? A backup will be created automatically.`)&&await l()}catch(o){console.error("[AdminSettings] updateDatabaseConfig error",o)}}async function cn(e){try{const o=document.getElementById("sslTestResult"),n=e&&e.target?e.target:document.activeElement,i={host:document.getElementById("testHost")&&document.getElementById("testHost").value||document.getElementById("newHost")&&document.getElementById("newHost").value||"",database:document.getElementById("testDatabase")&&document.getElementById("testDatabase").value||document.getElementById("newDatabase")&&document.getElementById("newDatabase").value||"",username:document.getElementById("testUsername")&&document.getElementById("testUsername").value||document.getElementById("newUsername")&&document.getElementById("newUsername").value||"",password:document.getElementById("testPassword")&&document.getElementById("testPassword").value||document.getElementById("newPassword")&&document.getElementById("newPassword").value||"",ssl_enabled:!0,ssl_cert:document.getElementById("sslCertPath")&&document.getElementById("sslCertPath").value||""};if(!i.ssl_cert){R(o,!1,"Please specify SSL certificate path");return}n&&(n.disabled=!0,n.textContent="🔄 Testing SSL..."),o&&(o.className="px-3 py-2 bg-blue-50 border border-blue-200 rounded text-sm",o.innerHTML="⏳ Testing SSL connection...",o.classList.remove("hidden"));try{const c=await(await fetch("/api/database_maintenance.php?action=test_connection&admin_token=whimsical_admin_2024",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();c.success?R(o,!0,`
                    <div class="font-medium text-green-800">🔒 SSL Connection Successful!</div>
                    <div class="text-xs space-y-1 text-green-700">
                        <div>SSL Certificate: Valid</div>
                        <div>Encryption: Active</div>
                        <div>MySQL Version: ${c&&c.info&&c.info.mysql_version?c.info.mysql_version:""}</div>
                    </div>
                `):R(o,!1,`SSL connection failed: ${c.message}`)}catch(l){R(o,!1,`SSL test error: ${l.message}`)}finally{n&&(n.disabled=!1,n.textContent="🔒 Test SSL Connection")}}catch(o){console.error("[AdminSettings] testSSLConnection error",o)}}function S(){try{document.querySelectorAll(".admin-modal-overlay:not(.hidden)").length>0?window.WFModals&&typeof window.WFModals.lockScroll=="function"&&(console.debug("[AdminSettings] updateModalScrollLock -> lockScroll (anyOpen)"),window.WFModals.lockScroll()):window.WFModals&&typeof window.WFModals.unlockScrollIfNoneOpen=="function"&&(console.debug("[AdminSettings] updateModalScrollLock -> unlockScrollIfNoneOpen (none open)"),window.WFModals.unlockScrollIfNoneOpen())}catch{}}function _t(){const e=document.getElementById("templateManagerModal");if(e){e.classList.remove("hidden");try{typeof ye=="function"?ye():typeof window<"u"&&typeof window.loadColorTemplates=="function"&&window.loadColorTemplates()}catch{}try{typeof ge=="function"?ge():typeof window<"u"&&typeof window.loadSizeTemplates=="function"&&window.loadSizeTemplates()}catch{}try{typeof loadCostTemplates=="function"?loadCostTemplates():typeof window<"u"&&typeof window.loadCostTemplates=="function"&&window.loadCostTemplates()}catch{}try{typeof loadSuggestionHistory=="function"?loadSuggestionHistory():typeof window<"u"&&typeof window.loadSuggestionHistory=="function"&&window.loadSuggestionHistory()}catch{}try{typeof loadEmailTemplates=="function"?loadEmailTemplates():typeof window<"u"&&typeof window.loadEmailTemplates=="function"&&window.loadEmailTemplates()}catch{}S()}}function St(){const e=document.getElementById("templateManagerModal");e&&(e.classList.add("hidden"),S())}function xt(e){try{document.querySelectorAll(".css-category-tab").forEach(i=>i.classList.remove("active"));const o=document.querySelector(`[data-tab="${e}"]`);o&&o.classList.add("active"),document.querySelectorAll(".css-category-content").forEach(i=>i.classList.add("hidden"));const n=document.getElementById(`${e}-tab`);n&&n.classList.remove("hidden")}catch{}}try{typeof window<"u"&&(window.openTemplateManagerModal=_t,window.closeTemplateManagerModal=St,window.switchTemplateTab=xt)}catch{}try{typeof window<"u"&&(window.changeTemplateAssignment=function(e){try{At(String(e||""))}catch{}})}catch{}async function ie(e){try{const o=encodeURIComponent(e),i=await(await fetch(`/api/email_templates.php?action=preview&template_id=${o}`)).json();i&&i.success?fn(i.preview):typeof window<"u"&&typeof window.showError=="function"?window.showError("Failed to preview template"+(i&&i.error?`: ${i.error}`:"")):console.error("[AdminSettings] Failed to preview template",i)}catch(o){console.error("[AdminSettings] previewEmailTemplate error",o),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error previewing email template")}}function fn(e){const o=document.getElementById("emailTemplatePreviewModal"),n=document.getElementById("emailPreviewFrame"),i=document.getElementById("previewSubject");if(!(!o||!n||!i)){try{o.classList.add("admin-modal-overlay","fixed","left-0","right-0","bg-black","bg-opacity-50","flex","items-start","justify-center","z-50","admin-modal-offset-under-header"),o.classList.remove("items-center")}catch{}i.textContent=e&&e.subject?e.subject:"";try{const l=e&&e.html_content?e.html_content:"",c=new Blob([l],{type:"text/html"}),m=URL.createObjectURL(c);n.src=m,o.dataset.previewUrl=m}catch(l){console.warn("[AdminSettings] Failed to create preview blob URL",l)}o.classList.remove("hidden");try{S()}catch{}}}function Dt(){const e=document.getElementById("emailTemplatePreviewModal");if(!e)return;const o=document.getElementById("emailPreviewFrame"),n=e.dataset.previewUrl;if(n){try{URL.revokeObjectURL(n)}catch{}delete e.dataset.previewUrl}if(o)try{o.src="about:blank"}catch{}e.classList.add("hidden");try{S()}catch{}}try{typeof window<"u"&&(window.previewEmailTemplate=ie,window.showEmailTemplatePreviewModal=fn,window.closeEmailTemplatePreviewModal=Dt)}catch{}document.addEventListener("click",function(e){const o=e.target;if(!o||!o.closest)return;const n=document.querySelector(".settings-page");if(!(n&&!n.contains(o))&&!o.closest(".admin-nav-tab")){if(o.closest('[data-action="close-email-preview-modal"]')){e.preventDefault(),Dt();return}if(o.closest('[data-action="close-admin-modal"], .admin-modal-close')){e.preventDefault();const i=o.closest(".admin-modal-overlay");if(i){i.classList.add("hidden");try{i._disposePositioner&&i._disposePositioner()}catch{}try{S()}catch{}}return}if(o.classList&&o.classList.contains("admin-modal-overlay")){o.classList.add("hidden");try{o._disposePositioner&&o._disposePositioner()}catch{}try{S()}catch{}return}}});function Et(e){let o=document.getElementById("testEmailSendModal");o||(o=document.createElement("div"),o.id="testEmailSendModal",o.className="admin-modal-overlay fixed left-0 right-0 bg-black bg-opacity-50 flex items-start justify-center z-50 hidden",o.innerHTML=`
          <div class="admin-modal bg-white rounded-lg w-full max-w-lg shadow-xl" role="dialog" aria-modal="true" aria-labelledby="testEmailTitle">
            <div class="flex items-center justify-between p-4 border-b">
              <h3 id="testEmailTitle" class="text-lg font-semibold text-gray-800">Send Test Email</h3>
              <button type="button" class="admin-modal-close text-gray-700 hover:text-gray-900" data-action="close-admin-modal" aria-label="Close">&times;</button>
            </div>
            <div class="p-4 space-y-3">
              <p class="text-sm text-gray-700">Enter an email address to send a test of this template.</p>
              <input id="testEmailInput" type="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" placeholder="name@example.com" aria-describedby="testEmailError" aria-invalid="false" />
              <p id="testEmailError" class="form-error hidden"></p>
            </div>
            <div class="flex items-center justify-end gap-2 p-4 border-t bg-gray-50">
              <button type="button" class="px-3 py-2 text-gray-700 hover:text-gray-900" data-action="close-test-email-modal">Cancel</button>
              <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" data-action="confirm-send-test-email">Send Test</button>
            </div>
          </div>`,document.body.appendChild(o)),o.dataset.templateId=String(e||"");try{lastFocusedBeforeTestModal=document.activeElement}catch{}o.classList.remove("hidden");try{S()}catch{}setOverlayPosition(o),o._disposePositioner?.(),o._disposePositioner=attachOverlayAutoPosition(o);const n=o.querySelector("#testEmailInput");if(n)try{n.focus()}catch{}}function fe(){const e=document.getElementById("testEmailSendModal");if(e){e.classList.add("hidden");try{S()}catch{}try{e._disposePositioner&&e._disposePositioner()}catch{}try{lastFocusedBeforeTestModal&&lastFocusedBeforeTestModal.focus&&lastFocusedBeforeTestModal.focus()}catch{}}}async function Ro(e){const o=String(e||"").trim();if(!o){console.warn("[AdminSettings] sendTestEmailTemplate: missing template id; falling back to default template");const n="order_confirmation";if(typeof window<"u"&&typeof window.showTestEmailModal=="function")return Et(n);typeof window<"u"&&typeof window.showError=="function"&&window.showError("Missing template id");return}Et(o)}async function Lt(){try{const e=document.getElementById("testEmailSendModal");if(!e)return;let o=String(e.dataset.templateId||"").trim();const n=e.querySelector("#testEmailInput"),i=String(n&&n.value||"").trim();o||(o="order_confirmation");const l=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,c=e.querySelector("#testEmailError");if(l.test(i))c&&(c.textContent="",c.classList.add("hidden")),n&&n.setAttribute("aria-invalid","false");else{if(c&&(c.textContent="Please enter a valid email address.",c.classList.remove("hidden")),n){n.setAttribute("aria-invalid","true");try{n.focus()}catch{}}typeof window<"u"&&typeof window.showError=="function"&&window.showError("Please enter a valid email address.");return}const m=e.querySelector('[data-action="confirm-send-test-email"]'),h=m?m.textContent:"";m&&(m.disabled=!0,m.setAttribute("aria-busy","true"),m.textContent="Sending..."),n&&(n.disabled=!0);const v=await(await fetch("/api/email_templates.php?action=send_test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:o,test_email:i})})).json();if(v&&v.success)typeof window<"u"&&window.wfNotifications&&typeof window.wfNotifications.show=="function"?window.wfNotifications.show(v.message||"Test email sent successfully.","success",{title:"Test Email"}):typeof window<"u"&&typeof window.showSuccess=="function"?window.showSuccess(v.message||"Test email sent successfully."):alert(v.message||"Test email sent successfully."),fe();else{const g=v&&(v.error||v.message)?v.error||v.message:"Failed to send test email.";typeof window<"u"&&window.wfNotifications&&typeof window.wfNotifications.show=="function"?window.wfNotifications.show(g,"error",{title:"Test Email"}):typeof window<"u"&&typeof window.showError=="function"?window.showError(g):alert(g)}m&&(m.disabled=!1,m.removeAttribute("aria-busy"),m.textContent=h),n&&(n.disabled=!1)}catch(e){console.error("[AdminSettings] confirmSendTestEmail error",e),typeof window<"u"&&window.wfNotifications&&typeof window.wfNotifications.show=="function"?window.wfNotifications.show("Error sending test email","error",{title:"Test Email"}):typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error sending test email")}finally{const e=document.getElementById("testEmailSendModal");if(e){const o=e.querySelector('[data-action="confirm-send-test-email"]'),n=e.querySelector("#testEmailInput");o&&(o.disabled=!1,o.removeAttribute("aria-busy")),n&&(n.disabled=!1)}}}try{typeof window<"u"&&(window.sendTestEmailTemplate=Ro,window.sendTestEmail=function(e){return Ro(e)},window.showTestEmailModal=Et,window.closeTestEmailModal=fe,window.confirmSendTestEmail=Lt)}catch{}document.addEventListener("click",function(e){const o=e.target;if(!o||!o.closest)return;const n=document.querySelector(".settings-page");if(n&&!n.contains(o)||o.closest(".admin-nav-tab"))return;if(o.closest('.admin-modal-close,[data-action="close-admin-modal"]')){e.preventDefault();const h=o.closest(".admin-modal-overlay");if(h){h.classList.add("hidden");try{S()}catch{}}return}if(o.closest('[data-action="close-test-email-modal"]')){e.preventDefault(),fe();return}if(o.closest('[data-action="confirm-send-test-email"]')){e.preventDefault(),Lt();return}const m=document.getElementById("testEmailSendModal");if(m&&o===m){e.preventDefault(),fe();return}});function un(){let e=document.getElementById("emailTemplateEditModal");return e||(e=document.createElement("div"),e.id="emailTemplateEditModal",e.className="admin-modal-overlay fixed left-0 right-0 bg-black bg-opacity-50 flex items-start justify-center z-50 hidden",e.innerHTML=`
        <div class="admin-modal bg-white rounded-lg w-full max-w-3xl max-h-[90vh] flex flex-col shadow-xl" role="dialog" aria-modal="true" aria-labelledby="emailTemplateEditTitle">
          <div class="flex items-center justify-between p-4 border-b">
            <h3 id="emailTemplateEditTitle" class="text-lg font-semibold text-gray-800">Edit Email Template</h3>
            <button type="button" class="admin-modal-close admin-modal-close--tight text-gray-700 hover:text-gray-900" data-action="close-admin-modal" aria-label="Close">&times;</button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Template Name</label>
                <input id="et_name" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" aria-required="true" aria-describedby="et_name_error" aria-invalid="false" />
                <p id="et_name_error" class="form-error hidden"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Type</label>
                <select id="et_type" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" aria-required="true" aria-describedby="et_type_error" aria-invalid="false">
                  <option value="order_confirmation">Order Confirmation</option>
                  <option value="admin_notification">Admin Notification</option>
                  <option value="welcome">Welcome</option>
                  <option value="password_reset">Password Reset</option>
                  <option value="custom">Custom</option>
                </select>
                <p id="et_type_error" class="form-error hidden"></p>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Subject</label>
              <input id="et_subject" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" aria-required="true" aria-describedby="et_subject_error" aria-invalid="false" />
              <p id="et_subject_error" class="form-error hidden"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">HTML Content</label>
              <textarea id="et_html" class="w-full h-56 border border-gray-300 rounded px-3 py-2 font-mono text-sm focus:outline-none focus:ring focus:border-blue-300" aria-required="true" aria-describedby="et_html_error" aria-invalid="false"></textarea>
              <p id="et_html_error" class="form-error hidden"></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Text Content (optional)</label>
              <textarea id="et_text" class="w-full h-32 border border-gray-300 rounded px-3 py-2 font-mono text-sm focus:outline-none focus:ring focus:border-blue-300"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Description (optional)</label>
              <input id="et_desc" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" />
            </div>
            <div class="flex items-center gap-2">
              <input id="et_active" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded" />
              <label for="et_active" class="text-sm text-gray-700">Active</label>
            </div>
          </div>
          <div class="flex items-center justify-end gap-2 p-4 border-t bg-gray-50">
            <button type="button" class="px-3 py-2 text-gray-700 hover:text-gray-900" data-action="close-email-template-modal">Cancel</button>
            <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" data-action="save-email-template">Save</button>
          </div>
        </div>`,document.body.appendChild(e),e)}function kt(e=null){const o=un();o.dataset.templateId=e&&e.id?String(e.id):"";const n=!!(e&&e.id),i=o.querySelector("#emailTemplateEditTitle");i&&(i.textContent=n?"Edit Email Template":"Create Email Template");const l=o.querySelector("#et_name"),c=o.querySelector("#et_type"),m=o.querySelector("#et_subject"),h=o.querySelector("#et_html"),f=o.querySelector("#et_text"),v=o.querySelector("#et_desc"),g=o.querySelector("#et_active");["et_name","et_type","et_subject","et_html"].forEach(x=>{const C=o.querySelector("#"+x),_=o.querySelector("#"+x+"_error");C&&C.setAttribute("aria-invalid","false"),_&&(_.textContent="",_.classList.add("hidden"))}),l&&(l.value=e&&e.template_name||""),c&&(c.value=e&&e.template_type||"custom"),m&&(m.value=e&&e.subject||""),h&&(h.value=e&&e.html_content||""),f&&(f.value=e&&e.text_content||""),v&&(v.value=e&&e.description||""),g&&(g.checked=e&&String(e.is_active)!=="0");try{lastFocusedBeforeEditModal=document.activeElement}catch{}o.classList.remove("hidden");try{S()}catch{}if(l)try{l.focus()}catch{}}function ue(){const e=document.getElementById("emailTemplateEditModal");if(e){e.classList.add("hidden");try{S()}catch{}try{lastFocusedBeforeEditModal&&lastFocusedBeforeEditModal.focus&&lastFocusedBeforeEditModal.focus()}catch{}}}async function Tt(e){try{const o=String(e||"").trim();if(!o){typeof window<"u"&&typeof window.showError=="function"&&window.showError("Missing template id");return}const i=await(await fetch(`/api/email_templates.php?action=get_template&template_id=${encodeURIComponent(o)}`)).json();i&&i.success&&i.template?kt(i.template):typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to load template")}catch(o){console.error("[AdminSettings] editEmailTemplate error",o),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error loading template")}}function Ct(){kt(null)}function zn(e){const o=[{id:"et_name",label:"Template Name"},{id:"et_type",label:"Type"},{id:"et_subject",label:"Subject"},{id:"et_html",label:"HTML Content"}];let n=null;for(const i of o){const l=e.querySelector("#"+i.id),c=e.querySelector("#"+i.id+"_error"),h=!(l&&(l.value||"").trim()||"");l&&l.setAttribute("aria-invalid",h?"true":"false"),c&&(h?(c.textContent=`${i.label} is required.`,c.classList.remove("hidden")):(c.textContent="",c.classList.add("hidden"))),h&&!n&&(n=l)}if(n)try{n.focus()}catch{}return!n}async function pe(){try{const e=un(),o=String(e&&e.dataset&&e.dataset.templateId?e.dataset.templateId:"").trim(),n=e?e.querySelector("#et_name"):null,i=e?e.querySelector("#et_type"):null,l=e?e.querySelector("#et_subject"):null,c=e?e.querySelector("#et_html"):null,m=e?e.querySelector("#et_text"):null,h=e?e.querySelector("#et_desc"):null,f=e?e.querySelector("#et_active"):null,v=n&&n.value?n.value.trim():"",g=i&&i.value?i.value:"",x=l&&l.value?l.value.trim():"",C=c&&c.value?c.value:"",_=m&&m.value?m.value:"",D=h&&h.value?h.value:"",M=!!(f&&f.checked);if(!zn(e)){typeof window<"u"&&typeof window.showError=="function"&&window.showError("Please fix the highlighted errors.");return}const B=e.querySelector('[data-action="save-email-template"]'),a=B?B.textContent:"";B&&(B.disabled=!0,B.setAttribute("aria-busy","true"),B.textContent="Saving...");const d={template_id:o||void 0,template_name:v,template_type:g,subject:x,html_content:C,text_content:_,description:D,variables:[],is_active:M?1:0},s=await(await fetch(`/api/email_templates.php?action=${encodeURIComponent(o?"update":"create")}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();if(s&&s.success){typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess(o?"Template updated":"Template created"),ue();try{typeof loadEmailTemplates=="function"?loadEmailTemplates():typeof window<"u"&&typeof window.loadEmailTemplates=="function"&&window.loadEmailTemplates()}catch{}}else{const b=s&&(s.error||s.message)?s.error||s.message:"Failed to save template";typeof window<"u"&&typeof window.showError=="function"&&window.showError(b)}B&&(B.disabled=!1,B.removeAttribute("aria-busy"),B.textContent=a)}catch(e){console.error("[AdminSettings] saveEmailTemplate error",e),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error saving template")}finally{const e=document.getElementById("emailTemplateEditModal");if(e){const o=e.querySelector('[data-action="save-email-template"]');o&&(o.disabled=!1,o.removeAttribute("aria-busy"))}}}async function se(e){if(confirm("Are you sure you want to delete this email template? This action cannot be undone."))try{const o=String(e||"").trim();if(!o)return;const i=await(await fetch("/api/email_templates.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`action=delete&template_id=${encodeURIComponent(o)}`})).json();if(i&&i.success){typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess("Template deleted");try{typeof loadEmailTemplates=="function"?loadEmailTemplates():typeof window<"u"&&typeof window.loadEmailTemplates=="function"&&window.loadEmailTemplates()}catch{}}else{const l=i&&(i.error||i.message)?i.error||i.message:"Failed to delete template";typeof window<"u"&&typeof window.showError=="function"&&window.showError(l)}}catch(o){console.error("[AdminSettings] deleteEmailTemplate error",o),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error deleting template")}}try{typeof window<"u"&&(window.showEmailTemplateEditModal=kt,window.closeEmailTemplateEditModal=ue,window.saveEmailTemplate=pe,window.editEmailTemplate=Tt,window.createNewEmailTemplate=Ct,window.deleteEmailTemplate=se)}catch{}document.addEventListener("click",function(e){const o=e.target;if(!o||!o.closest)return;const n=document.querySelector(".settings-page");if(n&&!n.contains(o)||o.closest(".admin-nav-tab"))return;if(o.closest('[data-action="close-email-template-modal"]')){e.preventDefault(),ue();return}if(o.closest('[data-action="save-email-template"]')){e.preventDefault(),pe();return}const i=document.getElementById("emailTemplateEditModal");if(i&&o===i){e.preventDefault(),ue();return}});function pn(){let e=document.getElementById("templateAssignmentModal");return e||(e=document.createElement("div"),e.id="templateAssignmentModal",e.className="admin-modal-overlay fixed left-0 right-0 bg-black bg-opacity-50 flex items-start justify-center z-50 hidden admin-modal-offset-under-header",e.innerHTML=`
        <div class="admin-modal bg-white rounded-lg w-full max-w-md shadow-xl" role="dialog" aria-modal="true" aria-labelledby="templateAssignmentTitle">
          <div class="flex items-center justify-between p-4 border-b">
            <h3 id="templateAssignmentTitle" class="text-lg font-semibold text-gray-800">Assign Email Template</h3>
            <button type="button" class="admin-modal-close text-gray-600 hover:text-gray-900 text-28 leading-1 p-6px" data-action="close-admin-modal" aria-label="Close">&times;</button>
          </div>
          <div class="p-4 space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Email Type</label>
              <input id="assignmentEmailType" type="text" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100 text-gray-700" readonly />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Template</label>
              <select id="assignmentTemplateSelect" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-blue-300" aria-required="true" aria-describedby="assignmentTemplateError" aria-invalid="false"></select>
              <p id="assignmentTemplateError" class="form-error hidden"></p>
            </div>
          </div>
          <div class="flex items-center justify-end gap-2 p-4 border-t bg-gray-50">
            <button type="button" class="px-3 py-2 text-gray-700 hover:text-gray-900" data-action="close-template-assignment">Cancel</button>
            <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" data-action="save-template-assignment">Save</button>
          </div>
        </div>`,document.body.appendChild(e),e)}async function On(e){const o=pn(),n=o.querySelector("#assignmentTemplateSelect"),i=o.querySelector("#assignmentEmailType");if(i&&(i.value=e||""),!!n){n.innerHTML='<option value="">Loading...</option>';try{const[l,c]=await Promise.all([fetch("/api/email_templates.php?action=get_all"),fetch("/api/email_templates.php?action=get_assignments")]),m=await l.json(),h=await c.json(),f=m&&m.templates||[],g=(h&&(h.assignments||h.data||{})||{})[e]||"",x=f.filter(_=>String(_.template_type)===String(e)),C=(x.length?x:f).map(_=>({id:_.id,name:`${_.template_name} (${_.template_type})`}));n.innerHTML=C.length?C.map(_=>`<option value="${_.id}">${_.name}</option>`).join(""):'<option value="">No templates available</option>',g&&(n.value=String(g));try{n.focus()}catch{}}catch(l){console.error("[AdminSettings] populateTemplateAssignment error",l),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error loading templates")}}}function At(e){const o=pn();o.dataset.emailType=String(e||"");try{lastFocusedBeforeAssignModal=document.activeElement}catch{}o.classList.remove("hidden");try{S()}catch{}On(String(e||""))}function me(){const e=document.getElementById("templateAssignmentModal");if(e){e.classList.add("hidden");try{S()}catch{}try{lastFocusedBeforeAssignModal&&lastFocusedBeforeAssignModal.focus&&lastFocusedBeforeAssignModal.focus()}catch{}}}async function we(){const e=document.getElementById("templateAssignmentModal"),o=document.getElementById("assignmentTemplateSelect");if(!e||!o)return;const n=e.dataset.emailType,i=o.value,l=e.querySelector("#assignmentTemplateError");if(!n){typeof window<"u"&&typeof window.showError=="function"&&window.showError("Email type not specified");return}if(i)l&&(l.textContent="",l.classList.add("hidden")),o.setAttribute("aria-invalid","false");else{l&&(l.textContent="Please select a template.",l.classList.remove("hidden")),o.setAttribute("aria-invalid","true");try{o.focus()}catch{}typeof window<"u"&&typeof window.showError=="function"&&window.showError("Please select a template");return}try{const c=e.querySelector('[data-action="save-template-assignment"]'),m=c?c.textContent:"";c&&(c.disabled=!0,c.setAttribute("aria-busy","true"),c.textContent="Saving...");const f=await(await fetch("/api/email_templates.php?action=set_assignment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email_type:n,template_id:i})})).json();if(f&&f.success){typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess("Template assignment updated successfully!"),me();try{typeof loadEmailTemplates=="function"?loadEmailTemplates():typeof window<"u"&&typeof window.loadEmailTemplates=="function"&&window.loadEmailTemplates()}catch{}}else typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to update assignment"+(f&&f.error?": "+f.error:""));c&&(c.disabled=!1,c.removeAttribute("aria-busy"),c.textContent=m)}catch(c){console.error("[AdminSettings] saveTemplateAssignment error",c),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error updating template assignment")}finally{const c=document.getElementById("templateAssignmentModal");if(c){const m=c.querySelector('[data-action="save-template-assignment"]');m&&(m.disabled=!1,m.removeAttribute("aria-busy"))}}}try{typeof window<"u"&&(window.openTemplateAssignmentModal=At,window.closeTemplateAssignmentModal=me,window.saveTemplateAssignment=we)}catch{}document.addEventListener("click",function(e){const o=e.target;if(!o||!o.closest)return;const n=document.querySelector(".settings-page");if(n&&!n.contains(o)||o.closest(".admin-nav-tab"))return;const i=o.closest('[data-action="open-template-assignment"]');if(i){e.preventDefault();const h=i.dataset.emailType||i.dataset.type||"";At(h);return}if(o.closest('[data-action="close-template-assignment"]')){e.preventDefault(),me();return}if(o.closest('[data-action="save-template-assignment"]')){e.preventDefault(),we();return}const m=document.getElementById("templateAssignmentModal");if(m&&o===m){e.preventDefault(),me();return}});function Ae(){try{document.body&&document.body.classList&&(document.body.classList.remove("wf-no-scroll"),document.body.classList.remove("modal-open","room-modal-open")),document.documentElement&&document.documentElement.classList&&document.documentElement.classList.remove("modal-open"),document.querySelectorAll(".admin-modal-overlay").forEach(o=>{o.classList.add("hidden"),o.classList.remove("show")});const e=document.getElementById("roomModalOverlay");e&&(e.classList.add("hidden"),e.classList.remove("show")),document.querySelectorAll(".modal-overlay").forEach(o=>{o.classList.add("hidden"),o.classList.remove("show")}),document.querySelectorAll(".confirmation-modal-overlay").forEach(o=>{o.classList.remove("show"),o.classList.add("hidden")}),["checkoutModalOverlay","cartModalOverlay","paymentModalOverlay","receiptModalOverlay"].forEach(o=>{const n=document.getElementById(o);if(n){try{n.classList.remove("show")}catch{}try{n.classList.add("hidden")}catch{}}});try{window.WFModals&&typeof WFModals.unlockScrollIfNoneOpen=="function"&&WFModals.unlockScrollIfNoneOpen()}catch{}}catch(e){console.warn("[AdminSettings] cleanupSettingsEnvironment failed",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ae,{once:!0}):Ae();window.addEventListener("pageshow",()=>{try{Ae()}catch{}});document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible")try{Ae()}catch{}});(function(){try{const o=document&&document.body&&document.body.dataset;if(!!!(o&&(o.isAdmin==="true"||o.page&&String(o.page).startsWith("admin"))))return;const i=()=>{try{if(!window.WFModals)return;if(!window.WFModals.__adminPatched){const m=window.WFModals.lockScroll;window.WFModals.lockScroll=function(){try{console.debug("[AdminSettings] Suppressed WFModals.lockScroll on admin page")}catch{}},window.WFModals.__adminPatched=!0,window.WFModals.__origLockScroll=m}}catch{}if(ENABLE_OVERLAY_GUARDS)try{window.addEventListener("load",()=>{try{document.querySelectorAll('.admin-modal-overlay, .modal-overlay, .room-modal-overlay, [id$="Modal"]').forEach(ensureOverlayHidden)}catch{}},{once:!0})}catch{}};i(),setTimeout(i,0),setTimeout(i,50),(()=>{try{document.body&&document.body.classList.remove("modal-open")}catch{}try{document.documentElement&&document.documentElement.classList.remove("modal-open")}catch{}})();const c=!1}catch{}})();document.addEventListener("keydown",function(e){const o=e.key;if(!o)return;const n=h=>h&&!h.classList.contains("hidden");document.activeElement&&document.activeElement.tagName;const i=document.getElementById("testEmailSendModal"),l=document.getElementById("emailTemplateEditModal"),c=document.getElementById("templateAssignmentModal"),m=document.getElementById("emailTemplatePreviewModal");if(o==="Escape"){if(n(i)){e.preventDefault(),fe();return}if(n(l)){e.preventDefault(),ue();return}if(n(c)){e.preventDefault(),me();return}if(n(m)){e.preventDefault(),Dt();return}}if(o==="Enter"&&!e.shiftKey){if(n(i)){e.preventDefault(),Lt();return}if(n(c)){e.preventDefault(),we();return}if(n(l)&&(e.ctrlKey||e.metaKey)){e.preventDefault(),pe();return}}});document.addEventListener("keydown",function(e){if(e.key!=="Tab")return;const o=f=>f&&!f.classList.contains("hidden"),i=[document.getElementById("testEmailSendModal"),document.getElementById("emailTemplateEditModal"),document.getElementById("templateAssignmentModal")].find(o);if(!i)return;const l=i.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'),c=Array.prototype.slice.call(l);if(!c.length)return;const m=c[0],h=c[c.length-1];e.shiftKey?(document.activeElement===m||!i.contains(document.activeElement))&&(h.focus(),e.preventDefault()):(document.activeElement===h||!i.contains(document.activeElement))&&(m.focus(),e.preventDefault())});let Ho=[],mn=0;async function ye(){const e=document.getElementById("colorTemplatesLoading"),o=document.getElementById("colorTemplatesList");if(!(!e||!o)){e.classList&&e.classList.remove("hidden"),o.classList&&o.classList.add("hidden");try{const i=await(await fetch("/api/color_templates.php?action=get_all")).json();if(i.success)zt(i.templates),Fn(i.templates);else throw new Error(i.message||"Failed to load color templates")}catch(n){console.error("Error loading color templates:",n),o&&(o.innerHTML='<div class="text-red-600 text-center">Failed to load color templates</div>')}finally{e&&e.classList&&e.classList.add("hidden"),o&&o.classList&&o.classList.remove("hidden")}}}function Fn(e){const o=document.getElementById("colorTemplateCategoryFilter");if(!o)return;const n=[...new Set((e||[]).map(i=>i.category))].sort();o.innerHTML='<option value="">All Categories</option>',n.forEach(i=>{const l=document.createElement("option");l.value=i,l.textContent=i,o.appendChild(l)})}function G(){zt()}function zt(e=null){const o=document.getElementById("colorTemplatesList");if(!o)return;e?(Ho=e,typeof window<"u"&&(window.colorTemplatesCache=e)):e=Ho||[];const n=document.getElementById("colorTemplateCategoryFilter"),i=n&&n.value||"",l=i?e.filter(c=>c.category===i):e;if(l.length===0){o.innerHTML='<div class="text-gray-500 text-center">No color templates found. Create your first template!</div>';return}o.innerHTML=l.map(c=>`
         <div class="bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
             <div class="flex items-start justify-between">
                 <div>
                     <h5 class="font-semibold text-gray-800">${c.template_name}</h5>
                     <p class="text-sm text-gray-600">${c.description||"No description"}</p>
                     <div class="flex items-center space-x-4 text-xs text-gray-500">
                         <span class="bg-purple-100 text-purple-800 rounded">${c.category}</span>
                         <span>${c.color_count} colors</span>
                         <span>Created: ${new Date(c.created_at).toLocaleDateString()}</span>
                     </div>
                 </div>
                 <div class="flex space-x-2">
                     <button data-action="tm-edit-color-template" data-id="${c.id}" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                     <button data-action="tm-delete-color-template" data-id="${c.id}" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                 </div>
             </div>
             <div class="template-preview" id="colorPreview${c.id}">
                 <div class="text-xs text-gray-500">Loading colors...</div>
             </div>
         </div>
     `).join(""),l.forEach(c=>$n(c.id))}async function $n(e){try{const n=await(await fetch(`/api/color_templates.php?action=get_template&template_id=${e}`)).json();if(n.success&&n.template.colors){const i=document.getElementById(`colorPreview${e}`);i&&(i.innerHTML=`
                     <div class="flex flex-wrap gap-2">
                         ${n.template.colors.map(l=>`
                             <div class="flex items-center space-x-2 bg-gray-50 rounded">
                                 <div class="w-4 h-4 rounded border border-gray-300"></div>
                                 <span class="text-xs text-gray-700">${l.color_name}</span>
                             </div>
                         `).join("")}
                     </div>
                 `)}}catch(o){console.error("Error loading color template preview:",o)}}function Mt(){Ot()}async function wn(e){try{const n=await(await fetch(`/api/color_templates.php?action=get_template&template_id=${e}`)).json();n.success?Ot(n.template):typeof window<"u"&&typeof window.showError=="function"?window.showError("Failed to load template: "+n.message):console.error("Failed to load template:",n.message)}catch(o){console.error("Error loading color template:",o);try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error loading color template")}catch{}}}async function yn(e){if(confirm("Are you sure you want to delete this color template? This action cannot be undone."))try{const n=await(await fetch("/api/color_templates.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`action=delete_template&template_id=${e}`})).json();if(n.success){try{typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess("Color template deleted successfully!")}catch{}ye()}else try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to delete template: "+n.message)}catch{}}catch(o){console.error("Error deleting color template:",o);try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error deleting color template")}catch{}}}function gn(){document.body.insertAdjacentHTML("beforeend",`
         <div id="colorTemplateEditModal" class="admin-modal-overlay hidden" data-action="close-color-template-modal">
             <div class="admin-modal-content content-section">
                 <div class="admin-modal-header section-header">
                     <h2 id="colorTemplateEditTitle" class="modal-title">Edit Color Template</h2>
                     <button data-action="close-color-template-modal" class="modal-close">&times;</button>
                 </div>
                 <div class="modal-body">
                     <form id="colorTemplateEditForm" data-action="save-color-template">
                         <input type="hidden" id="colorTemplateId" name="template_id">
                         <div>
                             <h4 class="text-lg font-semibold text-gray-800">Template Details</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">Template Name *</label>
                                     <input type="text" id="colorTemplateName" name="template_name" required class="modal-input" placeholder="e.g., T-Shirt Colors">
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">Category</label>
                                     <select id="colorTemplateCategory" name="category" class="modal-select">
                                         <option value="General">General</option>
                                         <option value="T-Shirts">T-Shirts</option>
                                         <option value="Tumblers">Tumblers</option>
                                         <option value="Artwork">Artwork</option>
                                         <option value="Sublimation">Sublimation</option>
                                         <option value="Window Wraps">Window Wraps</option>
                                     </select>
                                 </div>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-700">Description</label>
                                 <textarea id="colorTemplateDescription" name="description" rows="2" class="modal-input" placeholder="Optional description of this color template"></textarea>
                             </div>
                         </div>
                         <div>
                             <div class="flex items-center justify-between">
                                 <h4 class="text-lg font-semibold text-gray-800">Colors</h4>
                                 <button type="button" data-action="color-template-add-color" class="btn btn-primary">
                                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                     </svg>
                                     Add Color
                                 </button>
                             </div>
                             <div id="colorTemplateColors" class="space-y-3"></div>
                         </div>
                     </form>
                 </div>
                 <div class="modal-footer">
                     <button type="button" data-action="close-color-template-modal" class="btn btn-secondary">Cancel</button>
                     <button type="submit" form="colorTemplateEditForm" class="btn btn-primary">Save Template</button>
                 </div>
             </div>
         </div>`)}function Ot(e=null){document.getElementById("colorTemplateEditModal")||gn();const o=document.getElementById("colorTemplateEditModal"),n=document.getElementById("colorTemplateEditForm"),i=document.getElementById("colorTemplateEditTitle"),l=document.getElementById("colorTemplateColors");!o||!n||!i||!l||(n.reset(),l.innerHTML="",mn=0,e?(i.textContent="Edit Color Template",document.getElementById("colorTemplateId").value=e.id,document.getElementById("colorTemplateName").value=e.template_name,document.getElementById("colorTemplateDescription").value=e.description||"",document.getElementById("colorTemplateCategory").value=e.category||"General",e.colors&&e.colors.length>0&&e.colors.forEach(c=>ze(c))):(i.textContent="Create New Color Template",document.getElementById("colorTemplateId").value="",ze()),o.classList.remove("hidden"),S())}function P(){const e=document.getElementById("colorTemplateEditModal");e&&(e.classList.add("hidden"),S())}function ze(e=null){const o=document.getElementById("colorTemplateColors");if(!o)return;const n=mn++,i=`
         <div class="color-template-item border border-gray-200 rounded-lg bg-gray-50" data-index="${n}">
             <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Color Name *</label>
                     <input type="text" name="colors[${n}][color_name]" required class="w-full border border-gray-300 rounded text-sm" placeholder="e.g., Red" value="${e?.color_name||""}">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Color Code</label>
                     <div class="flex items-center space-x-2">
                         <input type="color" name="colors[${n}][color_code]" class="w-12 h-8 border border-gray-300 rounded cursor-pointer" value="${e?.color_code||"#ff0000"}" data-action="color-picker-change" data-index="${n}">
                         <input type="text" name="colors[${n}][color_code_text]" class="flex-1 border border-gray-300 rounded text-sm font-mono" placeholder="#ff0000" value="${e?.color_code||"#ff0000"}" data-action="color-text-change" data-index="${n}">
                     </div>
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Display Order</label>
                     <input type="number" name="colors[${n}][display_order]" min="0" class="w-full border border-gray-300 rounded text-sm" value="${e?.display_order||n}">
                 </div>
                 <div class="flex items-end">
                     <button type="button" data-action="color-template-remove-color" data-index="${n}" class="bg-red-500 text-white rounded text-sm hover:bg-red-600">Remove</button>
                 </div>
             </div>
         </div>`;o.insertAdjacentHTML("beforeend",i),e?.color_code&&Oe(n,e.color_code)}function vn(e){const o=document.querySelector(`[data-index="${e}"]`);o&&o.remove()}function Oe(e,o){const n=document.querySelector(`input[name="colors[${e}][color_code_text]"]`);n&&(n.value=o)}function It(e,o){const n=document.querySelector(`input[name="colors[${e}][color_code]"]`);n&&/^#[0-9A-F]{6}$/i.test(o)&&(n.value=o)}async function hn(e){e.preventDefault();const o=e.target,n=new FormData(o),i=n.get("template_id"),l=i&&i!=="",c=[];if(document.querySelectorAll(".color-template-item").forEach((f,v)=>{const g=f.querySelector('input[name*="[color_name]"]')?.value,x=f.querySelector('input[name*="[color_code]"]')?.value,C=f.querySelector('input[name*="[display_order]"]')?.value;g&&c.push({color_name:g,color_code:x||"#000000",display_order:parseInt(C)||v})}),c.length===0){try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Please add at least one color to the template")}catch{}return}const h={template_name:n.get("template_name"),description:n.get("description"),category:n.get("category"),colors:c};l&&(h.template_id=parseInt(i));try{const g=await(await fetch(`/api/color_templates.php?action=${l?"update_template":"create_template"}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)})).json();if(g.success){try{typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess(l?"Color template updated successfully!":"Color template created successfully!")}catch{}P(),ye()}else try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to save template: "+g.message)}catch{}}catch(f){console.error("Error saving color template:",f);try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error saving color template")}catch{}}}let qo=[],bn=0;async function ge(){const e=document.getElementById("sizeTemplatesLoading"),o=document.getElementById("sizeTemplatesList");if(!(!e||!o)){e.classList&&e.classList.remove("hidden"),o.classList&&o.classList.add("hidden");try{const i=await(await fetch("/api/size_templates.php?action=get_all")).json();if(i.success)Ft(i.templates),Pn(i.templates);else throw new Error(i.message||"Failed to load size templates")}catch(n){console.error("Error loading size templates:",n),o&&(o.innerHTML='<div class="text-red-600 text-center">Failed to load size templates</div>')}finally{e&&e.classList&&e.classList.add("hidden"),o&&o.classList&&o.classList.remove("hidden")}}}function Pn(e){const o=document.getElementById("sizeTemplateCategoryFilter");if(!o)return;const n=[...new Set((e||[]).map(i=>i.category))].sort();o.innerHTML='<option value="">All Categories</option>',n.forEach(i=>{const l=document.createElement("option");l.value=i,l.textContent=i,o.appendChild(l)})}function W(){Ft()}function Ft(e=null){const o=document.getElementById("sizeTemplatesList");if(!o)return;e?(qo=e,typeof window<"u"&&(window.sizeTemplatesCache=e)):e=qo||[];const n=document.getElementById("sizeTemplateCategoryFilter")?.value||"",i=n?e.filter(l=>l.category===n):e;if(i.length===0){o.innerHTML='<div class="text-gray-500 text-center">No size templates found. Create your first template!</div>';return}o.innerHTML=i.map(l=>`
         <div class="bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
             <div class="flex items-start justify-between">
                 <div>
                     <h5 class="font-semibold text-gray-800">${l.template_name}</h5>
                     <p class="text-sm text-gray-600">${l.description||"No description"}</p>
                     <div class="flex items-center space-x-4 text-xs text-gray-500">
                         <span class="bg-blue-100 text-blue-800 rounded">${l.category}</span>
                         <span>${l.size_count} sizes</span>
                         <span>Created: ${new Date(l.created_at).toLocaleDateString()}</span>
                     </div>
                 </div>
                 <div class="flex space-x-2">
                     <button data-action="tm-edit-size-template" data-id="${l.id}" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                     <button data-action="tm-delete-size-template" data-id="${l.id}" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                 </div>
             </div>
             <div class="template-preview" id="sizePreview${l.id}">
                 <div class="text-xs text-gray-500">Loading sizes...</div>
             </div>
         </div>
     `).join(""),i.forEach(l=>Nn(l.id))}async function Nn(e){try{const n=await(await fetch(`/api/size_templates.php?action=get_template&template_id=${e}`)).json();if(n.success&&n.template.sizes){const i=document.getElementById(`sizePreview${e}`);i&&(i.innerHTML=`
                     <div class="flex flex-wrap gap-2">
                         ${n.template.sizes.map(l=>`
                             <span class="inline-block bg-gray-100 text-gray-700 text-xs rounded">
                                 ${l.size_name} (${l.size_code})${l.price_adjustment>0?" +$"+l.price_adjustment:l.price_adjustment<0?" $"+l.price_adjustment:""}
                             </span>
                         `).join("")}
                     </div>
                 `)}}catch(o){console.error("Error loading size template preview:",o)}}function Bt(){$t()}async function _n(e){try{const n=await(await fetch(`/api/size_templates.php?action=get_template&template_id=${e}`)).json();if(n.success)$t(n.template);else try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to load template: "+n.message)}catch{}}catch(o){console.error("Error loading size template:",o);try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error loading size template")}catch{}}}async function Sn(e){if(confirm("Are you sure you want to delete this size template? This action cannot be undone."))try{const n=await(await fetch("/api/size_templates.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`action=delete_template&template_id=${e}`})).json();if(n.success){try{typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess("Size template deleted successfully!")}catch{}ge()}else try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to delete template: "+n.message)}catch{}}catch(o){console.error("Error deleting size template:",o);try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error deleting size template")}catch{}}}function xn(){document.body.insertAdjacentHTML("beforeend",`
         <div id="sizeTemplateEditModal" class="admin-modal-overlay hidden" data-action="close-size-template-modal">
             <div class="admin-modal-content content-section">
                 <div class="admin-modal-header section-header">
                     <h2 id="sizeTemplateEditTitle" class="modal-title">Edit Size Template</h2>
                     <button data-action="close-size-template-modal" class="modal-close">&times;</button>
                 </div>
                 <div class="modal-body">
                     <form id="sizeTemplateEditForm" data-action="save-size-template">
                         <input type="hidden" id="sizeTemplateId" name="template_id">
                         <div>
                             <h4 class="text-lg font-semibold text-gray-800">Template Details</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">Template Name *</label>
                                     <input type="text" id="sizeTemplateName" name="template_name" required class="modal-input" placeholder="e.g., T-Shirt Sizes">
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">Category</label>
                                     <select id="sizeTemplateCategory" name="category" class="modal-select">
                                         <option value="General">General</option>
                                         <option value="T-Shirts">T-Shirts</option>
                                         <option value="Tumblers">Tumblers</option>
                                         <option value="Artwork">Artwork</option>
                                         <option value="Sublimation">Sublimation</option>
                                         <option value="Window Wraps">Window Wraps</option>
                                     </select>
                                 </div>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-700">Description</label>
                                 <textarea id="sizeTemplateDescription" name="description" rows="2" class="modal-input" placeholder="Optional description of this size template"></textarea>
                             </div>
                         </div>
                         <div>
                             <div class="flex items-center justify-between">
                                 <h4 class="text-lg font-semibold text-gray-800">Sizes</h4>
                                 <button type="button" data-action="size-template-add-size" class="btn btn-primary">
                                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                     </svg>
                                     Add Size
                                 </button>
                             </div>
                             <div id="sizeTemplateSizes" class="space-y-3"></div>
                         </div>
                     </form>
                 </div>
                 <div class="modal-footer">
                     <button type="button" data-action="close-size-template-modal" class="btn btn-secondary">Cancel</button>
                     <button type="submit" form="sizeTemplateEditForm" class="btn btn-primary">Save Template</button>
                 </div>
             </div>
         </div>`)}function $t(e=null){document.getElementById("sizeTemplateEditModal")||xn();const o=document.getElementById("sizeTemplateEditModal"),n=document.getElementById("sizeTemplateEditForm"),i=document.getElementById("sizeTemplateEditTitle"),l=document.getElementById("sizeTemplateSizes");!o||!n||!i||!l||(n.reset(),l.innerHTML="",bn=0,e?(i.textContent="Edit Size Template",document.getElementById("sizeTemplateId").value=e.id,document.getElementById("sizeTemplateName").value=e.template_name,document.getElementById("sizeTemplateDescription").value=e.description||"",document.getElementById("sizeTemplateCategory").value=e.category||"General",e.sizes&&e.sizes.length>0&&e.sizes.forEach(c=>Fe(c))):(i.textContent="Create New Size Template",document.getElementById("sizeTemplateId").value="",Fe()),o.classList.remove("hidden"),S())}function N(){const e=document.getElementById("sizeTemplateEditModal");e&&(e.classList.add("hidden"),S())}function Fe(e=null){const o=document.getElementById("sizeTemplateSizes");if(!o)return;const n=bn++,i=`
         <div class="size-template-item border border-gray-200 rounded-lg bg-gray-50" data-index="${n}">
             <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Size Name *</label>
                     <input type="text" name="sizes[${n}][size_name]" required class="w-full border border-gray-300 rounded text-sm" placeholder="e.g., Small" value="${e?.size_name||""}">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Size Code *</label>
                     <input type="text" name="sizes[${n}][size_code]" required class="w-full border border-gray-300 rounded text-sm" placeholder="e.g., S" value="${e?.size_code||""}">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Price Adjustment</label>
                     <input type="number" name="sizes[${n}][price_adjustment]" step="0.01" class="w-full border border-gray-300 rounded text-sm" placeholder="0.00" value="${e?.price_adjustment||"0.00"}">
                 </div>
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Display Order</label>
                     <input type="number" name="sizes[${n}][display_order]" min="0" class="w-full border border-gray-300 rounded text-sm" value="${e?.display_order||n}">
                 </div>
                 <div class="flex items-end">
                     <button type="button" data-action="size-template-remove-size" data-index="${n}" class="bg-red-500 text-white rounded text-sm hover:bg-red-600">Remove</button>
                 </div>
             </div>
         </div>`;o.insertAdjacentHTML("beforeend",i)}function En(e){const o=document.querySelector(`[data-index="${e}"]`);o&&o.remove()}async function Tn(e){e.preventDefault();const o=e.target,n=new FormData(o),i=n.get("template_id"),l=i&&i!=="",c=[];if(document.querySelectorAll(".size-template-item").forEach((f,v)=>{const g=f.querySelector('input[name*="[size_name]"]')?.value,x=f.querySelector('input[name*="[size_code]"]')?.value,C=f.querySelector('input[name*="[price_adjustment]"]')?.value,_=f.querySelector('input[name*="[display_order]"]')?.value;g&&x&&c.push({size_name:g,size_code:x,price_adjustment:parseFloat(C)||0,display_order:parseInt(_)||v})}),c.length===0){try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Please add at least one size to the template")}catch{}return}const h={template_name:n.get("template_name"),description:n.get("description"),category:n.get("category"),sizes:c};l&&(h.template_id=parseInt(i));try{const g=await(await fetch(`/api/size_templates.php?action=${l?"update_template":"create_template"}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)})).json();if(g.success){try{typeof window<"u"&&typeof window.showSuccess=="function"&&window.showSuccess(l?"Size template updated successfully!":"Size template created successfully!")}catch{}N(),ge()}else try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Failed to save template: "+g.message)}catch{}}catch(f){console.error("Error saving size template:",f);try{typeof window<"u"&&typeof window.showError=="function"&&window.showError("Error saving size template")}catch{}}}typeof window<"u"&&(window.scanDatabaseConnections=tn,window.convertDatabaseConnections=on,window.openConversionTool=nn,window.toggleDatabaseBackupTables=an,window.viewTable=sn,window.closeTableViewModal=dn,window.compactRepairDatabase=rn,window.updateDatabaseConfig=ln,window.testSSLConnection=cn,window.loadColorTemplates=ye,window.renderColorTemplates=zt,window.filterColorTemplates=G,window.createNewColorTemplate=Mt,window.editColorTemplate=wn,window.deleteColorTemplate=yn,window.createColorTemplateEditModal=gn,window.showColorTemplateEditModal=Ot,window.closeColorTemplateEditModal=P,window.addColorToTemplate=ze,window.removeColorFromTemplate=vn,window.updateColorPreview=Oe,window.updateColorPicker=It,window.saveColorTemplate=hn,window.loadSizeTemplates=ge,window.renderSizeTemplates=Ft,window.filterSizeTemplates=W,window.createNewSizeTemplate=Bt,window.editSizeTemplate=_n,window.deleteSizeTemplate=Sn,window.createSizeTemplateEditModal=xn,window.showSizeTemplateEditModal=$t,window.closeSizeTemplateEditModal=N,window.addSizeToTemplate=Fe,window.removeSizeFromTemplate=En,window.saveSizeTemplate=Tn,window.openAISettingsModal=Cn,window.closeAISettingsModal=Jo,window.loadAIProviders=Yo,window.displayAIProviders=Zo,window.toggleSection=Mn,window.toggleProviderSections=pt,window.saveAISettings=mt,window.showAISettingsSuccess=Xo,window.showAISettingsError=wt,window.testAIProvider=yt,window.loadAllModels=In,window.loadAllModelsWithSelection=Bn,window.getDefaultAIProvider=ve,window.loadModelsForCurrentProvider=en,window.refreshModels=ke,window.populateModelDropdown=O,window.populateModelDropdownWithSelection=F,window.loadFallbackModels=gt,window.loadFallbackModelsForProvider=vt,window.loadFallbackModelsWithSelection=ht,window.loadFallbackModelsForProviderWithSelection=bt,window.loadContentToneOptions=le,window.initializeDefaultContentToneOptions=Go,window.loadDefaultContentToneOptions=Ie,window.populateContentToneDropdown=$e,window.manageContentToneOptions=nt,window.showContentToneModal=Wo,window.closeContentToneModal=Be,window.displayContentToneOptions=Pe,window.addContentToneOption=at,window.updateContentToneOption=H,window.removeContentToneOption=it,window.saveContentToneOptions=st,window.saveContentToneOption=Ce,window.deleteContentToneOptionFromDB=dt,window.loadBrandVoiceOptions=ce,window.initializeDefaultBrandVoiceOptions=Ko,window.loadDefaultBrandVoiceOptions=De,window.populateBrandVoiceDropdown=Ne,window.manageBrandVoiceOptions=rt,window.showBrandVoiceModal=Qo,window.closeBrandVoiceModal=Le,window.displayBrandVoiceOptions=Re,window.addBrandVoiceOption=lt,window.updateBrandVoiceOption=q,window.removeBrandVoiceOption=ct,window.saveBrandVoiceOptions=ft,window.saveBrandVoiceOption=Me,window.deleteBrandVoiceOptionFromDB=ut);let jo=!1;function Rn(e=document){try{const o=[{contains:"scanDatabaseConnections",action:"scan-db"},{contains:"convertDatabaseConnections",action:"convert-db"},{contains:"openConversionTool",action:"open-conversion-tool"},{contains:"compactRepairDatabase",action:"compact-repair"},{contains:"toggleDatabaseBackupTables",action:"toggle-backup-tables"},{contains:"closeTableViewModal",action:"close-table-view"},{contains:"updateDatabaseConfig",action:"update-db-config"},{contains:"testSSLConnection",action:"test-ssl"},{contains:"closeAISettingsModal",action:"ai-close-settings"},{contains:"saveAISettings",action:"ai-save-settings"},{contains:"testAIProvider",action:"ai-test-provider"},{contains:"refreshModels",action:"ai-refresh-models"},{contains:"toggleSection",action:"ai-toggle-section"},{contains:"manageBrandVoiceOptions",action:"ai-manage-brand-voice"},{contains:"manageContentToneOptions",action:"ai-manage-content-tone"},{contains:"closeContentToneModal",action:"content-tone-close"},{contains:"addContentToneOption",action:"content-tone-add"},{contains:"saveContentToneOptions",action:"content-tone-save"},{contains:"closeBrandVoiceModal",action:"brand-voice-close"},{contains:"addBrandVoiceOption",action:"brand-voice-add"},{contains:"saveBrandVoiceOptions",action:"brand-voice-save"}];e.querySelectorAll("[onclick], [onchange]").forEach(i=>{const l=(i.getAttribute("onclick")||i.getAttribute("onchange")||"").toString();for(const c of o)l.includes(c.contains)&&(i.dataset.action||(i.dataset.action=c.action));if(l.includes("viewTable(")){i.dataset.action||(i.dataset.action="view-table");try{const c=l.match(/viewTable\((?:'([^']+)'|\"([^\"]+)\"|([^\)]+))\)/),m=(c&&(c[1]||c[2]||c[3]||"")).toString().trim().replace(/^`|`$/g,"").replace(/^\"|\"$/g,"").replace(/^'|'$/g,"");m&&!i.dataset.table&&(i.dataset.table=m)}catch{}}if(l.includes("updateContentToneOption(")){i.dataset.action||(i.dataset.action="content-tone-update");try{const c=l.match(/updateContentToneOption\((\d+)\s*,\s*'([^']+)'/);c&&(i.dataset.index=c[1],i.dataset.field=c[2])}catch{}}if(l.includes("removeContentToneOption(")){i.dataset.action||(i.dataset.action="content-tone-remove");try{const c=l.match(/removeContentToneOption\((\d+)\)/);c&&(i.dataset.index=c[1])}catch{}}if(l.includes("updateBrandVoiceOption(")){i.dataset.action||(i.dataset.action="brand-voice-update");try{const c=l.match(/updateBrandVoiceOption\((\d+)\s*,\s*'([^']+)'/);c&&(i.dataset.index=c[1],i.dataset.field=c[2])}catch{}}if(l.includes("removeBrandVoiceOption(")){i.dataset.action||(i.dataset.action="brand-voice-remove");try{const c=l.match(/removeBrandVoiceOption\((\d+)\)/);c&&(i.dataset.index=c[1])}catch{}}})}catch(o){console.debug("[AdminSettings] tagInlineHandlersForMigration error",o)}}function Hn(e=document){try{const o=['[onclick*="scanDatabaseConnections"]','[onclick*="convertDatabaseConnections"]','[onclick*="openConversionTool"]','[onclick*="compactRepairDatabase"]','[onclick*="toggleDatabaseBackupTables"]','[onclick*="closeTableViewModal"]','[onclick*="viewTable("]','[onclick*="updateDatabaseConfig"]','[onclick*="testSSLConnection"]','[onclick*="closeAISettingsModal"]','[onclick*="saveAISettings"]','[onclick*="testAIProvider"]','[onclick*="refreshModels"]','[onclick*="toggleSection"]','[onclick*="closeContentToneModal"]','[onclick*="addContentToneOption"]','[onclick*="saveContentToneOptions"]','[onclick*="updateContentToneOption"]','[onclick*="removeContentToneOption"]','[onclick*="closeBrandVoiceModal"]','[onclick*="addBrandVoiceOption"]','[onclick*="saveBrandVoiceOptions"]','[onclick*="updateBrandVoiceOption"]','[onclick*="removeBrandVoiceOption"]'];e.querySelectorAll(o.join(",")).forEach(n=>{n.dataset.onclickLegacy||(n.dataset.onclickLegacy=n.getAttribute("onclick")||""),n.removeAttribute("onclick"),n.dataset.migrated="true"})}catch(o){console.debug("[AdminSettings] stripInlineHandlersForMigration error",o)}}function Vo(){if(jo)return;jo=!0;const e=()=>{Rn(),Hn()};document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",()=>e(),{once:!0}),Vn(),document.addEventListener("change",a=>{const d=a.target;if(d&&d.matches&&d.matches("#sslEnabled")){const y=document.getElementById("sslOptions");y&&(d.checked?y.classList.remove("hidden"):y.classList.add("hidden"))}if(d&&d.matches&&d.matches('input[name="ai_provider"]')){a.preventDefault();try{typeof window<"u"&&typeof window.toggleProviderSections=="function"?window.toggleProviderSections():typeof pt=="function"&&pt()}catch{}}const u=d&&d.closest&&d.closest('[data-action="content-tone-update"]');if(u||d&&d.dataset&&d.dataset.action==="content-tone-update"){const y=u||d,I=parseInt(y.dataset.index||"-1",10),T=y.dataset.field||"name",$=d.value;if(!isNaN(I)){const j=typeof window<"u"&&typeof window.updateContentToneOption=="function"?window.updateContentToneOption:typeof H=="function"?H:null;j&&j(I,T,$)}}const p=d&&d.closest&&d.closest('[data-action="brand-voice-update"]');if(p||d&&d.dataset&&d.dataset.action==="brand-voice-update"){const y=p||d,I=parseInt(y.dataset.index||"-1",10),T=y.dataset.field||"name",$=d.value;if(!isNaN(I)){const j=typeof window<"u"&&typeof window.updateBrandVoiceOption=="function"?window.updateBrandVoiceOption:typeof q=="function"?q:null;j&&j(I,T,$)}}const s=d&&d.closest&&d.closest('[data-action="color-picker-change"]');if(s||d&&d.dataset&&d.dataset.action==="color-picker-change"){const I=parseInt((s||d).dataset.index||"-1",10),T=d.value;if(!isNaN(I))try{typeof window<"u"&&typeof window.updateColorPreview=="function"?window.updateColorPreview(I,T):typeof Oe=="function"&&Oe(I,T)}catch{}}const b=d&&d.closest&&d.closest('[data-action="color-text-change"]');if(b||d&&d.dataset&&d.dataset.action==="color-text-change"){const I=parseInt((b||d).dataset.index||"-1",10),T=d.value;if(!isNaN(I))try{typeof window<"u"&&typeof window.updateColorPicker=="function"?window.updateColorPicker(I,T):typeof It=="function"&&It(I,T)}catch{}}if(d&&d.matches&&d.matches('[data-action="css-rule-color-change"]')){try{const y="CSS rules are now managed via static assets (Vite). This control is deprecated.";typeof window<"u"&&typeof window.showNotification=="function"?window.showNotification({type:"info",title:"CSS Rules Deprecated",message:y}):(console.warn("[AdminSettings] CSS rules deprecated:",y),alert(y))}catch{}return}if(d&&d.matches&&d.matches('[data-action="css-rule-change"]')){try{const y="CSS rules are now managed via static assets (Vite). This control is deprecated.";typeof window<"u"&&typeof window.showNotification=="function"?window.showNotification({type:"info",title:"CSS Rules Deprecated",message:y}):(console.warn("[AdminSettings] CSS rules deprecated:",y),alert(y))}catch{}return}if(d&&d.matches&&d.matches('[data-action="css-variable-change"]')){try{const y="CSS variables are now initialized via static assets (Vite). This control is deprecated.";typeof window<"u"&&typeof window.showNotification=="function"?window.showNotification({type:"info",title:"CSS Variables Deprecated",message:y}):(console.warn("[AdminSettings] CSS variables deprecated:",y),alert(y))}catch{}return}if(d&&d.matches&&d.matches('[data-action="dashboard-section-width-change"]')){const y=d.dataset.sectionKey,I=d.value;try{typeof window<"u"&&typeof window.updateSectionWidth=="function"?window.updateSectionWidth(y,I):typeof updateSectionWidth=="function"&&updateSectionWidth(y,I)}catch{}return}if(d&&d.matches&&d.matches('[data-action="sync-to"]')){const y=d.dataset.targetId,I=document.getElementById(y);if(I)try{I.value=d.value}catch{}return}if(d&&d.matches&&d.matches('[data-action="tm-filter-color-templates"]')){try{typeof window<"u"&&typeof window.filterColorTemplates=="function"?window.filterColorTemplates():typeof G=="function"&&G()}catch{}return}if(d&&d.matches&&d.matches('[data-action="tm-filter-size-templates"]')){try{typeof window<"u"&&typeof window.filterSizeTemplates=="function"?window.filterSizeTemplates():typeof W=="function"&&W()}catch{}return}if(d&&d.matches&&d.matches('[data-action="filter-color-category"]')){try{typeof window<"u"&&typeof window.filterColorsByCategory=="function"&&window.filterColorsByCategory()}catch{}return}if(d&&d.matches&&d.matches('[data-action="filter-size-category"]')){try{typeof window<"u"&&typeof window.filterSizesByCategory=="function"&&window.filterSizesByCategory()}catch{}return}},!0),document.addEventListener("input",a=>{const d=a.target;if(!(!d||!d.matches)&&d.matches('[data-action="startover-input"]')){try{typeof window<"u"&&typeof window.checkStartOverConfirmation=="function"?window.checkStartOverConfirmation():typeof checkStartOverConfirmation=="function"&&checkStartOverConfirmation()}catch{}return}},!0),document.addEventListener("change",a=>{const d=a.target;if(!(!d||!d.matches)){if(d.matches('[data-action="tm-filter-color-templates"]')){try{G()}catch{}return}if(d.matches('[data-action="tm-filter-size-templates"]')){try{W()}catch{}return}if(d.matches('[data-action="db-change-rows-per-page"]')){try{typeof window<"u"&&typeof window.changeRowsPerPage=="function"?window.changeRowsPerPage():typeof changeRowsPerPage=="function"&&changeRowsPerPage()}catch{}return}if(d.matches('[data-action="receipt-update-field"]')){const u=parseInt(d.dataset.messageId,10),p=d.dataset.field,s=d.value;try{typeof window<"u"&&typeof window.updateMessageField=="function"&&window.updateMessageField(u,p,s)}catch{}return}}},!0),document.addEventListener("submit",a=>{const d=a.target;if(!(!d||!d.matches)){if(d.matches('[data-action="save-room-settings"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveRoomSettings=="function"?window.saveRoomSettings(a):typeof saveRoomSettings=="function"&&saveRoomSettings(a)}catch{}}if(d.matches('[data-action="save-color-template"]')){a.preventDefault();try{hn(a)}catch{}}if(d.matches('[data-action="save-size-template"]')){a.preventDefault();try{Tn(a)}catch{}}if(d.matches('[data-action="save-global-gender"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveGlobalGender=="function"&&window.saveGlobalGender(a)}catch{}}if(d.matches('[data-action="save-global-color"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveGlobalColor=="function"&&window.saveGlobalColor(a)}catch{}}if(d.matches('[data-action="save-global-size"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveGlobalSize=="function"&&window.saveGlobalSize(a)}catch{}}}},!0);const o=()=>document.getElementById("backgroundManagerModal"),n=()=>{const a=o();return{modal:a,roomSelect:a?a.querySelector("#backgroundRoomSelect"):null,nameInput:a?a.querySelector("#backgroundName"):null,fileInput:a?a.querySelector("#backgroundFile"):null,list:a?a.querySelector("#backgroundsList"):null,info:a?a.querySelector("#currentBackgroundInfo"):null,preview:a?a.querySelector("#currentBackgroundPreview"):null}},i={ok:a=>{try{typeof window.showSuccess=="function"?window.showSuccess(a):alert(a)}catch{}},err:a=>{try{typeof window.showError=="function"?window.showError(a):alert(a)}catch{}}},l=a=>{if(!a)return"";const d=a.webp_filename||a.image_filename||"";return d?`/images/${encodeURIComponent(d)}`:""};async function c(){const{roomSelect:a}=n();if(a)try{const u=await(await fetch("/api/get_room_data.php")).json(),p=u&&u.data&&(u.data.roomTypeMapping||u.data.validRooms)||{},s=new Set(Array.from(a.options).map(y=>String(y.value))),b=Array.isArray(p)?p.map(y=>[y,y]):Object.entries(p);for(const[y,I]of b){const T=String(y);if(s.has(T))continue;const $=document.createElement("option");$.value=T,$.textContent=String(I||y),a.appendChild($),s.add(T)}}catch(d){console.warn("[BackgroundManager] Failed to load rooms",d)}}async function m(a){return(await fetch(`/api/backgrounds.php?room_type=${encodeURIComponent(a)}`)).json()}async function h(a){return(await fetch(`/api/backgrounds.php?room_type=${encodeURIComponent(a)}&active_only=true`)).json()}function f(a,d){const{list:u}=n();if(u){if(!d||!d.length){u.innerHTML='<div class="text-sm text-gray-500">No backgrounds yet.</div>';return}u.innerHTML=d.map(p=>{const s=l(p),b=(p.background_name||"").replace(/"/g,"&quot;"),y=String(p.is_active)==="1"||p.is_active===1;return`
              <div class="border rounded p-2 flex items-center justify-between">
                <div class="flex items-center gap-2">
                  ${s?`<img src="${s}" alt="${b}" class="w-12 h-12 object-cover rounded">`:""}
                  <div>
                    <div class="font-medium">${b}${y?' <span class="text-xs text-green-600">(Active)</span>':""}</div>
                    <div class="text-xs text-gray-500">#${p.id}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  ${s?`<button class="px-2 py-1 text-blue-600" data-action="preview-background" data-image-url="${s}" data-background-name="${b}">Preview</button>`:""}
                  <button class="px-2 py-1 text-green-600" data-action="apply-background" data-room="${a}" data-background-id="${p.id}">Apply</button>
                  <button class="px-2 py-1 text-red-600" data-action="delete-background" data-background-id="${p.id}" data-background-name="${b}">Delete</button>
                </div>
              </div>`}).join("")}}function v(a,d){const{info:u,preview:p}=n();if(u&&(d&&d.background&&(d=d.background),d&&d.id?u.textContent=`Active for ${a}: ${d.background_name} (#${d.id})`:u.textContent="No active background set."),p){const s=l(d&&(d.background||d));s?p.innerHTML=`<img src="${s}" alt="Active Background" class="max-w-full h-auto">`:p.innerHTML='<div class="text-gray-400 text-center p-6">No preview available</div>'}}async function g(a){const d=a||(n().roomSelect?n().roomSelect.value:"landing");try{const[u,p]=await Promise.all([m(d),h(d)]),s=u&&(u.backgrounds||[])||[];f(d,s),v(d,p&&(p.background||p))}catch(u){console.error("[BackgroundManager] refresh error",u);const{list:p,info:s}=n();p&&(p.innerHTML='<div class="text-red-600 text-sm">Failed to load backgrounds.</div>'),s&&(s.textContent="Failed to load active background.")}}function x(a){const{modal:d,roomSelect:u}=n();if(d){d.classList.remove("hidden");try{typeof S=="function"&&S()}catch{}c().then(()=>{u&&a&&(u.value=a),g(u?u.value:"landing")})}}function C(){const{modal:a}=n();if(a){a.classList.add("hidden");try{typeof S=="function"&&S()}catch{}}}async function _(a,d){if(!(!a||d==null)&&confirm("Apply this background?"))try{const p=await(await fetch("/api/backgrounds.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"apply",room_type:a,background_id:d})})).json();p&&p.success?(i.ok(p.message||"Background applied"),g(a)):i.err(p&&(p.error||p.message)||"Failed to apply background")}catch(u){console.error("[BackgroundManager] apply error",u),i.err("Error applying background")}}async function D(a,d){if(a!=null&&confirm(`Delete background "${d||"#"+a}"? This cannot be undone.`))try{const p=await(await fetch("/api/backgrounds.php",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({background_id:a})})).json();if(p&&p.success){i.ok(p.message||"Background deleted");const{roomSelect:s}=n();g(s?s.value:"")}else i.err(p&&(p.error||p.message)||"Failed to delete background")}catch(u){console.error("[BackgroundManager] delete error",u),i.err("Error deleting background")}}function M(a,d){if(!a)return;const u=document.createElement("div");u.className="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4",u.innerHTML=`
          <div class="relative bg-white rounded shadow-xl max-w-5xl w-full max-h-[90vh] overflow-auto">
            <button class="absolute top-2 right-3 text-2xl" data-action="close-preview" aria-label="Close">&times;</button>
            <div class="p-3 border-b"><div class="font-semibold">${(d||"Preview").replace(/</g,"&lt;")}</div></div>
            <div class="p-3 flex items-center justify-center"><img src="${a}" alt="${(d||"").replace(/</g,"&lt;")}" class="max-w-full h-auto"></div>
          </div>`,document.body.appendChild(u)}async function B(){const{roomSelect:a,nameInput:d,fileInput:u}=n(),p=a?a.value:"",s=d?d.value.trim():"",b=u?u.files[0]:null;if(!p){i.err("Select a room first");return}if(!s){i.err("Enter a background name");return}if(!b){i.err("Please choose an image file to upload.");return}try{const y=new FormData;y.append("room_type",p),y.append("background_name",s),y.append("background_image",b);const T=await(await fetch("/api/upload_background.php",{method:"POST",body:y})).json().catch(()=>({}));T&&T.success?(i.ok(T.message||"Upload successful"),g(p),d&&(d.value=""),u&&(u.value="")):i.err(T&&(T.error||T.message)||"Upload failed.")}catch(y){console.error("[BackgroundManager] upload error",y),i.err("Upload failed.")}}try{typeof window<"u"&&(window.openBackgroundManagerModal=x,window.closeBackgroundManagerModal=C,window.loadBackgroundsForRoom=g,window.uploadBackground=B,window.applyBackground=_,window.deleteBackground=D,window.previewBackground=M)}catch{}document.addEventListener("change",a=>{const d=a.target;if(!d||!d.matches)return;if(d.matches("#backgroundRoomSelect")&&g(d.value),d.closest('[data-action="help-toggle-global-tooltips"]')){try{typeof window<"u"&&typeof window.toggleGlobalTooltips=="function"&&window.toggleGlobalTooltips()}catch{}return}if(d.closest('[data-action="help-filter-hints"]')){try{typeof window<"u"&&typeof window.filterHelpHints=="function"&&window.filterHelpHints()}catch{}return}if(d.closest('[data-action="logs-refresh-current"]')){try{typeof window<"u"&&typeof window.refreshCurrentLog=="function"&&window.refreshCurrentLog()}catch{}return}if(d.closest('[data-action="help-import-file"]')){try{typeof window<"u"&&typeof window.importHelpHints=="function"&&window.importHelpHints()}catch{}return}},!0),document.addEventListener("submit",a=>{const d=a.target;if(!(!d||!d.matches)){if(d.closest('[data-action="add-category"]')){a.preventDefault();try{typeof window<"u"&&typeof window.addCategory=="function"&&window.addCategory(a)}catch{}return}if(d.closest('[data-action="help-save-form"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveHelpHint=="function"&&window.saveHelpHint()}catch{}return}}},!0),document.addEventListener("keydown",a=>{const d=a.target;if(!(!d||!d.matches)&&d.id==="newCartButtonText"&&(a.key==="Enter"||a.keyCode===13)){a.preventDefault();try{typeof window<"u"&&typeof window.addCartButtonText=="function"?window.addCartButtonText():document.dispatchEvent(new CustomEvent("wf:cart-text-add"))}catch{}}},!0),document.addEventListener("keydown",a=>{if(a.key!=="Escape"&&a.keyCode!==27)return;[document.getElementById("squareSettingsModal"),document.getElementById("aiSettingsModal"),document.getElementById("aiToolsModal")].filter(Boolean).forEach(u=>{u&&u.classList.contains("show")&&(u.classList.remove("show"),u.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),u.setAttribute("aria-hidden","true"))})},!0),document.addEventListener("submit",a=>{const d=a.target;d&&d.matches&&d.matches('form[data-action="prevent-submit"]')&&(a.preventDefault(),a.stopPropagation())},!0),document.addEventListener("click",a=>{const d=a.target,u=document.querySelector(".settings-page");if(u&&!u.contains(d)||d.closest&&d.closest(".admin-nav-tab"))return;const p=d.closest&&d.closest("a");if(p&&!p.hasAttribute("data-action"))return;const s=t=>d.closest(t),b=t=>{try{if(!t)return;if(typeof window<"u"&&typeof t=="string"&&typeof window[t]=="function"){window[t]();return}if(typeof t=="string"){const w=new Function(`return (${t});`)();typeof w=="function"&&w()}}catch(r){console.warn("[AdminSettings] modal callback failed",r)}};if(d&&d.dataset&&d.dataset.action==="overlay-close"){a.preventDefault();try{d.classList.add("hidden"),S()}catch{}return}const y=s('[data-action="close-admin-modal"]');if(y){a.preventDefault();try{const t=y.closest('[data-action="overlay-close"], .admin-modal-overlay, .modal-overlay');t&&t.classList.add("hidden"),S()}catch{}return}if(d&&d.classList&&d.classList.contains("admin-modal-overlay")){a.preventDefault();try{d.classList.remove("show"),d.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),d.setAttribute("aria-hidden","true")}catch{}return}if(s('[data-action="open-square-settings"]')){a.preventDefault();try{const t=document.getElementById("squareSettingsModal");t&&(console.debug("[SquareModal] open handler fired"),t.classList.remove("hidden"),t.classList.add("show"),document.documentElement.classList.add("modal-open"),document.body.classList.add("modal-open"),t.setAttribute("aria-hidden","false"),console.debug("[SquareModal] classes after open:",t.className))}catch{}return}if(s('[data-action="close-square-settings"]')){a.preventDefault();try{const t=document.getElementById("squareSettingsModal");t&&(t.classList.remove("show"),t.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),t.setAttribute("aria-hidden","true"))}catch{}return}if(s('[data-action="open-ai-settings"]')){a.preventDefault();try{const t=document.getElementById("aiSettingsModal");t&&(t.classList.remove("hidden"),t.classList.add("show"),document.documentElement.classList.add("modal-open"),document.body.classList.add("modal-open"),t.setAttribute("aria-hidden","false"))}catch{}return}if(s('[data-action="close-ai-settings"]')){a.preventDefault();try{const t=document.getElementById("aiSettingsModal");t&&(t.classList.remove("show"),t.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),t.setAttribute("aria-hidden","true"))}catch{}return}if(s('[data-action="open-ai-tools"]')){a.preventDefault();try{const t=document.getElementById("aiToolsModal");t&&(t.classList.remove("hidden"),t.classList.add("show"),document.documentElement.classList.add("modal-open"),document.body.classList.add("modal-open"),t.setAttribute("aria-hidden","false"))}catch{}return}if(s('[data-action="close-ai-tools"]')){a.preventDefault();try{const t=document.getElementById("aiToolsModal");t&&(t.classList.remove("show"),t.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),t.setAttribute("aria-hidden","true"))}catch{}return}if(s('[data-action="save-ai-settings"]')){a.preventDefault();const t=s('[data-action="save-ai-settings"]'),r=document.getElementById("aiSettingsResult");ne(t,()=>typeof window<"u"&&typeof window.saveAISettings=="function"?window.saveAISettings():document.dispatchEvent(new CustomEvent("wf:ai-settings-save")),{resultEl:r,startText:"Saving AI settings…",successText:"Saved.",errorText:"Failed to save AI settings."}).catch(E=>console.warn("[AI] save-ai-settings error",E));return}if(s('[data-action="test-ai-settings"]')){a.preventDefault();const t=s('[data-action="test-ai-settings"]'),r=document.getElementById("aiSettingsResult");ne(t,()=>typeof window<"u"&&typeof window.testAISettings=="function"?window.testAISettings():document.dispatchEvent(new CustomEvent("wf:ai-settings-test")),{resultEl:r,startText:"Testing AI settings…",successText:"Test succeeded.",errorText:"Test failed.",onSuccess:E=>{r&&(r.textContent=E===!1?"Test failed.":"Test succeeded.")}}).catch(E=>console.warn("[AI] test-ai-settings error",E));return}if(s('[data-action="ai-run-diagnostics"]')){a.preventDefault();const t=s('[data-action="ai-run-diagnostics"]'),r=document.getElementById("aiToolsResult");ne(t,()=>typeof window<"u"&&typeof window.runAIDiagnostics=="function"?window.runAIDiagnostics():document.dispatchEvent(new CustomEvent("wf:ai-run-diagnostics")),{resultEl:r,startText:"Running AI diagnostics…",successText:"Diagnostics complete.",errorText:"Diagnostics failed."}).catch(E=>console.warn("[AI] diagnostics error",E));return}if(s('[data-action="ai-clear-cache"]')){a.preventDefault();const t=s('[data-action="ai-clear-cache"]'),r=document.getElementById("aiToolsResult");ne(t,()=>typeof window<"u"&&typeof window.clearAICache=="function"?window.clearAICache():document.dispatchEvent(new CustomEvent("wf:ai-clear-cache")),{resultEl:r,startText:"Clearing AI cache…",successText:"AI cache cleared.",errorText:"Failed to clear cache."}).catch(E=>console.warn("[AI] clear-cache error",E));return}if(s('[data-action="ai-refresh-providers"]')){a.preventDefault();const t=s('[data-action="ai-refresh-providers"]'),r=document.getElementById("aiToolsResult");ne(t,()=>typeof window<"u"&&typeof window.refreshAIProviders=="function"?window.refreshAIProviders():document.dispatchEvent(new CustomEvent("wf:ai-refresh-providers")),{resultEl:r,startText:"Refreshing AI providers…",successText:"Providers refreshed.",errorText:"Failed to refresh providers."}).catch(E=>console.warn("[AI] refresh-providers error",E));return}if(s('[data-action="refresh-marketing-data"]')){a.preventDefault();try{typeof window<"u"&&typeof window.refreshMarketingData=="function"?window.refreshMarketingData():document.dispatchEvent(new CustomEvent("wf:refresh-marketing-data"))}catch{}return}const Pt=s('[data-action="switch-reports-tab"]');if(Pt){a.preventDefault();try{const t=Pt.dataset.tab;["sales","inventory","financial","operational"].forEach(w=>{const E=document.querySelector(`nav [data-action="switch-reports-tab"][data-tab="${w}"]`);if(E){const oe=w===t;E.classList.toggle("text-blue-600",oe),E.classList.toggle("border-blue-500",oe),E.classList.toggle("border-transparent",!oe),E.classList.toggle("text-gray-500",!oe)}const z=document.getElementById(`${w}-tab`);z&&z.classList.toggle("hidden",w!==t)})}catch{}return}const Nt=s('[data-action="edit-global-color"]');if(Nt){a.preventDefault();const t=parseInt(Nt.dataset.id,10);try{typeof window<"u"&&typeof window.editGlobalColor=="function"&&window.editGlobalColor(t)}catch{}return}const Rt=s('[data-action="delete-global-color"]');if(Rt){a.preventDefault();const t=parseInt(Rt.dataset.id,10);try{typeof window<"u"&&typeof window.deleteGlobalColor=="function"&&window.deleteGlobalColor(t)}catch{}return}const Ht=s('[data-action="edit-global-size"]');if(Ht){a.preventDefault();const t=parseInt(Ht.dataset.id,10);try{typeof window<"u"&&typeof window.editGlobalSize=="function"&&window.editGlobalSize(t)}catch{}return}const qt=s('[data-action="delete-global-size"]');if(qt){a.preventDefault();const t=parseInt(qt.dataset.id,10);try{typeof window<"u"&&typeof window.deleteGlobalSize=="function"&&window.deleteGlobalSize(t)}catch{}return}const jt=s('[data-action="edit-global-gender"]');if(jt){a.preventDefault();const t=parseInt(jt.dataset.id,10);try{typeof window<"u"&&typeof window.editGlobalGender=="function"&&window.editGlobalGender(t)}catch{}return}const Vt=s('[data-action="delete-global-gender"]');if(Vt){a.preventDefault();const t=parseInt(Vt.dataset.id,10);try{typeof window<"u"&&typeof window.deleteGlobalGender=="function"&&window.deleteGlobalGender(t)}catch{}return}if(s('[data-action="cleanup-stale-files"]')){a.preventDefault();try{typeof window<"u"&&typeof window.cleanupStaleFiles=="function"&&window.cleanupStaleFiles()}catch{}return}if(s('[data-action="remove-unused-code"]')){a.preventDefault();try{typeof window<"u"&&typeof window.removeUnusedCode=="function"&&window.removeUnusedCode()}catch{}return}if(s('[data-action="optimize-database"]')){a.preventDefault();try{typeof window<"u"&&typeof window.optimizeDatabase=="function"&&window.optimizeDatabase()}catch{}return}if(s('[data-action="show-start-over-confirmation"]')){a.preventDefault();try{typeof window<"u"&&typeof window.showStartOverConfirmation=="function"&&window.showStartOverConfirmation()}catch{}return}if(s('[data-action="execute-start-over"]')){a.preventDefault();try{typeof window<"u"&&typeof window.executeStartOver=="function"&&window.executeStartOver()}catch{}return}if(s('[data-action="run-system-analysis"]')){a.preventDefault();try{typeof window<"u"&&typeof window.runSystemAnalysis=="function"&&window.runSystemAnalysis()}catch{}return}if(s('[data-action="close-optimization-results"]')){a.preventDefault();try{typeof window<"u"&&typeof window.closeOptimizationResults=="function"&&window.closeOptimizationResults()}catch{}return}if(s('[data-action="retry-load-dashboard-config"]')){a.preventDefault();try{typeof window<"u"&&typeof window.loadDashboardConfiguration=="function"&&window.loadDashboardConfiguration()}catch{}return}const Ut=s('[data-action="retry-load-available-sections"]');if(Ut){a.preventDefault();const t=Ut.dataset.targetId,r=document.getElementById(t);try{typeof window<"u"&&typeof window.loadAvailableSections=="function"&&window.loadAvailableSections(r)}catch{}return}if(s('[data-action="retry-load-doc-list"]')){a.preventDefault();try{typeof window<"u"&&typeof window.loadDocumentationList=="function"&&window.loadDocumentationList()}catch{}return}const Gt=s('[data-action="view-document"]');if(Gt){a.preventDefault();const t=parseInt(Gt.dataset.docIndex,10);try{typeof window<"u"&&typeof window.viewDocument=="function"&&window.viewDocument(t)}catch{}return}const Wt=s('[data-action="scroll-doc-section"]');if(Wt){a.preventDefault();const t=Wt.dataset.anchor;try{typeof window<"u"&&typeof window.scrollToSection=="function"&&window.scrollToSection(t)}catch{}return}const Kt=s('[data-action="select-log"]');if(Kt){a.preventDefault();const t=Kt.dataset.logType;try{typeof window<"u"&&typeof window.selectLog=="function"&&window.selectLog(t)}catch{}return}const He=s('[data-action="view-log-entry"]');if(He){a.preventDefault();const t=He.dataset.logType,r=He.dataset.entryId;try{typeof window<"u"&&typeof window.viewLogEntry=="function"&&window.viewLogEntry(t,r)}catch{}return}const qe=s('[data-action="select-server-backup"]');if(qe){a.preventDefault();const t=qe.dataset.filename,r=qe.dataset.path;try{typeof window<"u"&&typeof window.selectServerBackup=="function"&&window.selectServerBackup(t,r)}catch{}return}if(s('[data-action="cart-text-add"]')){a.preventDefault();try{typeof window<"u"&&typeof window.addCartButtonText=="function"?window.addCartButtonText():document.dispatchEvent(new CustomEvent("wf:cart-text-add"))}catch{}return}const Qt=s('[data-action="cart-text-quick-add"]');if(Qt){a.preventDefault();const t=Qt.dataset.text||"";try{typeof window<"u"&&typeof window.addQuickCartText=="function"?window.addQuickCartText(t):document.dispatchEvent(new CustomEvent("wf:cart-text-quick-add",{detail:{text:t}}))}catch{}return}const Jt=s('[data-action="cart-text-remove"]');if(Jt){a.preventDefault();const t=parseInt(Jt.dataset.index,10);try{typeof window<"u"&&typeof window.removeCartButtonText=="function"?window.removeCartButtonText(t):document.dispatchEvent(new CustomEvent("wf:cart-text-remove",{detail:{index:t}}))}catch{}return}if(s('[data-action="cart-text-reset"]')){a.preventDefault();try{typeof window<"u"&&typeof window.resetToDefaults=="function"?window.resetToDefaults():document.dispatchEvent(new CustomEvent("wf:cart-text-reset"))}catch{}return}if(s('[data-action="opt-generate-suggestions"]')){a.preventDefault();try{typeof window<"u"&&typeof window.generateOptimizationSuggestions=="function"&&window.generateOptimizationSuggestions()}catch{}return}if(s('[data-action="marketing-save-defaults"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveMarketingDefaults=="function"&&window.saveMarketingDefaults()}catch{}return}if(s('[data-action="business-reset-defaults"]')){a.preventDefault();try{typeof window<"u"&&typeof window.resetAllSettingsToDefaults=="function"&&window.resetAllSettingsToDefaults()}catch{}return}if(s('[data-action="business-save-all"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveAllBusinessSettings=="function"&&window.saveAllBusinessSettings()}catch{}return}if(s('[data-action="general-config-retry"]')){a.preventDefault();try{typeof window<"u"&&typeof window.loadGeneralConfig=="function"&&window.loadGeneralConfig()}catch{}return}const je=s('[data-action="toggle-item-selection"]');if(je){a.preventDefault();const t=je.dataset.sku,r=String(je.dataset.select).toLowerCase()==="true";try{typeof window<"u"&&typeof window.toggleItemSelection=="function"&&window.toggleItemSelection(t,r)}catch{}return}const Yt=s('[data-action="close-modal"]');if(Yt){a.preventDefault();const t=Yt.dataset.target;if(t){const r=document.querySelector(t);r&&r.classList.add("hidden")}try{typeof S=="function"&&S()}catch{}return}const Zt=s('[data-action="switch-global-tab"]');if(Zt){a.preventDefault();const t=Zt.dataset.tab;try{typeof window<"u"&&typeof window.switchGlobalTab=="function"&&window.switchGlobalTab(t)}catch{}return}if(s('[data-action="show-add-gender-form"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.showAddGenderForm=="function")window.showAddGenderForm();else{const t=document.getElementById("addGenderForm");t&&t.classList.remove("hidden")}}catch{}return}if(s('[data-action="cancel-add-gender"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.cancelAddGender=="function")window.cancelAddGender();else{const t=document.getElementById("addGenderForm");t&&(t.classList.add("hidden"),t.querySelectorAll("input").forEach(w=>{try{w.value=""}catch{}}))}}catch{}return}const he=s('[data-action="open-create-sale-modal"]');if(he){a.preventDefault();try{const t=he.dataset&&he.dataset.saleId?parseInt(he.dataset.saleId,10):void 0;if(typeof window<"u"&&typeof window.openCreateSaleModal=="function")typeof t=="number"&&!Number.isNaN(t)?window.openCreateSaleModal(t):window.openCreateSaleModal();else{const r=document.getElementById("createSaleModal");r&&r.classList.remove("hidden")}S&&S()}catch{}return}const Ve=s('[data-action="overlay-close"]');if(Ve&&a.target===Ve){a.preventDefault(),Ve.classList.add("hidden");try{typeof S=="function"&&S()}catch{}return}if(s('[data-action="close-admin-modal"]')){a.preventDefault();const t=d.closest("#databaseTablesModal, .admin-modal-overlay, .fixed.inset-0");t&&t.classList.add("hidden");try{typeof S=="function"&&S()}catch{}try{typeof window<"u"&&typeof window.closeDatabaseTablesModal=="function"&&window.closeDatabaseTablesModal()}catch{}return}if(s('[data-action="open-square-settings"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.openSquareSettingsModal=="function")window.openSquareSettingsModal();else{const t=document.getElementById("squareSettingsModal");t&&t.classList.remove("hidden")}try{typeof window.loadSquareSettingsClient=="function"&&window.loadSquareSettingsClient()}catch{}typeof S=="function"&&S()}catch{}return}if(s('[data-action="square-test-connection"]')){a.preventDefault();try{typeof window<"u"&&typeof window.testSquareConnection=="function"?window.testSquareConnection():typeof window<"u"&&typeof window.testSquareConnectionClient=="function"&&window.testSquareConnectionClient()}catch{}return}if(s('[data-action="square-save-settings"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveSquareSettings=="function"?window.saveSquareSettings():typeof window<"u"&&typeof window.saveSquareSettingsClient=="function"&&window.saveSquareSettingsClient()}catch{}return}if(s('[data-action="square-sync-items"]')){a.preventDefault();try{typeof window<"u"&&typeof window.syncItemsToSquare=="function"?window.syncItemsToSquare():typeof window<"u"&&typeof window.syncItemsToSquareClient=="function"&&window.syncItemsToSquareClient()}catch{}return}if(s('[data-action="square-clear-token"]')){a.preventDefault();try{typeof window<"u"&&typeof window.clearSquareTokenClient=="function"&&window.clearSquareTokenClient()}catch{}return}if(s('[data-action="open-receipt-settings"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.openReceiptSettingsModal=="function")window.openReceiptSettingsModal();else{const t=document.getElementById("receiptSettingsModal");t&&t.classList.remove("hidden")}typeof S=="function"&&S()}catch{}return}const Xt=s('[data-action="receipt-tab"]');if(Xt){a.preventDefault();try{const t=Xt.dataset.tab;["shipping","items","categories","default"].forEach(w=>{const E=document.querySelector(`[data-action="receipt-tab"][data-tab="${w}"]`);E&&E.classList.toggle("active",w===t);const z=document.getElementById(`${w}Tab`);z&&z.classList.toggle("active",w===t),z&&z.classList.toggle("hidden",w!==t)}),typeof window<"u"&&typeof window.switchReceiptTab=="function"&&window.switchReceiptTab(t)}catch{}return}if(s('[data-action="receipt-add-shipping"]')){a.preventDefault();try{typeof window<"u"&&typeof window.addShippingMessage=="function"&&window.addShippingMessage()}catch{}return}if(s('[data-action="receipt-add-item-count"]')){a.preventDefault();try{typeof window<"u"&&typeof window.addItemCountMessage=="function"&&window.addItemCountMessage()}catch{}return}if(s('[data-action="receipt-add-category"]')){a.preventDefault();try{typeof window<"u"&&typeof window.addCategoryMessage=="function"&&window.addCategoryMessage()}catch{}return}const eo=s('[data-action="receipt-delete-message"]');if(eo){a.preventDefault();const t=parseInt(eo.dataset.messageId,10);try{typeof window<"u"&&typeof window.deleteReceiptMessage=="function"&&window.deleteReceiptMessage(t)}catch{}return}const Ue=s('[data-action="receipt-generate-ai"]');if(Ue){a.preventDefault();const t=parseInt(Ue.dataset.messageId,10),r=Ue.dataset.type;try{typeof window<"u"&&typeof window.generateAIMessage=="function"&&window.generateAIMessage(t,r)}catch{}return}if(s('[data-action="sale-select-all"]')){a.preventDefault();try{typeof window<"u"&&typeof window.selectAllItems=="function"&&window.selectAllItems()}catch{}return}if(s('[data-action="sale-deselect-all"]')){a.preventDefault();try{typeof window<"u"&&typeof window.deselectAllItems=="function"&&window.deselectAllItems()}catch{}return}const to=s('[data-action="sale-toggle-active"]');if(to){a.preventDefault();const t=parseInt(to.dataset.saleId,10);try{typeof window<"u"&&typeof window.toggleSaleActive=="function"&&window.toggleSaleActive(t)}catch{}return}const oo=s('[data-action="sale-delete"]');if(oo){a.preventDefault();const t=parseInt(oo.dataset.saleId,10);try{typeof window<"u"&&typeof window.deleteSale=="function"&&window.deleteSale(t)}catch{}return}const no=s('[data-action="sale-edit"]');if(no){a.preventDefault();const t=parseInt(no.dataset.saleId,10);try{typeof window<"u"&&typeof window.openCreateSaleModal=="function"&&window.openCreateSaleModal(t)}catch{}return}const ao=s('[data-action="category-edit-name"]');if(ao){a.preventDefault();try{typeof window<"u"&&typeof window.startEditCategory=="function"&&window.startEditCategory(ao)}catch{}return}const io=s('[data-action="category-edit-sku"]');if(io){a.preventDefault();try{typeof window<"u"&&typeof window.startEditSkuCode=="function"&&window.startEditSkuCode(io)}catch{}return}const so=s('[data-action="category-delete"]');if(so){a.preventDefault();const t=so.dataset.category;try{typeof window<"u"&&typeof window.deleteCategory=="function"&&window.deleteCategory(t)}catch{}return}if(s('[data-action="help-show-form"]')){a.preventDefault();try{typeof window<"u"&&typeof window.showHelpHintForm=="function"&&window.showHelpHintForm()}catch{}return}if(s('[data-action="help-hide-form"]')){a.preventDefault();try{typeof window<"u"&&typeof window.hideHelpHintForm=="function"&&window.hideHelpHintForm()}catch{}return}if(s('[data-action="help-bulk-apply"]')){a.preventDefault();try{typeof window<"u"&&typeof window.bulkToggleHints=="function"&&window.bulkToggleHints()}catch{}return}if(s('[data-action="help-export"]')){a.preventDefault();try{typeof window<"u"&&typeof window.exportHelpHints=="function"&&window.exportHelpHints()}catch{}return}if(s('[data-action="help-trigger-import"]')){a.preventDefault();const t=document.getElementById("importFile");t&&t.click();return}if(s('[data-action="show-add-color-form"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.showAddColorForm=="function")window.showAddColorForm();else{const t=document.getElementById("addColorForm");t&&t.classList.remove("hidden")}}catch{}return}if(s('[data-action="cancel-add-color"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.cancelAddColor=="function")window.cancelAddColor();else{const t=document.getElementById("addColorForm");t&&(t.classList.add("hidden"),t.querySelectorAll("input").forEach(w=>{try{w.value=""}catch{}}))}}catch{}return}if(s('[data-action="show-add-size-form"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.showAddSizeForm=="function")window.showAddSizeForm();else{const t=document.getElementById("addSizeForm");t&&t.classList.remove("hidden")}}catch{}return}if(s('[data-action="cancel-add-size"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.cancelAddSize=="function")window.cancelAddSize();else{const t=document.getElementById("addSizeForm");t&&(t.classList.add("hidden"),t.querySelectorAll("input").forEach(w=>{try{w.value=""}catch{}}))}}catch{}return}const ro=s('[data-action="help-edit-hint"]');if(ro){a.preventDefault();const t=parseInt(ro.dataset.id,10);try{typeof window<"u"&&typeof window.editHelpHint=="function"&&window.editHelpHint(t)}catch{}return}const lo=s('[data-action="help-toggle-hint"]');if(lo){a.preventDefault();const t=parseInt(lo.dataset.id,10);try{typeof window<"u"&&typeof window.toggleHelpHint=="function"&&window.toggleHelpHint(t)}catch{}return}const co=s('[data-action="help-delete-hint"]');if(co){a.preventDefault();const t=parseInt(co.dataset.id,10);try{typeof window<"u"&&typeof window.deleteHelpHint=="function"&&window.deleteHelpHint(t)}catch{}return}if(s('[data-action="logs-search"]')){a.preventDefault();try{typeof window<"u"&&typeof window.searchAllLogs=="function"&&window.searchAllLogs()}catch{}return}if(s('[data-action="logs-refresh"], [data-action="logs-refresh-current"]')){a.preventDefault();try{typeof window<"u"&&typeof window.refreshCurrentLog=="function"&&window.refreshCurrentLog()}catch{}return}if(s('[data-action="logs-download"]')){a.preventDefault();try{typeof window<"u"&&typeof window.downloadCurrentLog=="function"&&window.downloadCurrentLog()}catch{}return}if(s('[data-action="logs-clear"]')){a.preventDefault();try{typeof window<"u"&&typeof window.clearCurrentLog=="function"&&window.clearCurrentLog()}catch{}return}if(s('[data-action="logs-cleanup"]')){a.preventDefault();try{typeof window<"u"&&typeof window.cleanupOldLogs=="function"&&window.cleanupOldLogs()}catch{}return}if(s('[data-action="logs-prev-page"]')){a.preventDefault();try{typeof window<"u"&&typeof window.previousLogPage=="function"&&window.previousLogPage()}catch{}return}if(s('[data-action="logs-next-page"]')){a.preventDefault();try{typeof window<"u"&&typeof window.nextLogPage=="function"&&window.nextLogPage()}catch{}return}if(s('[data-action="docs-search"]')){a.preventDefault();try{typeof window<"u"&&typeof window.searchDocumentation=="function"&&window.searchDocumentation()}catch{}return}if(s('[data-action="docs-generate-glossary"]')){a.preventDefault();try{typeof window<"u"&&typeof window.generateGlossary=="function"&&window.generateGlossary()}catch{}return}if(s('[data-action="docs-prev-doc"]')){a.preventDefault();try{typeof window<"u"&&typeof window.previousDocument=="function"&&window.previousDocument()}catch{}return}if(s('[data-action="docs-next-doc"]')){a.preventDefault();try{typeof window<"u"&&typeof window.nextDocument=="function"&&window.nextDocument()}catch{}return}if(s('[data-action="db-execute-query"]')){a.preventDefault();try{typeof window<"u"&&typeof window.executeQuery=="function"&&window.executeQuery()}catch{}return}const K=s('[data-action="db-switch-tab"], [data-action="db-tab"]');if(K){a.preventDefault();const t=K.dataset.tab;if(!t)return;try{if(typeof window<"u"&&typeof window.switchDatabaseTab=="function")window.switchDatabaseTab(K,t);else if(typeof switchDatabaseTab=="function")switchDatabaseTab(K,t);else{document.querySelectorAll(".db-tab").forEach(w=>w.classList.remove("active")),K.classList.add("active"),document.querySelectorAll(".db-tab-content").forEach(w=>w.classList.add("hidden"));const r=document.getElementById(`${t}Tab`);r&&r.classList.remove("hidden")}}catch{}return}if(s('[data-action="db-prev-page"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.previousPage=="function"){try{window.event=a}catch{}window.previousPage()}}catch{}return}if(s('[data-action="db-next-page"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.nextPage=="function"){try{window.event=a}catch{}window.nextPage()}}catch{}return}const be=s('[data-action="db-sort"]');if(be){a.preventDefault();const t=be.dataset.table,r=be.dataset.col,w=be.dataset.order||"ASC";try{typeof window<"u"&&typeof window.sortTableData=="function"&&window.sortTableData(t,r,w)}catch{}return}const Ge=s('[data-action="db-start-cell-edit"]');if(Ge){a.preventDefault();const t=Ge.dataset.table||"";try{typeof window<"u"&&typeof window.startCellEdit=="function"&&window.startCellEdit(Ge,t)}catch{}return}const fo=s('[data-action="db-save-cell-edit"]');if(fo){a.preventDefault();try{if(typeof window<"u")try{window.event=a}catch{}}catch{}try{typeof window<"u"&&typeof window.saveCellEdit=="function"&&window.saveCellEdit(fo,a)}catch{}return}const uo=s('[data-action="db-cancel-cell-edit"]');if(uo){a.preventDefault();try{if(typeof window<"u")try{window.event=a}catch{}}catch{}try{typeof window<"u"&&typeof window.cancelCellEdit=="function"&&window.cancelCellEdit(uo,a)}catch{}return}if(s('[data-action="scan-db"]')){a.preventDefault(),tn();return}if(s('[data-action="convert-db"]')){a.preventDefault(),on(a);return}if(s('[data-action="open-conversion-tool"]')){a.preventDefault(),nn();return}if(s('[data-action="compact-repair"]')){a.preventDefault(),rn();return}if(s('[data-action="toggle-backup-tables"]')){a.preventDefault(),an();return}if(s('[data-action="close-table-view"]')){a.preventDefault(),dn();return}const Q=s('[data-action="view-table"]');if(Q){a.preventDefault();let t=Q.dataset.table||Q.dataset.tableName;if(!t&&Q.dataset.onclickLegacy)try{const r=Q.dataset.onclickLegacy.match(/viewTable\((?:'([^']+)'|\"([^\"]+)\"|([^\)]+))\)/);t=(r&&(r[1]||r[2]||r[3]||"")).toString().trim()}catch{}t?sn(t):console.warn("[AdminSettings] view-table clicked but no table name found");return}if(s('[data-action="update-db-config"]')){a.preventDefault(),ln(a);return}if(s('[data-action="test-ssl"]')){a.preventDefault(),cn(a);return}if(s('[data-action="perform-export"]')){a.preventDefault(),typeof window<"u"&&typeof window.performExport=="function"?window.performExport():typeof performExport=="function"?performExport():console.warn("[AdminSettings] performExport not found");return}if(s('[data-action="import-sql"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.importSQLFile=="function"?window.importSQLFile:typeof importSQLFile=="function"?importSQLFile:null;t?t():console.warn("[AdminSettings] importSQLFile not found");return}if(s('[data-action="import-csv"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.importCSVFile=="function"?window.importCSVFile:typeof importCSVFile=="function"?importCSVFile:null;t?t():console.warn("[AdminSettings] importCSVFile not found");return}if(s('[data-action="import-json"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.importJSONFile=="function"?window.importJSONFile:typeof importJSONFile=="function"?importJSONFile:null;t?t():console.warn("[AdminSettings] importJSONFile not found");return}if(s('[data-action="open-db-maintenance"]')){a.preventDefault();try{typeof window<"u"&&typeof window.openDatabaseMaintenanceModal=="function"?window.openDatabaseMaintenanceModal():typeof openDatabaseMaintenanceModal=="function"?openDatabaseMaintenanceModal():console.warn("[AdminSettings] openDatabaseMaintenanceModal not found")}catch(t){console.warn("[AdminSettings] open-db-maintenance error",t)}return}const J=s('[data-action="db-switch-tab"]');if(J){a.preventDefault();const t=J.dataset.tab;if(!t){console.warn("[AdminSettings] db-switch-tab clicked without data-tab");return}try{if(typeof window<"u"&&typeof window.switchDatabaseTab=="function")window.switchDatabaseTab(J,t);else if(typeof switchDatabaseTab=="function")switchDatabaseTab(J,t);else{document.querySelectorAll(".admin-tab").forEach(w=>w.classList.remove("active")),J.classList.add("active"),document.querySelectorAll(".db-tab-content").forEach(w=>w.classList.add("hidden"));const r=document.getElementById(`${t}Tab`);r&&r.classList.remove("hidden")}}catch(r){console.warn("[AdminSettings] switchDatabaseTab failed",r)}return}if(s('[data-action="test-db-connection"]')){a.preventDefault();try{try{typeof window<"u"&&(window.event=a)}catch{}typeof window<"u"&&typeof window.testDatabaseConnection=="function"?window.testDatabaseConnection(a):typeof testDatabaseConnection=="function"?testDatabaseConnection(a):console.warn("[AdminSettings] testDatabaseConnection not found")}catch(t){console.warn("[AdminSettings] testDatabaseConnection error",t)}return}if(s('[data-action="refresh-db-stats"]')){a.preventDefault();try{typeof window<"u"&&typeof window.refreshDatabaseStats=="function"?window.refreshDatabaseStats():typeof refreshDatabaseStats=="function"?refreshDatabaseStats():typeof window.loadDatabaseStats=="function"?window.loadDatabaseStats():typeof loadDatabaseStats=="function"?loadDatabaseStats():console.warn("[AdminSettings] refresh/load DatabaseStats functions not found")}catch(t){console.warn("[AdminSettings] refresh-db-stats error",t)}return}if(s('[data-action="custom-notification-ok"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeCustomNotification=="function")window.closeCustomNotification();else if(typeof closeCustomNotification=="function")closeCustomNotification();else{const t=s(".admin-modal-overlay");t&&t.remove()}}catch{const r=s(".admin-modal-overlay");r&&r.remove()}return}if(s('[data-action="execute-query"]')){a.preventDefault();try{typeof window<"u"&&typeof window.executeQuery=="function"?window.executeQuery():typeof executeQuery=="function"?executeQuery():console.warn("[AdminSettings] executeQuery not found")}catch(t){console.warn("[AdminSettings] execute-query error",t)}return}if(s('[data-action="clear-query"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.clearQuery=="function")window.clearQuery();else if(typeof clearQuery=="function")clearQuery();else{const t=document.getElementById("sqlQuery");t&&(t.value="");const r=document.getElementById("queryResults");r&&r.classList.add("hidden")}}catch(t){console.warn("[AdminSettings] clear-query error",t)}return}if(s('[data-action="load-query-templates"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.loadQueryTemplates=="function")window.loadQueryTemplates();else if(typeof loadQueryTemplates=="function")loadQueryTemplates();else{const t=document.getElementById("queryTemplatesModal");t&&t.classList.toggle("hidden")}}catch(t){console.warn("[AdminSettings] load-query-templates error",t)}return}if(s('[data-action="hide-query-templates"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.hideQueryTemplates=="function")window.hideQueryTemplates();else if(typeof hideQueryTemplates=="function")hideQueryTemplates();else{const t=document.getElementById("queryTemplatesModal");t&&t.classList.add("hidden")}}catch(t){console.warn("[AdminSettings] hide-query-templates error",t)}return}const po=s('[data-action="insert-template"]');if(po){a.preventDefault();const t=po.dataset.template||"";try{if(typeof window<"u"&&typeof window.insertTemplate=="function")window.insertTemplate(t);else if(typeof insertTemplate=="function")insertTemplate(t);else{const r=document.getElementById("sqlQuery");r&&(r.value=t);const w=document.getElementById("queryTemplatesModal");w&&w.classList.add("hidden")}}catch(r){console.warn("[AdminSettings] insert-template error",r)}return}if(s('[data-action="run-log-cleanup"]')){a.preventDefault();try{typeof window<"u"&&typeof window.runLogCleanup=="function"?window.runLogCleanup():typeof runLogCleanup=="function"&&runLogCleanup()}catch{}return}if(s('[data-action="download-logs"]')){a.preventDefault();try{typeof window<"u"&&typeof window.downloadLogs=="function"?window.downloadLogs():typeof downloadLogs=="function"&&downloadLogs()}catch{}return}if(s('[data-action="db-init"]')){a.preventDefault();try{typeof window<"u"&&typeof window.initializeDatabase=="function"?window.initializeDatabase():typeof initializeDatabase=="function"&&initializeDatabase()}catch{}return}if(s('[data-action="db-optimize"]')){a.preventDefault();try{typeof window<"u"&&typeof window.optimizeAllTables=="function"?window.optimizeAllTables():typeof optimizeAllTables=="function"&&optimizeAllTables()}catch{}return}if(s('[data-action="db-analyze-indexes"]')){a.preventDefault();try{typeof window<"u"&&typeof window.analyzeIndexes=="function"?window.analyzeIndexes():typeof analyzeIndexes=="function"&&analyzeIndexes()}catch{}return}if(s('[data-action="db-cleanup"]')){a.preventDefault();try{typeof window<"u"&&typeof window.cleanupDatabase=="function"?window.cleanupDatabase():typeof cleanupDatabase=="function"&&cleanupDatabase()}catch{}return}if(s('[data-action="db-repair"]')){a.preventDefault();try{typeof window<"u"&&typeof window.repairTables=="function"?window.repairTables():typeof repairTables=="function"&&repairTables()}catch{}return}if(s('[data-action="db-analyze-size"]')){a.preventDefault();try{typeof window<"u"&&typeof window.analyzeDatabaseSize=="function"?window.analyzeDatabaseSize():typeof analyzeDatabaseSize=="function"&&analyzeDatabaseSize()}catch{}return}if(s('[data-action="db-performance-monitor"]')){a.preventDefault();try{typeof window<"u"&&typeof window.showPerformanceMonitor=="function"?window.showPerformanceMonitor():typeof showPerformanceMonitor=="function"&&showPerformanceMonitor()}catch{}return}if(s('[data-action="db-check-foreign-keys"]')){a.preventDefault();try{typeof window<"u"&&typeof window.checkForeignKeys=="function"?window.checkForeignKeys():typeof checkForeignKeys=="function"&&checkForeignKeys()}catch{}return}if(s('[data-action="db-show-export-tools"]')){a.preventDefault();try{typeof window<"u"&&typeof window.showExportTools=="function"?window.showExportTools():typeof showExportTools=="function"&&showExportTools()}catch{}return}if(s('[data-action="db-show-import-tools"]')){a.preventDefault();try{typeof window<"u"&&typeof window.showImportTools=="function"?window.showImportTools():typeof showImportTools=="function"&&showImportTools()}catch{}return}if(s('[data-action="db-show-schema-browser"]')){a.preventDefault();try{typeof window<"u"&&typeof window.showSchemaBrowser=="function"?window.showSchemaBrowser():typeof showSchemaBrowser=="function"&&showSchemaBrowser()}catch{}return}if(s('[data-action="clear-tool-results"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.clearToolResults=="function")window.clearToolResults();else if(typeof clearToolResults=="function")clearToolResults();else{const t=document.querySelector("#toolResultsContainer");t&&(t.innerHTML="")}}catch{}return}if(s('[data-action="css-load-rules"]')){a.preventDefault();try{typeof window<"u"&&typeof window.loadCSSRules=="function"?window.loadCSSRules():typeof loadCSSRules=="function"&&loadCSSRules()}catch{}return}const mo=s('[data-action="css-tab"]');if(mo){a.preventDefault();const t=mo.dataset.tab;try{typeof window<"u"&&typeof window.switchCSSTab=="function"?window.switchCSSTab(t):typeof switchCSSTab=="function"&&switchCSSTab(t)}catch{}return}if(s('[data-action="css-reset-defaults"]')){a.preventDefault();try{typeof window<"u"&&typeof window.resetCSSToDefaults=="function"?window.resetCSSToDefaults():typeof resetCSSToDefaults=="function"&&resetCSSToDefaults()}catch{}return}if(s('[data-action="css-preview"]')){a.preventDefault();try{typeof window<"u"&&typeof window.previewChanges=="function"?window.previewChanges():typeof previewChanges=="function"&&previewChanges()}catch{}return}if(s('[data-action="css-save"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveCSSRules=="function"?window.saveCSSRules():typeof saveCSSRules=="function"&&saveCSSRules()}catch{}return}if(s('[data-action="open-template-manager"]')){a.preventDefault();try{typeof _t=="function"?_t():typeof window<"u"&&typeof window.openTemplateManagerModal=="function"&&window.openTemplateManagerModal()}catch{}return}const wo=s('[data-action="tm-switch-tab"]');if(wo){a.preventDefault();const t=wo.dataset.tab;try{typeof window<"u"&&typeof window.switchTemplateTab=="function"?window.switchTemplateTab(t):typeof xt=="function"&&xt(t)}catch{}return}if(s('[data-action="template-manager-close"]')){a.preventDefault();try{typeof St=="function"?St():typeof window<"u"&&typeof window.closeTemplateManagerModal=="function"&&window.closeTemplateManagerModal()}catch{}return}if(s('[data-action="tm-create-color-template"]')){a.preventDefault();try{typeof window<"u"&&typeof window.createNewColorTemplate=="function"?window.createNewColorTemplate():typeof Mt=="function"&&Mt()}catch{}return}if(s('[data-action="tm-create-size-template"]')){a.preventDefault();try{typeof window<"u"&&typeof window.createNewSizeTemplate=="function"?window.createNewSizeTemplate():typeof Bt=="function"&&Bt()}catch{}return}if(s('[data-action="tm-create-cost-template"]')){a.preventDefault();try{typeof window<"u"&&typeof window.createNewCostTemplate=="function"?window.createNewCostTemplate():typeof createNewCostTemplate=="function"?createNewCostTemplate():console.warn("[AdminSettings] createNewCostTemplate not found")}catch{}return}if(s('[data-action="tm-refresh-suggestion-history"]')){a.preventDefault();try{typeof window<"u"&&typeof window.refreshSuggestionHistory=="function"?window.refreshSuggestionHistory():typeof refreshSuggestionHistory=="function"&&refreshSuggestionHistory()}catch{}return}if(s('[data-action="tm-create-email-template"]')){a.preventDefault();try{typeof window<"u"&&typeof window.createNewEmailTemplate=="function"?window.createNewEmailTemplate():typeof Ct=="function"&&Ct()}catch{}return}const yo=s('[data-action="tm-edit-color-template"]');if(yo){a.preventDefault();const t=parseInt(yo.dataset.id||"-1",10);if(!isNaN(t))try{wn(t)}catch{}return}const go=s('[data-action="tm-delete-color-template"]');if(go){a.preventDefault();const t=parseInt(go.dataset.id||"-1",10);if(!isNaN(t))try{yn(t)}catch{}return}const vo=s('[data-action="tm-edit-size-template"]');if(vo){a.preventDefault();const t=parseInt(vo.dataset.id||"-1",10);if(!isNaN(t))try{_n(t)}catch{}return}const ho=s('[data-action="tm-delete-size-template"]');if(ho){a.preventDefault();const t=parseInt(ho.dataset.id||"-1",10);if(!isNaN(t))try{Sn(t)}catch{}return}if(s('[data-action="color-template-add-color"]')){a.preventDefault();try{ze()}catch{}return}const bo=s('[data-action="color-template-remove-color"]');if(bo){a.preventDefault();const t=parseInt(bo.dataset.index||"-1",10);if(!isNaN(t))try{vn(t)}catch{}return}if(d.closest('#colorTemplateEditModal [data-action="close-color-template-modal"]')){a.preventDefault();try{typeof P=="function"?P():typeof window<"u"&&typeof window.closeColorTemplateEditModal=="function"&&window.closeColorTemplateEditModal()}catch{}return}const _o=document.getElementById("colorTemplateEditModal");if(_o&&d===_o){a.preventDefault();try{typeof P=="function"?P():typeof window<"u"&&typeof window.closeColorTemplateEditModal=="function"&&window.closeColorTemplateEditModal()}catch{}return}if(s('[data-action="size-template-add-size"]')){a.preventDefault();try{Fe()}catch{}return}const So=s('[data-action="size-template-remove-size"]');if(So){a.preventDefault();const t=parseInt(So.dataset.index||"-1",10);if(!isNaN(t))try{En(t)}catch{}return}if(d.closest('#sizeTemplateEditModal [data-action="close-size-template-modal"]')){a.preventDefault();try{typeof N=="function"?N():typeof window<"u"&&typeof window.closeSizeTemplateEditModal=="function"&&window.closeSizeTemplateEditModal()}catch{}return}const xo=document.getElementById("sizeTemplateEditModal");if(xo&&d===xo){a.preventDefault();try{typeof N=="function"?N():typeof window<"u"&&typeof window.closeSizeTemplateEditModal=="function"&&window.closeSizeTemplateEditModal()}catch{}return}if(s('[data-action="save-template-assignment"]')){a.preventDefault();try{typeof window<"u"&&typeof window.saveTemplateAssignment=="function"?window.saveTemplateAssignment():typeof we=="function"&&we()}catch{}return}const Eo=s('[data-action="tm-edit-cost-template"]');if(Eo){a.preventDefault();const t=parseInt(Eo.dataset.id||"-1",10);try{typeof window<"u"&&typeof window.editCostTemplate=="function"?window.editCostTemplate(t):typeof editCostTemplate=="function"?editCostTemplate(t):console.warn("[AdminSettings] editCostTemplate not found")}catch{}return}const To=s('[data-action="tm-delete-cost-template"]');if(To){a.preventDefault();const t=parseInt(To.dataset.id||"-1",10);try{typeof window<"u"&&typeof window.deleteCostTemplate=="function"?window.deleteCostTemplate(t):typeof deleteCostTemplate=="function"?deleteCostTemplate(t):console.warn("[AdminSettings] deleteCostTemplate not found")}catch{}return}const Co=s('[data-action="tm-preview-email-template"]');if(Co){a.preventDefault();const t=parseInt(Co.dataset.id||"-1",10);try{typeof window<"u"&&typeof window.previewEmailTemplate=="function"?window.previewEmailTemplate(t):typeof ie=="function"&&ie(t)}catch{}return}const Mo=s('[data-action="tm-send-test-email"]');if(Mo){a.preventDefault();const t=parseInt(Mo.dataset.id||"-1",10);try{if(typeof window<"u"&&typeof window.sendTestEmail=="function"){const r=window.sendTestEmail;typeof r=="function"&&r.length>=1?r(t):r()}else typeof sendTestEmail=="function"?sendTestEmail.length>=1?sendTestEmail(t):sendTestEmail():console.warn("[AdminSettings] sendTestEmail handler not found")}catch{}return}const Io=s('[data-action="tm-edit-email-template"]');if(Io){a.preventDefault();const t=parseInt(Io.dataset.id||"-1",10);try{typeof window<"u"&&typeof window.editEmailTemplate=="function"?window.editEmailTemplate(t):typeof Tt=="function"&&Tt(t)}catch{}return}const Bo=s('[data-action="tm-delete-email-template"]');if(Bo){a.preventDefault();const t=parseInt(Bo.dataset.id||"-1",10);try{typeof window<"u"&&typeof window.deleteEmailTemplate=="function"?window.deleteEmailTemplate(t):typeof se=="function"&&se(t)}catch{}return}{const t=d&&d.matches&&d.matches('[data-action="close-color-template-modal"]'),r=document.getElementById("colorTemplateEditModal");if(t||r&&d===r){a.preventDefault();try{typeof window<"u"&&typeof window.closeColorTemplateEditModal=="function"?window.closeColorTemplateEditModal():typeof P=="function"?P():r&&r.classList.add("hidden")}catch{}return}}{const t=d&&d.matches&&d.matches('[data-action="close-size-template-modal"]'),r=document.getElementById("sizeTemplateEditModal");if(t||r&&d===r){a.preventDefault();try{typeof window<"u"&&typeof window.closeSizeTemplateEditModal=="function"?window.closeSizeTemplateEditModal():typeof N=="function"?N():r&&r.classList.add("hidden")}catch{}return}}if(s('[data-action="retry-load-system-config"]')){a.preventDefault();try{typeof window<"u"&&typeof window.loadSystemConfiguration=="function"?window.loadSystemConfiguration():typeof Po=="function"&&Po()}catch{}return}if(s('[data-action="retry-load-db-info"]')){a.preventDefault();try{typeof window<"u"&&typeof window.loadDatabaseInformation=="function"?window.loadDatabaseInformation():typeof No=="function"&&No()}catch{}return}const We=s('[data-action="close-admin-modal"]');if(We){a.preventDefault();const t=We.closest(".admin-modal-overlay")||We.closest(".admin-modal");if(t){const r=t.id||"";if(r==="roomSettingsModal"&&typeof window<"u"&&typeof window.closeRoomSettingsModal=="function")try{window.closeRoomSettingsModal()}catch{t.classList.add("hidden")}else if(r==="roomCategoryMapperModal"&&typeof window<"u"&&typeof window.closeRoomCategoryMapperModal=="function")try{window.closeRoomCategoryMapperModal()}catch{t.remove()}else if(r==="areaItemMapperModal"&&typeof window<"u"&&typeof window.closeAreaItemMapperModal=="function")try{window.closeAreaItemMapperModal()}catch{t.remove()}else if(r==="systemConfigModal"&&typeof window<"u"&&typeof window.closeSystemConfigModal=="function")try{window.closeSystemConfigModal()}catch{t.remove()}else if(r==="backupModal"&&typeof window<"u"&&typeof window.closeBackupModal=="function")try{window.closeBackupModal()}catch{t.remove()}else if(r==="databaseBackupModal"&&typeof window<"u"&&typeof window.closeDatabaseBackupModal=="function")try{window.closeDatabaseBackupModal()}catch{t.remove()}else if(r==="databaseRestoreModal"&&typeof window<"u"&&typeof window.closeDatabaseRestoreModal=="function")try{window.closeDatabaseRestoreModal()}catch{t.remove()}else if(r==="databaseToolResultsModal"&&typeof window<"u"&&typeof window.closeDatabaseToolResultsModal=="function")try{window.closeDatabaseToolResultsModal()}catch{t.remove()}else if(r==="tableViewModal"&&typeof window<"u"&&typeof window.closeTableViewModal=="function")try{window.closeTableViewModal()}catch{t.remove()}else if(r==="fileExplorerModal"&&typeof window<"u"&&typeof window.closeFileExplorerModal=="function")try{window.closeFileExplorerModal()}catch{t.remove()}else if(r==="cssRulesModal"&&typeof window<"u"&&typeof window.closeCSSRulesModal=="function")try{window.closeCSSRulesModal()}catch{t.remove()}else if(r==="templateManagerModal"&&typeof window<"u"&&typeof window.closeTemplateManagerModal=="function")try{window.closeTemplateManagerModal()}catch{t.remove()}else if(r==="templateAssignmentModal"&&typeof window<"u"&&typeof window.closeTemplateAssignmentModal=="function")try{window.closeTemplateAssignmentModal()}catch{t.remove()}else t.remove()}return}const _e=s('[data-action="modal-cancel"]');if(_e){a.preventDefault();const t=_e.closest(".admin-modal-overlay")||_e.closest(".admin-modal");t&&t.remove();const r=_e.dataset.callback;r&&b(r);return}const Se=s('[data-action="modal-confirm"]');if(Se){a.preventDefault();const t=Se.closest(".admin-modal-overlay")||Se.closest(".admin-modal");t&&t.remove();const r=Se.dataset.callback;r&&b(r);return}const Do=s('[data-action="maintenance-cancel"]');if(Do){a.preventDefault();const t=Do.closest(".admin-modal-overlay");t&&t.remove();try{typeof window<"u"&&typeof window.maintenanceConfirmResolve=="function"&&window.maintenanceConfirmResolve(!1)}catch{}return}const Lo=s('[data-action="maintenance-continue"]');if(Lo){a.preventDefault();const t=Lo.closest(".admin-modal-overlay");t&&t.remove();try{typeof window<"u"&&typeof window.maintenanceConfirmResolve=="function"&&window.maintenanceConfirmResolve(!0)}catch{}return}if(d&&d.matches&&d.matches('[data-action="overlay-close"]')){if(a.target===d){const t=d.id||"";try{t==="roomCategoryManagerModal"&&typeof window.closeRoomCategoryManagerModal=="function"?window.closeRoomCategoryManagerModal():t==="backgroundManagerModal"&&typeof window.closeBackgroundManagerModal=="function"?window.closeBackgroundManagerModal():t==="aiSettingsModal"&&typeof window.closeAISettingsModal=="function"?window.closeAISettingsModal():t==="roomSettingsModal"&&typeof window.closeRoomSettingsModal=="function"?window.closeRoomSettingsModal():t==="systemConfigModal"&&typeof window.closeSystemConfigModal=="function"?window.closeSystemConfigModal():t==="backupModal"&&typeof window.closeBackupModal=="function"?window.closeBackupModal():t==="databaseBackupModal"&&typeof window.closeDatabaseBackupModal=="function"?window.closeDatabaseBackupModal():t==="databaseRestoreModal"&&typeof window.closeDatabaseRestoreModal=="function"?window.closeDatabaseRestoreModal():t==="roomCategoryMapperModal"&&typeof window.closeRoomCategoryMapperModal=="function"?window.closeRoomCategoryMapperModal():t==="areaItemMapperModal"&&typeof window.closeAreaItemMapperModal=="function"?window.closeAreaItemMapperModal():t==="databaseToolResultsModal"&&typeof window.closeDatabaseToolResultsModal=="function"?window.closeDatabaseToolResultsModal():t==="tableViewModal"&&typeof window.closeTableViewModal=="function"?window.closeTableViewModal():t==="fileExplorerModal"&&typeof window.closeFileExplorerModal=="function"?window.closeFileExplorerModal():t==="cssRulesModal"&&typeof window.closeCSSRulesModal=="function"?window.closeCSSRulesModal():t==="templateManagerModal"&&typeof window.closeTemplateManagerModal=="function"?window.closeTemplateManagerModal():t==="templateAssignmentModal"&&typeof window.closeTemplateAssignmentModal=="function"?window.closeTemplateAssignmentModal():d.remove()}catch{d.remove()}}return}const Y=s('[data-action="open-room-category-manager"]');if(Y){a.preventDefault();const t=Y.dataset.room?isNaN(Y.dataset.room)?Y.dataset.room:parseInt(Y.dataset.room,10):null;typeof window.openRoomCategoryManagerModal=="function"?window.openRoomCategoryManagerModal(t):typeof openRoomCategoryManagerModal=="function"&&openRoomCategoryManagerModal(t);return}if(s('[data-action="add-room-category"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.addRoomCategory=="function"?window.addRoomCategory:typeof addRoomCategory=="function"?addRoomCategory:null;t?t():console.warn("[AdminSettings] addRoomCategory not found");return}const ko=s('[data-action="open-background-manager"]');if(ko){a.preventDefault();const t=ko.dataset.room||"",r=typeof window<"u"&&typeof window.openBackgroundManagerModal=="function"?window.openBackgroundManagerModal:typeof x=="function"?x:null;r?r(t):console.warn("[AdminSettings] openBackgroundManagerModal not found");return}const xe=s('[data-action="set-primary-category"]');if(xe){a.preventDefault();const t=xe.dataset.room,r=xe.dataset.categoryId||xe.dataset.categoryid,w=typeof window<"u"&&typeof window.setPrimaryCategory=="function"?window.setPrimaryCategory:typeof setPrimaryCategory=="function"?setPrimaryCategory:null;w&&t!=null&&r!=null?w(isNaN(t)?t:parseInt(t,10),parseInt(r,10)):console.warn("[AdminSettings] setPrimaryCategory missing args or not found");return}const Ke=s('[data-action="remove-room-category"]');if(Ke){a.preventDefault();const t=Ke.dataset.assignmentId||Ke.dataset.assignmentid,r=typeof window<"u"&&typeof window.removeRoomCategory=="function"?window.removeRoomCategory:typeof removeRoomCategory=="function"?removeRoomCategory:null;r&&t!=null?r(parseInt(t,10)):console.warn("[AdminSettings] removeRoomCategory not found");return}if(s('[data-action="upload-background"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.uploadBackground=="function"?window.uploadBackground:typeof B=="function"?B:null;t?t():console.warn("[AdminSettings] uploadBackground not found");return}const Ee=s('[data-action="apply-background"]');if(Ee){a.preventDefault();const t=Ee.dataset.room,r=Ee.dataset.backgroundId||Ee.dataset.backgroundid,w=typeof window<"u"&&typeof window.applyBackground=="function"?window.applyBackground:typeof _=="function"?_:null;w&&t!=null&&r!=null?w(t,parseInt(r,10)):console.warn("[AdminSettings] applyBackground missing args or not found");return}const Z=s('[data-action="delete-background"]');if(Z){a.preventDefault();const t=Z.dataset.backgroundId||Z.dataset.backgroundid,r=Z.dataset.backgroundName||Z.dataset.backgroundname||"",w=typeof window<"u"&&typeof window.deleteBackground=="function"?window.deleteBackground:typeof D=="function"?D:null;w&&t!=null?w(parseInt(t,10),r):console.warn("[AdminSettings] deleteBackground missing args or not found");return}const X=s('[data-action="preview-background"]');if(X){a.preventDefault();const t=X.dataset.imageUrl||X.dataset.imageurl,r=X.dataset.backgroundName||X.dataset.backgroundname||"",w=typeof window<"u"&&typeof window.previewBackground=="function"?window.previewBackground:typeof M=="function"?M:null;w&&t?w(t,r):console.warn("[AdminSettings] previewBackground missing args or not found");return}const Qe=s('[data-action="close-preview"]');if(Qe){a.preventDefault();const t=Qe.closest(".fixed")||Qe.closest(".admin-modal-overlay");t&&t.remove();return}const V=s('[data-action="map-restore"]');if(V){a.preventDefault();const t=parseInt(V.dataset.mapId||V.dataset.mapid||"-1",10),r=V.dataset.mapName||V.dataset.mapname||"",w=(()=>{try{return decodeURIComponent(r)}catch{return r}})(),E=String(V.dataset.apply||"").toLowerCase()==="true",z=typeof window<"u"&&typeof window.restoreMap=="function"?window.restoreMap:typeof restoreMap=="function"?restoreMap:null;z&&t>=0?z(t,w,E):console.warn("[AdminSettings] restoreMap not found or bad args");return}const ee=s('[data-action="map-preview"]');if(ee){a.preventDefault();const t=parseInt(ee.dataset.mapId||ee.dataset.mapid||"-1",10),r=ee.dataset.mapName||ee.dataset.mapname||"",w=(()=>{try{return decodeURIComponent(r)}catch{return r}})(),E=typeof window<"u"&&typeof window.previewHistoricalMap=="function"?window.previewHistoricalMap:typeof previewHistoricalMap=="function"?previewHistoricalMap:null;E&&t>=0?E(t,w):console.warn("[AdminSettings] previewHistoricalMap not found or bad args");return}const te=s('[data-action="map-delete"]');if(te){a.preventDefault();const t=parseInt(te.dataset.mapId||te.dataset.mapid||"-1",10),r=te.dataset.mapName||te.dataset.mapname||"",w=(()=>{try{return decodeURIComponent(r)}catch{return r}})(),E=typeof window<"u"&&typeof window.deleteHistoricalMap=="function"?window.deleteHistoricalMap:typeof deleteHistoricalMap=="function"?deleteHistoricalMap:null;E&&t>=0?E(t,w):console.warn("[AdminSettings] deleteHistoricalMap not found or bad args");return}const Je=s('[data-action="email-view"]');if(Je){a.preventDefault();const t=parseInt(Je.dataset.emailId||Je.dataset.emailid||"-1",10),r=typeof window<"u"&&typeof window.viewEmailDetails=="function"?window.viewEmailDetails:typeof viewEmailDetails=="function"?viewEmailDetails:null;r&&t>=0?r(t):console.warn("[AdminSettings] viewEmailDetails not found or bad id");return}const Ye=s('[data-action="email-edit-resend"]');if(Ye){a.preventDefault();const t=parseInt(Ye.dataset.emailId||Ye.dataset.emailid||"-1",10),r=typeof window<"u"&&typeof window.editAndResendEmail=="function"?window.editAndResendEmail:typeof editAndResendEmail=="function"?editAndResendEmail:null;r&&t>=0?r(t):console.warn("[AdminSettings] editAndResendEmail not found or bad id");return}if(s('[data-action="email-history-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeEmailHistoryModal=="function")window.closeEmailHistoryModal();else{const t=document.getElementById("emailHistoryModal")||document.querySelector("#emailHistoryModal");t&&t.remove()}}catch{}return}if(s('[data-action="email-history-filter"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.loadEmailHistory=="function"?window.loadEmailHistory:typeof loadEmailHistory=="function"?loadEmailHistory:null;t?t():console.warn("[AdminSettings] loadEmailHistory not found");return}const Ao=s('[data-action="email-history-page"]');if(Ao){a.preventDefault();const t=Ao.dataset.direction||"",r=typeof window<"u"&&typeof window.loadEmailHistoryPage=="function"?window.loadEmailHistoryPage:typeof loadEmailHistoryPage=="function"?loadEmailHistoryPage:null;r&&t?r(t):console.warn("[AdminSettings] loadEmailHistoryPage not found or dir missing");return}if(s('[data-action="email-edit-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeEmailEditModal=="function")window.closeEmailEditModal();else{const t=document.getElementById("emailEditModal");t&&t.remove()}}catch{}return}if(s('[data-action="email-template-edit-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeEmailEditModal=="function")window.closeEmailEditModal();else{const t=document.getElementById("emailTemplateEditModal");t&&t.remove()}try{S()}catch{}}catch{}return}const U=s('[data-action="dismiss-notification"]');if(U){a.preventDefault();const t=U.closest(".bg-green-100")||U.closest(".shadow-lg")||U.parentElement&&U.parentElement.parentElement||U.closest(".admin-modal-overlay");t&&t.remove&&t.remove();return}if(s('[data-action="email-config-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeEmailConfigModal=="function")window.closeEmailConfigModal();else{const t=document.getElementById("emailConfigModal");t&&t.remove()}}catch{}return}if(s('[data-action="email-send-test"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.sendTestEmail=="function"?window.sendTestEmail:typeof sendTestEmail=="function"?sendTestEmail:null;t?t():console.warn("[AdminSettings] sendTestEmail not found");return}if(s('[data-action="template-manager-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeTemplateManagerModal=="function")window.closeTemplateManagerModal();else{const r=document.getElementById("templateManagerModal")||document.querySelector("#templateManagerModal")||document.querySelector("#emailTemplateManagerModal")||document.querySelector("#templateManagerModal .admin-modal-overlay")||document.querySelector(".admin-modal-overlay");r&&r.remove()}}catch{}return}if(s('[data-action="email-template-edit-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeEmailTemplateEditModal=="function")window.closeEmailTemplateEditModal();else{const t=document.getElementById("emailTemplateEditModal");t&&t.remove()}try{S()}catch{}}catch{}return}if(s('[data-action="email-template-save"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.saveEmailTemplate=="function"?window.saveEmailTemplate:typeof pe=="function"?pe:null;t?t():console.warn("[AdminSettings] saveEmailTemplate not found");return}if(s('[data-action="email-template-preview-close"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeEmailTemplatePreviewModal=="function")window.closeEmailTemplatePreviewModal();else{const t=document.getElementById("emailTemplatePreviewModal");t&&t.remove()}try{S()}catch{}}catch{}return}const Ze=s('[data-action="tm-preview-email-template"]');if(Ze){a.preventDefault();const t=Ze.dataset.id||Ze.getAttribute("data-id")||"";if(!t){console.warn("[AdminSettings] preview: missing template id");return}try{typeof ie=="function"?ie(t):typeof window<"u"&&typeof window.previewEmailTemplate=="function"?window.previewEmailTemplate(t):console.warn("[AdminSettings] previewEmailTemplate not found")}catch(r){console.error("[AdminSettings] preview handler error",r)}return}const Xe=s('[data-action="tm-edit-email-template"]');if(Xe){a.preventDefault();const t=Xe.dataset.id||Xe.getAttribute("data-id")||"";if(!t){console.warn("[AdminSettings] edit: missing template id");return}try{typeof window<"u"&&typeof window.editEmailTemplate=="function"?window.editEmailTemplate(t):typeof window<"u"&&typeof window.showEmailTemplateEditModal=="function"?fetch(`/api/email_templates.php?action=get_template&template_id=${encodeURIComponent(t)}`).then(r=>r.json()).then(r=>{r&&r.success?window.showEmailTemplateEditModal(r.template):typeof window.showError=="function"&&window.showError("Failed to load template")}).catch(r=>console.error("[AdminSettings] edit fetch error",r)):console.warn("[AdminSettings] editEmailTemplate/showEmailTemplateEditModal not found")}catch(r){console.error("[AdminSettings] edit handler error",r)}return}const et=s('[data-action="tm-delete-email-template"]');if(et){a.preventDefault();const t=et.dataset.id||et.getAttribute("data-id")||"";if(!t){console.warn("[AdminSettings] delete: missing template id");return}try{typeof window<"u"&&typeof window.deleteEmailTemplate=="function"?window.deleteEmailTemplate(t):typeof se=="function"?se(t):console.warn("[AdminSettings] deleteEmailTemplate not found")}catch(r){console.error("[AdminSettings] delete handler error",r)}return}const tt=s('[data-action="tm-send-test-email"]');if(tt){a.preventDefault();const t=tt.dataset.id||tt.getAttribute("data-id")||"";try{typeof window<"u"&&typeof window.sendTestEmailTemplate=="function"?window.sendTestEmailTemplate(t):typeof window<"u"&&typeof window.sendTestEmail=="function"?window.sendTestEmail():(console.warn("[AdminSettings] send test email not implemented"),typeof window<"u"&&typeof window.showError=="function"&&window.showError("Send test email is not implemented yet."))}catch(r){console.error("[AdminSettings] test handler error",r)}return}if(s('[data-action="area-mapping-add"]')){a.preventDefault();try{typeof window<"u"&&typeof window.addAreaMapping=="function"?window.addAreaMapping():typeof addAreaMapping=="function"&&addAreaMapping()}catch{}return}const ot=s('[data-action="area-mapping-remove"]');if(ot){a.preventDefault();const t=parseInt(ot.dataset.mappingId||ot.dataset.mappingid||"-1",10);try{typeof window<"u"&&typeof window.removeAreaMapping=="function"?window.removeAreaMapping(t):typeof removeAreaMapping=="function"&&removeAreaMapping(t)}catch{}return}if(s('[data-action="ai-close-settings"]')){a.preventDefault();try{if(typeof window<"u"&&typeof window.closeAISettingsModal=="function")window.closeAISettingsModal();else{const t=document.getElementById("aiSettingsModal");t&&t.remove()}}catch{}return}if(s('[data-action="ai-save-settings"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.saveAISettings=="function"?window.saveAISettings:typeof mt=="function"?mt:null;t?t():console.warn("[AdminSettings] saveAISettings not found");return}if(s('[data-action="ai-test-provider"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.testAIProvider=="function"?window.testAIProvider:typeof yt=="function"?yt:null;t?t():console.warn("[AdminSettings] testAIProvider not found");return}const zo=s('[data-action="ai-toggle-section"]');if(zo){a.preventDefault();const t=zo.dataset.section;try{if(typeof window<"u"&&typeof window.toggleSection=="function")window.toggleSection(t);else if(t){const r=document.getElementById(`${t}-content`),w=document.getElementById(`${t}-icon`);r&&r.classList.toggle("hidden"),w&&(w.textContent=r&&!r.classList.contains("hidden")?"▼":"▶")}}catch{}return}const Oo=s('[data-action="ai-refresh-models"]');if(Oo){a.preventDefault();const t=Oo.dataset.provider,r=typeof window<"u"&&typeof window.refreshModels=="function"?window.refreshModels:typeof ke=="function"?ke:null;r&&t?r(t):console.warn("[AdminSettings] refreshModels not found or provider missing");return}if(s('[data-action="ai-manage-brand-voice"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.manageBrandVoiceOptions=="function"?window.manageBrandVoiceOptions:typeof rt=="function"?rt:null;t?t():console.warn("[AdminSettings] manageBrandVoiceOptions not found");return}if(s('[data-action="ai-manage-content-tone"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.manageContentToneOptions=="function"?window.manageContentToneOptions:typeof nt=="function"?nt:null;t?t():console.warn("[AdminSettings] manageContentToneOptions not found");return}if(s('[data-action="content-tone-close"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.closeContentToneModal=="function"?window.closeContentToneModal:typeof Be=="function"?Be:null;if(t)t();else{const r=document.getElementById("contentToneModal");r&&r.remove()}return}if(s('[data-action="content-tone-add"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.addContentToneOption=="function"?window.addContentToneOption:typeof at=="function"?at:null;t?t():console.warn("[AdminSettings] addContentToneOption not found");return}if(s('[data-action="content-tone-save"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.saveContentToneOptions=="function"?window.saveContentToneOptions:typeof st=="function"?st:null;t?t():console.warn("[AdminSettings] saveContentToneOptions not found");return}const Fo=s('[data-action="content-tone-remove"]');if(Fo){a.preventDefault();const t=parseInt(Fo.dataset.index||"-1",10),r=typeof window<"u"&&typeof window.removeContentToneOption=="function"?window.removeContentToneOption:typeof it=="function"?it:null;r&&!isNaN(t)?r(t):console.warn("[AdminSettings] removeContentToneOption missing args or not found");return}if(s('[data-action="brand-voice-close"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.closeBrandVoiceModal=="function"?window.closeBrandVoiceModal:typeof Le=="function"?Le:null;if(t)t();else{const r=document.getElementById("brandVoiceModal");r&&r.remove()}return}if(s('[data-action="brand-voice-add"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.addBrandVoiceOption=="function"?window.addBrandVoiceOption:typeof lt=="function"?lt:null;t?t():console.warn("[AdminSettings] addBrandVoiceOption not found");return}if(s('[data-action="brand-voice-save"]')){a.preventDefault();const t=typeof window<"u"&&typeof window.saveBrandVoiceOptions=="function"?window.saveBrandVoiceOptions:typeof ft=="function"?ft:null;t?t():console.warn("[AdminSettings] saveBrandVoiceOptions not found");return}const $o=s('[data-action="brand-voice-remove"]');if($o){a.preventDefault();const t=parseInt($o.dataset.index||"-1",10),r=typeof window<"u"&&typeof window.removeBrandVoiceOption=="function"?window.removeBrandVoiceOption:typeof ct=="function"?ct:null;r&&!isNaN(t)?r(t):console.warn("[AdminSettings] removeBrandVoiceOption missing args or not found");return}},!0),document.addEventListener("input",a=>{const d=a.target;if(!d||!d.getAttribute)return;const u=d.getAttribute("data-value-target");if(u){const b=document.getElementById(u);b&&(b.textContent=d.value)}const p=d.getAttribute("data-target-id");if(p){const b=document.getElementById(p);if(b&&"value"in b){if(b.value!==d.value){if(window.WF_InputMirrorSync||(window.WF_InputMirrorSync=new WeakSet),window.WF_InputMirrorSync.has(d))return;window.WF_InputMirrorSync.add(b);try{b.value=d.value}catch{}try{b.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}window.WF_InputMirrorSync.delete(b)}}else b&&(b.textContent=d.value)}const s=d.getAttribute("data-action");if(s==="css-search-input"){const b=(d.value||"").toString();try{typeof window<"u"&&typeof window.filterCSSRules=="function"?window.filterCSSRules(b):typeof filterCSSRules=="function"&&filterCSSRules(b)}catch{}}else if(s==="content-tone-change"){const b=parseInt(d.getAttribute("data-index")||"-1",10),y=d.getAttribute("data-field"),I=d.value,T=typeof window<"u"&&typeof window.updateContentToneOption=="function"?window.updateContentToneOption:typeof H=="function"?H:null;T&&!isNaN(b)&&y&&T(b,y,I)}else if(s==="brand-voice-change"){const b=parseInt(d.getAttribute("data-index")||"-1",10),y=d.getAttribute("data-field"),I=d.value,T=typeof window<"u"&&typeof window.updateBrandVoiceOption=="function"?window.updateBrandVoiceOption:typeof q=="function"?q:null;T&&!isNaN(b)&&y&&T(b,y,I)}},!0),document.addEventListener("change",a=>{const d=a.target;if(!d||!d.getAttribute)return;const u=d.getAttribute("data-action");if(u==="content-tone-change"){const p=parseInt(d.getAttribute("data-index")||"-1",10),s=d.getAttribute("data-field"),b=d.value,y=typeof window<"u"&&typeof window.updateContentToneOption=="function"?window.updateContentToneOption:typeof H=="function"?H:null;y&&!isNaN(p)&&s&&y(p,s,b)}else if(u==="brand-voice-change"){const p=parseInt(d.getAttribute("data-index")||"-1",10),s=d.getAttribute("data-field"),b=d.value,y=typeof window<"u"&&typeof window.updateBrandVoiceOption=="function"?window.updateBrandVoiceOption:typeof q=="function"?q:null;y&&!isNaN(p)&&s&&y(p,s,b)}else if(u==="backup-option-change")try{typeof window<"u"&&typeof window.updateBackupButton=="function"?window.updateBackupButton():typeof updateBackupButton=="function"&&updateBackupButton()}catch{}else if(u==="db-backup-option-change")try{typeof window<"u"&&typeof window.updateDatabaseBackupButton=="function"?window.updateDatabaseBackupButton():typeof updateDatabaseBackupButton=="function"&&updateDatabaseBackupButton()}catch{}else if(u==="tm-filter-color-templates")try{typeof window<"u"&&typeof window.filterColorTemplates=="function"?window.filterColorTemplates():typeof G=="function"&&G()}catch{}else if(u==="tm-filter-size-templates")try{typeof window<"u"&&typeof window.filterSizeTemplates=="function"?window.filterSizeTemplates():typeof W=="function"&&W()}catch{}else if(u==="tm-filter-email-templates")try{typeof window<"u"&&typeof window.filterEmailTemplates=="function"?window.filterEmailTemplates():typeof filterEmailTemplates=="function"&&filterEmailTemplates()}catch{}else if(d.id&&d.id==="backupFile"||u==="restore-file-change")try{typeof window<"u"&&typeof window.handleFileSelect=="function"?window.handleFileSelect(a):typeof handleFileSelect=="function"&&handleFileSelect(a)}catch{}},!0)}typeof window<"u"&&(document.readyState!=="loading"?Vo():document.addEventListener("DOMContentLoaded",()=>Vo(),{once:!0}));function Te(){try{if(window.__wfModalUserInteracted||document.querySelector('.admin-modal-overlay.show, .modal-overlay.show, .room-modal-overlay.show, [id$="Modal"].show'))return;const o=window.location&&typeof window.location.hash=="string"?window.location.hash:"",n=[".admin-modal-overlay",".modal-overlay",".room-modal-overlay",".wf-revealco-overlay","#global-confirmation-modal",".confirmation-modal-overlay","#searchModal",".wf-login-overlay","#quantityModal","#detailedItemModal",'[id$="Modal"]'];document.querySelectorAll(n.join(", ")).forEach(l=>{if(!(o&&l.id&&o==="#"+l.id.replace(/Modal$/,"_config"))){try{l.classList.remove("show")}catch{}try{l.classList.add("hidden")}catch{}}}),window.WFModals&&typeof window.WFModals.unlockScrollIfNoneOpen=="function"?window.WFModals.unlockScrollIfNoneOpen():(document.body.classList.remove("modal-open"),document.documentElement.classList.remove("modal-open"))}catch{}}if(typeof window<"u"){const o=Date.now(),n=()=>Date.now()-o<500;window.__wfIsSquelchActive=n,typeof window.__wfModalUserInteracted>"u"&&(window.__wfModalUserInteracted=!1),document.readyState!=="loading"?Te():document.addEventListener("DOMContentLoaded",()=>Te(),{once:!0}),window.addEventListener("load",()=>{try{Te()}catch{}setTimeout(()=>{try{Te()}catch{}},200)},{once:!0});const i=()=>{window.__wfModalUserInteracted=!0};window.addEventListener("pointerdown",i,{passive:!0,once:!0}),window.addEventListener("click",i,{passive:!0,once:!0}),window.addEventListener("keydown",i,{passive:!0,once:!0})}function Uo(){try{const e=document.querySelector("header")||document.querySelector(".site-header")||document.querySelector("#site-header")||document.querySelector(".universal-page-header");let o=0;if(e){const n=e.getBoundingClientRect();o=Math.max(0,Math.round(n.height))}if(!o){const i=[document.querySelector("#adminContent"),document.querySelector(".admin-content"),document.querySelector("main"),document.querySelector("#content")].filter(Boolean)[0];if(i){const l=Math.round(i.getBoundingClientRect().top);Number.isFinite(l)&&l>0&&(o=l)}}return o||(o=64),o}catch{return 0}}function qn(){try{const e=document.querySelector("header")||document.querySelector(".site-header")||document.querySelector("#site-header");if(!e)return null;const o=window.getComputedStyle(e).zIndex,n=parseInt(o,10);return Number.isFinite(n)?n:null}catch{return null}}function jn(e){try{if(!e)return;e.classList.add("admin-modal-offset-under-header")}catch{}}function ae(){try{const e=[".admin-modal-overlay",".modal-overlay",".room-modal-overlay",".wf-revealco-overlay","#global-confirmation-modal",".confirmation-modal-overlay","#searchModal",".wf-login-overlay","#quantityModal","#detailedItemModal",'[id$="Modal"]'];document.querySelectorAll(e.join(", ")).forEach(o=>jn(o))}catch{}}if(typeof window<"u"){const e=()=>{try{const f=document.getElementById("wf-modal-offset-style"),v=f||document.createElement("style");v.id="wf-modal-offset-style";const g=qn(),x=`
                :root { --wf-header-h: ${Uo()}px; --wf-header-h-plus: calc(var(--wf-header-h) + 16px); --wf-header-z: ${Number.isFinite(g)?g:100}; --wf-modal-below-header-z: calc(var(--wf-header-z) - 1); }
                /* Apply offset rules ONLY to visible overlays */
                .admin-modal-overlay.show,
                .modal-overlay.show,
                .room-modal-overlay.show,
                .wf-revealco-overlay.show,
                #global-confirmation-modal.show,
                .confirmation-modal-overlay.show,
                #searchModal.show,
                .wf-login-overlay.show,
                #quantityModal:not(.hidden):not([aria-hidden="true"]),
                #detailedItemModal:not(.hidden):not([aria-hidden="true"]),
                [id$="Modal"].show,
                [id$="Modal"]:not(.hidden):not([aria-hidden="true"]) {
                    position: fixed !important;
                    top: var(--wf-header-h-plus) !important;
                    height: calc(100vh - var(--wf-header-h-plus)) !important;
                    left: 0 !important;
                    right: 0 !important;
                    overflow: auto !important;
                    box-sizing: border-box !important;
                    padding-top: 12px; /* ensure inner content and close button clear the site header */
                    z-index: var(--wf-modal-below-header-z) !important;
                }
                /* Try to ensure inner fixed dialogs respect the header too */
                .admin-modal-overlay [role="dialog"],
                .modal-overlay [role="dialog"],
                .room-modal-overlay [role="dialog"],
                .admin-modal-overlay .modal,
                .modal-overlay .modal,
                .room-modal-overlay .modal,
                .admin-modal-content {
                    margin-top: max(0px, var(--wf-header-h-plus));
                }
                .admin-modal-header,
                .admin-modal-overlay .section-header,
                .modal-overlay .section-header {
                    position: sticky;
                    top: 0;
                    z-index: 1;
                }
            `;v.textContent=x,f||document.head.appendChild(v)}catch{}ae(),window.addEventListener("resize",()=>{try{const f=Uo(),v=document.getElementById("wf-modal-offset-style");v&&(v.textContent=v.textContent.replace(/--wf-header-h: \d+px;/,`--wf-header-h: ${f}px;`))}catch{}ae()}),setTimeout(()=>ae(),250),window.addEventListener("load",()=>ae(),{once:!0});const o=document;try{window.__ALLOW_DASHBOARD_CONFIG_AUTOOPEN=!1}catch{}const n=!1,i=()=>n;try{window.__wfIsSquelchActive=i}catch{}try{document.documentElement.classList.add("wf-admin-no-page-scroll")}catch{}const l=f=>{try{if(!f)return null;const v=String(f).replace(/Modal$/i,""),g=v.toLowerCase().replace(/[^a-z0-9]+/g,"-"),x=g.replace(/-([a-z0-9])/g,(D,M)=>M.toUpperCase()),C=[`#${v}Modal`,`#${g}Modal`,`#${g}-modal`,`#${x}Modal`];for(const D of C){const M=document.querySelector(D);if(M)return M}return Array.from(document.querySelectorAll('[id$="Modal"]')).find(D=>{const M=(D.id||"").toLowerCase();return M.includes(g)||M.includes(v.toLowerCase())})}catch{return null}},c=f=>{if(!f||!f.__wfUserInitiated)return;if((typeof window.__wfIsSquelchActive=="function"?window.__wfIsSquelchActive():!1)&&!f.__wfUserInitiated){try{f.classList.remove("show")}catch{}try{f.classList.add("hidden")}catch{}return}window.__wfModalUserInteracted=!0;try{f.classList.remove("hidden")}catch{}try{f.classList.add("show")}catch{}try{f.querySelectorAll(":scope .hidden[data-default-visible], :scope [data-unhide-on-open]").forEach(g=>g.classList.remove("hidden"))}catch{}try{window.WFModals&&typeof window.WFModals.lockScroll=="function"&&(console.debug("[AdminSettings] openOverlay -> WFModals.lockScroll() for",f.id||f),window.WFModals.lockScroll())}catch{}ae();try{const g=f.id||"";if(g){const x=g.replace(/Modal$/,""),C=M=>M.charAt(0).toUpperCase()+M.slice(1),_=x.replace(/[-_](\w)/g,(M,B)=>B.toUpperCase()),D=[`init${C(g)}`,`init${C(_)}Modal`,`init${C(_)}`];for(const M of D)if(typeof window[M]=="function"){try{window[M](f)}catch{}break}}}catch{}},m=f=>{if(f){try{f.classList.remove("show")}catch{}try{f.classList.add("hidden")}catch{}window.WFModals&&typeof window.WFModals.unlockScrollIfNoneOpen=="function"&&window.WFModals.unlockScrollIfNoneOpen()}},h=new Set(["dashboardConfigBtn","categoriesBtn","globalColorSizeBtn","roomsBtn","roomCategoryBtn","templateManagerBtn","cssRulesBtn","backgroundManagerBtn","roomMapperBtn","areaItemMapperBtn"]);o.addEventListener("click",f=>{if(!f.isTrusted||typeof f.button=="number"&&f.button!==0)return;const v=f.target.closest("[data-action]"),g=f.target.closest('button, a, [role="button"]');if(f.target.closest(".js-retry-compact-repair")){f.preventDefault();try{typeof window.closeBackupProgressModal=="function"&&window.closeBackupProgressModal()}catch{}try{typeof window.compactRepairDatabase=="function"&&window.compactRepairDatabase()}catch{}return}const C=f.target.closest(".js-edit-room-settings");if(C){f.preventDefault();try{let d=null;if(C.dataset.room)try{d=JSON.parse(C.dataset.room)}catch{}if(!d&&C.dataset.roomNumber){const u=String(C.dataset.roomNumber);Array.isArray(window.rooms)&&(d=window.rooms.find(p=>String(p.room_number)===u)||null)}d&&typeof window.editRoomSettings=="function"&&window.editRoomSettings(d)}catch{}return}const _=f.target.closest(".js-edit-category");if(_){f.preventDefault();try{typeof window.startEditCategory=="function"&&window.startEditCategory(_)}catch{}return}const D=f.target.closest(".js-edit-sku-code");if(D){f.preventDefault();try{typeof window.startEditSkuCode=="function"&&window.startEditSkuCode(D)}catch{}return}const M=f.target.closest(".js-select-table");if(M){f.preventDefault();try{const d=M.dataset.table||"";d&&typeof window.selectTable=="function"&&window.selectTable(d)}catch{}return}if(g&&g.id&&h.has(g.id)){const d=g.id.replace(/Btn$/,""),u=l(d);if(u){f.preventDefault(),u.__wfUserInitiated=!0,c(u),delete u.__wfUserInitiated;return}if(/^loggingStatus$/i.test(d)&&typeof window.createLoggingStatusModal=="function"){f.preventDefault();try{window.createLoggingStatusModal()}catch{}const p=document.getElementById("loggingStatusModal");if(p){p.__wfUserInitiated=!0,c(p),delete p.__wfUserInitiated;return}}/^aiSettings$/i.test(d)&&setTimeout(()=>{const p=l(d);p&&(p.__wfUserInitiated=!0,c(p),delete p.__wfUserInitiated)},50)}if(!v)return;const B=String(v.getAttribute("data-action")||""),a=B.match(/^open-(.+)$/);if(a){f.preventDefault();const d=l(a[1]);if(d)d.__wfUserInitiated=!0,c(d),delete d.__wfUserInitiated;else if(a[1].toLowerCase().includes("logging")&&typeof window.createLoggingStatusModal=="function"){try{window.createLoggingStatusModal()}catch{}const p=document.getElementById("loggingStatusModal");p&&(p.__wfUserInitiated=!0,c(p),delete p.__wfUserInitiated)}return}if(B==="close-admin-modal"){f.preventDefault();const d=v.closest('.admin-modal-overlay, .modal-overlay, .room-modal-overlay, [id$="Modal"]');d&&m(d);return}},{capture:!0})};document.readyState!=="loading"?e():document.addEventListener("DOMContentLoaded",e,{once:!0})}function Vn(e=document){try{const o=e.querySelector?e.querySelector("#sslEnabled"):null,n=e.querySelector?e.querySelector("#sslOptions"):null;o&&n&&n.classList.toggle("hidden",!o.checked)}catch{}}
