import{A as h}from"./apiClient-Bz7HftkC.js";function v(e){const t=new URLSearchParams;return Object.entries(e||{}).forEach(([n,s])=>{s!=null&&s!==""&&t.append(n,s)}),t.toString()}const E={async getByCategory(e){if(!e)throw new Error("category is required");const t=v({action:"get",category:e});return h.get(`/api/business_settings.php?${t}`)},async upsert(e,t){if(!e)throw new Error("category is required");if(!t||typeof t!="object")throw new Error("settings map is required");return h.post("business_settings.php",{action:"upsert",category:e,settings:t})},async get(e=[]){const t=v({action:"get",keys:Array.isArray(e)?e.join(","):String(e||"")});return h.get(`/api/business_settings.php?${t}`)}};function r(e){return document.getElementById(e)}function p(e,t){const n=r(e);n&&(n.value=t??"")}function P(e,t){const n=r(e);n&&(n.checked=!!t)}function A(e){const t=e||{},n=i=>i===!0||i==="1"||i===1||i==="true"||i==="on",s=i=>i==null||i===""?"":Number(i);return{fromEmail:t.from_email||t.fromEmail||"",fromName:t.from_name||t.fromName||"",adminEmail:t.admin_email||t.adminEmail||"",bccEmail:t.bcc_email||t.bccEmail||"",smtpEnabled:n(t.smtp_enabled??t.smtpEnabled),smtpHost:t.smtp_host||t.smtpHost||"",smtpPort:s(t.smtp_port??t.smtpPort),smtpUsername:t.smtp_username||t.smtpUsername||"",smtpEncryption:(t.smtp_encryption||t.smtpEncryption||"").toString().toLowerCase()}}async function N(){try{const e=await E.getByCategory("email"),t=e&&(e.settings||e.data||e)||{};return A(t)}catch(e){console.warn("[AdminSettingsBridge] BusinessSettingsAPI email fetch failed; falling back to legacy endpoint",e)}try{const e=await h.get("/api/get_email_config.php");return e&&e.success&&e.config?e.config:e?.config||{}}catch(e){return console.error("[AdminSettingsBridge] Legacy email config fetch failed",e),{}}}function k(e){p("fromEmail",e.fromEmail),p("fromName",e.fromName),p("adminEmail",e.adminEmail),p("bccEmail",e.bccEmail),P("smtpEnabled",e.smtpEnabled),p("smtpHost",e.smtpHost),e.smtpPort!==void 0&&e.smtpPort!==null&&e.smtpPort!==""&&p("smtpPort",String(e.smtpPort)),p("smtpUsername",e.smtpUsername),p("smtpEncryption",e.smtpEncryption);const t=r("smtpEnabled"),n=r("smtpSettings");n&&t&&(t.checked?n.classList.remove("hidden"):n.classList.add("hidden"))}function I(){const e=r("smtpEnabled"),t=r("smtpSettings");e&&t&&e.addEventListener("change",()=>{e.checked?t.classList.remove("hidden"):t.classList.add("hidden")})}function B(){const e=document.querySelector('[data-action="email-send-test"]'),t=r("testEmailAddress");if(!e||!t)return;const n=s=>/.+@.+\..+/.test(s);e.addEventListener("click",async()=>{const s=(t.value||"").trim();if(!n(s)){f("error","Invalid Email","Enter a valid test email address."),t.focus();return}e.disabled=!0;const i=e.textContent;e.textContent="Sending…";try{const c=await fetch("/api/email_test.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to:s})}),o=await c.json().catch(()=>({}));if(c.ok&&o&&o.success)f("success","Test Email Sent",`A test email was sent to ${s}.`);else{const a=o&&o.error?o.error:`HTTP ${c.status}`;f("error","Test Email Failed",a)}}catch(c){f("error","Network Error",c?.message||"Unable to send test email.")}finally{e.disabled=!1,e.textContent=i}})}function C(){const e=o=>r(o)?r(o).value.trim():"",t=o=>!!(r(o)&&r(o).checked),n=o=>{const a=e(o);if(a==="")return"";const m=Number(a);return Number.isFinite(m)?m:""},s={from_email:e("fromEmail"),from_name:e("fromName"),admin_email:e("adminEmail"),bcc_email:e("bccEmail"),smtp_enabled:t("smtpEnabled")?1:0,smtp_host:e("smtpHost"),smtp_port:n("smtpPort"),smtp_encryption:e("smtpEncryption")},i=e("smtpUsername");i!==""&&(s.smtp_username=i);const c=e("smtpPassword");return c!==""&&(s.smtp_password=c),s}function f(e,t,n){typeof window.showNotification=="function"?window.showNotification({type:e,title:t,message:n}):(console.log(e==="error"?"[Error]":e==="success"?"[Success]":"[Info]",t||"",n||""),e==="error"&&alert(`${t||"Error"}
${n||""}`))}function q(){const e=r("emailConfigForm");e&&e.addEventListener("submit",async t=>{try{t.preventDefault()}catch{}const n=C();if(!n.from_email){f("error","Missing From Email","Please enter a From Email address.");return}if(n.smtp_enabled){if(!n.smtp_host){f("error","Missing SMTP Host","Please enter SMTP Host or disable SMTP.");return}if(n.smtp_port===""){f("error","Missing SMTP Port","Please select an SMTP Port.");return}}try{await E.upsert("email",n),f("success","Email Settings Saved","Your email configuration has been updated.")}catch(s){console.error("[AdminSettingsBridge] Failed to save email settings",s),f("error","Save Failed",s?.message||"Could not save settings.")}})}async function T(){const e=await N();k(e),I(),q(),B()}async function M(){try{const e=await E.getByCategory("business");return e&&(e.settings||e.data||e)||{}}catch(e){return console.warn("[AdminSettingsBridge] Failed to load business info",e),{}}}function x(e={}){const t=(n,s)=>{const i=r(n);i&&(i.value=s??"")};t("bizName",e.business_name||e.name||""),t("bizLegalName",e.legal_name||""),t("bizPhone",e.phone||""),t("bizEmail",e.email||""),t("bizAddr1",e.address1||e.addr1||""),t("bizAddr2",e.address2||e.addr2||""),t("bizCity",e.city||""),t("bizState",e.state||""),t("bizZip",e.zip||e.postal_code||""),t("bizWebsite",e.website||e.site||""),t("bizTaxRate",e.tax_rate!==void 0&&e.tax_rate!==null?String(e.tax_rate):""),r("bizHours")&&(r("bizHours").value=e.hours||""),r("bizReturnPolicy")&&(r("bizReturnPolicy").value=e.return_policy||""),t("bizFacebook",e.facebook||""),t("bizInstagram",e.instagram||""),t("bizTiktok",e.tiktok||"")}function F(){const e=n=>r(n)?r(n).value.trim():"",t=n=>{const s=e(n);if(s==="")return"";const i=Number(s);return Number.isFinite(i)?i:""};return{business_name:e("bizName"),legal_name:e("bizLegalName"),phone:e("bizPhone"),email:e("bizEmail"),address1:e("bizAddr1"),address2:e("bizAddr2"),city:e("bizCity"),state:e("bizState"),zip:e("bizZip"),website:e("bizWebsite"),tax_rate:t("bizTaxRate"),hours:e("bizHours"),return_policy:e("bizReturnPolicy"),facebook:e("bizFacebook"),instagram:e("bizInstagram"),tiktok:e("bizTiktok")}}function H(){const e=document.getElementById("businessInfoModal");if(!e)return;const t=Array.from(document.querySelectorAll('[data-action="open-business-info"]')),n=Array.from(document.querySelectorAll('[data-action="close-business-info"]')),s=document.getElementById("businessInfoResult"),i=async()=>{e.classList.remove("hidden"),e.classList.add("show"),document.documentElement.classList.add("modal-open"),document.body.classList.add("modal-open"),e.setAttribute("aria-hidden","false");const a=await M();x(a)},c=()=>{e.classList.remove("show"),e.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),e.setAttribute("aria-hidden","true")};t.forEach(a=>a.addEventListener("click",m=>{m.preventDefault(),i()})),n.forEach(a=>a.addEventListener("click",m=>{m.preventDefault(),c()})),e.addEventListener("click",a=>{a.target===e&&c()}),document.addEventListener("keydown",a=>{a.key==="Escape"&&e.classList.contains("show")&&c()});const o=document.querySelector('[data-action="business-info-save"]');o&&o.addEventListener("click",async a=>{a.preventDefault(),s&&(s.textContent="Saving…",s.className="status status--info");try{const m=F();await E.upsert("business",m),s&&(s.textContent="Saved successfully.",s.className="status status--success")}catch(m){console.error("[BusinessInfo] save failed",m),s&&(s.textContent=m?.message||"Save failed.",s.className="status status--error")}})}function R(e){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e()}function D(){if(typeof window<"u"){if(window.__WF_ADMIN_SETTINGS_BRIDGE_INIT)return;window.__WF_ADMIN_SETTINGS_BRIDGE_INIT=!0}R(()=>{const e=document.body,t=e&&e.dataset||{},n=typeof location<"u"?location:{pathname:"",search:""},s=t.path||n.pathname+(n.search||"")||"";let i="";try{i=n.search||(s.includes("?")?"?"+s.split("?")[1]:"")}catch{}let c;try{c=new URLSearchParams(i||"")}catch{c=new URLSearchParams("")}const o=c.get("section")==="settings"||/[?&]section=settings\b/.test(s),a=/\/admin\/(settings)(\b|\/|\?|#)/.test(s),m=/admin\.php\?section=settings\b/.test(s),L=t.page==="admin-settings"||t.page==="admin/settings"||t.page==="admin",z=t.isAdmin==="true";if(a||m||z&&o||L&&(o||a||m)){(function(){const d=()=>document.querySelector([".admin-header",".site-header","#siteHeader","#header","#wfHeader",".wf-header",".header","header"].join(", ")),_=l=>getComputedStyle(document.documentElement).getPropertyValue(l).trim(),S=l=>{if(!l)return NaN;const b=/([\d.]+)px/.exec(l);return b?Math.ceil(parseFloat(b[1])):NaN},w=()=>{let l=S(_("--wf-header-height"));if(!Number.isFinite(l)||l<=0){const b=d();l=b?Math.ceil(b.getBoundingClientRect().height):64}(!Number.isFinite(l)||l<=0)&&(l=64),document.documentElement.style.setProperty("--admin-header-height",`${l}px`),document.querySelectorAll('.admin-modal-overlay, .modal-overlay, .room-modal-overlay, [id$="Modal"]').forEach(b=>{b.classList.add("under-header")})};let g=0;const u=()=>{cancelAnimationFrame(g),g=requestAnimationFrame(w)};w(),window.addEventListener("resize",u)})(),T(),H();try{if(typeof window.loadSquareSettingsClient=="function")try{window.loadSquareSettingsClient()}catch{}const y=document.getElementById("saveSquareSettingsBtn");y&&typeof window.saveSquareSettingsClient=="function"&&y.addEventListener("click",u=>{u.preventDefault();try{window.saveSquareSettingsClient()}catch(l){console.error("[Square] save error",l)}},{once:!1});const d=document.getElementById("squareSettingsModal"),_=Array.from(document.querySelectorAll(".js-open-square-settings")),S=Array.from(document.querySelectorAll(".js-close-square-settings")),w=()=>{d&&(d.classList.remove("hidden"),d.classList.add("show"),document.documentElement.classList.add("modal-open"),document.body.classList.add("modal-open"),d.setAttribute("aria-hidden","false"))},g=()=>{if(!d)return;d.classList.remove("show"),d.classList.add("hidden"),document.documentElement.classList.remove("modal-open"),document.body.classList.remove("modal-open"),d.setAttribute("aria-hidden","true");const u=d.querySelector(".admin-modal")};S.forEach(u=>u.addEventListener("click",l=>{l.preventDefault(),g()})),d&&d.addEventListener("click",u=>{u.target===d&&g()}),document.addEventListener("keydown",u=>{u.key==="Escape"&&d&&d.classList.contains("show")&&g()})}catch{}}})}D();export{D as init};
