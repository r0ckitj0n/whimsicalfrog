class y{constructor(){this.currentItemSku=null,this.items=[],this.categories=[],this.costBreakdown={materials:{},labor:{},energy:{},equipment:{},totals:{}},this.currentEditCostItem=null,this.tooltipTimeout=null,this.currentTooltip=null,this.editCarouselPosition=0,this.viewCarouselPosition=0,this.selectedComparisonChanges={},this.itemToDeleteSku=null,this.loadData(),this.bindEvents(),this.init()}handleDelegatedKeydown(e){const t=e.target;if(t instanceof HTMLElement&&t.matches("input[data-add-enter-field]")&&e.key==="Enter"){e.preventDefault();const o=t.getAttribute("data-add-enter-field");o&&this.handleAddListItem(o)}}async loadItemColors(){if(!this.currentItemSku){const t=document.getElementById("sku")||document.getElementById("skuDisplay");t&&t.value&&(this.currentItemSku=t.value)}if(!this.currentItemSku){const t=document.getElementById("colorsLoading");t&&(t.textContent="No SKU available",t.style.display="block");return}const e=document.getElementById("colorsLoading");e&&(e.textContent="Loading colors...",e.style.display="block");try{const o=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json();o.success?this.renderColors(o.colors):(console.error("Error loading colors:",o.message),this.renderColors([]))}catch(t){console.error("Error fetching colors:",t),this.renderColors([])}}renderColors(e){const t=document.getElementById("colorsList"),o=document.getElementById("colorsLoading");if(o&&(o.style.display="none"),!t)return;if(!Array.isArray(e)||e.length===0){t.innerHTML='<div class="text-center text-gray-500 text-sm">No colors defined. Click "Add Color" to get started.</div>';return}const s=e.filter(c=>c.is_active==1),i=s.reduce((c,d)=>c+(parseInt(d.stock_level,10)||0),0),a=document.getElementById("stockLevel"),n=a&&parseInt(a.value,10)||0,r=i===n;let l="";if(s.length>0){const c=r?"bg-green-50 border-green-200 text-green-800":"bg-yellow-50 border-yellow-200 text-yellow-800",d=r?"‚úÖ":"‚ö†Ô∏è",m=r?`Stock synchronized (${i} total)`:`Stock out of sync! Colors total: ${i}, Item stock: ${n}`;l+=`
                <div class="border rounded-lg ${c}">
                    <div class="text-sm font-medium">${d} ${m}</div>
                    ${r?"":'<div class="text-xs">Click "Sync Stock" to fix this.</div>'}
                </div>
            `}l+=e.map(c=>{const d=c.is_active==1,m=d?"bg-white":"bg-gray-100 opacity-75",u=d?"":" (Inactive)",p=c.color_code?`style="background-color: ${c.color_code}"`:"";return`
                <div class="color-item flex items-center justify-between border border-gray-200 rounded-lg ${m}">
                    <div class="flex items-center space-x-3">
                        <div class="color-swatch w-8 h-8 rounded-full border-2 border-gray-300" ${p}></div>
                        <div>
                            <div class="font-medium text-gray-800">${c.color_name}${u}</div>
                            <div class="text-sm text-gray-500 flex items-center">
                                <span class="inline-stock-editor"
                                      data-type="color"
                                      data-id="${c.id}"
                                      data-field="stock_level"
                                      data-value="${c.stock_level}"
                                      data-action="edit-inline-stock"
                                      title="Click to edit stock level">${c.stock_level}</span>
                                <span class="">in stock</span>
                            </div>
                            ${c.image_path?`<div class="text-xs text-blue-600">Image: ${c.image_path}</div>`:""}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" data-action="delete-color" data-id="${c.id}" class="bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `}).join(""),t.innerHTML=l}showColorModal(e=null){document.getElementById("colorModal")||this.createColorModal();const t=document.getElementById("colorModal"),o=document.getElementById("colorForm"),s=document.getElementById("colorModalTitle");if(!(!t||!o)){if(o.reset(),e)if(s.textContent="Edit Color",document.getElementById("colorId").value=e.id,document.getElementById("colorName").value=e.color_name,document.getElementById("colorCode").value=e.color_code||"",document.getElementById("colorStockLevel").value=e.stock_level||0,document.getElementById("displayOrder").value=e.display_order||0,document.getElementById("isActive").checked=e.is_active==1,e.image_path){const i=document.getElementById("colorImagePath");i&&(i.value=e.image_path),this.updateImagePreview(),setTimeout(()=>{this.highlightSelectedImageInGrid(e.image_path)},100)}else{const i=document.getElementById("imagePreviewContainer");i&&i.classList.add("hidden"),setTimeout(()=>{this.highlightSelectedImageInGrid(null)},100)}else{s.textContent="Add New Color";const i=document.getElementById("imagePreviewContainer");i&&i.classList.add("hidden"),setTimeout(()=>{this.highlightSelectedImageInGrid(null)},100)}t.classList.remove("hidden")}}createColorModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="colorModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="colorModalTitle">Add New Color</h2>
                    <button type="button" class="modal-close" data-action="close-color-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="colorForm">
                        <input type="hidden" id="colorId" name="colorId">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <label for="globalColorSelect" class="block text-sm font-medium text-gray-700">Select Color * <span class="text-xs text-gray-500">(from predefined colors)</span></label>
                                    <select id="globalColorSelect" name="globalColorSelect" required class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                        <option value="">Choose a color...</option>
                                    </select>
                                    <div class="text-xs">
                                        <a href="#" data-action="open-global-colors-management" class="text-blue-600 hover:text-blue-800">‚öôÔ∏è Manage Global Colors in Settings</a>
                                    </div>
                                </div>
                                <input type="hidden" id="colorName" name="colorName">
                                <input type="hidden" id="colorCode" name="colorCode">
                                <div id="selectedColorPreview" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Selected Color Preview</label>
                                    <div class="flex items-center space-x-3 bg-gray-50 rounded-lg">
                                        <div id="colorPreviewSwatch" class="w-12 h-12 rounded border-2 border-gray-300 shadow-sm"></div>
                                        <div>
                                            <div id="colorPreviewName" class="font-medium text-gray-900"></div>
                                            <div id="colorPreviewCode" class="text-sm text-gray-500"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="colorStockLevel" class="block text-sm font-medium text-gray-700">Stock Level</label>
                                    <input type="number" id="colorStockLevel" name="stockLevel" min="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                </div>
                                <div>
                                    <label for="displayOrder" class="block text-sm font-medium text-gray-700">Display Order</label>
                                    <input type="number" id="displayOrder" name="displayOrder" min="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="isActive" name="isActive" class="">
                                        <span class="text-sm font-medium text-gray-700">Active (visible to customers)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div id="availableImagesGrid">
                                    <label class="block text-sm font-medium text-gray-700">Available Images <span class="text-xs text-gray-500 font-normal">(click to select for this color)</span></label>
                                    <div class="grid grid-cols-4 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded bg-gray-50"></div>
                                </div>
                                <div id="imagePreviewContainer" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Selected Image Preview</label>
                                    <div class="border border-gray-300 rounded-lg bg-gray-50">
                                        <div class="flex justify-center">
                                            <img id="imagePreview" src="" alt="Selected image preview" class="max-h-64 object-contain rounded border border-gray-200 shadow-sm">
                                        </div>
                                        <div id="imagePreviewInfo" class="text-center">
                                            <div id="imagePreviewName" class="text-sm font-medium text-gray-700"></div>
                                            <div id="imagePreviewPath" class="text-xs text-gray-500"></div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="colorImagePath" name="colorImagePath" value="">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 border-t border-gray-200">
                            <button type="button" data-action="close-color-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition-colors">Cancel</button>
                            <button type="submit" class="text-white rounded transition-colors bg-[#87ac3a] hover:bg-[#6b8e23]">Save Color</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`),this.loadGlobalColorsForSelection(),this.loadAvailableImages()}async loadAvailableImages(){if(this.currentItemSku)try{const t=await(await fetch(`/api/get_item_images.php?sku=${this.currentItemSku}`)).json(),o=document.getElementById("availableImagesGrid");if(!o)return;const s=o.querySelector(".grid");if(!s)return;t.success&&Array.isArray(t.images)&&t.images.length>0?(s.innerHTML="",t.images.forEach(i=>{const a=document.createElement("div");a.className="relative cursor-pointer hover:opacity-75 transition-all hover:scale-105 hover:shadow-md p-1 rounded",a.addEventListener("click",()=>this.selectImageFromGrid(i.image_path));const n=document.createElement("img"),r=i.image_path.startsWith("/images/items/")||i.image_path.startsWith("images/items/")?i.image_path:`/images/items/${i.image_path}`;n.src=r,n.alt=i.image_path,n.className="w-full h-20 object-cover rounded border border-gray-200 hover:border-green-400 transition-colors",n.onerror=()=>{n.style.display="none",n.parentElement.innerHTML='<div class="u-width-100 u-height-100 u-display-flex u-flex-direction-column u-align-items-center u-justify-content-center u-background-f8f9fa u-color-6c757d u-border-radius-8px"><div class="u-font-size-2rem u-margin-bottom-0-5rem u-opacity-0-7">üì∑</div><div class="u-font-size-0-8rem u-font-weight-500">Image Not Found</div></div>'};const l=document.createElement("div");if(l.className="text-xs text-gray-600 mt-1 text-center",l.textContent=i.image_path,i.is_primary){const c=document.createElement("div");c.className="absolute top-0 right-0 bg-green-500 text-white text-xs px-1 rounded-bl",c.textContent="1¬∞",a.appendChild(c)}a.appendChild(n),a.appendChild(l),s.appendChild(a)}),o.style.display="block"):(s.innerHTML='<div class="col-span-4 text-center text-gray-500"><div class="text-3xl">üì∑</div><div class="text-sm">No images available for this item</div></div>',o.style.display="block")}catch(e){console.error("Error loading available images:",e);const t=document.querySelector("#availableImagesGrid .grid");t&&(t.innerHTML='<div class="col-span-4 text-center text-red-500"><div class="text-sm">Error loading images</div></div>')}}selectImageFromGrid(e){const t=document.getElementById("colorImagePath");t&&(t.value=e,this.updateImagePreview(),this.highlightSelectedImageInGrid(e))}updateImagePreview(){const e=document.getElementById("colorImagePath"),t=document.getElementById("imagePreviewContainer"),o=document.getElementById("imagePreview"),s=document.getElementById("imagePreviewName"),i=document.getElementById("imagePreviewPath");if(!e||!t)return;const a=e.value;if(a){const n=a.startsWith("/images/items/")||a.startsWith("images/items/")?a:`/images/items/${a}`;o.src=n,o.onerror=()=>{o.style.display="none",o.parentElement.innerHTML='<div class="u-width-100 u-height-100 u-display-flex u-flex-direction-column u-align-items-center u-justify-content-center u-background-f8f9fa u-color-6c757d u-border-radius-8px"><div class="u-font-size-2rem u-margin-bottom-0-5rem u-opacity-0-7">üì∑</div><div class="u-font-size-0-8rem u-font-weight-500">No Image Available</div></div>'},s&&(s.textContent=a),i&&(i.textContent=n),t.classList.remove("hidden")}else t.classList.add("hidden")}highlightSelectedImageInGrid(e){const t=document.querySelector("#availableImagesGrid .grid");if(!t)return;t.querySelectorAll("div").forEach(s=>{const i=s.querySelector("img");if(!i)return;const a=i.alt;e&&a===e?(s.classList.add("ring-2","ring-green-500","bg-green-50"),i.classList.add("border-green-400")):(s.classList.remove("ring-2","ring-green-500","bg-green-50"),i.classList.remove("border-green-400"))})}async loadGlobalColorsForSelection(){try{const t=await(await fetch("/api/global_color_size_management.php?action=get_global_colors")).json(),o=document.getElementById("globalColorSelect");if(!o)return;if(o.innerHTML='<option value="">Choose a color...</option>',t.success&&Array.isArray(t.colors)&&t.colors.length>0){const s={};t.colors.forEach(i=>{const a=i.category||"General";s[a]||(s[a]=[]),s[a].push(i)}),Object.keys(s).sort().forEach(i=>{const a=document.createElement("optgroup");a.label=i,s[i].forEach(n=>{const r=document.createElement("option");r.value=JSON.stringify({id:n.id,name:n.color_name,code:n.color_code,category:n.category}),r.textContent=`${n.color_name} ${n.color_code?"("+n.color_code+")":""}`,a.appendChild(r)}),o.appendChild(a)})}else{const s=document.createElement("option");s.value="",s.textContent="No global colors available - add some in Settings",s.disabled=!0,o.appendChild(s)}}catch(e){console.error("Error loading global colors:",e),this.showError("Error loading global colors")}}async loadItemSizes(e=null){if(!this.currentItemSku){const o=document.getElementById("sku")||document.getElementById("skuDisplay");o&&o.value&&(this.currentItemSku=o.value)}if(!this.currentItemSku)return;let t=e;if(t===null){const o=document.getElementById("sizeColorFilter");o&&(t=o.value)}try{let o=`/api/item_sizes.php?action=get_all_sizes&item_sku=${this.currentItemSku}`;t&&t!=="general"?o+=`&color_id=${t}`:t==="general"&&(o+="&color_id=0");const i=await(await fetch(o)).json();i.success?this.renderSizes(i.sizes):(console.error("Error loading sizes:",i.message),this.renderSizes([]))}catch(o){console.error("Error fetching sizes:",o),this.renderSizes([])}}renderSizes(e){const t=document.getElementById("sizesList"),o=document.getElementById("sizesLoading");if(o&&(o.style.display="none"),!t)return;if(!Array.isArray(e)||e.length===0){t.innerHTML='<div class="text-center text-gray-500 text-sm">No sizes defined. Click "Add Size" to get started.</div>';return}const s={};e.forEach(c=>{const d=c.color_id?`color_${c.color_id}`:"general";s[d]||(s[d]={color_name:c.color_name||"General Sizes",color_code:c.color_code||null,sizes:[]}),s[d].sizes.push(c)});const i=e.reduce((c,d)=>c+(parseInt(d.stock_level,10)||0),0),a=document.getElementById("stockLevel"),n=a&&parseInt(a.value,10)||0,r=i===n;let l="";if(e.length>0){const c=r?"bg-green-50 border-green-200 text-green-800":"bg-yellow-50 border-yellow-200 text-yellow-800",d=r?"‚úÖ":"‚ö†Ô∏è",m=r?`Stock synchronized (${i} total)`:`Stock out of sync! Sizes total: ${i}, Item stock: ${n}`;l+=`
                <div class="border rounded-lg ${c}">
                    <div class="text-sm font-medium">${d} ${m}</div>
                    ${r?"":'<div class="text-xs flex items-center gap-2"><button type="button" data-action="sync-size-stock" class="bg-blue-500 text-white rounded text-xs px-2 py-1 hover:bg-blue-600">Sync Stock</button><span>Click to synchronize item stock with sizes total.</span></div>'}
                </div>
            `}Object.keys(s).forEach(c=>{const d=s[c];Object.keys(s).length>1&&(l+=`
                    <div class="font-medium text-gray-700 flex items-center">
                        ${d.color_code?`<div class="w-4 h-4 rounded border" style="background-color: ${d.color_code}"></div>`:""}
                        ${d.color_name}
                    </div>
                `),d.sizes.forEach(m=>{const u=m.is_active==1,p=u?"bg-white":"bg-gray-100 opacity-75",g=u?"":" (Inactive)",h=m.price_adjustment>0?` (+$${m.price_adjustment})`:"";l+=`
                    <div class="size-item flex items-center justify-between border border-gray-200 rounded-lg ${p} ml-${Object.keys(s).length>1?"4":"0"}">
                        <div class="flex items-center space-x-3">
                            <div class="size-badge bg-blue-100 text-blue-800 rounded text-sm font-medium">${m.size_code}</div>
                            <div>
                                <div class="font-medium text-gray-800">${m.size_name}${g}${h}</div>
                                <div class="text-sm text-gray-500 flex items-center">
                                    <span class="inline-stock-editor"
                                          data-type="size"
                                          data-id="${m.id}"
                                          data-field="stock_level"
                                          data-value="${m.stock_level}"
                                          data-action="edit-inline-stock"
                                          title="Click to edit stock level">${m.stock_level}</span>
                                    <span class="">in stock</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="button" data-action="delete-size" data-id="${m.id}" class="bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `})}),t.innerHTML=l}async loadColorOptions(){if(this.currentItemSku)try{const t=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json(),o=document.getElementById("sizeColorFilter");if(!o)return;o.innerHTML='<option value="general">General Sizes (No Color)</option>',t.success&&Array.isArray(t.colors)&&t.colors.forEach(s=>{if(s.is_active==1){const i=document.createElement("option");i.value=s.id,i.textContent=`${s.color_name} (${s.stock_level} in stock)`,o.appendChild(i)}})}catch(e){console.error("Error loading colors for size filter:",e)}}async populateSizeColorSelect(){try{const t=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json(),o=document.getElementById("sizeColorId");if(!o)return;o.innerHTML='<option value="">General Size (No specific color)</option>',t.success&&Array.isArray(t.colors)&&t.colors.forEach(s=>{if(s.is_active==1){const i=document.createElement("option");i.value=s.id,i.textContent=s.color_name,o.appendChild(i)}})}catch(e){console.error("Error populating size color select:",e)}}updateSizeConfiguration(){const e=document.querySelector('input[name="sizeConfiguration"]:checked');if(!e)return;const t=e.value,o=document.getElementById("sizeTypeSelector"),s=document.getElementById("sizesList");t==="none"?(o&&o.classList.add("hidden"),s&&(s.innerHTML='<div class="text-center text-gray-500 text-sm">No sizes configured for this item</div>')):t==="general"?(o&&o.classList.add("hidden"),this.loadItemSizes("general")):t==="color_specific"&&(o&&o.classList.remove("hidden"),this.loadColorOptions(),this.loadItemSizes())}showSizeModal(e=null){document.getElementById("sizeModal")||this.createSizeModal();const t=document.getElementById("sizeModal"),o=document.getElementById("sizeForm"),s=document.getElementById("sizeModalTitle");if(!(!t||!o)){if(o.reset(),this.populateSizeColorSelect(),e){if(s.textContent="Edit Size",document.getElementById("sizeId").value=e.id,document.getElementById("sizeName").value=e.size_name||"",document.getElementById("sizeCode").value=e.size_code||"",document.getElementById("sizeStockLevel").value=e.stock_level||0,document.getElementById("sizePriceAdjustment").value=e.price_adjustment||0,document.getElementById("sizeDisplayOrder").value=e.display_order||0,document.getElementById("sizeIsActive").checked=e.is_active==1,e.color_id){const i=document.getElementById("sizeColorId");i&&(i.value=e.color_id)}}else{s.textContent="Add New Size",document.getElementById("sizeId").value="",document.getElementById("sizePriceAdjustment").value="0.00",document.getElementById("sizeDisplayOrder").value="0",document.getElementById("sizeIsActive").checked=!0;const i=document.getElementById("sizeColorFilter"),a=document.getElementById("sizeColorId");i&&a&&(a.value=i.value==="general"?"":i.value)}t.classList.remove("hidden")}}createSizeModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="sizeModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="sizeModalTitle" class="text-xl font-semibold text-gray-800">Add New Size</h2>
                    <button type="button" data-action="close-size-modal" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="sizeForm">
                        <input type="hidden" id="sizeId" name="sizeId">
                        <div class="">
                            <label for="sizeColorId" class="block text-sm font-medium text-gray-700">Color Association</label>
                            <select id="sizeColorId" name="sizeColorId" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                <option value="">General Size (No specific color)</option>
                            </select>
                            <div class="text-xs text-gray-500">Choose a color if this size is specific to a particular color variant</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="sizeName" class="block text-sm font-medium text-gray-700">Size Name *</label>
                                <input type="text" id="sizeName" name="sizeName" placeholder="e.g., Medium" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2" required>
                            </div>
                            <div>
                                <label for="sizeCode" class="block text-sm font-medium text-gray-700">Size Code *</label>
                                <select id="sizeCode" name="sizeCode" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2" required>
                                    <option value="">Select size...</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                    <option value="OS">OS (One Size)</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="sizeStockLevel" class="block text-sm font-medium text-gray-700">Stock Level</label>
                                <input type="number" id="sizeStockLevel" name="sizeStockLevel" min="0" value="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                            </div>
                            <div>
                                <label for="sizePriceAdjustment" class="block text-sm font-medium text-gray-700">Price Adjustment ($)</label>
                                <input type="number" id="sizePriceAdjustment" name="sizePriceAdjustment" step="0.01" value="0.00" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                <div class="text-xs text-gray-500">Extra charge for this size (e.g., +$2 for XXL)</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="sizeDisplayOrder" class="block text-sm font-medium text-gray-700">Display Order</label>
                                <input type="number" id="sizeDisplayOrder" name="sizeDisplayOrder" min="0" value="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                <div class="text-xs text-gray-500">Lower numbers appear first</div>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="sizeIsActive" name="sizeIsActive" class="">
                                    <span class="text-sm font-medium text-gray-700">Active (available to customers)</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 border-t border-gray-200">
                            <button type="button" data-action="close-size-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition-colors">Cancel</button>
                            <button type="submit" class="text-white rounded transition-colors bg-[#87ac3a] hover:bg-[#6b8e23]">Save Size</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`),this.populateSizeColorSelect()}loadData(){const e=document.getElementById("inventory-data");if(e)try{const t=JSON.parse(e.textContent);this.currentItemSku=t.currentItemSku,this.items=t.items||[],this.categories=t.categories||[],t.costBreakdown&&(this.costBreakdown={materials:t.costBreakdown.materials||{},labor:t.costBreakdown.labor||{},energy:t.costBreakdown.energy||{},equipment:t.costBreakdown.equipment||{},totals:t.costBreakdown.totals||{}})}catch(t){console.error("Error parsing inventory data:",t)}}init(){this.renderCostList("materials"),this.renderCostList("labor"),this.renderCostList("energy"),this.renderCostList("equipment"),this.updateTotalsDisplay(),this.loadExistingPriceSuggestion(this.currentItemSku),this.loadExistingMarketingSuggestion(this.currentItemSku),this.updateCategoryDropdown(),window.handleGlobalColorSelection=this.handleGlobalColorSelection.bind(this),window.loadItemColors=this.loadItemColors.bind(this),window.loadItemSizes=this.loadItemSizes.bind(this),document.getElementById("colorsList")&&this.loadItemColors(),document.getElementById("sizesList")&&this.loadItemSizes()}bindEvents(){document.body.addEventListener("click",this.handleDelegatedClick.bind(this)),document.body.addEventListener("mouseover",this.handleDelegatedMouseOver.bind(this)),document.body.addEventListener("mouseout",this.handleDelegatedMouseOut.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.body.addEventListener("keydown",this.handleDelegatedKeydown.bind(this)),document.body.addEventListener("submit",this.handleDelegatedSubmit.bind(this),!0),document.body.addEventListener("change",this.handleDelegatedChange.bind(this));const e=document.getElementById("imageUpload");e&&e.addEventListener("change",this.handleImageUpload.bind(this));const t=document.getElementById("multiImageUpload");t&&t.addEventListener("change",this.handleImageUpload.bind(this));const o=document.getElementById("aiAnalysisUpload");o&&o.addEventListener("change",this.handleImageUpload.bind(this))}handleKeyDown(e){e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||(e.key==="ArrowRight"?this.navigateToItem("next"):e.key==="ArrowLeft"&&this.navigateToItem("prev"))}handleDelegatedClick(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action,s=t.dataset.id,i=t.dataset.category;switch(t.tagName==="BUTTON"&&e.preventDefault(),o){case"delete-item":{const a=t.dataset.sku;if(!a){this.showError("Missing SKU to delete");return}this.itemToDeleteSku=a;const n=document.getElementById("deleteConfirmModal");n&&n.classList.add("show")}break;case"close-delete-modal":{const a=document.getElementById("deleteConfirmModal");a&&a.classList.remove("show"),this.itemToDeleteSku=null}break;case"confirm-delete-item":this.handleConfirmDeleteItem();break;case"navigate-item":this.navigateToItem(t.dataset.direction);break;case"add-item-color":this.showColorModal();break;case"add-item-size":this.showSizeModal();break;case"set-primary-image":this.setPrimaryImage(s);break;case"delete-image":this.confirmDeleteImage(s);break;case"trigger-upload":{const a=t.dataset.target||"imageUpload",n=document.getElementById(a);n&&typeof n.click=="function"?n.click():console.warn("Upload input not found for target:",a)}break;case"process-images-ai":this.processExistingImagesWithAI();break;case"open-cost-modal":this.openCostModal(i,s);break;case"close-cost-modal":this.closeCostModal();break;case"save-cost-item":this.saveCostItem();break;case"delete-cost-item":this.confirmDeleteCostItem(i,s);break;case"clear-cost-breakdown":this.confirmClearCostBreakdown();break;case"get-cost-suggestion":this.getCostSuggestion();break;case"get-price-suggestion":this.getPriceSuggestion();break;case"apply-price-suggestion":this.applyPriceSuggestion();break;case"clear-price-suggestion":this.clearPriceSuggestion();break;case"open-marketing-manager":this.openMarketingManager();break;case"generate-marketing-copy":this.generateMarketingCopy();break;case"close-marketing-manager":this.closeMarketingManager();break;case"close-marketing-modal":this.closeMarketingModal();break;case"close-ai-comparison-modal":this.closeAiComparisonModal();break;case"apply-selected-changes":this.applySelectedComparisonChanges();break;case"apply-marketing-to-item":this.applyMarketingToItem();break;case"generate-all-marketing":this.handleGenerateAllMarketing(t);break;case"generate-fresh-marketing":this.handleGenerateFreshMarketing(t);break;case"apply-and-save-marketing-title":this.handleApplyAndSaveMarketingTitle();break;case"apply-and-save-marketing-description":this.handleApplyAndSaveMarketingDescription();break;case"apply-title":this.applyTitle(t.dataset.value||"");break;case"apply-description":this.applyDescription(t.dataset.value||"");break;case"show-marketing-tab":this.switchMarketingTab(t.dataset.tab,t);break;case"apply-cost-suggestion-to-cost":this.applyCostSuggestionToCost();break;case"apply-suggested-cost-to-cost-field":this.applySuggestedCostToCostField(t);break;case"save-marketing-field":this.handleSaveMarketingField(t.dataset.field,t);break;case"add-list-item":this.handleAddListItem(t.dataset.field);break;case"remove-list-item":this.handleRemoveListItem(t.dataset.field,t.dataset.item,t);break;case"populate-cost-breakdown-from-suggestion":this.populateCostBreakdownFromSuggestion(JSON.parse(t.getAttribute("data-suggestion").replace(/&quot;/g,'"').replace(/&#39;/g,"'"))),this.closeCostSuggestionChoiceDialog();break;case"close-cost-suggestion-choice-dialog":this.closeCostSuggestionChoiceDialog();break;case"refresh-categories":this.refreshCategoryDropdown();break;case"move-carousel":this.moveCarousel(t.dataset.type,parseInt(t.dataset.direction,10)||0);break;case"show-pricing-tooltip-with-data":e.stopPropagation(),this.showPricingTooltipWithData(e,t.dataset.componentType,decodeURIComponent(t.dataset.explanation||""));break;case"show-pricing-tooltip-text":e.stopPropagation(),this.showPricingTooltip(e,decodeURIComponent(t.dataset.text||""));break;case"edit-inline-stock":this.editInlineStock(t);break;case"delete-color":this.deleteColor(parseInt(t.dataset.id,10));break;case"close-color-modal":this.closeColorModal();break;case"open-global-colors-management":this.openGlobalColorsManagement();break;case"delete-size":this.deleteSize(parseInt(t.dataset.id,10));break;case"close-size-modal":this.closeSizeModal();break;case"sync-size-stock":this.syncSizeStock();break;case"open-color-template-modal":this.openColorTemplateModal();break;case"close-color-template-modal":this.closeColorTemplateModal();break;case"apply-color-template":this.applySelectedColorTemplate();break;case"select-color-template":this.selectColorTemplate(parseInt(t.dataset.id,10));break;case"open-size-template-modal":this.openSizeTemplateModal();break;case"close-size-template-modal":this.closeSizeTemplateModal();break;case"apply-size-template":this.applySelectedSizeTemplate();break;case"select-size-template":this.selectSizeTemplate(parseInt(t.dataset.id,10));break;case"close-restructure-modal":typeof window.closeRestructureModal=="function"&&window.closeRestructureModal();break;case"close-structure-view-modal":typeof window.closeStructureViewModal=="function"&&window.closeStructureViewModal();break}}handleDelegatedSubmit(e){const t=e.target;t instanceof HTMLFormElement&&(t.id==="colorForm"?(e.preventDefault(),this.saveColor(t)):t.id==="sizeForm"?(e.preventDefault(),this.saveSize(t)):t.id==="inventoryForm"&&typeof window.validateGenderSizeColorRequirements=="function"&&window.validateGenderSizeColorRequirements(e)===!1&&e.preventDefault())}handleDelegatedChange(e){const t=e.target;if(t instanceof HTMLElement){if(t.id==="globalColorSelect")this.handleGlobalColorSelection();else if(t.getAttribute&&t.getAttribute("name")==="sizeConfiguration")this.updateSizeConfiguration();else if(t.id==="sizeColorFilter")this.loadItemSizes();else if(t.id==="colorTemplateCategory")this.filterColorTemplates();else if(t.id==="sizeTemplateCategory")this.filterSizeTemplates();else if(t.getAttribute&&t.getAttribute("name")==="sizeApplyMode"){const o=document.getElementById("colorSelectionForSizes");o&&(t.value==="color_specific"?(o.classList.remove("hidden"),this.loadColorsForSizeTemplate()):o.classList.add("hidden"))}else if(t.matches('select[data-action="marketing-default-change"]')){const o=t.getAttribute("data-setting");o&&this.updateGlobalMarketingDefault(o,t.value)}else if(t.matches('[data-action="toggle-select-all-comparison"]'))this.toggleSelectAllComparison();else if(t.matches('[data-action="toggle-comparison"]')){const o=t.getAttribute("data-field");o&&this.toggleComparison(o)}}}handleGlobalColorSelection(){const e=document.getElementById("globalColorSelect");if(!e)return;const t=e.value,o=document.getElementById("colorName"),s=document.getElementById("colorCode"),i=document.getElementById("selectedColorPreview"),a=document.getElementById("colorPreviewSwatch"),n=document.getElementById("colorPreviewName"),r=document.getElementById("colorPreviewCode");if(t)try{const l=JSON.parse(t);o.value=l.name,s.value=l.code||"#000000",i&&i.classList.remove("hidden"),a&&(a.style.backgroundColor=l.code||"#000000"),n&&(n.textContent=l.name),r&&(r.textContent=l.code||"No color code")}catch(l){console.error("Error parsing color data:",l)}else o&&(o.value=""),s&&(s.value=""),i&&i.classList.add("hidden")}openGlobalColorsManagement(){this.showConfirmationModal("Manage Global Colors","Global colors are managed in Admin Settings > Content Management > Global Colors & Sizes. Open Admin Settings now?",()=>{window.location.href="/?page=admin&section=settings"})}async syncSizeStock(){if(!this.currentItemSku){this.showError("No item selected");return}try{const t=await(await fetch("/api/item_sizes.php?action=sync_stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_sku:this.currentItemSku})})).json();if(t.success){this.showSuccess(`Stock synchronized - Total: ${t.new_total_stock}`);const o=document.getElementById("stockLevel");o&&t.new_total_stock!==void 0&&(o.value=t.new_total_stock),this.loadItemSizes()}else this.showError(`Error syncing stock: ${t.message||""}`)}catch(e){console.error("Error syncing stock:",e),this.showError("Error syncing stock levels")}}closeColorModal(){const e=document.getElementById("colorModal");e&&e.classList.add("hidden")}async saveColor(e){const t=e instanceof HTMLFormElement?e:document.getElementById("colorForm");if(!t)return;const o=new FormData(t),s={item_sku:this.currentItemSku,color_name:o.get("colorName"),color_code:o.get("colorCode"),image_path:o.get("colorImagePath")||"",stock_level:parseInt(o.get("stockLevel"),10)||0,display_order:parseInt(o.get("displayOrder"),10)||0,is_active:o.get("isActive")?1:0},i=o.get("colorId"),a=!!(i&&i!=="");a&&(s.color_id=parseInt(i,10));try{const r=await(await fetch(`/api/item_colors.php?action=${a?"update_color":"add_color"}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(r.success){this.showSuccess(`Color ${a?"updated":"added"} successfully${r.new_total_stock?` - Total stock: ${r.new_total_stock}`:""}`),this.closeColorModal(),this.loadItemColors();const l=document.getElementById("stockLevel");l&&r.new_total_stock!==void 0&&(l.value=r.new_total_stock)}else this.showError(`Error ${a?"updating":"adding"} color: ${r.message}`)}catch(n){console.error("Error saving color:",n),this.showError(`Error ${a?"updating":"adding"} color`)}}async openColorTemplateModal(){if(!this.currentItemSku){this.showError("Please save the item first before applying templates");return}document.getElementById("colorTemplateModal")||this.createColorTemplateModal(),await this.loadColorTemplates();const e=document.getElementById("colorTemplateModal");e&&e.classList.remove("hidden")}createColorTemplateModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="colorTemplateModal" class="modal-overlay hidden">
            <div class="modal-content" >
                <div class="modal-header">
                    <h2 class="text-xl font-bold text-gray-800">üé® Color Templates</h2>
                    <button type="button" data-action="close-color-template-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-4">
                            <div class="">
                                <label class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                                <select id="colorTemplateCategory" class="w-full border border-gray-300 rounded">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div id="colorTemplatesList" class="space-y-3">
                                <div class="text-center text-gray-500">Loading templates...</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h3 class="font-medium text-blue-800">Application Options</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="replaceExistingColors">
                                        <span class="text-sm">Replace existing colors (clear current colors first)</span>
                                    </label>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Default Stock Level for New Colors:</label>
                                        <input type="number" id="defaultColorStock" value="0" min="0" class="w-32 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-action="close-color-template-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="button" data-action="apply-color-template" id="applyColorTemplateBtn" class="bg-purple-600 text-white rounded hover:bg-purple-700" disabled>
                        Apply Template
                    </button>
                </div>
            </div>
        </div>`)}async loadColorTemplates(){try{const t=await(await fetch("/api/color_templates.php?action=get_all")).json();t.success?(this.colorTemplates=t.templates||[],this.renderColorTemplates(),this.loadColorTemplateCategories()):this.showError("Error loading color templates: "+(t.message||""))}catch(e){console.error("Error loading color templates:",e),this.showError("Error loading color templates")}}loadColorTemplateCategories(){const e=document.getElementById("colorTemplateCategory");if(!e)return;const t=[...new Set((this.colorTemplates||[]).map(o=>o.category))].sort();e.innerHTML='<option value="">All Categories</option>',t.forEach(o=>{const s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)})}filterColorTemplates(){this.renderColorTemplates()}renderColorTemplates(){const e=document.getElementById("colorTemplatesList");if(!e)return;const t=document.getElementById("colorTemplateCategory")?.value||"",o=this.colorTemplates||[],s=t?o.filter(i=>i.category===t):o;if(s.length===0){e.innerHTML='<div class="text-center text-gray-500">No templates found</div>';return}e.innerHTML=s.map(i=>`
            <div class="template-item border border-gray-200 rounded-lg hover:border-purple-300 cursor-pointer"
                 data-action="select-color-template" data-id="${i.id}" data-template-id="${i.id}">
                <div class="flex justify-between items-start p-2">
                    <div>
                        <h4 class="font-medium text-gray-800">${i.template_name}</h4>
                        <p class="text-sm text-gray-600">${i.description||"No description"}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs rounded">${i.category}</span>
                        <div class="text-xs text-gray-500">${i.color_count} colors</div>
                    </div>
                </div>
                <div class="template-preview p-2" id="colorPreview${i.id}">
                    <div class="text-xs text-gray-500">Loading colors...</div>
                </div>
            </div>
        `).join(""),s.forEach(i=>this.loadColorTemplatePreview(i.id))}async loadColorTemplatePreview(e){try{const o=await(await fetch(`/api/color_templates.php?action=get_template&template_id=${e}`)).json();if(o.success&&o.template&&Array.isArray(o.template.colors)){const s=document.getElementById(`colorPreview${e}`);s&&(s.innerHTML=`
                        <div class="flex flex-wrap gap-2">
                            ${o.template.colors.map(i=>`
                                <div class="flex items-center gap-1 text-xs">
                                    <div class="w-4 h-4 rounded border border-gray-300" style="background:${i.color_code||"#000"}"></div>
                                    <span>${i.color_name}</span>
                                </div>
                            `).join("")}
                        </div>
                    `)}}catch(t){console.error("Error loading color template preview:",t)}}selectColorTemplate(e){document.querySelectorAll("#colorTemplatesList .template-item").forEach(s=>{s.classList.remove("border-purple-500","bg-purple-50")});const t=document.querySelector(`#colorTemplatesList [data-template-id="${e}"]`);t&&t.classList.add("border-purple-500","bg-purple-50");const o=document.getElementById("applyColorTemplateBtn");o&&(o.disabled=!1,o.setAttribute("data-template-id",String(e)))}async applySelectedColorTemplate(){const e=document.getElementById("applyColorTemplateBtn"),t=e?.getAttribute("data-template-id");if(!t){this.showError("Please select a template first");return}const o=document.getElementById("replaceExistingColors")?.checked||!1,s=parseInt(document.getElementById("defaultColorStock")?.value,10)||0;try{e&&(e.disabled=!0,e.textContent="Applying...");const a=await(await fetch("/api/color_templates.php?action=apply_to_item",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:parseInt(t,10),item_sku:this.currentItemSku,replace_existing:!!o,default_stock:s})})).json();a.success?(this.showSuccess(`Template applied successfully! Added ${a.colors_added} colors.`),this.closeColorTemplateModal(),this.loadItemColors()):this.showError("Error applying template: "+(a.message||""))}catch(i){console.error("Error applying color template:",i),this.showError("Error applying color template")}finally{e&&(e.disabled=!1,e.textContent="Apply Template")}}closeColorTemplateModal(){const e=document.getElementById("colorTemplateModal");e&&e.classList.add("hidden")}async openSizeTemplateModal(){if(!this.currentItemSku){this.showError("Please save the item first before applying templates");return}document.getElementById("sizeTemplateModal")||this.createSizeTemplateModal(),await this.loadSizeTemplates();const e=document.getElementById("sizeTemplateModal");e&&e.classList.remove("hidden")}createSizeTemplateModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="sizeTemplateModal" class="modal-overlay hidden">
            <div class="modal-content" >
                <div class="modal-header">
                    <h2 class="text-xl font-bold text-gray-800">üìè Size Templates</h2>
                    <button type="button" data-action="close-size-template-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" >
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                            <select id="sizeTemplateCategory" class="w-full border border-gray-300 rounded">
                                <option value="">All Categories</option>
                            </select>
                        </div>

                        <div id="sizeTemplatesList" class="space-y-3">
                            <div class="text-center text-gray-500">Loading templates...</div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h3 class="font-medium text-blue-800">Application Options</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Apply Mode:</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sizeApplyMode" value="general" checked>
                                            <span class="text-sm">General sizes (not color-specific)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sizeApplyMode" value="color_specific">
                                            <span class="text-sm">Color-specific sizes</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="colorSelectionForSizes" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Select Color:</label>
                                    <select id="sizeTemplateColorId" class="w-full border border-gray-300 rounded text-sm">
                                        <option value="">Loading colors...</option>
                                    </select>
                                </div>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="replaceExistingSizes">
                                    <span class="text-sm">Replace existing sizes</span>
                                </label>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Default Stock Level for New Sizes:</label>
                                    <input type="number" id="defaultSizeStock" value="0" min="0" class="w-32 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-action="close-size-template-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="button" data-action="apply-size-template" id="applySizeTemplateBtn" class="bg-purple-600 text-white rounded hover:bg-purple-700" disabled>
                        Apply Template
                    </button>
                </div>
            </div>
        </div>`)}async loadSizeTemplates(){try{const t=await(await fetch("/api/size_templates.php?action=get_all")).json();t.success?(this.sizeTemplates=t.templates||[],this.renderSizeTemplates(),this.loadSizeTemplateCategories()):this.showError("Error loading size templates: "+(t.message||""))}catch(e){console.error("Error loading size templates:",e),this.showError("Error loading size templates")}}loadSizeTemplateCategories(){const e=document.getElementById("sizeTemplateCategory");if(!e)return;const t=[...new Set((this.sizeTemplates||[]).map(o=>o.category))].sort();e.innerHTML='<option value="">All Categories</option>',t.forEach(o=>{const s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)})}filterSizeTemplates(){this.renderSizeTemplates()}renderSizeTemplates(){const e=document.getElementById("sizeTemplatesList");if(!e)return;const t=document.getElementById("sizeTemplateCategory")?.value||"",o=this.sizeTemplates||[],s=t?o.filter(i=>i.category===t):o;if(s.length===0){e.innerHTML='<div class="text-center text-gray-500">No templates found</div>';return}e.innerHTML=s.map(i=>`
            <div class="template-item border border-gray-200 rounded-lg hover:border-purple-300 cursor-pointer"
                 data-action="select-size-template" data-id="${i.id}" data-template-id="${i.id}">
                <div class="flex justify-between items-start p-2">
                    <div>
                        <h4 class="font-medium text-gray-800">${i.template_name}</h4>
                        <p class="text-sm text-gray-600">${i.description||"No description"}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs rounded">${i.category}</span>
                        <div class="text-xs text-gray-500">${i.size_count} sizes</div>
                    </div>
                </div>
                <div class="template-preview p-2" id="sizePreview${i.id}">
                    <div class="text-xs text-gray-500">Loading sizes...</div>
                </div>
            </div>
        `).join(""),s.forEach(i=>this.loadSizeTemplatePreview(i.id))}async loadSizeTemplatePreview(e){try{const o=await(await fetch(`/api/size_templates.php?action=get_template&template_id=${e}`)).json();if(o.success&&o.template&&Array.isArray(o.template.sizes)){const s=document.getElementById(`sizePreview${e}`);s&&(s.innerHTML=`
                        <div class="flex flex-wrap gap-2">
                            ${o.template.sizes.map(i=>`
                                <span class="inline-block bg-gray-100 text-gray-700 text-xs rounded px-1">${i.size_name} (${i.size_code})${i.price_adjustment>0?" +$"+i.price_adjustment:i.price_adjustment<0?" $"+i.price_adjustment:""}</span>
                            `).join("")}
                        </div>
                    `)}}catch(t){console.error("Error loading size template preview:",t)}}selectSizeTemplate(e){document.querySelectorAll("#sizeTemplatesList .template-item").forEach(s=>{s.classList.remove("border-purple-500","bg-purple-50")});const t=document.querySelector(`#sizeTemplatesList [data-template-id="${e}"]`);t&&t.classList.add("border-purple-500","bg-purple-50");const o=document.getElementById("applySizeTemplateBtn");o&&(o.disabled=!1,o.setAttribute("data-template-id",String(e)))}async loadColorsForSizeTemplate(){if(this.currentItemSku)try{const t=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json(),o=document.getElementById("sizeTemplateColorId");if(!o)return;o.innerHTML='<option value="">Select a color...</option>',t.success&&Array.isArray(t.colors)&&t.colors.length>0?t.colors.forEach(s=>{if(s.is_active==1){const i=document.createElement("option");i.value=s.id,i.textContent=s.color_name,o.appendChild(i)}}):o.innerHTML='<option value="">No colors available - add colors first</option>'}catch(e){console.error("Error loading colors for size template:",e)}}async applySelectedSizeTemplate(){const e=document.getElementById("applySizeTemplateBtn"),t=e?.getAttribute("data-template-id");if(!t){this.showError("Please select a template first");return}const o=document.querySelector('input[name="sizeApplyMode"]:checked')?.value||"general",s=document.getElementById("replaceExistingSizes")?.checked||!1,i=parseInt(document.getElementById("defaultSizeStock")?.value,10)||0;let a=null;if(o==="color_specific"&&(a=document.getElementById("sizeTemplateColorId")?.value,!a)){this.showError("Please select a color for color-specific sizes");return}try{e&&(e.disabled=!0,e.textContent="Applying...");const r=await(await fetch("/api/size_templates.php?action=apply_to_item",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:parseInt(t,10),item_sku:this.currentItemSku,apply_mode:o,color_id:a?parseInt(a,10):null,replace_existing:!!s,default_stock:i})})).json();r.success?(this.showSuccess(`Template applied successfully! Added ${r.sizes_added} sizes.`),this.closeSizeTemplateModal(),this.loadItemSizes()):this.showError("Error applying template: "+(r.message||""))}catch(n){console.error("Error applying size template:",n),this.showError("Error applying size template")}finally{e&&(e.disabled=!1,e.textContent="Apply Template")}}closeSizeTemplateModal(){const e=document.getElementById("sizeTemplateModal");e&&e.classList.add("hidden")}editInlineStock(e){if(!e||e.classList.contains("editing"))return;const t=e.getAttribute("data-value"),o=e.getAttribute("data-type"),s=e.getAttribute("data-id"),i=document.createElement("input");i.type="number",i.min="0",i.value=t,i.className="inline-stock-input";const a=e.innerHTML;e.innerHTML="",e.appendChild(i),e.classList.add("editing"),i.focus(),i.select();const n=()=>{e.classList.remove("editing"),e.innerHTML=a},r=async()=>{const l=parseInt(i.value,10)||0;if(l==t){n();return}try{i.disabled=!0,i.style.opacity="0.6";let c,d;if(o==="color")c="/api/item_colors.php?action=update_stock",d={color_id:parseInt(s,10),stock_level:l};else if(o==="size")c="/api/item_sizes.php?action=update_stock",d={size_id:parseInt(s,10),stock_level:l};else{n();return}const u=await(await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();if(u.success){if(e.setAttribute("data-value",l),e.classList.remove("editing"),e.innerHTML=String(l),u.new_total_stock!==void 0){const p=document.getElementById("stockLevel");p&&(p.value=u.new_total_stock)}o==="color"?typeof window.loadItemColors=="function"&&window.loadItemColors():o==="size"&&typeof window.loadItemSizes=="function"&&window.loadItemSizes(),this.showSuccess(`${o.charAt(0).toUpperCase()+o.slice(1)} stock updated to ${l}`)}else throw new Error(u.message||"Failed to update stock")}catch(c){console.error("Error updating stock:",c),this.showError(`Error updating ${o} stock: ${c.message}`),n()}};i.addEventListener("blur",r),i.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),r()):l.key==="Escape"&&(l.preventDefault(),n())}),i.addEventListener("click",l=>{l.stopPropagation()})}deleteColor(e){e&&this.showConfirmationModal("Delete Color","Are you sure you want to delete this color? This action cannot be undone.",async()=>{try{const o=await(await fetch("/api/item_colors.php?action=delete_color",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({color_id:e})})).json();o.success?(this.showSuccess("Color deleted successfully"),typeof window.loadItemColors=="function"&&window.loadItemColors()):this.showError("Error deleting color: "+(o.message||""))}catch(t){console.error("Error deleting color:",t),this.showError("Error deleting color")}})}closeSizeModal(){const e=document.getElementById("sizeModal");e&&e.classList.add("hidden")}async saveSize(e){const t=e instanceof HTMLFormElement?e:document.getElementById("sizeForm");if(!t)return;const o=new FormData(t),s={item_sku:this.currentItemSku,color_id:o.get("sizeColorId")||null,size_name:o.get("sizeName"),size_code:o.get("sizeCode"),stock_level:parseInt(o.get("sizeStockLevel"),10)||0,price_adjustment:parseFloat(o.get("sizePriceAdjustment"))||0,display_order:parseInt(o.get("sizeDisplayOrder"),10)||0,is_active:o.get("sizeIsActive")?1:0},i=o.get("sizeId"),a=!!(i&&i!=="");a&&(s.size_id=parseInt(i,10));try{const r=await(await fetch(`/api/item_sizes.php?action=${a?"update_size":"add_size"}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})).json();if(r.success){this.showSuccess(`Size ${a?"updated":"added"} successfully${r.new_total_stock?` - Total stock: ${r.new_total_stock}`:""}`),this.closeSizeModal(),typeof window.loadItemSizes=="function"&&window.loadItemSizes();const l=document.getElementById("stockLevel");l&&r.new_total_stock!==void 0&&(l.value=r.new_total_stock)}else this.showError("Error saving size: "+(r.message||""))}catch(n){console.error("Error saving size:",n),this.showError("Error saving size")}}deleteSize(e){e&&this.showConfirmationModal("Delete Size","Are you sure you want to delete this size? This action cannot be undone.",async()=>{try{const o=await(await fetch("/api/item_sizes.php?action=delete_size",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({size_id:e})})).json();if(o.success){if(this.showSuccess("Size deleted successfully"),typeof window.loadItemSizes=="function"&&window.loadItemSizes(),o.new_total_stock!==void 0){const s=document.getElementById("stockLevel");s&&(s.value=o.new_total_stock)}}else this.showError("Error deleting size: "+(o.message||""))}catch(t){console.error("Error deleting size:",t),this.showError("Error deleting size")}})}handleDelegatedMouseOver(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action;if(o==="show-pricing-tooltip-with-data"){const s=t.dataset.componentType,i=decodeURIComponent(t.dataset.explanation||"");this.showPricingTooltipWithData(e,s,i)}else if(o==="show-pricing-tooltip-text"){const s=decodeURIComponent(t.dataset.text||"");this.showPricingTooltip(e,s)}}handleDelegatedMouseOut(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action;(o==="show-pricing-tooltip-with-data"||o==="show-pricing-tooltip-text")&&this.hidePricingTooltipDelayed()}hidePricingTooltipDelayed(){this.tooltipTimeout=setTimeout(()=>{this.currentTooltip&&this.currentTooltip.parentNode&&(this.currentTooltip.remove(),this.currentTooltip=null)},300)}async getPricingExplanation(e){try{const t=`/api/get_pricing_explanation.php?text=${encodeURIComponent(e)}`,s=await(await fetch(t)).json();if(s.success)return{title:s.title,explanation:s.explanation}}catch(t){console.error("Error fetching pricing explanation:",t)}return{title:"AI Pricing Analysis",explanation:"Advanced algorithmic analysis considering multiple market factors and pricing strategies."}}async showPricingTooltip(e,t){e.stopPropagation(),this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),document.querySelectorAll(".pricing-tooltip").forEach(i=>i.remove());const o=e.target.closest(".info-icon-container");if(!o)return;o.style.position="relative";const s=document.createElement("div");s.className="pricing-tooltip absolute z-50 bg-gray-800 text-white text-xs rounded-lg p-3 shadow-lg max-w-xs",s.style.cssText=`
            top: -10px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            word-wrap: break-word;
            line-height: 1.4;
        `,s.innerHTML=`
            <div class="tooltip-arrow absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-white"></div>
                <span>Loading explanation...</span>
            </div>
        `,o.appendChild(s);try{const i=await this.getPricingExplanation(t);s.remove();const a=document.createElement("div");a.className="pricing-tooltip absolute z-50 bg-gray-800 text-white text-xs rounded-lg p-3 shadow-lg max-w-xs",a.style.cssText=`
                top: -10px;
                left: 50%;
                transform: translateX(-50%) translateY(-100%);
                word-wrap: break-word;
                line-height: 1.4;
                pointer-events: auto;
            `,a.innerHTML=`
                <div class="tooltip-arrow absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                <div class="font-semibold text-blue-200">${i.title}</div>
                <div>${i.explanation}</div>
            `,a.addEventListener("mouseenter",()=>{this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null)}),a.addEventListener("mouseleave",()=>{this.hidePricingTooltipDelayed()}),o.appendChild(a),this.currentTooltip=a;const n=r=>{a.contains(r.target)||(a.parentNode&&a.remove(),document.removeEventListener("click",n))};document.addEventListener("click",n)}catch{s&&s.parentNode&&s.remove()}}showPricingTooltipWithData(e,t,o){e.stopPropagation(),this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),document.querySelectorAll(".pricing-tooltip").forEach(l=>l.remove());const s=e.target.closest(".info-icon-container");if(!s)return;s.style.position="relative";const i=document.createElement("div");i.className="pricing-tooltip absolute z-50 bg-gray-800 text-white text-xs rounded-lg p-3 shadow-lg max-w-xs",i.style.cssText=`
            left: 25px;
            top: -10px;
            white-space: normal;
            line-height: 1.4;
            pointer-events: auto;
        `;const n={cost_plus:"Cost-Plus Pricing",market_research:"Market Research Analysis",competitive_analysis:"Competitive Analysis",value_based:"Value-Based Pricing",brand_premium:"Brand Premium",psychological_pricing:"Psychological Pricing",seasonality:"Seasonal Adjustment",analysis:"AI Pricing Analysis"}[t]||"Pricing Analysis";let r=o;try{const l=typeof o=="string"?JSON.parse(o):o;Array.isArray(l)?r=l.join(" "):l&&typeof l=="object"?r=Object.values(l).join(" "):typeof l=="string"&&(r=l)}catch{}i.innerHTML=`
            <div class="font-semibold">${n}</div>
            <div>${r}</div>
        `,i.addEventListener("mouseenter",()=>{this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null)}),i.addEventListener("mouseleave",()=>{this.hidePricingTooltipDelayed()}),s.appendChild(i),this.currentTooltip=i}moveCarousel(e,t){const o=e==="edit"?"editCarouselTrack":"viewCarouselTrack",s=e==="edit"?"editCarouselPosition":"viewCarouselPosition",i=document.getElementById(o);if(!i)return;const n=i.querySelectorAll(".carousel-slide").length,r=3;if(n<=r)return;const l=Math.max(0,n-r);let c=this[s]||0;c+=t,c<0&&(c=0),c>l&&(c=l),this[s]=c;const d=-(c*170);i.style.transform=`translateX(${d}px)`,this.updateCarouselNavigation(e,n)}updateCarouselNavigation(e,t){const o=e==="edit"?"editCarouselTrack":"viewCarouselTrack",s=e==="edit"?"editCarouselPosition":"viewCarouselPosition",i=document.getElementById(o);if(!i)return;const a=i.closest(".image-carousel-container"),n=a.querySelector(".carousel-prev"),r=a.querySelector(".carousel-next"),l=3,c=this[s]||0,d=Math.max(0,t-l);n&&(n.style.display=c===0?"none":"block"),r&&(r.style.display=c>=d?"none":"block")}navigateToItem(e){if(!this.currentItemSku||this.items.length===0)return;const t=this.items.findIndex(a=>a.sku===this.currentItemSku);if(t===-1)return;let o;e==="next"?o=(t+1)%this.items.length:o=(t-1+this.items.length)%this.items.length;const s=this.items[o].sku,i=new URL(window.location.href);i.searchParams.set("edit",s),i.searchParams.delete("view"),window.location.href=i.toString()}async setPrimaryImage(e){try{const o=await(await fetch("/api/set_primary_image.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sku:this.currentItemSku,image_id:e})})).json();o.success?(this.showSuccess("Primary image updated!"),document.querySelectorAll(".image-card").forEach(s=>s.classList.remove("border-green-500","border-4")),document.querySelector(`.image-card[data-id='${e}']`).classList.add("border-green-500","border-4")):this.showError(o.error||"Failed to set primary image.")}catch(t){this.showError("An error occurred. Please try again."),console.error("Set primary image error:",t)}}confirmDeleteImage(e){this.showConfirmationModal("Delete Image","Are you sure you want to delete this image? This action cannot be undone.",()=>this.deleteImage(e))}async deleteImage(e){try{const o=await(await fetch("/api/delete_item_image.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_id:e})})).json();if(o.success){this.showSuccess("Image deleted successfully!");const s=document.querySelector(`.image-card[data-id='${e}']`);s&&s.remove()}else this.showError(o.error||"Failed to delete image.")}catch(t){this.showError("An error occurred. Please try again."),console.error("Delete image error:",t)}}async handleImageUpload(e){const t=e.target.files;if(t.length===0)return;const o=new FormData;o.append("sku",this.currentItemSku);for(let i=0;i<t.length;i++)o.append("images[]",t[i]);const s=document.getElementById("uploadIndicator");s.classList.remove("hidden");try{const a=await(await fetch("/api/upload_item_images.php",{method:"POST",body:o})).json();a.success?(this.showSuccess("Images uploaded successfully! Refreshing..."),setTimeout(()=>window.location.reload(),1500)):this.showError(a.error||"An error occurred during upload.")}catch(i){this.showError("Upload failed. Please check the console for details."),console.error("Upload error:",i)}finally{s.classList.add("hidden")}}async processExistingImagesWithAI(){this.showConfirmationModal("Process Images with AI","This will analyze existing images to improve product data. This may take a moment. Continue?",async()=>{const e=document.querySelector('[data-action="process-images-ai"]'),t=e.innerHTML;e.innerHTML="Processing...",e.disabled=!0;try{const s=await(await fetch(`/api/run_image_analysis.php?sku=${this.currentItemSku}`)).json();s.success?(this.showSuccess("AI processing complete! The page will now reload."),setTimeout(()=>window.location.reload(),2e3)):this.showError(s.error||"AI processing failed.")}catch(o){this.showError("An error occurred during AI processing."),console.error("AI processing error:",o)}finally{e.innerHTML=t,e.disabled=!1}})}openCostModal(e,t=null){this.currentEditCostItem={category:e,id:t};const o=document.getElementById("costItemModal"),s=document.getElementById("costItemModalTitle"),i=document.getElementById("costName"),a=document.getElementById("costValue");if(s.textContent=t?`Edit ${e} Item`:`Add ${e} Item`,t&&this.costBreakdown[e]&&this.costBreakdown[e][t]){const n=this.costBreakdown[e][t];i.value=n.name,a.value=n.cost}else i.value="",a.value="";o.classList.remove("hidden")}closeCostModal(){document.getElementById("costItemModal").classList.add("hidden"),this.currentEditCostItem=null}async saveCostItem(){if(!this.currentEditCostItem)return;const{category:e,id:t}=this.currentEditCostItem,o=document.getElementById("costName").value.trim(),s=parseFloat(document.getElementById("costValue").value);if(!o||isNaN(s)){this.showError("Please enter a valid name and cost.");return}const i=t||`${e}_${Date.now()}`,a={name:o,cost:s};this.costBreakdown[e]||(this.costBreakdown[e]={}),this.costBreakdown[e][i]=a,this.renderCostList(e),this.updateTotalsDisplay(),this.closeCostModal();try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t?"update":"add",inventory_id:this.currentItemSku,category:e,item_id:i,data:a})})).json()).success||(this.showError("Failed to save item. Reverting changes."),delete this.costBreakdown[e][i],this.renderCostList(e),this.updateTotalsDisplay())}catch(n){this.showError("An error occurred while saving."),console.error("Save cost item error:",n)}}confirmDeleteCostItem(e,t){this.showConfirmationModal("Delete Cost Item","Are you sure you want to delete this item?",()=>this.deleteCostItem(e,t))}async deleteCostItem(e,t){this.costBreakdown[e]&&this.costBreakdown[e][t]&&(delete this.costBreakdown[e][t],this.renderCostList(e),this.updateTotalsDisplay());try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"delete",inventory_id:this.currentItemSku,category:e,item_id:t})})).json()).success||this.showError("Failed to delete item from server.")}catch(o){this.showError("An error occurred while deleting."),console.error("Delete cost item error:",o)}}async handleConfirmDeleteItem(){try{const e=this.itemToDeleteSku;if(!e)return;const t=document.getElementById("deleteConfirmModal");t&&t.classList.remove("show");const s=await(await fetch(`/functions/process_inventory_update.php?action=delete&sku=${encodeURIComponent(e)}`,{method:"DELETE",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();s&&s.success?(this.showSuccess(s.message||"Item deleted"),setTimeout(()=>{window.location.href="?page=admin&section=inventory"},1e3)):this.showError(s&&s.error||"Failed to delete item.")}catch(e){console.error("Delete item error:",e),this.showError("Failed to delete item.")}finally{this.itemToDeleteSku=null}}renderCostList(e){const t=document.getElementById(`${e}List`);if(!t)return;t.innerHTML="";const o=this.costBreakdown[e],s=Object.keys(o||{});if(s.length===0){t.innerHTML='<p class="text-gray-500 text-xs italic">No items added yet.</p>';return}s.forEach(i=>{const a=o[i],n=document.createElement("div");n.className="cost-item-row flex justify-between items-center p-2 rounded hover:bg-gray-100",n.innerHTML=`
                <span>${this.escapeHtml(a.name)}</span>
                <div class="flex items-center">
                    <span class="mr-4 font-medium">$${parseFloat(a.cost).toFixed(2)}</span>
                    <button data-action="open-cost-modal" data-category="${e}" data-id="${i}" class="text-blue-500 hover:text-blue-700 mr-2">Edit</button>
                    <button data-action="delete-cost-item" data-category="${e}" data-id="${i}" class="text-red-500 hover:text-red-700">Delete</button>
                </div>
            `,t.appendChild(n)})}updateTotalsDisplay(){let e=0,t=0,o=0,s=0;for(const n in this.costBreakdown.materials)e+=parseFloat(this.costBreakdown.materials[n].cost);for(const n in this.costBreakdown.labor)t+=parseFloat(this.costBreakdown.labor[n].cost);for(const n in this.costBreakdown.energy)o+=parseFloat(this.costBreakdown.energy[n].cost);for(const n in this.costBreakdown.equipment)s+=parseFloat(this.costBreakdown.equipment[n].cost);const i=e+t+o+s;this.costBreakdown.totals={materialTotal:e,laborTotal:t,energyTotal:o,equipmentTotal:s,totalCost:i},document.getElementById("materialTotal").textContent=`$${e.toFixed(2)}`,document.getElementById("laborTotal").textContent=`$${t.toFixed(2)}`,document.getElementById("energyTotal").textContent=`$${o.toFixed(2)}`,document.getElementById("equipmentTotal").textContent=`$${s.toFixed(2)}`,document.getElementById("totalCost").textContent=`$${i.toFixed(2)}`;const a=document.getElementById("suggestedCostDisplay");a&&(a.textContent=`$${i.toFixed(2)}`)}confirmClearCostBreakdown(){this.showConfirmationModal("Clear Cost Breakdown","Are you sure you want to delete all cost items? This is irreversible.",()=>this.clearCostBreakdownCompletely())}async clearCostBreakdownCompletely(){this.costBreakdown={materials:{},labor:{},energy:{},equipment:{},totals:{}},["materials","labor","energy","equipment"].forEach(e=>this.renderCostList(e)),this.updateTotalsDisplay();try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"clear_all",inventory_id:this.currentItemSku})})).json()).success?this.showSuccess("Cost breakdown cleared."):this.showError("Failed to clear breakdown on server.")}catch(e){this.showError("An error occurred while clearing the breakdown."),console.error("Clear breakdown error:",e)}}async getCostSuggestion(){const e=document.querySelector('[data-action="get-cost-suggestion"]'),t=e.innerHTML;e.innerHTML="Analyzing...",e.disabled=!0;try{const s=await(await fetch(`/api/suggest_cost.php?sku=${this.currentItemSku}`)).json();s.success?this.showCostSuggestionChoiceDialog(s.suggestions):this.showError(s.error||"Failed to get cost suggestion.")}catch(o){this.showError("Failed to connect to cost suggestion service."),console.error("Get cost suggestion error:",o)}finally{e.innerHTML=t,e.disabled=!1}}async getPriceSuggestion(){const e=document.querySelector('[data-action="get-price-suggestion"]'),t=e.innerHTML;e.innerHTML="Analyzing...",e.disabled=!0;const o={name:document.getElementById("name").value,description:document.getElementById("description").value,category:document.getElementById("category").value,costPrice:document.getElementById("costPrice").value,sku:this.currentItemSku,useImages:!0};try{const i=await(await fetch("/api/suggest_price.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json();i.success?(this.displayPriceSuggestion(i),this.showSuccess("Price suggestion generated!")):this.showError(i.error||"Failed to get price suggestion.")}catch(s){this.showError("Failed to connect to pricing service."),console.error("Get price suggestion error:",s)}finally{e.innerHTML=t,e.disabled=!1}}displayPriceSuggestion(e){const t=document.getElementById("priceSuggestionDisplay"),o=document.getElementById("priceSuggestionPlaceholder");if(!t||!o)return;o.classList.add("hidden"),t.classList.remove("hidden"),document.getElementById("displaySuggestedPrice").textContent=`$${parseFloat(e.suggestedPrice).toFixed(2)}`,document.getElementById("displayConfidence").textContent=`${e.confidence||"N/A"}`,document.getElementById("displayTimestamp").textContent=new Date(e.createdAt).toLocaleString(),t.dataset.suggestedPrice=e.suggestedPrice;const s=document.getElementById("reasoningList");s.innerHTML="",e.reasoning&&e.reasoning.split("‚Ä¢").filter(a=>a.trim()).forEach(a=>{const n=document.createElement("li");n.textContent=a.trim(),s.appendChild(n)})}applyPriceSuggestion(){const e=document.getElementById("priceSuggestionDisplay"),t=document.getElementById("retailPrice"),o=e.dataset.suggestedPrice;o&&(t.value=parseFloat(o).toFixed(2),t.style.backgroundColor="#dcfce7",setTimeout(()=>{t.style.backgroundColor=""},2e3),this.showSuccess("Suggested price applied!"))}clearPriceSuggestion(){const e=document.getElementById("priceSuggestionDisplay"),t=document.getElementById("priceSuggestionPlaceholder");e.classList.add("hidden"),t.classList.remove("hidden"),e.dataset.suggestedPrice=""}async loadExistingPriceSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_price_suggestion.php?sku=${e}`)).json();o.success&&o.suggestedPrice&&this.displayPriceSuggestion(o)}catch(t){console.error("Error loading existing price suggestion:",t)}}async loadExistingMarketingSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_marketing_suggestion.php?sku=${e}`)).json();if(o.success&&o.exists){const s=document.querySelector("#open-marketing-manager-btn")||document.querySelector('[data-action="open-marketing-manager"]');if(!s)return;const i=document.createElement("span");i.className="suggestion-indicator ml-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full",i.textContent="üíæ Previous",i.title="Previous AI analysis available",s.appendChild(i)}}catch(t){console.error("Error loading existing marketing suggestion:",t)}}async generateMarketingCopy(){const e=this.currentItemSku||document.getElementById("sku")?.value||document.getElementById("skuDisplay")?.textContent;if(!e){this.showError("No item selected for marketing generation");return}const t=document.getElementById("name");if(!t||!t.value.trim()){this.showError("Item name is required for marketing generation");return}if(window.showAIComparisonModal)try{window.showAIComparisonModal()}catch{}else{const r=document.getElementById("aiComparisonModal");r&&r.classList.remove("hidden")}const o=document.getElementById("aiProgressText");o&&(o.textContent="Initializing AI analysis...");const s=document.getElementById("brandVoice")?.value||"",i=document.getElementById("contentTone")?.value||"",a=await this.checkAIImageSupport(),n={sku:e,name:t.value.trim(),description:document.getElementById("description")?.value||"",category:document.getElementById("categoryEdit")?.value||"",brandVoice:s,contentTone:i,useImages:!!a};try{const l=await(await fetch("/api/suggest_marketing.php",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(n)})).json();if(!l||!l.success){this.showError(l&&l.error||"Failed to generate marketing content"),this.closeAiComparisonModal();return}window.aiComparisonData=l;const c=async()=>{try{const p=await(await fetch(`/api/marketing_manager.php?action=get_marketing_data&sku=${encodeURIComponent(e)}&_t=${Date.now()}`)).json();if(window.buildComparisonInterface)window.buildComparisonInterface(l,p?.data||null);else{const g=document.getElementById("aiComparisonContent");g&&(g.innerHTML='<pre class="text-xs bg-gray-50 p-3 rounded border">'+this.escapeHtml(JSON.stringify(l,null,2))+"</pre>")}}catch{window.buildComparisonInterface&&window.buildComparisonInterface(l,null)}};if(window.collapseAIProgressSection)try{window.collapseAIProgressSection()}catch{}await c();const d=document.getElementById("applyChangesBtn");d&&d.classList.remove("hidden");const m=document.getElementById("statusText");m&&(m.textContent="Select changes to apply, then click Apply Selected Changes"),this.showSuccess("AI marketing content generated.")}catch(r){console.error("Error generating marketing content:",r),this.showError("Failed to generate marketing content"),this.closeAiComparisonModal()}}closeMarketingModal(){const e=document.getElementById("marketingIntelligenceModal");e&&e.remove()}openMarketingManager(){const e=document.getElementById("marketingManagerModal");if(!e)return;const t=document.getElementById("currentEditingSku");t&&this.currentItemSku&&(t.textContent=this.currentItemSku),e.classList.remove("hidden")}closeMarketingManager(){const e=document.getElementById("marketingManagerModal");e&&e.classList.add("hidden")}closeAiComparisonModal(){const e=document.getElementById("aiComparisonModal");e&&e.classList.add("hidden")}async updateGlobalMarketingDefault(e,t){try{const o={auto_apply_defaults:"true"};if(e==="brand_voice"){o.default_brand_voice=t;const a=document.getElementById("contentTone");o.default_content_tone=a?a.value:"conversational"}else if(e==="content_tone"){o.default_content_tone=t;const a=document.getElementById("brandVoice");o.default_brand_voice=a?a.value:"friendly"}const i=await(await fetch("/api/website_config.php?action=update_marketing_defaults",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(o)})).json();i.success?this.showSuccess(`Global ${e.replace("_"," ")} updated successfully!`):this.showError(i.error||"Failed to update global setting")}catch(o){console.error("Error updating global marketing default:",o),this.showError("Failed to update global setting")}}toggleSelectAllComparison(){const e=document.getElementById("selectAllComparison");if(!e)return;const t=!!e.checked;document.querySelectorAll('[data-action="toggle-comparison"][data-field]').forEach(s=>{s.checked=t;const i=s.getAttribute("data-field");i&&this.toggleComparison(i)})}toggleComparison(e){const t=document.getElementById(`comparison-${e}-checkbox`)||document.querySelector(`[data-action="toggle-comparison"][data-field="${e}"]`);if(!t)return;if(t.checked){const i=this.getAiSuggestedValue(e);i&&(this.selectedComparisonChanges[e]=i)}else delete this.selectedComparisonChanges[e];this.updateSelectAllState();const o=document.getElementById("applyChangesBtn"),s=Object.keys(this.selectedComparisonChanges).length;o&&(o.textContent=s>0?`Apply ${s} Selected Changes`:"Apply Selected Changes")}getAiSuggestedValue(e){const t=window.aiComparisonData||{};if(e==="title"&&t.title)return t.title;if(e==="description"&&t.description)return t.description;if(e==="target_audience"&&t.targetAudience)return t.targetAudience;if((e==="demographic_targeting"||e==="psychographic_profile")&&t.marketingIntelligence){const s=t.marketingIntelligence[e];if(s)return s}const o=document.getElementById(`comparison-${e}-checkbox`)||document.querySelector(`[data-action="toggle-comparison"][data-field="${e}"]`);if(o){const s=o.closest(".bg-white")||o.closest("[data-comparison-card]")||o.closest("div"),i=s&&s.querySelector(".bg-green-50 p");if(i)return i.textContent.trim()}return""}updateSelectAllState(){const e=document.getElementById("selectAllComparison");if(!e)return;const t=Array.from(document.querySelectorAll('[data-action="toggle-comparison"][data-field]')),o=t.filter(s=>s.checked).length;o===0?(e.checked=!1,e.indeterminate=!1):o===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}async applySelectedComparisonChanges(){const e=this.selectedComparisonChanges||{},t=Object.keys(e);if(t.length===0){this.showError("Please select at least one change to apply");return}let o=this.currentItemSku;if(!o){const s=document.getElementById("sku")||document.getElementById("skuDisplay");o=s&&(s.value||s.textContent)}if(!o){console.error("No SKU available for saving changes"),this.showError("Unable to save changes - no item SKU available");return}try{const i=(await Promise.all(t.map(async a=>{const n=e[a],r={sku:o,field:a==="title"?"suggested_title":a==="description"?"suggested_description":a,value:n};try{const c=await(await fetch("/api/marketing_manager.php?action=update_field",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(r)})).json();if(!c.success)throw new Error(c.error||"Save failed");return{fieldKey:a,success:!0}}catch(l){return console.error(`Error saving ${a}:`,l),{fieldKey:a,success:!1,error:l}}}))).filter(a=>a.success).length;i>0?(t.forEach(a=>{if(a==="title"||a==="description"){const n=document.getElementById(a==="title"?"name":"description");n&&(n.value=e[a],n.style.backgroundColor="#f0fdf4",setTimeout(()=>{n.style.backgroundColor=""},3e3))}}),this.showSuccess(`${i} changes saved to database successfully!`),this.closeAiComparisonModal()):this.showError("Failed to save changes to database")}catch(s){console.error("Error in batch save operation:",s),this.showError("Failed to save changes to database")}}applyMarketingToItem(){let e=this.currentItemSku||document.getElementById("sku")?.value||document.getElementById("skuDisplay")?.textContent;if(!e){this.showError("Unable to apply marketing - no item SKU available");return}const t={marketingTitle:"suggested_title",marketingDescription:"suggested_description",targetAudience:"target_audience",demographics:"demographic_targeting",psychographics:"psychographic_profile",searchIntent:"search_intent",seasonalRelevance:"seasonal_relevance"},o=[];Object.keys(t).forEach(r=>{const l=document.getElementById(r);if(!l)return;let c=l.tagName==="SELECT"?l.value:l.value||"";typeof c=="string"&&(c=c.trim()),c&&o.push({sku:e,field:t[r],value:c})});const s=document.getElementById("brandVoice"),i=document.getElementById("contentTone");if(s&&s.value&&o.push({sku:e,field:"brand_voice",value:s.value}),i&&i.value&&o.push({sku:e,field:"content_tone",value:i.value}),o.length===0){this.showError("No marketing content to apply");return}const a=document.getElementById("marketingTitle")?.value||"",n=document.getElementById("marketingDescription")?.value||"";if(a){const r=document.getElementById("name");r&&(r.value=a,r.style.backgroundColor="#f0fdf4",setTimeout(()=>{r.style.backgroundColor=""},3e3))}if(n){const r=document.getElementById("description");r&&(r.value=n,r.style.backgroundColor="#f0fdf4",setTimeout(()=>{r.style.backgroundColor=""},3e3))}Promise.all(o.map(async r=>{try{const c=await(await fetch("/api/marketing_manager.php?action=update_field",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(r)})).json();return!!(c&&c.success)}catch(l){return console.error("Error saving field",r.field,l),!1}})).then(r=>{const l=r.filter(Boolean).length;if(l>0){if(this.showSuccess(`${l} marketing field(s) saved!`),window.loadExistingMarketingData)try{window.loadExistingMarketingData()}catch{}}else this.showError("Failed to save marketing fields")})}getMarketingListDomMap(){return{selling_points:{inputId:"newSellingPoint",listId:"sellingPointsList"},competitive_advantages:{inputId:"newCompetitiveAdvantage",listId:"competitiveAdvantagesList"},customer_benefits:{inputId:"newCustomerBenefit",listId:"customerBenefitsList"},seo_keywords:{inputId:"newSEOKeyword",listId:"seoKeywordsList"},call_to_action_suggestions:{inputId:"newCallToAction",listId:"callToActionsList"},urgency_factors:{inputId:"newUrgencyFactor",listId:"urgencyFactorsList"},conversion_triggers:{inputId:"newConversionTrigger",listId:"conversionTriggersList"},emotional_triggers:{inputId:"newEmotionalTriggers",listId:"emotionalTriggersList"},unique_selling_points:{inputId:"newUniqueSellingPoints",listId:"uniqueSellingPointsList"},value_propositions:{inputId:"newValuePropositions",listId:"valuePropositionsList"},marketing_channels:{inputId:"newMarketingChannels",listId:"marketingChannelsList"},social_proof_elements:{inputId:"newSocialProofElements",listId:"socialProofElementsList"},objection_handlers:{inputId:"newObjectionHandlers",listId:"objectionHandlersList"},content_themes:{inputId:"newContentThemes",listId:"contentThemesList"},pain_points_addressed:{inputId:"newPainPointsAddressed",listId:"painPointsAddressedList"},lifestyle_alignment:{inputId:"newLifestyleAlignment",listId:"lifestyleAlignmentList"}}}normalizeText(e){return(e||"").trim().replace(/\s+/g," ").toLowerCase()}findAddButtonForField(e){return e?document.querySelector(`button[data-action="add-list-item"][data-field="${e}"]`):null}startLoadingButton(e,t){e&&(e.dataset.originalText||(e.dataset.originalText=e.innerText),e.innerText=t||"Working...",e.disabled=!0,e.classList.add("opacity-50","cursor-not-allowed"))}stopLoadingButton(e){e&&(e.dataset.originalText&&(e.innerText=e.dataset.originalText),e.disabled=!1,e.classList.remove("opacity-50","cursor-not-allowed"))}startLoadingInput(e){e&&(e.dataset.originalPlaceholder||(e.dataset.originalPlaceholder=e.placeholder||""),e.placeholder="Working...",e.disabled=!0)}stopLoadingInput(e){e&&(e.dataset.originalPlaceholder!==void 0&&(e.placeholder=e.dataset.originalPlaceholder),e.disabled=!1)}getExistingItemsForList(e){const t=new Set,o=e?document.getElementById(e):null;return o&&(o.querySelectorAll('button[data-action="remove-list-item"][data-item]').forEach(i=>{try{const a=decodeURIComponent(i.getAttribute("data-item")||"");a&&t.add(this.normalizeText(a))}catch{}}),t.size===0&&o.querySelectorAll(".marketing-list-item span").forEach(i=>{t.add(this.normalizeText(i.textContent||""))})),t}appendMarketingListItem(e,t,o){const s=document.getElementById(e);if(!s)return;const i=document.createElement("div");i.className="marketing-list-item flex justify-between items-center bg-white p-2 rounded border",i.innerHTML=`
            <span class="text-sm text-gray-700">${this.escapeHtml(o)}</span>
            <button data-action="remove-list-item" data-field="${t}" data-item="${encodeURIComponent(o)}" class="text-red-500 hover:text-red-700 text-xs">Remove</button>
        `,s.appendChild(i),i.style.backgroundColor="#f0fdf4",setTimeout(()=>{i.style.backgroundColor=""},800)}async handleAddListItem(e){try{if(!e)return;let t=this.currentItemSku;if(!t){const m=document.getElementById("sku")||document.getElementById("skuDisplay");t=m&&(m.value||m.textContent)}if(!t){this.showError("No item selected");return}const s=this.getMarketingListDomMap()[e]||{},i=s.inputId?document.getElementById(s.inputId):null;if(!i||!i.value||!i.value.trim()){this.showError("Please enter a value");return}const a=i.value.trim(),n=s.listId;if(this.getExistingItemsForList(n).has(this.normalizeText(a))){this.showError("Item already exists");return}const l=this.findAddButtonForField(e);this.startLoadingButton(l,"Adding..."),this.startLoadingInput(i);const d=await(await fetch("/api/marketing_manager.php?action=add_list_item",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sku:t,field:e,item:a})})).json();if(!d||!d.success){this.showError(d&&d.error||"Failed to add item");return}i.value="",n&&this.appendMarketingListItem(n,e,a),this.showSuccess("Item added successfully")}catch(t){console.error("Error adding list item:",t),this.showError("Failed to add item")}finally{const o=this.getMarketingListDomMap()[e]||{},s=o.inputId?document.getElementById(o.inputId):null,i=this.findAddButtonForField(e);this.stopLoadingInput(s),this.stopLoadingButton(i)}}async handleRemoveListItem(e,t,o){try{if(!e)return;let s=this.currentItemSku;if(!s){const l=document.getElementById("sku")||document.getElementById("skuDisplay");s=l&&(l.value||l.textContent)}if(!s){this.showError("No item selected");return}const i=t?decodeURIComponent(t):"";if(!i){this.showError("No item specified");return}this.startLoadingButton(o,"Removing...");const n=await(await fetch("/api/marketing_manager.php?action=remove_list_item",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sku:s,field:e,item:i})})).json();if(!n||!n.success){this.showError(n&&n.error||"Failed to remove item");return}let r=null;if(o instanceof HTMLElement&&(r=o.closest(".marketing-list-item"),!r)){const l=o.closest("button");l&&l.parentElement&&(r=l.parentElement)}r&&r.parentElement&&r.parentElement.removeChild(r),this.showSuccess("Item removed")}catch(s){console.error("Error removing list item:",s),this.showError("Failed to remove item")}finally{this.stopLoadingButton(o)}}async handleSaveMarketingField(e,t){try{if(!e)return;let o=this.currentItemSku;if(!o){const c=document.getElementById("sku")||document.getElementById("skuDisplay");o=c&&(c.value||c.textContent)}if(!o){this.showError("No item selected");return}const i={search_intent:"searchIntent",seasonal_relevance:"seasonalRelevance"}[e]||"",a=i?document.getElementById(i):null,n=a?(a.tagName==="SELECT"?a.value:a.value||"").trim():"";if(!n){this.showError("Please enter a value");return}this.startLoadingButton(t,"Saving...");const l=await(await fetch("/api/marketing_manager.php?action=update_field",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sku:o,field:e,value:n})})).json();if(!l||!l.success){this.showError(l&&l.error||"Failed to save field");return}a&&(a.style.backgroundColor="#f0fdf4",setTimeout(()=>{a.style.backgroundColor=""},800)),this.showSuccess("Field saved")}catch(o){console.error("Error saving marketing field:",o),this.showError("Failed to save field")}finally{this.stopLoadingButton(t)}}async checkAIImageSupport(){return!0}async handleGenerateAllMarketing(e){if(!this.currentItemSku){this.showError("No item selected for marketing generation");return}const t=e.innerHTML;e.innerHTML='<span class="animate-spin">‚è≥</span> Generating...',e.disabled=!0;const o=document.getElementById("brandVoice")?.value||"",s=document.getElementById("contentTone")?.value||"",i=await this.checkAIImageSupport(),a={sku:this.currentItemSku,name:document.getElementById("name")?.value||"",description:document.getElementById("description")?.value||"",category:document.getElementById("categoryEdit")?.value||"",brandVoice:o,contentTone:s,useImages:i};try{const r=await(await fetch("/api/suggest_marketing.php",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)})).json();if(r.success){if(this.showSuccess("üéØ AI content generated for: Target Audience, Selling Points, SEO & Keywords, and Conversion tabs!"),window.populateAllMarketingTabs&&window.populateAllMarketingTabs(r),window.loadExistingMarketingData){await window.loadExistingMarketingData();const c=document.getElementById("brandVoice");c&&o&&(c.value=o);const d=document.getElementById("contentTone");d&&s&&(d.value=s)}typeof window.hasMarketingChanges<"u"&&(window.hasMarketingChanges=!0),["marketingTitle","marketingDescription","targetAudience","demographics","psychographics","brandVoice","contentTone","searchIntent","seasonalRelevance"].forEach(c=>{const d=document.getElementById(c);d&&d.value&&window.trackMarketingFieldChange&&window.trackMarketingFieldChange(c)}),window.updateMarketingSaveButtonVisibility&&window.updateMarketingSaveButtonVisibility()}else this.showError(r.error||"Failed to generate marketing content")}catch(n){console.error("Error generating marketing content:",n),this.showError("Failed to generate marketing content")}finally{e.innerHTML=t,e.disabled=!1}}async handleGenerateFreshMarketing(e){if(!this.currentItemSku){this.showError("No item selected for marketing generation");return}const t=document.getElementById("name");if(!t||!t.value.trim()){this.showError("Item name is required for marketing generation");return}const o=e.innerHTML;e.innerHTML="üî• Generating...",e.disabled=!0;const s=document.getElementById("brandVoice"),i=document.getElementById("contentTone"),a={sku:this.currentItemSku,name:t.value.trim(),category:document.getElementById("categoryEdit")?.value||"",description:document.getElementById("description")?.value.trim()||"",brand_voice:s?s.value:"",content_tone:i?i.value:"",fresh_start:!0};try{const r=await(await fetch("/api/suggest_marketing.php",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)})).json();r.success?(this.showSuccess("üî• Fresh marketing content generated! All fields updated with brand new AI suggestions."),window.populateAllMarketingTabs&&window.populateAllMarketingTabs(r),window.clearMarketingFields&&window.clearMarketingFields(),setTimeout(async()=>{window.loadExistingMarketingData&&await window.loadExistingMarketingData()},50)):this.showError(r.error||"Failed to generate marketing content")}catch(n){console.error("Error generating fresh marketing content:",n),this.showError("Failed to generate marketing content")}finally{e.innerHTML=o,e.disabled=!1}}handleApplyAndSaveMarketingTitle(){if(window.applyAndSaveMarketingTitle)window.applyAndSaveMarketingTitle();else{const e=document.getElementById("marketingTitle")?.value||"";this.applyTitle(e)}}handleApplyAndSaveMarketingDescription(){if(window.applyAndSaveMarketingDescription)window.applyAndSaveMarketingDescription();else{const e=document.getElementById("marketingDescription")?.value||"";this.applyDescription(e)}}applyTitle(e){const t=document.getElementById("name");t&&(t.value=e,t.style.backgroundColor="#f3e8ff",setTimeout(()=>{t.style.backgroundColor=""},2e3),this.showSuccess("Title applied! Remember to save your changes."))}applyDescription(e){const t=document.getElementById("description");t&&(t.value=e,t.style.backgroundColor="#f3e8ff",setTimeout(()=>{t.style.backgroundColor=""},2e3),this.showSuccess("Description applied! Remember to save your changes."))}switchMarketingTab(e,t){document.querySelectorAll(".marketing-tab-content").forEach(s=>s.classList.add("hidden")),document.querySelectorAll(".marketing-tab-btn").forEach(s=>{s.classList.remove("active","border-purple-500","text-purple-600"),s.classList.add("border-transparent","text-gray-500")});const o=document.getElementById(`tab-${e}`);o&&o.classList.remove("hidden"),t&&(t.classList.add("active","border-purple-500","text-purple-600"),t.classList.remove("border-transparent","text-gray-500"))}showConfirmationModal(e,t,o){const s=document.getElementById("confirmationModal");document.getElementById("confirmationModalTitle").textContent=e,document.getElementById("confirmationModalMessage").textContent=t;const i=document.getElementById("confirmationModalConfirm"),a=document.getElementById("confirmationModalCancel"),n=()=>{this.closeConfirmationModal(),o()},r=i.cloneNode(!0);i.parentNode.replaceChild(r,i),r.addEventListener("click",n);const l=a.cloneNode(!0);a.parentNode.replaceChild(l,a),l.addEventListener("click",this.closeConfirmationModal.bind(this)),s.classList.remove("hidden")}closeConfirmationModal(){document.getElementById("confirmationModal").classList.add("hidden")}showCostSuggestionChoiceDialog(e){const t=document.getElementById("costSuggestionChoiceDialog"),o=document.getElementById("costSuggestionChoices");o.innerHTML="",!e||e.length===0?o.innerHTML="<p>No suggestions available.</p>":e.forEach(s=>{const i=document.createElement("div");i.className="suggestion-card p-4 border rounded-lg hover:bg-gray-50",i.innerHTML=`
                    <h4 class="font-bold text-lg">${this.escapeHtml(s.model)}</h4>
                    <p class="text-2xl font-light my-2">$${parseFloat(s.suggestedCost).toFixed(2)}</p>
                    <p class="text-sm text-gray-600">Confidence: ${this.escapeHtml(s.confidence)}</p>
                    <p class="text-xs italic text-gray-500 mt-2">${this.escapeHtml(s.reasoning)}</p>
                    <div class="mt-4 flex gap-2">
                        <button data-action="populate-cost-breakdown-from-suggestion" data-suggestion='${this.escapeHtml(JSON.stringify(s))}' class="btn btn-primary flex-1">Apply Breakdown</button>
                        <button data-action="apply-suggested-cost-to-cost-field" data-suggestion='${this.escapeHtml(JSON.stringify(s))}' class="btn btn-secondary flex-1">Apply to Field</button>
                    </div>
                `,o.appendChild(i)}),t.classList.remove("hidden")}closeCostSuggestionChoiceDialog(){document.getElementById("costSuggestionChoiceDialog").classList.add("hidden")}applyCostSuggestionToCost(){const e=document.getElementById("suggestedCostDisplay"),t=document.getElementById("costPrice");if(e&&t){const o=e.textContent.replace("$",""),s=parseFloat(o)||0;s>0?(t.value=s.toFixed(2),t.style.backgroundColor="#dbeafe",setTimeout(()=>{t.style.backgroundColor=""},2e3),this.showSuccess("Suggested cost applied to Cost Price field!")):this.showError("No suggested cost available.")}}applySuggestedCostToCostField(e){try{const t=JSON.parse(e.getAttribute("data-suggestion").replace(/&quot;/g,'"').replace(/&#39;/g,"'")),o=document.getElementById("costPrice");if(o){const s=parseFloat(t.suggestedCost)||0;o.value=s.toFixed(2),o.style.backgroundColor="#dcfce7",setTimeout(()=>{o.style.backgroundColor=""},3e3),this.closeCostSuggestionChoiceDialog(),this.showSuccess(`AI suggested cost of $${s.toFixed(2)} applied!`)}}catch(t){console.error("Error applying suggested cost:",t),this.showError("Error applying suggested cost.")}}async populateCostBreakdownFromSuggestion(e){await this.clearCostBreakdownCompletely();const t=e.breakdown,o=["materials","labor","energy","equipment"];for(const s of o)if(t[s]>0){const i=`${s}_${Date.now()}`,a={name:`Suggested ${s}`,cost:t[s]};this.costBreakdown[s][i]=a,await this.saveCostItemToDatabase(s,a,i)}this.init(),this.showSuccess("AI cost breakdown has been applied and saved.")}async saveCostItemToDatabase(e,t,o){try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"add",inventory_id:this.currentItemSku,category:e,item_id:o,data:t})})).json()).success||this.showError(`Failed to save ${e} item.`)}catch{this.showError(`An error occurred while saving ${e}.`)}}async refreshCategoryDropdown(){try{const t=await(await fetch("/api/get_categories.php")).json();this.categories=t,this.updateCategoryDropdown(),this.showSuccess("Categories updated!")}catch(e){this.showError("Failed to refresh categories."),console.error("Refresh categories error:",e)}}updateCategoryDropdown(){const e=document.getElementById("category");if(!e)return;const t=e.value;e.innerHTML="",this.categories.forEach(o=>{const s=document.createElement("option");s.value=o.id,s.textContent=o.name,e.appendChild(s)}),e.value=t}escapeHtml(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}showToast(e,t="info"){const o=document.getElementById("toast-container");if(!o)return;const s=document.createElement("div"),i={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500"};s.className=`toast ${i[t]} text-white p-4 rounded-lg shadow-lg mb-2`,s.textContent=e,o.appendChild(s),setTimeout(()=>{s.style.opacity="0",setTimeout(()=>s.remove(),500)},3e3)}showSuccess(e){this.showToast(e,"success")}showError(e){this.showToast(e,"error")}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("inventory-data")&&document.getElementById("admin-inventory-container")&&new y});const v=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{v as a};
