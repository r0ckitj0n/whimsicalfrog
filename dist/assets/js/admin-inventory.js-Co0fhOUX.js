import"../console-gate-Dw9Mqr3S.js";class S{constructor(){this.currentItemSku=null,this.items=[],this.categories=[],this.costBreakdown={materials:{},labor:{},energy:{},equipment:{},totals:{}},this.currentEditCostItem=null,this.tooltipTimeout=null,this.currentTooltip=null,this.editCarouselPosition=0,this.viewCarouselPosition=0,this.selectedComparisonChanges={},this.itemToDeleteSku=null,this.loadData(),this.bindEvents(),this.init();try{window.buildComparisonInterface=(e,t)=>this.buildComparisonInterface(e,t)}catch{}}handleDelegatedKeydown(e){const t=e.target;if(t instanceof HTMLElement&&t.matches("input[data-add-enter-field]")&&e.key==="Enter"){e.preventDefault();const o=t.getAttribute("data-add-enter-field");o&&this.handleAddListItem(o)}}async loadItemColors(){if(!this.currentItemSku){const t=document.getElementById("sku")||document.getElementById("skuDisplay");t&&t.value&&(this.currentItemSku=t.value)}if(!this.currentItemSku){const t=document.getElementById("colorsLoading");t&&(t.textContent="No SKU available",t.classList.remove("hidden"));return}const e=document.getElementById("colorsLoading");e&&(e.textContent="Loading colors...",e.classList.remove("hidden"));try{const o=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json();o.success?this.renderColors(o.colors):(console.error("Error loading colors:",o.message),this.renderColors([]))}catch(t){console.error("Error fetching colors:",t),this.renderColors([])}}renderColors(e){const t=document.getElementById("colorsList"),o=document.getElementById("colorsLoading");if(o&&o.classList.add("hidden"),!t)return;if(!Array.isArray(e)||e.length===0){t.innerHTML='<div class="text-center text-gray-500 text-sm">No colors defined. Click "Add Color" to get started.</div>';return}const i=e.filter(c=>c.is_active==1),s=i.reduce((c,d)=>c+(parseInt(d.stock_level,10)||0),0),a=document.getElementById("stockLevel"),n=a&&parseInt(a.value,10)||0,r=s===n;let l="";if(i.length>0){const c=r?"bg-green-50 border-green-200 text-green-800":"bg-yellow-50 border-yellow-200 text-yellow-800",d=r?"✅":"⚠️",m=r?`Stock synchronized (${s} total)`:`Stock out of sync! Colors total: ${s}, Item stock: ${n}`;l+=`
                <div class="border rounded-lg ${c}">
                    <div class="text-sm font-medium">${d} ${m}</div>
                    ${r?"":'<div class="text-xs">Click "Sync Stock" to fix this.</div>'}
                </div>
            `}l+=e.map(c=>{const d=c.is_active==1,m=d?"bg-white":"bg-gray-100 opacity-75",u=d?"":" (Inactive)";return`
                <div class="color-item flex items-center justify-between border border-gray-200 rounded-lg ${m}">
                    <div class="flex items-center space-x-3">
                        <div class="color-swatch w-8 h-8 rounded-full border-2 border-gray-300" ${c.color_code?`data-color="${c.color_code}"`:""}></div>
                        <div>
                            <div class="font-medium text-gray-800">${c.color_name}${u}</div>
                            <div class="text-sm text-gray-500 flex items-center">
                                <span class="inline-stock-editor"
                                      data-type="color"
                                      data-id="${c.id}"
                                      data-field="stock_level"
                                      data-value="${c.stock_level}"
                                      data-action="edit-inline-stock"
                                      title="Click to edit stock level">${c.stock_level}</span>
                                <span class="">in stock</span>
                            </div>
                            ${c.image_path?`<div class="text-xs text-blue-600">Image: ${c.image_path}</div>`:""}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button type="button" data-action="delete-color" data-id="${c.id}" class="bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `}).join(""),t.innerHTML=l,t.querySelectorAll(".color-swatch[data-color]").forEach(c=>{const d=c.getAttribute("data-color");if(!d)return;const m=(d||"").trim().toLowerCase(),u=m.startsWith("#")?m:`#${m}`,p=u.length===4?`#${u[1]}${u[1]}${u[2]}${u[2]}${u[3]}${u[3]}`:u,g=`color-var-${p.replace("#","")}`,h=window.__wfInventoryColorClasses||=new Set;let f=document.getElementById("inventory-color-classes");f||(f=document.createElement("style"),f.id="inventory-color-classes",document.head.appendChild(f)),h.has(g)||(f.textContent+=`
.${g}{--swatch-color:${p};}`,h.add(g)),c.classList.add(g)})}showColorModal(e=null){document.getElementById("colorModal")||this.createColorModal();const t=document.getElementById("colorModal"),o=document.getElementById("colorForm"),i=document.getElementById("colorModalTitle");if(!(!t||!o)){if(o.reset(),e)if(i.textContent="Edit Color",document.getElementById("colorId").value=e.id,document.getElementById("colorName").value=e.color_name,document.getElementById("colorCode").value=e.color_code||"",document.getElementById("colorStockLevel").value=e.stock_level||0,document.getElementById("displayOrder").value=e.display_order||0,document.getElementById("isActive").checked=e.is_active==1,e.image_path){const s=document.getElementById("colorImagePath");s&&(s.value=e.image_path),this.updateImagePreview(),setTimeout(()=>{this.highlightSelectedImageInGrid(e.image_path)},100)}else{const s=document.getElementById("imagePreviewContainer");s&&s.classList.add("hidden"),setTimeout(()=>{this.highlightSelectedImageInGrid(null)},100)}else{i.textContent="Add New Color";const s=document.getElementById("imagePreviewContainer");s&&s.classList.add("hidden"),setTimeout(()=>{this.highlightSelectedImageInGrid(null)},100)}t.classList.remove("hidden")}}createColorModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="colorModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="colorModalTitle">Add New Color</h2>
                    <button type="button" class="modal-close" data-action="close-color-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="colorForm">
                        <input type="hidden" id="colorId" name="colorId">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <div>
                                    <label for="globalColorSelect" class="block text-sm font-medium text-gray-700">Select Color * <span class="text-xs text-gray-500">(from predefined colors)</span></label>
                                    <select id="globalColorSelect" name="globalColorSelect" required class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                        <option value="">Choose a color...</option>
                                    </select>
                                    <div class="text-xs">
                                        <a href="#" data-action="open-global-colors-management" class="text-blue-600 hover:text-blue-800">⚙️ Manage Global Colors in Settings</a>
                                    </div>
                                </div>
                                <input type="hidden" id="colorName" name="colorName">
                                <input type="hidden" id="colorCode" name="colorCode">
                                <div id="selectedColorPreview" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Selected Color Preview</label>
                                    <div class="flex items-center space-x-3 bg-gray-50 rounded-lg">
                                        <div id="colorPreviewSwatch" class="w-12 h-12 rounded border-2 border-gray-300 shadow-sm"></div>
                                        <div>
                                            <div id="colorPreviewName" class="font-medium text-gray-900"></div>
                                            <div id="colorPreviewCode" class="text-sm text-gray-500"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="colorStockLevel" class="block text-sm font-medium text-gray-700">Stock Level</label>
                                    <input type="number" id="colorStockLevel" name="stockLevel" min="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                </div>
                                <div>
                                    <label for="displayOrder" class="block text-sm font-medium text-gray-700">Display Order</label>
                                    <input type="number" id="displayOrder" name="displayOrder" min="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="isActive" name="isActive" class="">
                                        <span class="text-sm font-medium text-gray-700">Active (visible to customers)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div id="availableImagesGrid">
                                    <label class="block text-sm font-medium text-gray-700">Available Images <span class="text-xs text-gray-500 font-normal">(click to select for this color)</span></label>
                                    <div class="grid grid-cols-4 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded bg-gray-50"></div>
                                </div>
                                <div id="imagePreviewContainer" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Selected Image Preview</label>
                                    <div class="border border-gray-300 rounded-lg bg-gray-50">
                                        <div class="flex justify-center">
                                            <img id="imagePreview" src="" alt="Selected image preview" class="max-h-64 object-contain rounded border border-gray-200 shadow-sm">
                                        </div>
                                        <div id="imagePreviewInfo" class="text-center">
                                            <div id="imagePreviewName" class="text-sm font-medium text-gray-700"></div>
                                            <div id="imagePreviewPath" class="text-xs text-gray-500"></div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="colorImagePath" name="colorImagePath" value="">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 border-t border-gray-200">
                            <button type="button" data-action="close-color-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition-colors">Cancel</button>
                            <button type="submit" class="text-white rounded transition-colors bg-[#87ac3a] hover:bg-[#6b8e23]">Save Color</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`),this.loadGlobalColorsForSelection(),this.loadAvailableImages()}async loadAvailableImages(){if(this.currentItemSku)try{const t=await(await fetch(`/api/get_item_images.php?sku=${this.currentItemSku}`)).json(),o=document.getElementById("availableImagesGrid");if(!o)return;const i=o.querySelector(".grid");if(!i)return;t.success&&Array.isArray(t.images)&&t.images.length>0?(i.innerHTML="",t.images.forEach(s=>{const a=document.createElement("div");a.className="relative cursor-pointer hover:opacity-75 transition-all hover:scale-105 hover:shadow-md p-1 rounded",a.addEventListener("click",()=>this.selectImageFromGrid(s.image_path));const n=document.createElement("img"),r=s.image_path.startsWith("/images/items/")||s.image_path.startsWith("images/items/")?s.image_path:`/images/items/${s.image_path}`;n.src=r,n.alt=s.image_path,n.className="w-full h-20 object-cover rounded border border-gray-200 hover:border-green-400 transition-colors",n.onerror=()=>{n.classList.add("hidden"),n.parentElement.innerHTML='<div class="u-width-100 u-height-100 u-display-flex u-flex-direction-column u-align-items-center u-justify-content-center u-background-f8f9fa u-color-6c757d u-border-radius-8px"><div class="u-font-size-2rem u-margin-bottom-0-5rem u-opacity-0-7">📷</div><div class="u-font-size-0-8rem u-font-weight-500">Image Not Found</div></div>'};const l=document.createElement("div");if(l.className="text-xs text-gray-600 mt-1 text-center",l.textContent=s.image_path,s.is_primary){const c=document.createElement("div");c.className="absolute top-0 right-0 bg-green-500 text-white text-xs px-1 rounded-bl",c.textContent="1°",a.appendChild(c)}a.appendChild(n),a.appendChild(l),i.appendChild(a)}),o.classList.remove("hidden")):(i.innerHTML='<div class="col-span-4 text-center text-gray-500"><div class="text-3xl">📷</div><div class="text-sm">No images available for this item</div></div>',o.classList.remove("hidden"))}catch(e){console.error("Error loading available images:",e);const t=document.querySelector("#availableImagesGrid .grid");t&&(t.innerHTML='<div class="col-span-4 text-center text-red-500"><div class="text-sm">Error loading images</div></div>')}}selectImageFromGrid(e){const t=document.getElementById("colorImagePath");t&&(t.value=e,this.updateImagePreview(),this.highlightSelectedImageInGrid(e))}updateImagePreview(){const e=document.getElementById("colorImagePath"),t=document.getElementById("imagePreviewContainer"),o=document.getElementById("imagePreview"),i=document.getElementById("imagePreviewName"),s=document.getElementById("imagePreviewPath");if(!e||!t)return;const a=e.value;if(a){const n=a.startsWith("/images/items/")||a.startsWith("images/items/")?a:`/images/items/${a}`;o.src=n,o.onerror=()=>{o.classList.add("hidden"),o.parentElement.innerHTML='<div class="u-width-100 u-height-100 u-display-flex u-flex-direction-column u-align-items-center u-justify-content-center u-background-f8f9fa u-color-6c757d u-border-radius-8px"><div class="u-font-size-2rem u-margin-bottom-0-5rem u-opacity-0-7">📷</div><div class="u-font-size-0-8rem u-font-weight-500">No Image Available</div></div>'},i&&(i.textContent=a),s&&(s.textContent=n),t.classList.remove("hidden")}else t.classList.add("hidden")}highlightSelectedImageInGrid(e){const t=document.querySelector("#availableImagesGrid .grid");if(!t)return;t.querySelectorAll("div").forEach(i=>{const s=i.querySelector("img");if(!s)return;const a=s.alt;e&&a===e?(i.classList.add("ring-2","ring-green-500","bg-green-50"),s.classList.add("border-green-400")):(i.classList.remove("ring-2","ring-green-500","bg-green-50"),s.classList.remove("border-green-400"))})}async loadGlobalColorsForSelection(){try{const t=await(await fetch("/api/global_color_size_management.php?action=get_global_colors")).json(),o=document.getElementById("globalColorSelect");if(!o)return;if(o.innerHTML='<option value="">Choose a color...</option>',t.success&&Array.isArray(t.colors)&&t.colors.length>0){const i={};t.colors.forEach(s=>{const a=s.category||"General";i[a]||(i[a]=[]),i[a].push(s)}),Object.keys(i).sort().forEach(s=>{const a=document.createElement("optgroup");a.label=s,i[s].forEach(n=>{const r=document.createElement("option");r.value=JSON.stringify({id:n.id,name:n.color_name,code:n.color_code,category:n.category}),r.textContent=`${n.color_name} ${n.color_code?"("+n.color_code+")":""}`,a.appendChild(r)}),o.appendChild(a)})}else{const i=document.createElement("option");i.value="",i.textContent="No global colors available - add some in Settings",i.disabled=!0,o.appendChild(i)}}catch(e){console.error("Error loading global colors:",e),this.showError("Error loading global colors")}}async loadItemSizes(e=null){if(!this.currentItemSku){const o=document.getElementById("sku")||document.getElementById("skuDisplay");o&&o.value&&(this.currentItemSku=o.value)}if(!this.currentItemSku)return;let t=e;if(t===null){const o=document.getElementById("sizeColorFilter");o&&(t=o.value)}try{let o=`/api/item_sizes.php?action=get_all_sizes&item_sku=${this.currentItemSku}`;t&&t!=="general"?o+=`&color_id=${t}`:t==="general"&&(o+="&color_id=0");const s=await(await fetch(o)).json();s.success?this.renderSizes(s.sizes):(console.error("Error loading sizes:",s.message),this.renderSizes([]))}catch(o){console.error("Error fetching sizes:",o),this.renderSizes([])}}renderSizes(e){const t=document.getElementById("sizesList"),o=document.getElementById("sizesLoading");if(o&&o.classList.add("hidden"),!t)return;if(!Array.isArray(e)||e.length===0){t.innerHTML='<div class="text-center text-gray-500 text-sm">No sizes defined. Click "Add Size" to get started.</div>';return}const i={};e.forEach(c=>{const d=c.color_id?`color_${c.color_id}`:"general";i[d]||(i[d]={color_name:c.color_name||"General Sizes",color_code:c.color_code||null,sizes:[]}),i[d].sizes.push(c)});const s=e.reduce((c,d)=>c+(parseInt(d.stock_level,10)||0),0),a=document.getElementById("stockLevel"),n=a&&parseInt(a.value,10)||0,r=s===n;let l="";if(e.length>0){const c=r?"bg-green-50 border-green-200 text-green-800":"bg-yellow-50 border-yellow-200 text-yellow-800",d=r?"✅":"⚠️",m=r?`Stock synchronized (${s} total)`:`Stock out of sync! Sizes total: ${s}, Item stock: ${n}`;l+=`
                <div class="border rounded-lg ${c}">
                    <div class="text-sm font-medium">${d} ${m}</div>
                    ${r?"":'<div class="text-xs flex items-center gap-2"><button type="button" data-action="sync-size-stock" class="bg-blue-500 text-white rounded text-xs px-2 py-1 hover:bg-blue-600">Sync Stock</button><span>Click to synchronize item stock with sizes total.</span></div>'}
                </div>
            `}Object.keys(i).forEach(c=>{const d=i[c];Object.keys(i).length>1&&(l+=`
                    <div class="font-medium text-gray-700 flex items-center">
                        ${d.color_code?`<div class="w-4 h-4 rounded border color-dot" data-color="${d.color_code}"></div>`:""}
                        ${d.color_name}
                    </div>
                `),d.sizes.forEach(m=>{const u=m.is_active==1,p=u?"bg-white":"bg-gray-100 opacity-75",y=u?"":" (Inactive)",g=m.price_adjustment>0?` (+$${m.price_adjustment})`:"";l+=`
                    <div class="size-item flex items-center justify-between border border-gray-200 rounded-lg ${p} ml-${Object.keys(i).length>1?"4":"0"}">
                        <div class="flex items-center space-x-3">
                            <div class="size-badge bg-blue-100 text-blue-800 rounded text-sm font-medium">${m.size_code}</div>
                            <div>
                                <div class="font-medium text-gray-800">${m.size_name}${y}${g}</div>
                                <div class="text-sm text-gray-500 flex items-center">
                                    <span class="inline-stock-editor"
                                          data-type="size"
                                          data-id="${m.id}"
                                          data-field="stock_level"
                                          data-value="${m.stock_level}"
                                          data-action="edit-inline-stock"
                                          title="Click to edit stock level">${m.stock_level}</span>
                                    <span class="">in stock</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="button" data-action="delete-size" data-id="${m.id}" class="bg-red-500 text-white rounded text-xs hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `})}),t.innerHTML=l,t.querySelectorAll(".color-dot[data-color]").forEach(c=>{const d=c.getAttribute("data-color");if(!d)return;const m=(d||"").trim().toLowerCase(),u=m.startsWith("#")?m:`#${m}`,p=u.length===4?`#${u[1]}${u[1]}${u[2]}${u[2]}${u[3]}${u[3]}`:u,g=`color-var-${p.replace("#","")}`,h=window.__wfInventoryColorClasses||=new Set;let f=document.getElementById("inventory-color-classes");f||(f=document.createElement("style"),f.id="inventory-color-classes",document.head.appendChild(f)),h.has(g)||(f.textContent+=`
.${g}{--swatch-color:${p};}`,h.add(g)),c.classList.add(g)})}async loadColorOptions(){if(this.currentItemSku)try{const t=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json(),o=document.getElementById("sizeColorFilter");if(!o)return;o.innerHTML='<option value="general">General Sizes (No Color)</option>',t.success&&Array.isArray(t.colors)&&t.colors.forEach(i=>{if(i.is_active==1){const s=document.createElement("option");s.value=i.id,s.textContent=`${i.color_name} (${i.stock_level} in stock)`,o.appendChild(s)}})}catch(e){console.error("Error loading colors for size filter:",e)}}async populateSizeColorSelect(){try{const t=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json(),o=document.getElementById("sizeColorId");if(!o)return;o.innerHTML='<option value="">General Size (No specific color)</option>',t.success&&Array.isArray(t.colors)&&t.colors.forEach(i=>{if(i.is_active==1){const s=document.createElement("option");s.value=i.id,s.textContent=i.color_name,o.appendChild(s)}})}catch(e){console.error("Error populating size color select:",e)}}updateSizeConfiguration(){const e=document.querySelector('input[name="sizeConfiguration"]:checked');if(!e)return;const t=e.value,o=document.getElementById("sizeTypeSelector"),i=document.getElementById("sizesList");t==="none"?(o&&o.classList.add("hidden"),i&&(i.innerHTML='<div class="text-center text-gray-500 text-sm">No sizes configured for this item</div>')):t==="general"?(o&&o.classList.add("hidden"),this.loadItemSizes("general")):t==="color_specific"&&(o&&o.classList.remove("hidden"),this.loadColorOptions(),this.loadItemSizes())}showSizeModal(e=null){document.getElementById("sizeModal")||this.createSizeModal();const t=document.getElementById("sizeModal"),o=document.getElementById("sizeForm"),i=document.getElementById("sizeModalTitle");if(!(!t||!o)){if(o.reset(),this.populateSizeColorSelect(),e){if(i.textContent="Edit Size",document.getElementById("sizeId").value=e.id,document.getElementById("sizeName").value=e.size_name||"",document.getElementById("sizeCode").value=e.size_code||"",document.getElementById("sizeStockLevel").value=e.stock_level||0,document.getElementById("sizePriceAdjustment").value=e.price_adjustment||0,document.getElementById("sizeDisplayOrder").value=e.display_order||0,document.getElementById("sizeIsActive").checked=e.is_active==1,e.color_id){const s=document.getElementById("sizeColorId");s&&(s.value=e.color_id)}}else{i.textContent="Add New Size",document.getElementById("sizeId").value="",document.getElementById("sizePriceAdjustment").value="0.00",document.getElementById("sizeDisplayOrder").value="0",document.getElementById("sizeIsActive").checked=!0;const s=document.getElementById("sizeColorFilter"),a=document.getElementById("sizeColorId");s&&a&&(a.value=s.value==="general"?"":s.value)}t.classList.remove("hidden")}}createSizeModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="sizeModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="sizeModalTitle" class="text-xl font-semibold text-gray-800">Add New Size</h2>
                    <button type="button" data-action="close-size-modal" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="sizeForm">
                        <input type="hidden" id="sizeId" name="sizeId">
                        <div class="">
                            <label for="sizeColorId" class="block text-sm font-medium text-gray-700">Color Association</label>
                            <select id="sizeColorId" name="sizeColorId" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                <option value="">General Size (No specific color)</option>
                            </select>
                            <div class="text-xs text-gray-500">Choose a color if this size is specific to a particular color variant</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="sizeName" class="block text-sm font-medium text-gray-700">Size Name *</label>
                                <input type="text" id="sizeName" name="sizeName" placeholder="e.g., Medium" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2" required>
                            </div>
                            <div>
                                <label for="sizeCode" class="block text-sm font-medium text-gray-700">Size Code *</label>
                                <select id="sizeCode" name="sizeCode" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2" required>
                                    <option value="">Select size...</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                    <option value="OS">OS (One Size)</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="sizeStockLevel" class="block text-sm font-medium text-gray-700">Stock Level</label>
                                <input type="number" id="sizeStockLevel" name="sizeStockLevel" min="0" value="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                            </div>
                            <div>
                                <label for="sizePriceAdjustment" class="block text-sm font-medium text-gray-700">Price Adjustment ($)</label>
                                <input type="number" id="sizePriceAdjustment" name="sizePriceAdjustment" step="0.01" value="0.00" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                <div class="text-xs text-gray-500">Extra charge for this size (e.g., +$2 for XXL)</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="sizeDisplayOrder" class="block text-sm font-medium text-gray-700">Display Order</label>
                                <input type="number" id="sizeDisplayOrder" name="sizeDisplayOrder" min="0" value="0" class="w-full border border-gray-300 rounded-md focus:outline-none focus:ring-2">
                                <div class="text-xs text-gray-500">Lower numbers appear first</div>
                            </div>
                            <div class="flex items-center">
                                <label class="flex items-center">
                                    <input type="checkbox" id="sizeIsActive" name="sizeIsActive" class="">
                                    <span class="text-sm font-medium text-gray-700">Active (available to customers)</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 border-t border-gray-200">
                            <button type="button" data-action="close-size-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400 transition-colors">Cancel</button>
                            <button type="submit" class="text-white rounded transition-colors bg-[#87ac3a] hover:bg-[#6b8e23]">Save Size</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`),this.populateSizeColorSelect()}loadData(){const e=document.getElementById("inventory-data");if(e)try{const t=JSON.parse(e.textContent);this.currentItemSku=t.currentItemSku,this.items=t.items||[],this.categories=t.categories||[],t.costBreakdown&&(this.costBreakdown={materials:t.costBreakdown.materials||{},labor:t.costBreakdown.labor||{},energy:t.costBreakdown.energy||{},equipment:t.costBreakdown.equipment||{},totals:t.costBreakdown.totals||{}})}catch(t){console.error("Error parsing inventory data:",t)}}init(){this.renderCostList("materials"),this.renderCostList("labor"),this.renderCostList("energy"),this.renderCostList("equipment"),this.updateTotalsDisplay(),this.loadExistingPriceSuggestion(this.currentItemSku),this.loadExistingMarketingSuggestion(this.currentItemSku),this.updateCategoryDropdown(),window.handleGlobalColorSelection=this.handleGlobalColorSelection.bind(this),window.loadItemColors=this.loadItemColors.bind(this),window.loadItemSizes=this.loadItemSizes.bind(this),window.loadExistingPriceSuggestion=this.loadExistingPriceSuggestion.bind(this),window.loadExistingViewPriceSuggestion=this.loadExistingViewPriceSuggestion.bind(this),window.loadExistingMarketingSuggestion=this.loadExistingMarketingSuggestion.bind(this),window.displayMarketingSuggestionIndicator=this.displayMarketingSuggestionIndicator.bind(this),document.getElementById("colorsList")&&this.loadItemColors(),document.getElementById("sizesList")&&this.loadItemSizes();const e=document.getElementById("skuEdit")||document.getElementById("skuDisplay")||document.getElementById("sku");e&&e.value&&(this.currentItemSku=e.value),document.getElementById("currentImagesList")&&this.currentItemSku&&this.loadCurrentImages(this.currentItemSku,!1)}bindEvents(){document.body.addEventListener("click",this.handleDelegatedClick.bind(this)),document.body.addEventListener("mouseover",this.handleDelegatedMouseOver.bind(this)),document.body.addEventListener("mouseout",this.handleDelegatedMouseOut.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.body.addEventListener("keydown",this.handleDelegatedKeydown.bind(this)),document.body.addEventListener("submit",this.handleDelegatedSubmit.bind(this),!0),document.body.addEventListener("change",this.handleDelegatedChange.bind(this));const e=document.getElementById("imageUpload");e&&e.addEventListener("change",this.handleImageUpload.bind(this));const t=document.getElementById("multiImageUpload");t&&t.addEventListener("change",this.handleImageUpload.bind(this));const o=document.getElementById("aiAnalysisUpload");o&&o.addEventListener("change",this.handleImageUpload.bind(this)),window.addEventListener("storage",i=>{i.key==="categoriesUpdated"&&(typeof this.refreshCategoryDropdown=="function"&&this.refreshCategoryDropdown(),this.showToast("Categories updated! Dropdown refreshed.","info"))})}handleKeyDown(e){e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||(e.key==="ArrowRight"?this.navigateToItem("next"):e.key==="ArrowLeft"&&this.navigateToItem("prev"))}handleDelegatedClick(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action,i=t.dataset.id,s=t.dataset.category;switch(t.tagName==="BUTTON"&&e.preventDefault(),o){case"delete-item":{const a=t.dataset.sku;if(!a){this.showError("Missing SKU to delete");return}this.itemToDeleteSku=a;const n=document.getElementById("deleteConfirmModal");n&&n.classList.add("show")}break;case"close-delete-modal":{const a=document.getElementById("deleteConfirmModal");a&&a.classList.remove("show"),this.itemToDeleteSku=null}break;case"apply-selected-comparison":this.applySelectedComparisonChanges();break;case"close-ai-comparison":this.closeAiComparisonModal();break;case"confirm-delete-item":this.handleConfirmDeleteItem();break;case"navigate-item":this.navigateToItem(t.dataset.direction);break;case"add-item-color":this.showColorModal();break;case"add-item-size":this.showSizeModal();break;case"set-primary-image":case"set-primary":this.setPrimaryImage(i||t.dataset.imageId);break;case"delete-image":this.confirmDeleteImage(i);break;case"trigger-upload":{const a=t.dataset.target||"imageUpload",n=document.getElementById(a);n&&typeof n.click=="function"?n.click():console.warn("Upload input not found for target:",a)}break;case"process-images-ai":this.processExistingImagesWithAI();break;case"open-cost-modal":this.openCostModal(s,i);break;case"close-cost-modal":this.closeCostModal();break;case"save-cost-item":this.saveCostItem();break;case"delete-cost-item":this.confirmDeleteCostItem(s,i);break;case"clear-cost-breakdown":this.confirmClearCostBreakdown();break;case"get-cost-suggestion":this.getCostSuggestion();break;case"get-price-suggestion":this.getPriceSuggestion();break;case"apply-price-suggestion":this.applyPriceSuggestion();break;case"clear-price-suggestion":this.clearPriceSuggestion();break;case"open-marketing-manager":this.openMarketingManager();break;case"generate-marketing-copy":this.generateMarketingCopy();break;case"close-marketing-manager":this.closeMarketingManager();break;case"close-marketing-modal":this.closeMarketingModal();break;case"close-ai-comparison-modal":this.closeAiComparisonModal();break;case"apply-selected-changes":this.applySelectedComparisonChanges();break;case"apply-marketing-to-item":this.applyMarketingToItem();break;case"generate-all-marketing":this.handleGenerateAllMarketing(t);break;case"generate-fresh-marketing":this.handleGenerateFreshMarketing(t);break;case"apply-and-save-marketing-title":this.handleApplyAndSaveMarketingTitle();break;case"apply-and-save-marketing-description":this.handleApplyAndSaveMarketingDescription();break;case"apply-title":this.applyTitle(t.dataset.value||"");break;case"apply-description":this.applyDescription(t.dataset.value||"");break;case"show-marketing-tab":this.switchMarketingTab(t.dataset.tab,t);break;case"apply-cost-suggestion-to-cost":this.applyCostSuggestionToCost();break;case"apply-suggested-cost-to-cost-field":this.applySuggestedCostToCostField(t);break;case"save-marketing-field":this.handleSaveMarketingField(t.dataset.field,t);break;case"add-list-item":this.handleAddListItem(t.dataset.field);break;case"remove-list-item":this.handleRemoveListItem(t.dataset.field,t.dataset.item,t);break;case"populate-cost-breakdown-from-suggestion":this.populateCostBreakdownFromSuggestion(JSON.parse(t.getAttribute("data-suggestion").replace(/&quot;/g,'"').replace(/&#39;/g,"'"))),this.closeCostSuggestionChoiceDialog();break;case"close-cost-suggestion-choice-dialog":this.closeCostSuggestionChoiceDialog();break;case"refresh-categories":this.refreshCategoryDropdown();break;case"move-carousel":this.moveCarousel(t.dataset.type,parseInt(t.dataset.direction,10)||0);break;case"show-pricing-tooltip-with-data":e.stopPropagation(),this.showPricingTooltipWithData(e,t.dataset.componentType,decodeURIComponent(t.dataset.explanation||""));break;case"show-pricing-tooltip-text":e.stopPropagation(),this.showPricingTooltip(e,decodeURIComponent(t.dataset.text||""));break;case"edit-inline-stock":this.editInlineStock(t);break;case"delete-color":this.deleteColor(parseInt(t.dataset.id,10));break;case"close-color-modal":this.closeColorModal();break;case"open-global-colors-management":this.openGlobalColorsManagement();break;case"delete-size":this.deleteSize(parseInt(t.dataset.id,10));break;case"close-size-modal":this.closeSizeModal();break;case"sync-size-stock":this.syncSizeStock();break;case"open-color-template-modal":this.openColorTemplateModal();break;case"close-color-template-modal":this.closeColorTemplateModal();break;case"apply-color-template":this.applySelectedColorTemplate();break;case"select-color-template":this.selectColorTemplate(parseInt(t.dataset.id,10));break;case"open-size-template-modal":this.openSizeTemplateModal();break;case"close-size-template-modal":this.closeSizeTemplateModal();break;case"apply-size-template":this.applySelectedSizeTemplate();break;case"select-size-template":this.selectSizeTemplate(parseInt(t.dataset.id,10));break;case"close-restructure-modal":typeof window.closeRestructureModal=="function"&&window.closeRestructureModal();break;case"close-structure-view-modal":typeof window.closeStructureViewModal=="function"&&window.closeStructureViewModal();break}}handleDelegatedSubmit(e){const t=e.target;t instanceof HTMLFormElement&&(t.id==="colorForm"?(e.preventDefault(),this.saveColor(t)):t.id==="sizeForm"?(e.preventDefault(),this.saveSize(t)):t.id==="inventoryForm"&&typeof window.validateGenderSizeColorRequirements=="function"&&window.validateGenderSizeColorRequirements(e)===!1&&e.preventDefault())}handleDelegatedChange(e){const t=e.target;if(t instanceof HTMLElement){if(t.id==="globalColorSelect")this.handleGlobalColorSelection();else if(t.getAttribute&&t.getAttribute("name")==="sizeConfiguration")this.updateSizeConfiguration();else if(t.id==="sizeColorFilter")this.loadItemSizes();else if(t.id==="colorTemplateCategory")this.filterColorTemplates();else if(t.id==="sizeTemplateCategory")this.filterSizeTemplates();else if(t.getAttribute&&t.getAttribute("name")==="sizeApplyMode"){const o=document.getElementById("colorSelectionForSizes");o&&(t.value==="color_specific"?(o.classList.remove("hidden"),this.loadColorsForSizeTemplate()):o.classList.add("hidden"))}else if(t.matches('select[data-action="marketing-default-change"]')){const o=t.getAttribute("data-setting");o&&this.updateGlobalMarketingDefault(o,t.value)}else if(t.id==="selectAllComparison")this.toggleSelectAllComparison();else if(t.matches('[data-action="toggle-select-all-comparison"]'))this.toggleSelectAllComparison();else if(t.matches('[data-action="toggle-comparison"]')){const o=t.getAttribute("data-field");o&&this.toggleComparison(o)}}}handleGlobalColorSelection(){const e=document.getElementById("globalColorSelect");if(!e)return;const t=e.value,o=document.getElementById("colorName"),i=document.getElementById("colorCode"),s=document.getElementById("selectedColorPreview"),a=document.getElementById("colorPreviewSwatch"),n=document.getElementById("colorPreviewName"),r=document.getElementById("colorPreviewCode");if(t)try{const l=JSON.parse(t);if(o.value=l.name,i.value=l.code||"#000000",s&&s.classList.remove("hidden"),a){const c=(l.code||"#000000").toLowerCase().trim(),d=c.startsWith("#")?c:`#${c}`,m=d.length===4?`#${d[1]}${d[1]}${d[2]}${d[2]}${d[3]}${d[3]}`:d,p=`color-var-${m.replace("#","")}`;a.className=a.className.split(" ").filter(h=>!/^color-var-[0-9a-fA-F]{6}$/.test(h)).join(" ");const y=window.__wfInventoryColorClasses||=new Set;let g=document.getElementById("inventory-color-classes");g||(g=document.createElement("style"),g.id="inventory-color-classes",document.head.appendChild(g)),y.has(p)||(g.textContent+=`
.${p}{--swatch-color:${m};}`,y.add(p)),a.classList.add(p)}n&&(n.textContent=l.name),r&&(r.textContent=l.code||"No color code")}catch(l){console.error("Error parsing color data:",l)}else o&&(o.value=""),i&&(i.value=""),s&&s.classList.add("hidden")}openGlobalColorsManagement(){this.showConfirmationModal("Manage Global Colors","Global colors are managed in Admin Settings > Content Management > Global Colors & Sizes. Open Admin Settings now?",()=>{window.location.href="/?page=admin&section=settings"})}async syncSizeStock(){if(!this.currentItemSku){this.showError("No item selected");return}try{const t=await(await fetch("/api/item_sizes.php?action=sync_stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_sku:this.currentItemSku})})).json();if(t.success){this.showSuccess(`Stock synchronized - Total: ${t.new_total_stock}`);const o=document.getElementById("stockLevel");o&&t.new_total_stock!==void 0&&(o.value=t.new_total_stock),this.loadItemSizes()}else this.showError(`Error syncing stock: ${t.message||""}`)}catch(e){console.error("Error syncing stock:",e),this.showError("Error syncing stock levels")}}closeColorModal(){const e=document.getElementById("colorModal");e&&e.classList.add("hidden")}async saveColor(e){const t=e instanceof HTMLFormElement?e:document.getElementById("colorForm");if(!t)return;const o=new FormData(t),i={item_sku:this.currentItemSku,color_name:o.get("colorName"),color_code:o.get("colorCode"),image_path:o.get("colorImagePath")||"",stock_level:parseInt(o.get("stockLevel"),10)||0,display_order:parseInt(o.get("displayOrder"),10)||0,is_active:o.get("isActive")?1:0},s=o.get("colorId"),a=!!(s&&s!=="");a&&(i.color_id=parseInt(s,10));try{const r=await(await fetch(`/api/item_colors.php?action=${a?"update_color":"add_color"}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();if(r.success){this.showSuccess(`Color ${a?"updated":"added"} successfully${r.new_total_stock?` - Total stock: ${r.new_total_stock}`:""}`),this.closeColorModal(),this.loadItemColors();const l=document.getElementById("stockLevel");l&&r.new_total_stock!==void 0&&(l.value=r.new_total_stock)}else this.showError(`Error ${a?"updating":"adding"} color: ${r.message}`)}catch(n){console.error("Error saving color:",n),this.showError(`Error ${a?"updating":"adding"} color`)}}async openColorTemplateModal(){if(!this.currentItemSku){this.showError("Please save the item first before applying templates");return}document.getElementById("colorTemplateModal")||this.createColorTemplateModal(),await this.loadColorTemplates();const e=document.getElementById("colorTemplateModal");e&&e.classList.remove("hidden")}createColorTemplateModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="colorTemplateModal" class="modal-overlay hidden">
            <div class="modal-content" >
                <div class="modal-header">
                    <h2 class="text-xl font-bold text-gray-800">🎨 Color Templates</h2>
                    <button type="button" data-action="close-color-template-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-4">
                            <div class="">
                                <label class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                                <select id="colorTemplateCategory" class="w-full border border-gray-300 rounded">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div id="colorTemplatesList" class="space-y-3">
                                <div class="text-center text-gray-500">Loading templates...</div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h3 class="font-medium text-blue-800">Application Options</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="replaceExistingColors">
                                        <span class="text-sm">Replace existing colors (clear current colors first)</span>
                                    </label>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Default Stock Level for New Colors:</label>
                                        <input type="number" id="defaultColorStock" value="0" min="0" class="w-32 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-action="close-color-template-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="button" data-action="apply-color-template" id="applyColorTemplateBtn" class="bg-purple-600 text-white rounded hover:bg-purple-700" disabled>
                        Apply Template
                    </button>
                </div>
            </div>
        </div>`)}async loadColorTemplates(){try{const t=await(await fetch("/api/color_templates.php?action=get_all")).json();t.success?(this.colorTemplates=t.templates||[],this.renderColorTemplates(),this.loadColorTemplateCategories()):this.showError("Error loading color templates: "+(t.message||""))}catch(e){console.error("Error loading color templates:",e),this.showError("Error loading color templates")}}loadColorTemplateCategories(){const e=document.getElementById("colorTemplateCategory");if(!e)return;const t=[...new Set((this.colorTemplates||[]).map(o=>o.category))].sort();e.innerHTML='<option value="">All Categories</option>',t.forEach(o=>{const i=document.createElement("option");i.value=o,i.textContent=o,e.appendChild(i)})}filterColorTemplates(){this.renderColorTemplates()}renderColorTemplates(){const e=document.getElementById("colorTemplatesList");if(!e)return;const t=document.getElementById("colorTemplateCategory")?.value||"",o=this.colorTemplates||[],i=t?o.filter(s=>s.category===t):o;if(i.length===0){e.innerHTML='<div class="text-center text-gray-500">No templates found</div>';return}e.innerHTML=i.map(s=>`
            <div class="template-item border border-gray-200 rounded-lg hover:border-purple-300 cursor-pointer"
                 data-action="select-color-template" data-id="${s.id}" data-template-id="${s.id}">
                <div class="flex justify-between items-start p-2">
                    <div>
                        <h4 class="font-medium text-gray-800">${s.template_name}</h4>
                        <p class="text-sm text-gray-600">${s.description||"No description"}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs rounded">${s.category}</span>
                        <div class="text-xs text-gray-500">${s.color_count} colors</div>
                    </div>
                </div>
                <div class="template-preview p-2" id="colorPreview${s.id}">
                    <div class="text-xs text-gray-500">Loading colors...</div>
                </div>
            </div>
        `).join(""),i.forEach(s=>this.loadColorTemplatePreview(s.id))}async loadColorTemplatePreview(e){try{const o=await(await fetch(`/api/color_templates.php?action=get_template&template_id=${e}`)).json();if(o.success&&o.template&&Array.isArray(o.template.colors)){const i=document.getElementById(`colorPreview${e}`);i&&(i.innerHTML=`
                        <div class="flex flex-wrap gap-2">
                            ${o.template.colors.map(s=>`
                                <div class="flex items-center gap-1 text-xs">
                                    <div class="w-4 h-4 rounded border border-gray-300 color-dot" ${s.color_code?`data-color="${s.color_code}"`:""}></div>
                                    <span>${s.color_name}</span>
                                </div>
                            `).join("")}
                        </div>
                    `,i.querySelectorAll(".color-dot[data-color]").forEach(s=>{const a=s.getAttribute("data-color");if(!a)return;const n=(a||"").trim().toLowerCase(),r=n.startsWith("#")?n:`#${n}`,l=r.length===4?`#${r[1]}${r[1]}${r[2]}${r[2]}${r[3]}${r[3]}`:r,d=`color-var-${l.replace("#","")}`,m=window.__wfInventoryColorClasses||=new Set;let u=document.getElementById("inventory-color-classes");u||(u=document.createElement("style"),u.id="inventory-color-classes",document.head.appendChild(u)),m.has(d)||(u.textContent+=`
.${d}{--swatch-color:${l};}`,m.add(d)),s.classList.add(d)}))}}catch(t){console.error("Error loading color template preview:",t)}}selectColorTemplate(e){document.querySelectorAll("#colorTemplatesList .template-item").forEach(i=>{i.classList.remove("border-purple-500","bg-purple-50")});const t=document.querySelector(`#colorTemplatesList [data-template-id="${e}"]`);t&&t.classList.add("border-purple-500","bg-purple-50");const o=document.getElementById("applyColorTemplateBtn");o&&(o.disabled=!1,o.setAttribute("data-template-id",String(e)))}async applySelectedColorTemplate(){const e=document.getElementById("applyColorTemplateBtn"),t=e?.getAttribute("data-template-id");if(!t){this.showError("Please select a template first");return}const o=document.getElementById("replaceExistingColors")?.checked||!1,i=parseInt(document.getElementById("defaultColorStock")?.value,10)||0;try{e&&(e.disabled=!0,e.textContent="Applying...");const a=await(await fetch("/api/color_templates.php?action=apply_to_item",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:parseInt(t,10),item_sku:this.currentItemSku,replace_existing:!!o,default_stock:i})})).json();a.success?(this.showSuccess(`Template applied successfully! Added ${a.colors_added} colors.`),this.closeColorTemplateModal(),this.loadItemColors()):this.showError("Error applying template: "+(a.message||""))}catch(s){console.error("Error applying color template:",s),this.showError("Error applying color template")}finally{e&&(e.disabled=!1,e.textContent="Apply Template")}}closeColorTemplateModal(){const e=document.getElementById("colorTemplateModal");e&&e.classList.add("hidden")}async openSizeTemplateModal(){if(!this.currentItemSku){this.showError("Please save the item first before applying templates");return}document.getElementById("sizeTemplateModal")||this.createSizeTemplateModal(),await this.loadSizeTemplates();const e=document.getElementById("sizeTemplateModal");e&&e.classList.remove("hidden")}createSizeTemplateModal(){document.body.insertAdjacentHTML("beforeend",`
        <div id="sizeTemplateModal" class="modal-overlay hidden">
            <div class="modal-content" >
                <div class="modal-header">
                    <h2 class="text-xl font-bold text-gray-800">📏 Size Templates</h2>
                    <button type="button" data-action="close-size-template-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="modal-body" >
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Filter by Category:</label>
                            <select id="sizeTemplateCategory" class="w-full border border-gray-300 rounded">
                                <option value="">All Categories</option>
                            </select>
                        </div>

                        <div id="sizeTemplatesList" class="space-y-3">
                            <div class="text-center text-gray-500">Loading templates...</div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h3 class="font-medium text-blue-800">Application Options</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Apply Mode:</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sizeApplyMode" value="general" checked>
                                            <span class="text-sm">General sizes (not color-specific)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sizeApplyMode" value="color_specific">
                                            <span class="text-sm">Color-specific sizes</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="colorSelectionForSizes" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Select Color:</label>
                                    <select id="sizeTemplateColorId" class="w-full border border-gray-300 rounded text-sm">
                                        <option value="">Loading colors...</option>
                                    </select>
                                </div>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="replaceExistingSizes">
                                    <span class="text-sm">Replace existing sizes</span>
                                </label>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Default Stock Level for New Sizes:</label>
                                    <input type="number" id="defaultSizeStock" value="0" min="0" class="w-32 border border-gray-300 rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-action="close-size-template-modal" class="bg-gray-300 text-gray-800 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="button" data-action="apply-size-template" id="applySizeTemplateBtn" class="bg-purple-600 text-white rounded hover:bg-purple-700" disabled>
                        Apply Template
                    </button>
                </div>
            </div>
        </div>`)}async loadSizeTemplates(){try{const t=await(await fetch("/api/size_templates.php?action=get_all")).json();t.success?(this.sizeTemplates=t.templates||[],this.renderSizeTemplates(),this.loadSizeTemplateCategories()):this.showError("Error loading size templates: "+(t.message||""))}catch(e){console.error("Error loading size templates:",e),this.showError("Error loading size templates")}}loadSizeTemplateCategories(){const e=document.getElementById("sizeTemplateCategory");if(!e)return;const t=[...new Set((this.sizeTemplates||[]).map(o=>o.category))].sort();e.innerHTML='<option value="">All Categories</option>',t.forEach(o=>{const i=document.createElement("option");i.value=o,i.textContent=o,e.appendChild(i)})}filterSizeTemplates(){this.renderSizeTemplates()}renderSizeTemplates(){const e=document.getElementById("sizeTemplatesList");if(!e)return;const t=document.getElementById("sizeTemplateCategory")?.value||"",o=this.sizeTemplates||[],i=t?o.filter(s=>s.category===t):o;if(i.length===0){e.innerHTML='<div class="text-center text-gray-500">No templates found</div>';return}e.innerHTML=i.map(s=>`
            <div class="template-item border border-gray-200 rounded-lg hover:border-purple-300 cursor-pointer"
                 data-action="select-size-template" data-id="${s.id}" data-template-id="${s.id}">
                <div class="flex justify-between items-start p-2">
                    <div>
                        <h4 class="font-medium text-gray-800">${s.template_name}</h4>
                        <p class="text-sm text-gray-600">${s.description||"No description"}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs rounded">${s.category}</span>
                        <div class="text-xs text-gray-500">${s.size_count} sizes</div>
                    </div>
                </div>
                <div class="template-preview p-2" id="sizePreview${s.id}">
                    <div class="text-xs text-gray-500">Loading sizes...</div>
                </div>
            </div>
        `).join(""),i.forEach(s=>this.loadSizeTemplatePreview(s.id))}async loadSizeTemplatePreview(e){try{const o=await(await fetch(`/api/size_templates.php?action=get_template&template_id=${e}`)).json();if(o.success&&o.template&&Array.isArray(o.template.sizes)){const i=document.getElementById(`sizePreview${e}`);i&&(i.innerHTML=`
                        <div class="flex flex-wrap gap-2">
                            ${o.template.sizes.map(s=>`
                                <span class="inline-block bg-gray-100 text-gray-700 text-xs rounded px-1">${s.size_name} (${s.size_code})${s.price_adjustment>0?" +$"+s.price_adjustment:s.price_adjustment<0?" $"+s.price_adjustment:""}</span>
                            `).join("")}
                        </div>
                    `)}}catch(t){console.error("Error loading size template preview:",t)}}selectSizeTemplate(e){document.querySelectorAll("#sizeTemplatesList .template-item").forEach(i=>{i.classList.remove("border-purple-500","bg-purple-50")});const t=document.querySelector(`#sizeTemplatesList [data-template-id="${e}"]`);t&&t.classList.add("border-purple-500","bg-purple-50");const o=document.getElementById("applySizeTemplateBtn");o&&(o.disabled=!1,o.setAttribute("data-template-id",String(e)))}async loadColorsForSizeTemplate(){if(this.currentItemSku)try{const t=await(await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${this.currentItemSku}`)).json(),o=document.getElementById("sizeTemplateColorId");if(!o)return;o.innerHTML='<option value="">Select a color...</option>',t.success&&Array.isArray(t.colors)&&t.colors.length>0?t.colors.forEach(i=>{if(i.is_active==1){const s=document.createElement("option");s.value=i.id,s.textContent=i.color_name,o.appendChild(s)}}):o.innerHTML='<option value="">No colors available - add colors first</option>'}catch(e){console.error("Error loading colors for size template:",e)}}async applySelectedSizeTemplate(){const e=document.getElementById("applySizeTemplateBtn"),t=e?.getAttribute("data-template-id");if(!t){this.showError("Please select a template first");return}const o=document.querySelector('input[name="sizeApplyMode"]:checked')?.value||"general",i=document.getElementById("replaceExistingSizes")?.checked||!1,s=parseInt(document.getElementById("defaultSizeStock")?.value,10)||0;let a=null;if(o==="color_specific"&&(a=document.getElementById("sizeTemplateColorId")?.value,!a)){this.showError("Please select a color for color-specific sizes");return}try{e&&(e.disabled=!0,e.textContent="Applying...");const r=await(await fetch("/api/size_templates.php?action=apply_to_item",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({template_id:parseInt(t,10),item_sku:this.currentItemSku,apply_mode:o,color_id:a?parseInt(a,10):null,replace_existing:!!i,default_stock:s})})).json();r.success?(this.showSuccess(`Template applied successfully! Added ${r.sizes_added} sizes.`),this.closeSizeTemplateModal(),this.loadItemSizes()):this.showError("Error applying template: "+(r.message||""))}catch(n){console.error("Error applying size template:",n),this.showError("Error applying size template")}finally{e&&(e.disabled=!1,e.textContent="Apply Template")}}closeSizeTemplateModal(){const e=document.getElementById("sizeTemplateModal");e&&e.classList.add("hidden")}editInlineStock(e){if(!e||e.classList.contains("editing"))return;const t=e.getAttribute("data-value"),o=e.getAttribute("data-type"),i=e.getAttribute("data-id"),s=document.createElement("input");s.type="number",s.min="0",s.value=t,s.className="inline-stock-input";const a=e.innerHTML;e.innerHTML="",e.appendChild(s),e.classList.add("editing"),s.focus(),s.select();const n=()=>{e.classList.remove("editing"),e.innerHTML=a},r=async()=>{const l=parseInt(s.value,10)||0;if(l==t){n();return}try{s.disabled=!0,s.classList.add("is-busy");let c,d;if(o==="color")c="/api/item_colors.php?action=update_stock",d={color_id:parseInt(i,10),stock_level:l};else if(o==="size")c="/api/item_sizes.php?action=update_stock",d={size_id:parseInt(i,10),stock_level:l};else{n();return}const u=await(await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();if(u.success){if(e.setAttribute("data-value",l),e.classList.remove("editing"),e.innerHTML=String(l),u.new_total_stock!==void 0){const p=document.getElementById("stockLevel");p&&(p.value=u.new_total_stock)}o==="color"?typeof window.loadItemColors=="function"&&window.loadItemColors():o==="size"&&typeof window.loadItemSizes=="function"&&window.loadItemSizes(),this.showSuccess(`${o.charAt(0).toUpperCase()+o.slice(1)} stock updated to ${l}`)}else throw new Error(u.message||"Failed to update stock")}catch(c){console.error("Error updating stock:",c),this.showError(`Error updating ${o} stock: ${c.message}`),n()}};s.addEventListener("blur",r),s.addEventListener("keydown",l=>{l.key==="Enter"?(l.preventDefault(),r()):l.key==="Escape"&&(l.preventDefault(),n())}),s.addEventListener("click",l=>{l.stopPropagation()})}deleteColor(e){e&&this.showConfirmationModal("Delete Color","Are you sure you want to delete this color? This action cannot be undone.",async()=>{try{const o=await(await fetch("/api/item_colors.php?action=delete_color",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({color_id:e})})).json();o.success?(this.showSuccess("Color deleted successfully"),typeof window.loadItemColors=="function"&&window.loadItemColors()):this.showError("Error deleting color: "+(o.message||""))}catch(t){console.error("Error deleting color:",t),this.showError("Error deleting color")}})}closeSizeModal(){const e=document.getElementById("sizeModal");e&&e.classList.add("hidden")}async saveSize(e){const t=e instanceof HTMLFormElement?e:document.getElementById("sizeForm");if(!t)return;const o=new FormData(t),i={item_sku:this.currentItemSku,color_id:o.get("sizeColorId")||null,size_name:o.get("sizeName"),size_code:o.get("sizeCode"),stock_level:parseInt(o.get("sizeStockLevel"),10)||0,price_adjustment:parseFloat(o.get("sizePriceAdjustment"))||0,display_order:parseInt(o.get("sizeDisplayOrder"),10)||0,is_active:o.get("sizeIsActive")?1:0},s=o.get("sizeId"),a=!!(s&&s!=="");a&&(i.size_id=parseInt(s,10));try{const r=await(await fetch(`/api/item_sizes.php?action=${a?"update_size":"add_size"}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})).json();if(r.success){this.showSuccess(`Size ${a?"updated":"added"} successfully${r.new_total_stock?` - Total stock: ${r.new_total_stock}`:""}`),this.closeSizeModal(),typeof window.loadItemSizes=="function"&&window.loadItemSizes();const l=document.getElementById("stockLevel");l&&r.new_total_stock!==void 0&&(l.value=r.new_total_stock)}else this.showError("Error saving size: "+(r.message||""))}catch(n){console.error("Error saving size:",n),this.showError("Error saving size")}}deleteSize(e){e&&this.showConfirmationModal("Delete Size","Are you sure you want to delete this size? This action cannot be undone.",async()=>{try{const o=await(await fetch("/api/item_sizes.php?action=delete_size",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({size_id:e})})).json();if(o.success){if(this.showSuccess("Size deleted successfully"),typeof window.loadItemSizes=="function"&&window.loadItemSizes(),o.new_total_stock!==void 0){const i=document.getElementById("stockLevel");i&&(i.value=o.new_total_stock)}}else this.showError("Error deleting size: "+(o.message||""))}catch(t){console.error("Error deleting size:",t),this.showError("Error deleting size")}})}handleDelegatedMouseOver(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action;if(o==="show-pricing-tooltip-with-data"){const i=t.dataset.componentType,s=decodeURIComponent(t.dataset.explanation||"");this.showPricingTooltipWithData(e,i,s)}else if(o==="show-pricing-tooltip-text"){const i=decodeURIComponent(t.dataset.text||"");this.showPricingTooltip(e,i)}}handleDelegatedMouseOut(e){const t=e.target.closest("[data-action]");if(!t)return;const o=t.dataset.action;(o==="show-pricing-tooltip-with-data"||o==="show-pricing-tooltip-text")&&this.hidePricingTooltipDelayed()}hidePricingTooltipDelayed(){this.tooltipTimeout=setTimeout(()=>{this.currentTooltip&&this.currentTooltip.parentNode&&(this.currentTooltip.remove(),this.currentTooltip=null)},300)}async getPricingExplanation(e){try{const t=`/api/get_pricing_explanation.php?text=${encodeURIComponent(e)}`,i=await(await fetch(t)).json();if(i.success)return{title:i.title,explanation:i.explanation}}catch(t){console.error("Error fetching pricing explanation:",t)}return{title:"AI Pricing Analysis",explanation:"Advanced algorithmic analysis considering multiple market factors and pricing strategies."}}async showPricingTooltip(e,t){e.stopPropagation(),this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),document.querySelectorAll(".pricing-tooltip").forEach(s=>s.remove());const o=e.target.closest(".info-icon-container");if(!o)return;o.classList.add("inv-relative");const i=document.createElement("div");i.className="pricing-tooltip absolute z-50 bg-gray-800 text-white text-xs rounded-lg p-3 shadow-lg max-w-xs",i.classList.add("tt-top-center"),i.innerHTML=`
            <div class="tooltip-arrow absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-white"></div>
                <span>Loading explanation...</span>
            </div>
        `,o.appendChild(i);try{const s=await this.getPricingExplanation(t);i.remove();const a=document.createElement("div");a.className="pricing-tooltip absolute z-50 bg-gray-800 text-white text-xs rounded-lg p-3 shadow-lg max-w-xs",a.classList.add("tt-top-center"),a.innerHTML=`
                <div class="tooltip-arrow absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-800"></div>
                <div class="font-semibold text-blue-200">${s.title}</div>
                <div>${s.explanation}</div>
            `,a.addEventListener("mouseenter",()=>{this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null)}),a.addEventListener("mouseleave",()=>{this.hidePricingTooltipDelayed()}),o.appendChild(a),this.currentTooltip=a;const n=r=>{a.contains(r.target)||(a.parentNode&&a.remove(),document.removeEventListener("click",n))};document.addEventListener("click",n)}catch{i&&i.parentNode&&i.remove()}}showPricingTooltipWithData(e,t,o){e.stopPropagation(),this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null),document.querySelectorAll(".pricing-tooltip").forEach(l=>l.remove());const i=e.target.closest(".info-icon-container");if(!i)return;i.classList.add("inv-relative");const s=document.createElement("div");s.className="pricing-tooltip absolute z-50 bg-gray-800 text-white text-xs rounded-lg p-3 shadow-lg max-w-xs",s.classList.add("tt-left-offset");const n={cost_plus:"Cost-Plus Pricing",market_research:"Market Research Analysis",competitive_analysis:"Competitive Analysis",value_based:"Value-Based Pricing",brand_premium:"Brand Premium",psychological_pricing:"Psychological Pricing",seasonality:"Seasonal Adjustment",analysis:"AI Pricing Analysis"}[t]||"Pricing Analysis";let r=o;try{const l=typeof o=="string"?JSON.parse(o):o;Array.isArray(l)?r=l.join(" "):l&&typeof l=="object"?r=Object.values(l).join(" "):typeof l=="string"&&(r=l)}catch{}s.innerHTML=`
            <div class="font-semibold">${n}</div>
            <div>${r}</div>
        `,s.addEventListener("mouseenter",()=>{this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null)}),s.addEventListener("mouseleave",()=>{this.hidePricingTooltipDelayed()}),i.appendChild(s),this.currentTooltip=s}moveCarousel(e,t){const o=e==="edit"?"editCarouselTrack":"viewCarouselTrack",i=e==="edit"?"editCarouselPosition":"viewCarouselPosition",s=document.getElementById(o);if(!s)return;const n=s.querySelectorAll(".carousel-slide").length,r=3;if(n<=r)return;const l=Math.max(0,n-r);let c=this[i]||0;c+=t,c<0&&(c=0),c>l&&(c=l),this[i]=c;const d=c*170,m=s.parentElement;m&&(m.scrollLeft=d),this.updateCarouselNavigation(e,n)}updateCarouselNavigation(e,t){const o=e==="edit"?"editCarouselTrack":"viewCarouselTrack",i=e==="edit"?"editCarouselPosition":"viewCarouselPosition",s=document.getElementById(o);if(!s)return;const a=s.closest(".image-carousel-container"),n=a.querySelector(".carousel-prev"),r=a.querySelector(".carousel-next"),l=3,c=this[i]||0,d=Math.max(0,t-l);n&&n.classList.toggle("hidden",c===0),r&&r.classList.toggle("hidden",c>=d)}navigateToItem(e){if(!this.currentItemSku||this.items.length===0)return;const t=this.items.findIndex(a=>a.sku===this.currentItemSku);if(t===-1)return;let o;e==="next"?o=(t+1)%this.items.length:o=(t-1+this.items.length)%this.items.length;const i=this.items[o].sku,s=new URL(window.location.href);s.searchParams.set("edit",i),s.searchParams.delete("view"),window.location.href=s.toString()}confirmDeleteImage(e){this.showConfirmationModal("Delete Image","Are you sure you want to delete this image? This action cannot be undone.",()=>this.deleteImage(e))}async handleImageUpload(e){const t=e.target,o=t.files;if(!o||o.length===0)return;const i=10*1024*1024,s=[...o].filter(m=>m.size>i);if(s.length){const m=s.map(u=>`${u.name} (${(u.size/1024/1024).toFixed(1)}MB)`).join(", ");this.showError(`The following files are too large (max 10MB): ${m}`),t.value="";return}const a=this.currentItemSku||document.getElementById("skuEdit")?.value||document.getElementById("skuDisplay")?.value||"";if(!a){this.showError("SKU is required");return}const n=new FormData;n.append("sku",a);for(let m=0;m<o.length;m++)n.append("images[]",o[m]);const r=document.getElementById("name")?.value||"";n.append("altText",r);const l=document.getElementById("useAIProcessing")?.checked?"true":"false";n.append("useAIProcessing",l);const c=document.getElementById("uploadProgress"),d=document.getElementById("uploadProgressBar");c&&d&&(c.classList.remove("hidden"),((u,p)=>{const y=Math.max(0,Math.min(100,Math.round(p))),g=window.__wfInvWidthClasses||=new Set;let h=document.getElementById("inventory-dynamic-widths");h||(h=document.createElement("style"),h.id="inventory-dynamic-widths",document.head.appendChild(h));const f=`w-p-${y}`;g.has(f)||(h.textContent+=`
.${f}{width:${y}%}`,g.add(f)),(u.className||"").split(" ").forEach(v=>{/^w-p-\d{1,3}$/.test(v)&&u.classList.remove(v)}),u.classList.add(f)})(d,0));try{const m=await new Promise((u,p)=>{const y=new XMLHttpRequest;y.open("POST","/functions/process_multi_image_upload.php"),y.setRequestHeader("X-Requested-With","XMLHttpRequest"),y.upload.onprogress=g=>{if(!d||!g.lengthComputable)return;const h=Math.min(100,Math.round(g.loaded/g.total*100));((v,k)=>{const w=Math.max(0,Math.min(100,Math.round(k))),I=window.__wfInvWidthClasses||=new Set;let b=document.getElementById("inventory-dynamic-widths");b||(b=document.createElement("style"),b.id="inventory-dynamic-widths",document.head.appendChild(b));const C=`w-p-${w}`;I.has(C)||(b.textContent+=`
.${C}{width:${w}%}`,I.add(C)),(v.className||"").split(" ").forEach(E=>{/^w-p-\d{1,3}$/.test(E)&&v.classList.remove(E)}),v.classList.add(C)})(d,h)},y.onload=()=>{d&&((h,f)=>{const v=Math.max(0,Math.min(100,Math.round(f))),k=window.__wfInvWidthClasses||=new Set;let w=document.getElementById("inventory-dynamic-widths");w||(w=document.createElement("style"),w.id="inventory-dynamic-widths",document.head.appendChild(w));const I=`w-p-${v}`;k.has(I)||(w.textContent+=`
.${I}{width:${v}%}`,k.add(I)),(h.className||"").split(" ").forEach(b=>{/^w-p-\d{1,3}$/.test(b)&&h.classList.remove(b)}),h.classList.add(I)})(d,100);try{const g=JSON.parse(y.responseText||"{}");y.status>=200&&y.status<300?u(g):p(new Error(g.error||`HTTP ${y.status}`))}catch(g){console.error("Invalid JSON from upload:",g,y.responseText),p(new Error("Server returned invalid response"))}},y.onerror=()=>{p(new Error("Network error during upload"))},y.send(n)});if(m.success){this.showSuccess(m.message||`Successfully uploaded ${o.length} image(s)`),t.value="";const u=a;typeof this.loadCurrentImages=="function"?await this.loadCurrentImages(u,!1):setTimeout(()=>window.location.reload(),1500),Array.isArray(m.warnings)&&m.warnings.length&&m.warnings.forEach(p=>this.showToast(p,"info"))}else throw new Error(m.error||"Upload failed")}catch(m){this.showError(`Upload failed: ${m.message}`),console.error("Upload error:",m)}finally{c&&d&&setTimeout(()=>{c.classList.add("hidden"),((u,p)=>{const y=Math.max(0,Math.min(100,Math.round(p))),g=window.__wfInvWidthClasses||=new Set;let h=document.getElementById("inventory-dynamic-widths");h||(h=document.createElement("style"),h.id="inventory-dynamic-widths",document.head.appendChild(h));const f=`w-p-${y}`;g.has(f)||(h.textContent+=`
.${f}{width:${y}%}`,g.add(f)),(u.className||"").split(" ").forEach(v=>{/^w-p-\d{1,3}$/.test(v)&&u.classList.remove(v)}),u.classList.add(f)})(d,0)},800)}}async loadCurrentImages(e,t=!1){const o=e||this.currentItemSku;if(o)try{const s=await(await fetch(`/api/get_item_images.php?sku=${encodeURIComponent(o)}`)).json();if(s.success)this.displayCurrentImages(s.images,t);else{const a=document.getElementById("currentImagesList");a&&(a.innerHTML='<div class="text-center text-gray-500 text-sm">Failed to load images</div>')}}catch(i){console.error("Error loading images:",i);const s=document.getElementById("currentImagesList");s&&(s.innerHTML='<div class="text-center text-gray-500 text-sm">Error loading images</div>')}}displayCurrentImages(e,t=!1){const o=document.getElementById("currentImagesList");if(!o)return;if(!e||e.length===0){o.innerHTML='<div class="text-gray-500 text-sm col-span-full">No images uploaded yet</div>';return}o.innerHTML="";const i=document.createElement("div");i.className="grid grid-cols-3 gap-3",e.forEach(s=>{const a=document.createElement("div");a.className="bg-white border rounded-lg overflow-hidden shadow-sm",a.innerHTML=`
                <div class="relative">
                    <img src="${s.image_path}" alt="${s.alt_text||""}" class="w-full h-32 object-contain bg-gray-50">
                    ${s.is_primary?'<div class="absolute top-1 left-1 text-xs bg-green-600 text-white px-1 rounded">Primary</div>':""}
                </div>
                <div class="p-2 text-xs text-gray-700 truncate" title="${(s.image_path||"").split("/").pop()}">
                    ${(s.image_path||"").split("/").pop()}
                </div>
                ${t?"":`
                <div class="p-2 pt-0 flex gap-2">
                    ${s.is_primary?"":`<button type="button" data-action="set-primary-image" data-sku="${s.sku}" data-id="${s.id}" class="text-xs py-0.5 px-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">Primary</button>`}
                    <button type="button" data-action="delete-image" data-sku="${s.sku}" data-id="${s.id}" class="text-xs py-0.5 px-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">Delete</button>
                </div>`}
            `;const n=a.querySelector("img");n&&n.addEventListener("error",()=>{n.classList.add("hidden"),n.parentElement&&(n.parentElement.innerHTML='<div class="u-width-100 u-height-100 u-display-flex u-flex-direction-column u-align-items-center u-justify-content-center u-background-f8f9fa u-color-6c757d u-border-radius-8px"><div class="u-font-size-2rem u-margin-bottom-0-5rem u-opacity-0-7">📷</div><div class="u-font-size-0-8rem u-font-weight-500">Image Not Found</div></div>')}),i.appendChild(a)}),o.appendChild(i)}async setPrimaryImage(e){const t=this.currentItemSku||document.getElementById("skuEdit")?.value||document.getElementById("skuDisplay")?.value||"";if(!e){this.showError("Missing image ID");return}if(!t){this.showError("SKU is required");return}try{const i=await(await fetch("/api/set_primary_image.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageId:e,sku:t})})).json();i.success?(this.showSuccess("Primary image updated"),await this.loadCurrentImages(t,!1)):this.showError(i.error||"Failed to set primary image")}catch(o){console.error("setPrimaryImage error:",o),this.showError("Failed to set primary image")}}async deleteImage(e){try{const o=await(await fetch("/api/delete_item_image.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageId:e})})).json();if(o.success){this.showSuccess(o.message||"Image deleted");const i=this.currentItemSku||document.getElementById("skuEdit")?.value||document.getElementById("skuDisplay")?.value||"";i&&await this.loadCurrentImages(i,!1)}else this.showError(o.error||"Failed to delete image")}catch(t){console.error("deleteImage error:",t),this.showError("Failed to delete image")}}async processExistingImagesWithAI(){this.showConfirmationModal("Process Images with AI","This will analyze existing images. It may take a moment. Continue?",async()=>{const e=document.querySelector('[data-action="process-images-ai"]'),t=e?e.innerHTML:"";e&&(e.innerHTML="Processing...",e.disabled=!0);const o=this.currentItemSku||document.getElementById("skuEdit")?.value||document.getElementById("skuDisplay")?.value||"";if(!o){this.showError("SKU is required"),e&&(e.innerHTML=t,e.disabled=!1);return}const i=this;try{window.aiProcessingModal&&typeof window.aiProcessingModal.show=="function"&&(window.aiProcessingModal.onComplete=async function(){try{typeof i.loadCurrentImages=="function"&&await i.loadCurrentImages(o,!1),i.showSuccess("AI processing completed! Images updated.")}catch(n){console.warn("Refresh images after AI complete failed:",n)}},window.aiProcessingModal.onCancel=function(){i.showInfo("AI processing was cancelled.")},window.aiProcessingModal.show(),typeof window.aiProcessingModal.updateProgress=="function"&&window.aiProcessingModal.updateProgress("Analyzing images…"));const s=await fetch(`/api/run_image_analysis.php?sku=${encodeURIComponent(o)}`,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const a=await s.json();if(!a.success)throw new Error(a.error||"AI processing failed.");if(window.aiProcessingModal&&typeof window.aiProcessingModal.showSuccess=="function"){const n=a.processed||0,r=a.skipped||0,l=Array.isArray(a.errors)?a.errors.length:0;window.aiProcessingModal.showSuccess("AI processing finished",[`Processed: ${n}`,`Skipped: ${r}`,l?`Errors: ${l}`:"No errors"])}else this.showSuccess(`AI processing finished. Processed: ${a.processed||0}, Skipped: ${a.skipped||0}`)}catch(s){console.error("AI processing error:",s),this.showError("AI processing failed: "+s.message)}finally{e&&(e.innerHTML=t,e.disabled=!1)}})}openCostModal(e,t=null){this.currentEditCostItem={category:e,id:t};const o=document.getElementById("costItemModal"),i=document.getElementById("costItemModalTitle"),s=document.getElementById("costName"),a=document.getElementById("costValue");if(i.textContent=t?`Edit ${e} Item`:`Add ${e} Item`,t&&this.costBreakdown[e]&&this.costBreakdown[e][t]){const n=this.costBreakdown[e][t];s.value=n.name,a.value=n.cost}else s.value="",a.value="";o.classList.remove("hidden")}closeCostModal(){document.getElementById("costItemModal").classList.add("hidden"),this.currentEditCostItem=null}async saveCostItem(){if(!this.currentEditCostItem)return;const{category:e,id:t}=this.currentEditCostItem,o=document.getElementById("costName").value.trim(),i=parseFloat(document.getElementById("costValue").value);if(!o||isNaN(i)){this.showError("Please enter a valid name and cost.");return}const s=t||`${e}_${Date.now()}`,a={name:o,cost:i};this.costBreakdown[e]||(this.costBreakdown[e]={}),this.costBreakdown[e][s]=a,this.renderCostList(e),this.updateTotalsDisplay(),this.closeCostModal();try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:t?"update":"add",inventory_id:this.currentItemSku,category:e,item_id:s,data:a})})).json()).success||(this.showError("Failed to save item. Reverting changes."),delete this.costBreakdown[e][s],this.renderCostList(e),this.updateTotalsDisplay())}catch(n){this.showError("An error occurred while saving."),console.error("Save cost item error:",n)}}confirmDeleteCostItem(e,t){this.showConfirmationModal("Delete Cost Item","Are you sure you want to delete this item?",()=>this.deleteCostItem(e,t))}async deleteCostItem(e,t){this.costBreakdown[e]&&this.costBreakdown[e][t]&&(delete this.costBreakdown[e][t],this.renderCostList(e),this.updateTotalsDisplay());try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"delete",inventory_id:this.currentItemSku,category:e,item_id:t})})).json()).success||this.showError("Failed to delete item from server.")}catch(o){this.showError("An error occurred while deleting."),console.error("Delete cost item error:",o)}}async handleConfirmDeleteItem(){try{const e=this.itemToDeleteSku;if(!e)return;const t=document.getElementById("deleteConfirmModal");t&&t.classList.remove("show");const i=await(await fetch(`/functions/process_inventory_update.php?action=delete&sku=${encodeURIComponent(e)}`,{method:"DELETE",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();i&&i.success?(this.showSuccess(i.message||"Item deleted"),setTimeout(()=>{window.location.href="?page=admin&section=inventory"},1e3)):this.showError(i&&i.error||"Failed to delete item.")}catch(e){console.error("Delete item error:",e),this.showError("Failed to delete item.")}finally{this.itemToDeleteSku=null}}renderCostList(e){const t=document.getElementById(`${e}List`);if(!t)return;t.innerHTML="";const o=this.costBreakdown[e],i=Object.keys(o||{});if(i.length===0){t.innerHTML='<p class="text-gray-500 text-xs italic">No items added yet.</p>';return}i.forEach(s=>{const a=o[s],n=document.createElement("div");n.className="cost-item-row flex justify-between items-center p-2 rounded hover:bg-gray-100",n.innerHTML=`
                <span>${this.escapeHtml(a.name)}</span>
                <div class="flex items-center">
                    <span class="mr-4 font-medium">$${parseFloat(a.cost).toFixed(2)}</span>
                    <button data-action="open-cost-modal" data-category="${e}" data-id="${s}" class="text-blue-500 hover:text-blue-700 mr-2">Edit</button>
                    <button data-action="delete-cost-item" data-category="${e}" data-id="${s}" class="text-red-500 hover:text-red-700">Delete</button>
                </div>
            `,t.appendChild(n)})}updateTotalsDisplay(){let e=0,t=0,o=0,i=0;for(const n in this.costBreakdown.materials)e+=parseFloat(this.costBreakdown.materials[n].cost);for(const n in this.costBreakdown.labor)t+=parseFloat(this.costBreakdown.labor[n].cost);for(const n in this.costBreakdown.energy)o+=parseFloat(this.costBreakdown.energy[n].cost);for(const n in this.costBreakdown.equipment)i+=parseFloat(this.costBreakdown.equipment[n].cost);const s=e+t+o+i;this.costBreakdown.totals={materialTotal:e,laborTotal:t,energyTotal:o,equipmentTotal:i,totalCost:s},document.getElementById("materialTotal").textContent=`$${e.toFixed(2)}`,document.getElementById("laborTotal").textContent=`$${t.toFixed(2)}`,document.getElementById("energyTotal").textContent=`$${o.toFixed(2)}`,document.getElementById("equipmentTotal").textContent=`$${i.toFixed(2)}`,document.getElementById("totalCost").textContent=`$${s.toFixed(2)}`;const a=document.getElementById("suggestedCostDisplay");a&&(a.textContent=`$${s.toFixed(2)}`)}confirmClearCostBreakdown(){this.showConfirmationModal("Clear Cost Breakdown","Are you sure you want to delete all cost items? This is irreversible.",()=>this.clearCostBreakdownCompletely())}async clearCostBreakdownCompletely(){this.costBreakdown={materials:{},labor:{},energy:{},equipment:{},totals:{}},["materials","labor","energy","equipment"].forEach(e=>this.renderCostList(e)),this.updateTotalsDisplay();try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"clear_all",inventory_id:this.currentItemSku})})).json()).success?this.showSuccess("Cost breakdown cleared."):this.showError("Failed to clear breakdown on server.")}catch(e){this.showError("An error occurred while clearing the breakdown."),console.error("Clear breakdown error:",e)}}async getCostSuggestion(){const e=document.querySelector('[data-action="get-cost-suggestion"]'),t=e.innerHTML;e.innerHTML="Analyzing...",e.disabled=!0;try{const i=await(await fetch(`/api/suggest_cost.php?sku=${this.currentItemSku}`)).json();i.success?this.showCostSuggestionChoiceDialog(i.suggestions):this.showError(i.error||"Failed to get cost suggestion.")}catch(o){this.showError("Failed to connect to cost suggestion service."),console.error("Get cost suggestion error:",o)}finally{e.innerHTML=t,e.disabled=!1}}async getPriceSuggestion(){const e=document.querySelector('[data-action="get-price-suggestion"]'),t=e.innerHTML;e.innerHTML="Analyzing...",e.disabled=!0;const o={name:document.getElementById("name").value,description:document.getElementById("description").value,category:document.getElementById("category").value,costPrice:document.getElementById("costPrice").value,sku:this.currentItemSku,useImages:!0};try{const s=await(await fetch("/api/suggest_price.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})).json();s.success?(this.displayPriceSuggestion(s),this.showSuccess("Price suggestion generated!")):this.showError(s.error||"Failed to get price suggestion.")}catch(i){this.showError("Failed to connect to pricing service."),console.error("Get price suggestion error:",i)}finally{e.innerHTML=t,e.disabled=!1}}displayPriceSuggestion(e){const t=document.getElementById("priceSuggestionDisplay"),o=document.getElementById("priceSuggestionPlaceholder");if(!t||!o)return;o.classList.add("hidden"),t.classList.remove("hidden"),document.getElementById("displaySuggestedPrice").textContent=`$${parseFloat(e.suggestedPrice).toFixed(2)}`,document.getElementById("displayConfidence").textContent=`${e.confidence||"N/A"}`,document.getElementById("displayTimestamp").textContent=new Date(e.createdAt).toLocaleString(),t.dataset.suggestedPrice=e.suggestedPrice;const i=document.getElementById("reasoningList");i.innerHTML="",e.reasoning&&e.reasoning.split("•").filter(a=>a.trim()).forEach(a=>{const n=document.createElement("li");n.textContent=a.trim(),i.appendChild(n)})}applyPriceSuggestion(){const e=document.getElementById("priceSuggestionDisplay"),t=document.getElementById("retailPrice"),o=e.dataset.suggestedPrice;o&&(t.value=parseFloat(o).toFixed(2),t.classList.add("flash-highlight-green"),setTimeout(()=>{t.classList.remove("flash-highlight-green")},2e3),this.showSuccess("Suggested price applied!"))}clearPriceSuggestion(){const e=document.getElementById("priceSuggestionDisplay"),t=document.getElementById("priceSuggestionPlaceholder");e.classList.add("hidden"),t.classList.remove("hidden"),e.dataset.suggestedPrice=""}async loadExistingPriceSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_price_suggestion.php?sku=${e}`)).json();o.success&&o.suggestedPrice&&this.displayPriceSuggestion(o)}catch(t){console.error("Error loading existing price suggestion:",t)}}async loadExistingViewPriceSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_price_suggestion.php?sku=${encodeURIComponent(e)}&_t=${Date.now()}`)).json(),i=document.getElementById("viewPriceSuggestionDisplay"),s=document.getElementById("viewPriceSuggestionPlaceholder");o.success&&o.suggestedPrice?i&&s?(s.classList.add("hidden"),i.classList.remove("hidden")):this.displayPriceSuggestion(o):i&&s&&(s.classList.remove("hidden"),i.classList.add("hidden"))}catch(t){console.error("Error loading view price suggestion:",t)}}async loadExistingMarketingSuggestion(e){if(e)try{const o=await(await fetch(`/api/get_marketing_suggestion.php?sku=${e}`)).json();o.success&&o.exists&&this.displayMarketingSuggestionIndicator(o.suggestion||null)}catch(t){console.error("Error loading existing marketing suggestion:",t)}}displayMarketingSuggestionIndicator(e=null){const t=document.querySelector("#open-marketing-manager-btn")||document.querySelector('[data-action="open-marketing-manager"]');if(!t)return;const o=t.querySelector(".suggestion-indicator");o&&o.remove();const i=document.createElement("span");i.className="suggestion-indicator ml-2 px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full",i.textContent="💾 Previous";try{if(e&&e.created_at){const s=new Date(e.created_at);i.title=`Previous AI analysis available from ${s.toLocaleDateString()}`}else i.title="Previous AI analysis available"}catch{i.title="Previous AI analysis available"}t.appendChild(i),e&&(window.existingMarketingSuggestion=e)}async generateMarketingCopy(){const e=this.currentItemSku||document.getElementById("sku")?.value||document.getElementById("skuDisplay")?.textContent;if(!e){this.showError("No item selected for marketing generation");return}const t=document.getElementById("name");if(!t||!t.value.trim()){this.showError("Item name is required for marketing generation");return}this.openAiComparisonModal();const o=document.getElementById("aiProgressText");o&&(o.textContent="Initializing AI analysis...");const i=document.getElementById("brandVoice")?.value||"",s=document.getElementById("contentTone")?.value||"",a=await this.checkAIImageSupport(),n={sku:e,name:t.value.trim(),description:document.getElementById("description")?.value||"",category:document.getElementById("categoryEdit")?.value||"",brandVoice:i,contentTone:s,useImages:!!a};try{const l=await(await fetch("/api/suggest_marketing.php",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(n)})).json();if(!l||!l.success){this.showError(l&&l.error||"Failed to generate marketing content"),this.closeAiComparisonModal();return}window.aiComparisonData=l;const c=async()=>{try{const p=await(await fetch(`/api/marketing_manager.php?action=get_marketing_data&sku=${encodeURIComponent(e)}&_t=${Date.now()}`)).json();this.buildComparisonInterface(l,p?.data||null)}catch{this.buildComparisonInterface(l,null)}};if(window.collapseAIProgressSection)try{window.collapseAIProgressSection()}catch{}await c();const d=document.getElementById("applyChangesBtn");d&&d.classList.remove("hidden");const m=document.getElementById("statusText");m&&(m.textContent="Select changes to apply, then click Apply Selected Changes"),this.showSuccess("AI marketing content generated.")}catch(r){console.error("Error generating marketing content:",r),this.showError("Failed to generate marketing content"),this.closeAiComparisonModal()}}closeMarketingModal(){const e=document.getElementById("marketingIntelligenceModal");e&&e.remove()}openMarketingManager(){const e=document.getElementById("marketingManagerModal");if(!e)return;const t=document.getElementById("currentEditingSku");t&&this.currentItemSku&&(t.textContent=this.currentItemSku),e.classList.remove("hidden")}closeMarketingManager(){const e=document.getElementById("marketingManagerModal");e&&e.classList.add("hidden")}closeAiComparisonModal(){const e=document.getElementById("aiComparisonModal");e&&e.classList.add("hidden")}ensureAiComparisonModal(){if(document.getElementById("aiComparisonModal"))return;const e=document.createElement("div");e.id="aiComparisonModal",e.className="fixed inset-0 z-50 hidden",e.innerHTML=`
            <div class="absolute inset-0 bg-black bg-opacity-40" data-action="close-ai-comparison"></div>
            <div class="relative mx-auto my-8 w-11/12 max-w-4xl bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="border-b px-4 py-3 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">AI Content Comparison</h3>
                    <button type="button" class="text-gray-500 hover:text-gray-700" data-action="close-ai-comparison">✕</button>
                </div>
                <div class="p-4 space-y-4">
                    <div id="aiProgressText" class="text-sm text-gray-500"></div>
                    <div id="aiComparisonContent" class="space-y-4"></div>
                </div>
                <div class="border-t px-4 py-3 bg-gray-50 flex items-center justify-end">
                    <button id="applyChangesBtn" data-action="apply-selected-comparison" class="hidden bg-blue-600 text-white text-sm rounded px-4 py-2 hover:bg-blue-700">Apply Selected Changes</button>
                </div>
            </div>`,document.body.appendChild(e)}openAiComparisonModal(){this.ensureAiComparisonModal();const e=document.getElementById("aiComparisonModal");e&&e.classList.remove("hidden")}async updateGlobalMarketingDefault(e,t){try{const o={auto_apply_defaults:"true"};if(e==="brand_voice"){o.default_brand_voice=t;const a=document.getElementById("contentTone");o.default_content_tone=a?a.value:"conversational"}else if(e==="content_tone"){o.default_content_tone=t;const a=document.getElementById("brandVoice");o.default_brand_voice=a?a.value:"friendly"}const s=await(await fetch("/api/website_config.php?action=update_marketing_defaults",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(o)})).json();s.success?this.showSuccess(`Global ${e.replace("_"," ")} updated successfully!`):this.showError(s.error||"Failed to update global setting")}catch(o){console.error("Error updating global marketing default:",o),this.showError("Failed to update global setting")}}toggleSelectAllComparison(){const e=document.getElementById("selectAllComparison");if(!e)return;const t=!!e.checked;document.querySelectorAll('[data-action="toggle-comparison"][data-field]').forEach(i=>{i.checked=t;const s=i.getAttribute("data-field");s&&this.toggleComparison(s)})}toggleComparison(e){const t=document.getElementById(`comparison-${e}-checkbox`)||document.querySelector(`[data-action="toggle-comparison"][data-field="${e}"]`);if(!t)return;if(t.checked){const s=this.getAiSuggestedValue(e);s&&(this.selectedComparisonChanges[e]=s)}else delete this.selectedComparisonChanges[e];this.updateSelectAllState();const o=document.getElementById("applyChangesBtn"),i=Object.keys(this.selectedComparisonChanges).length;o&&(o.textContent=i>0?`Apply ${i} Selected Changes`:"Apply Selected Changes")}getAiSuggestedValue(e){const t=window.aiComparisonData||{};if(e==="title"&&t.title)return t.title;if(e==="description"&&t.description)return t.description;if(e==="target_audience"&&t.targetAudience)return t.targetAudience;if((e==="demographic_targeting"||e==="psychographic_profile")&&t.marketingIntelligence){const i=t.marketingIntelligence[e];if(i)return i}const o=document.getElementById(`comparison-${e}-checkbox`)||document.querySelector(`[data-action="toggle-comparison"][data-field="${e}"]`);if(o){const i=o.closest(".bg-white")||o.closest("[data-comparison-card]")||o.closest("div"),s=i&&i.querySelector(".bg-green-50 p");if(s)return s.textContent.trim()}return""}updateSelectAllState(){const e=document.getElementById("selectAllComparison");if(!e)return;const t=Array.from(document.querySelectorAll('[data-action="toggle-comparison"][data-field]')),o=t.filter(i=>i.checked).length;o===0?(e.checked=!1,e.indeterminate=!1):o===t.length?(e.checked=!0,e.indeterminate=!1):(e.checked=!1,e.indeterminate=!0)}createComparisonCard(e,t,o,i){const s=`comparison-${e}`;return`
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm" data-comparison-card>
                <div class="flex items-center justify-between">
                    <h4 class="font-medium text-gray-800">${t}</h4>
                    <label class="flex items-center">
                        <input type="checkbox" id="${s}-checkbox" class="" data-action="toggle-comparison" data-field="${e}">
                        <span class="text-sm text-gray-600">Apply AI suggestion</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 rounded">
                        <h5 class="text-sm font-medium text-gray-600">Current</h5>
                        <p class="text-sm text-gray-800">${o||"<em>No current value</em>"}</p>
                    </div>
                    <div class="bg-green-50 rounded">
                        <h5 class="text-sm font-medium text-green-600">AI Suggested</h5>
                        <p class="text-sm text-gray-800">${i}</p>
                    </div>
                </div>
            </div>
        `}buildComparisonInterface(e,t){const o=document.getElementById("aiComparisonContent"),i=document.getElementById("applyChangesBtn");if(!o)return;let s='<div class="space-y-6">';s+='<div class="text-center">',s+='<h3 class="text-lg font-semibold text-gray-800">🎯 AI Content Comparison</h3>',s+='<p class="text-sm text-gray-600">Review and select which AI-generated content to apply to your item</p>',s+="</div>";const a=[];if(e.title){const r=document.getElementById("name")?.value||"",l=e.title;r!==l&&(a.push("title"),s+=this.createComparisonCard("title","Item Title",r,l))}if(e.description){const r=document.getElementById("description")?.value||"",l=e.description;r!==l&&(a.push("description"),s+=this.createComparisonCard("description","Item Description",r,l))}[{key:"target_audience",label:"Target Audience",current:t?.target_audience||"",suggested:e.targetAudience},{key:"demographic_targeting",label:"Demographics",current:t?.demographic_targeting||"",suggested:e.marketingIntelligence?.demographic_targeting},{key:"psychographic_profile",label:"Psychographics",current:t?.psychographic_profile||"",suggested:e.marketingIntelligence?.psychographic_profile}].forEach(r=>{r.suggested&&r.current!==r.suggested&&(a.push(r.key),s+=this.createComparisonCard(r.key,r.label,r.current,r.suggested))}),a.length>0&&(s=s.replace('<div class="space-y-6">',`
                <div class="space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="p-3 flex items-center justify-between">
                        <div class="text-blue-800 font-medium">Select All Suggested Changes</div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="selectAllComparison">
                            <span class="text-sm text-blue-700">Select All</span>
                        </label>
                    </div>
                </div>`)),a.length===0&&(s+='<div class="text-center text-gray-500">',s+="<p>No changes detected. All AI suggestions match your current content.</p>",s+="</div>"),s+="</div>",o.innerHTML=s,i&&(a.length>0?i.classList.remove("hidden"):i.classList.add("hidden"))}async applySelectedComparisonChanges(){const e=this.selectedComparisonChanges||{},t=Object.keys(e);if(t.length===0){this.showError("Please select at least one change to apply");return}let o=this.currentItemSku;if(!o){const i=document.getElementById("sku")||document.getElementById("skuDisplay");o=i&&(i.value||i.textContent)}if(!o){console.error("No SKU available for saving changes"),this.showError("Unable to save changes - no item SKU available");return}try{const s=(await Promise.all(t.map(async a=>{const n=e[a],r={sku:o,field:a==="title"?"suggested_title":a==="description"?"suggested_description":a,value:n};try{const c=await(await fetch("/api/marketing_manager.php?action=update_field",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(r)})).json();if(!c.success)throw new Error(c.error||"Save failed");return{fieldKey:a,success:!0}}catch(l){return console.error(`Error saving ${a}:`,l),{fieldKey:a,success:!1,error:l}}}))).filter(a=>a.success).length;s>0?(t.forEach(a=>{if(a==="title"||a==="description"){const n=document.getElementById(a==="title"?"name":"description");n&&(n.value=e[a],n.classList.add("flash-highlight-green-light"),setTimeout(()=>{n.classList.remove("flash-highlight-green-light")},3e3))}}),this.showSuccess(`${s} changes saved to database successfully!`),this.closeAiComparisonModal()):this.showError("Failed to save changes to database")}catch(i){console.error("Error in batch save operation:",i),this.showError("Failed to save changes to database")}}applyMarketingToItem(){const e=this.currentItemSku||document.getElementById("sku")?.value||document.getElementById("skuDisplay")?.textContent;if(!e){this.showError("Unable to apply marketing - no item SKU available");return}const t={marketingTitle:"suggested_title",marketingDescription:"suggested_description",targetAudience:"target_audience",demographics:"demographic_targeting",psychographics:"psychographic_profile",searchIntent:"search_intent",seasonalRelevance:"seasonal_relevance"},o=[];Object.keys(t).forEach(r=>{const l=document.getElementById(r);if(!l)return;let c=l.tagName==="SELECT"?l.value:l.value||"";typeof c=="string"&&(c=c.trim()),c&&o.push({sku:e,field:t[r],value:c})});const i=document.getElementById("brandVoice"),s=document.getElementById("contentTone");if(i&&i.value&&o.push({sku:e,field:"brand_voice",value:i.value}),s&&s.value&&o.push({sku:e,field:"content_tone",value:s.value}),o.length===0){this.showError("No marketing content to apply");return}const a=document.getElementById("marketingTitle")?.value||"",n=document.getElementById("marketingDescription")?.value||"";if(a){const r=document.getElementById("name");r&&(r.value=a,r.classList.add("flash-highlight-green-light"),setTimeout(()=>{r.classList.remove("flash-highlight-green-light")},3e3))}if(n){const r=document.getElementById("description");r&&(r.value=n,r.classList.add("flash-highlight-green-light"),setTimeout(()=>{r.classList.remove("flash-highlight-green-light")},3e3))}Promise.all(o.map(async r=>{try{const c=await(await fetch("/api/marketing_manager.php?action=update_field",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(r)})).json();return!!(c&&c.success)}catch(l){return console.error("Error saving field",r.field,l),!1}})).then(r=>{const l=r.filter(Boolean).length;if(l>0){if(this.showSuccess(`${l} marketing field(s) saved!`),window.loadExistingMarketingData)try{window.loadExistingMarketingData()}catch{}}else this.showError("Failed to save marketing fields")})}getMarketingListDomMap(){return{selling_points:{inputId:"newSellingPoint",listId:"sellingPointsList"},competitive_advantages:{inputId:"newCompetitiveAdvantage",listId:"competitiveAdvantagesList"},customer_benefits:{inputId:"newCustomerBenefit",listId:"customerBenefitsList"},seo_keywords:{inputId:"newSEOKeyword",listId:"seoKeywordsList"},call_to_action_suggestions:{inputId:"newCallToAction",listId:"callToActionsList"},urgency_factors:{inputId:"newUrgencyFactor",listId:"urgencyFactorsList"},conversion_triggers:{inputId:"newConversionTrigger",listId:"conversionTriggersList"},emotional_triggers:{inputId:"newEmotionalTriggers",listId:"emotionalTriggersList"},unique_selling_points:{inputId:"newUniqueSellingPoints",listId:"uniqueSellingPointsList"},value_propositions:{inputId:"newValuePropositions",listId:"valuePropositionsList"},marketing_channels:{inputId:"newMarketingChannels",listId:"marketingChannelsList"},social_proof_elements:{inputId:"newSocialProofElements",listId:"socialProofElementsList"},objection_handlers:{inputId:"newObjectionHandlers",listId:"objectionHandlersList"},content_themes:{inputId:"newContentThemes",listId:"contentThemesList"},pain_points_addressed:{inputId:"newPainPointsAddressed",listId:"painPointsAddressedList"},lifestyle_alignment:{inputId:"newLifestyleAlignment",listId:"lifestyleAlignmentList"}}}normalizeText(e){return(e||"").trim().replace(/\s+/g," ").toLowerCase()}findAddButtonForField(e){return e?document.querySelector(`button[data-action="add-list-item"][data-field="${e}"]`):null}startLoadingButton(e,t){e&&(e.dataset.originalText||(e.dataset.originalText=e.innerText),e.innerText=t||"Working...",e.disabled=!0,e.classList.add("opacity-50","cursor-not-allowed"))}stopLoadingButton(e){e&&(e.dataset.originalText&&(e.innerText=e.dataset.originalText),e.disabled=!1,e.classList.remove("opacity-50","cursor-not-allowed"))}startLoadingInput(e){e&&(e.dataset.originalPlaceholder||(e.dataset.originalPlaceholder=e.placeholder||""),e.placeholder="Working...",e.disabled=!0)}stopLoadingInput(e){e&&(e.dataset.originalPlaceholder!==void 0&&(e.placeholder=e.dataset.originalPlaceholder),e.disabled=!1)}getExistingItemsForList(e){const t=new Set,o=e?document.getElementById(e):null;return o&&(o.querySelectorAll('button[data-action="remove-list-item"][data-item]').forEach(s=>{try{const a=decodeURIComponent(s.getAttribute("data-item")||"");a&&t.add(this.normalizeText(a))}catch{}}),t.size===0&&o.querySelectorAll(".marketing-list-item span").forEach(s=>{t.add(this.normalizeText(s.textContent||""))})),t}appendMarketingListItem(e,t,o){const i=document.getElementById(e);if(!i)return;const s=document.createElement("div");s.className="marketing-list-item flex justify-between items-center bg-white p-2 rounded border",s.innerHTML=`
            <span class="text-sm text-gray-700">${this.escapeHtml(o)}</span>
            <button data-action="remove-list-item" data-field="${t}" data-item="${encodeURIComponent(o)}" class="text-red-500 hover:text-red-700 text-xs">Remove</button>
        `,i.appendChild(s),s.classList.add("flash-highlight-green-light"),setTimeout(()=>{s.classList.remove("flash-highlight-green-light")},800)}async handleAddListItem(e){try{if(!e)return;let t=this.currentItemSku;if(!t){const m=document.getElementById("sku")||document.getElementById("skuDisplay");t=m&&(m.value||m.textContent)}if(!t){this.showError("No item selected");return}const i=this.getMarketingListDomMap()[e]||{},s=i.inputId?document.getElementById(i.inputId):null;if(!s||!s.value||!s.value.trim()){this.showError("Please enter a value");return}const a=s.value.trim(),n=i.listId;if(this.getExistingItemsForList(n).has(this.normalizeText(a))){this.showError("Item already exists");return}const l=this.findAddButtonForField(e);this.startLoadingButton(l,"Adding..."),this.startLoadingInput(s);const d=await(await fetch("/api/marketing_manager.php?action=add_list_item",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sku:t,field:e,item:a})})).json();if(!d||!d.success){this.showError(d&&d.error||"Failed to add item");return}s.value="",n&&this.appendMarketingListItem(n,e,a),this.showSuccess("Item added successfully")}catch(t){console.error("Error adding list item:",t),this.showError("Failed to add item")}finally{const o=this.getMarketingListDomMap()[e]||{},i=o.inputId?document.getElementById(o.inputId):null,s=this.findAddButtonForField(e);this.stopLoadingInput(i),this.stopLoadingButton(s)}}async handleRemoveListItem(e,t,o){try{if(!e)return;let i=this.currentItemSku;if(!i){const l=document.getElementById("sku")||document.getElementById("skuDisplay");i=l&&(l.value||l.textContent)}if(!i){this.showError("No item selected");return}const s=t?decodeURIComponent(t):"";if(!s){this.showError("No item specified");return}this.startLoadingButton(o,"Removing...");const n=await(await fetch("/api/marketing_manager.php?action=remove_list_item",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sku:i,field:e,item:s})})).json();if(!n||!n.success){this.showError(n&&n.error||"Failed to remove item");return}let r=null;if(o instanceof HTMLElement&&(r=o.closest(".marketing-list-item"),!r)){const l=o.closest("button");l&&l.parentElement&&(r=l.parentElement)}r&&r.parentElement&&r.parentElement.removeChild(r),this.showSuccess("Item removed")}catch(i){console.error("Error removing list item:",i),this.showError("Failed to remove item")}finally{this.stopLoadingButton(o)}}async handleSaveMarketingField(e,t){try{if(!e)return;let o=this.currentItemSku;if(!o){const c=document.getElementById("sku")||document.getElementById("skuDisplay");o=c&&(c.value||c.textContent)}if(!o){this.showError("No item selected");return}const s={search_intent:"searchIntent",seasonal_relevance:"seasonalRelevance"}[e]||"",a=s?document.getElementById(s):null,n=a?(a.tagName==="SELECT"?a.value:a.value||"").trim():"";if(!n){this.showError("Please enter a value");return}this.startLoadingButton(t,"Saving...");const l=await(await fetch("/api/marketing_manager.php?action=update_field",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sku:o,field:e,value:n})})).json();if(!l||!l.success){this.showError(l&&l.error||"Failed to save field");return}a&&(a.classList.add("flash-highlight-green-light"),setTimeout(()=>{a.classList.remove("flash-highlight-green-light")},800)),this.showSuccess("Field saved")}catch(o){console.error("Error saving marketing field:",o),this.showError("Failed to save field")}finally{this.stopLoadingButton(t)}}async checkAIImageSupport(){return!0}async handleGenerateAllMarketing(e){if(!this.currentItemSku){this.showError("No item selected for marketing generation");return}const t=e.innerHTML;e.innerHTML='<span class="animate-spin">⏳</span> Generating...',e.disabled=!0;const o=document.getElementById("brandVoice")?.value||"",i=document.getElementById("contentTone")?.value||"",s=await this.checkAIImageSupport(),a={sku:this.currentItemSku,name:document.getElementById("name")?.value||"",description:document.getElementById("description")?.value||"",category:document.getElementById("categoryEdit")?.value||"",brandVoice:o,contentTone:i,useImages:s};try{const r=await(await fetch("/api/suggest_marketing.php",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)})).json();if(r.success){if(this.showSuccess("🎯 AI content generated for: Target Audience, Selling Points, SEO & Keywords, and Conversion tabs!"),window.populateAllMarketingTabs&&window.populateAllMarketingTabs(r),window.loadExistingMarketingData){await window.loadExistingMarketingData();const c=document.getElementById("brandVoice");c&&o&&(c.value=o);const d=document.getElementById("contentTone");d&&i&&(d.value=i)}typeof window.hasMarketingChanges<"u"&&(window.hasMarketingChanges=!0),["marketingTitle","marketingDescription","targetAudience","demographics","psychographics","brandVoice","contentTone","searchIntent","seasonalRelevance"].forEach(c=>{const d=document.getElementById(c);d&&d.value&&window.trackMarketingFieldChange&&window.trackMarketingFieldChange(c)}),window.updateMarketingSaveButtonVisibility&&window.updateMarketingSaveButtonVisibility()}else this.showError(r.error||"Failed to generate marketing content")}catch(n){console.error("Error generating marketing content:",n),this.showError("Failed to generate marketing content")}finally{e.innerHTML=t,e.disabled=!1}}async handleGenerateFreshMarketing(e){if(!this.currentItemSku){this.showError("No item selected for marketing generation");return}const t=document.getElementById("name");if(!t||!t.value.trim()){this.showError("Item name is required for marketing generation");return}const o=e.innerHTML;e.innerHTML="🔥 Generating...",e.disabled=!0;const i=document.getElementById("brandVoice"),s=document.getElementById("contentTone"),a={sku:this.currentItemSku,name:t.value.trim(),category:document.getElementById("categoryEdit")?.value||"",description:document.getElementById("description")?.value.trim()||"",brand_voice:i?i.value:"",content_tone:s?s.value:"",fresh_start:!0};try{const r=await(await fetch("/api/suggest_marketing.php",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)})).json();r.success?(this.showSuccess("🔥 Fresh marketing content generated! All fields updated with brand new AI suggestions."),window.populateAllMarketingTabs&&window.populateAllMarketingTabs(r),window.clearMarketingFields&&window.clearMarketingFields(),setTimeout(async()=>{window.loadExistingMarketingData&&await window.loadExistingMarketingData()},50)):this.showError(r.error||"Failed to generate marketing content")}catch(n){console.error("Error generating fresh marketing content:",n),this.showError("Failed to generate marketing content")}finally{e.innerHTML=o,e.disabled=!1}}handleApplyAndSaveMarketingTitle(){if(window.applyAndSaveMarketingTitle)window.applyAndSaveMarketingTitle();else{const e=document.getElementById("marketingTitle")?.value||"";this.applyTitle(e)}}handleApplyAndSaveMarketingDescription(){if(window.applyAndSaveMarketingDescription)window.applyAndSaveMarketingDescription();else{const e=document.getElementById("marketingDescription")?.value||"";this.applyDescription(e)}}applyTitle(e){const t=document.getElementById("name");t&&(t.value=e,t.classList.add("flash-highlight-purple"),setTimeout(()=>{t.classList.remove("flash-highlight-purple")},2e3),this.showSuccess("Title applied! Remember to save your changes."))}applyDescription(e){const t=document.getElementById("description");t&&(t.value=e,t.classList.add("flash-highlight-purple"),setTimeout(()=>{t.classList.remove("flash-highlight-purple")},2e3),this.showSuccess("Description applied! Remember to save your changes."))}switchMarketingTab(e,t){document.querySelectorAll(".marketing-tab-content").forEach(i=>i.classList.add("hidden")),document.querySelectorAll(".marketing-tab-btn").forEach(i=>{i.classList.remove("active","border-purple-500","text-purple-600"),i.classList.add("border-transparent","text-gray-500")});const o=document.getElementById(`tab-${e}`);o&&o.classList.remove("hidden"),t&&(t.classList.add("active","border-purple-500","text-purple-600"),t.classList.remove("border-transparent","text-gray-500"))}showConfirmationModal(e,t,o){const i=document.getElementById("confirmationModal");document.getElementById("confirmationModalTitle").textContent=e,document.getElementById("confirmationModalMessage").textContent=t;const s=document.getElementById("confirmationModalConfirm"),a=document.getElementById("confirmationModalCancel"),n=()=>{this.closeConfirmationModal(),o()},r=s.cloneNode(!0);s.parentNode.replaceChild(r,s),r.addEventListener("click",n);const l=a.cloneNode(!0);a.parentNode.replaceChild(l,a),l.addEventListener("click",this.closeConfirmationModal.bind(this)),i.classList.remove("hidden")}closeConfirmationModal(){document.getElementById("confirmationModal").classList.add("hidden")}showCostSuggestionChoiceDialog(e){const t=document.getElementById("costSuggestionChoiceDialog"),o=document.getElementById("costSuggestionChoices");o.innerHTML="",!e||e.length===0?o.innerHTML="<p>No suggestions available.</p>":e.forEach(i=>{const s=document.createElement("div");s.className="suggestion-card p-4 border rounded-lg hover:bg-gray-50",s.innerHTML=`
                    <h4 class="font-bold text-lg">${this.escapeHtml(i.model)}</h4>
                    <p class="text-2xl font-light my-2">$${parseFloat(i.suggestedCost).toFixed(2)}</p>
                    <p class="text-sm text-gray-600">Confidence: ${this.escapeHtml(i.confidence)}</p>
                    <p class="text-xs italic text-gray-500 mt-2">${this.escapeHtml(i.reasoning)}</p>
                    <div class="mt-4 flex gap-2">
                        <button data-action="populate-cost-breakdown-from-suggestion" data-suggestion='${this.escapeHtml(JSON.stringify(i))}' class="btn btn-primary flex-1">Apply Breakdown</button>
                        <button data-action="apply-suggested-cost-to-cost-field" data-suggestion='${this.escapeHtml(JSON.stringify(i))}' class="btn btn-secondary flex-1">Apply to Field</button>
                    </div>
                `,o.appendChild(s)}),t.classList.remove("hidden")}closeCostSuggestionChoiceDialog(){document.getElementById("costSuggestionChoiceDialog").classList.add("hidden")}applyCostSuggestionToCost(){const e=document.getElementById("suggestedCostDisplay"),t=document.getElementById("costPrice");if(e&&t){const o=e.textContent.replace("$",""),i=parseFloat(o)||0;i>0?(t.value=i.toFixed(2),t.classList.add("flash-highlight-blue"),setTimeout(()=>{t.classList.remove("flash-highlight-blue")},2e3),this.showSuccess("Suggested cost applied to Cost Price field!")):this.showError("No suggested cost available.")}}applySuggestedCostToCostField(e){try{const t=JSON.parse(e.getAttribute("data-suggestion").replace(/&quot;/g,'"').replace(/&#39;/g,"'")),o=document.getElementById("costPrice");if(o){const i=parseFloat(t.suggestedCost)||0;o.value=i.toFixed(2),o.classList.add("flash-highlight-green"),setTimeout(()=>{o.classList.remove("flash-highlight-green")},3e3),this.closeCostSuggestionChoiceDialog(),this.showSuccess(`AI suggested cost of $${i.toFixed(2)} applied!`)}}catch(t){console.error("Error applying suggested cost:",t),this.showError("Error applying suggested cost.")}}async populateCostBreakdownFromSuggestion(e){await this.clearCostBreakdownCompletely();const t=e.breakdown,o=["materials","labor","energy","equipment"];for(const i of o)if(t[i]>0){const s=`${i}_${Date.now()}`,a={name:`Suggested ${i}`,cost:t[i]};this.costBreakdown[i][s]=a,await this.saveCostItemToDatabase(i,a,s)}this.init(),this.showSuccess("AI cost breakdown has been applied and saved.")}async saveCostItemToDatabase(e,t,o){try{(await(await fetch("/functions/process_cost_breakdown.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"add",inventory_id:this.currentItemSku,category:e,item_id:o,data:t})})).json()).success||this.showError(`Failed to save ${e} item.`)}catch{this.showError(`An error occurred while saving ${e}.`)}}async refreshCategoryDropdown(){try{const t=await(await fetch("/api/get_categories.php")).json();this.categories=t,this.updateCategoryDropdown(),this.showSuccess("Categories updated!")}catch(e){this.showError("Failed to refresh categories."),console.error("Refresh categories error:",e)}}updateCategoryDropdown(){const e=document.getElementById("category");if(!e)return;const t=e.value;e.innerHTML="",this.categories.forEach(o=>{const i=document.createElement("option");i.value=o.id,i.textContent=o.name,e.appendChild(i)}),e.value=t}escapeHtml(e){return typeof e!="string"?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}showToast(e,t="info"){const o=document.getElementById("toast-container");if(!o)return;const i=document.createElement("div"),s=t==="success"||t==="error"||t==="info"?t:"info";i.className=`toast toast--${s} text-white p-4 rounded-lg shadow-lg mb-2`,i.textContent=e,o.appendChild(i),setTimeout(()=>{i.classList.add("fade-out"),setTimeout(()=>i.remove(),500)},3e3)}showSuccess(e){this.showToast(e,"success")}showError(e){this.showToast(e,"error")}showInfo(e){this.showToast(e,"info")}}document.addEventListener("DOMContentLoaded",()=>{if(document.getElementById("admin-inventory-container")||document.getElementById("inventory-data")||document.getElementById("currentImagesList")||document.getElementById("multiImageUpload")||document.querySelector('[data-action="process-images-ai"]')){const e=new S;try{window.adminInventoryModule=e}catch{}typeof window.showSuccess!="function"&&(window.showSuccess=t=>e.showSuccess(t)),typeof window.showError!="function"&&(window.showError=t=>e.showError(t)),typeof window.showToast!="function"&&(window.showToast=(t,o="info")=>e.showToast(t,o))}});
