<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Stock Sync Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        button { padding: 8px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input, select { margin: 5px; padding: 5px; }
        .color-swatch { width: 20px; height: 20px; border: 1px solid #ccc; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Color Stock Synchronization Test</h1>
    
    <div class="test-section">
        <h3>1. Check Current Color Stock Levels</h3>
        <select id="testSku">
            <option value="WF-TS-002">WF-TS-002 (Pink, White, Red, Blue)</option>
            <option value="WF-TS-003">WF-TS-003 (Black, Navy)</option>
        </select>
        <button onclick="checkColorStock()">Check Color Stock</button>
        <div id="colorStockResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Update Color Stock (Admin)</h3>
        <input type="text" id="updateSku" placeholder="SKU" value="WF-TS-002">
        <input type="text" id="updateColor" placeholder="Color Name" value="Pink">
        <input type="number" id="updateStock" placeholder="New Stock Level" value="25">
        <button onclick="updateColorStock()">Update Color Stock</button>
        <div id="updateResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Add to Cart and Test Checkout</h3>
        <select id="cartSku">
            <option value="WF-TS-002">WF-TS-002</option>
            <option value="WF-TS-003">WF-TS-003</option>
        </select>
        <input type="text" id="cartColor" placeholder="Color" value="Pink">
        <input type="number" id="cartQuantity" placeholder="Quantity" value="2" min="1">
        <button onclick="addToCartTest()">Add to Cart</button>
        <button onclick="simulateCheckout()">Simulate Checkout</button>
        <div id="cartResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. Current Cart Contents</h3>
        <button onclick="showCart()">Show Cart</button>
        <button onclick="clearCart()">Clear Cart</button>
        <div id="cartDisplay" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>5. Test Stock Reduction API</h3>
        <input type="text" id="reduceSku" placeholder="SKU" value="WF-TS-002">
        <input type="text" id="reduceColor" placeholder="Color" value="Pink">
        <input type="number" id="reduceQuantity" placeholder="Quantity" value="1" min="1">
        <button onclick="testStockReduction()">Test Stock Reduction</button>
        <div id="reductionResult" class="result"></div>
    </div>

    <script src="js/cart.js"></script>
    <script>
        async function checkColorStock() {
            const sku = document.getElementById('testSku').value;
            const resultDiv = document.getElementById('colorStockResult');
            
            try {
                const response = await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${sku}`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<h4>Color Stock Levels:</h4>';
                    data.colors.forEach(color => {
                        html += `
                            <div style="margin: 5px 0;">
                                <div class="color-swatch" style="background-color: ${color.color_code || '#ccc'}"></div>
                                <strong>${color.color_name}</strong>: ${color.stock_level} units
                                ${color.is_active ? '' : ' (Inactive)'}
                            </div>
                        `;
                    });
                    
                    // Also get total stock from main item
                    const itemResponse = await fetch(`/api/get-item.php?sku=${sku}`);
                    const itemData = await itemResponse.json();
                    if (itemData.success) {
                        html += `<div style="margin-top: 10px; font-weight: bold;">Total Stock: ${itemData.item.stockLevel}</div>`;
                    }
                    
                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `Error: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function updateColorStock() {
            const sku = document.getElementById('updateSku').value;
            const color = document.getElementById('updateColor').value;
            const stock = parseInt(document.getElementById('updateStock').value);
            const resultDiv = document.getElementById('updateResult');
            
            try {
                // First get the color ID
                const colorsResponse = await fetch(`/api/item_colors.php?action=get_all_colors&item_sku=${sku}`);
                const colorsData = await colorsResponse.json();
                
                if (!colorsData.success) {
                    throw new Error('Failed to get colors');
                }
                
                const colorObj = colorsData.colors.find(c => c.color_name === color);
                if (!colorObj) {
                    throw new Error(`Color '${color}' not found for SKU '${sku}'`);
                }
                
                // Update the stock
                const response = await fetch('/api/item_colors.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_stock',
                        color_id: colorObj.id,
                        stock_level: stock
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `Success: ${data.message}<br>New Total Stock: ${data.new_total_stock}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `Error: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function addToCartTest() {
            const sku = document.getElementById('cartSku').value;
            const color = document.getElementById('cartColor').value;
            const quantity = parseInt(document.getElementById('cartQuantity').value);
            const resultDiv = document.getElementById('cartResult');
            
            try {
                // Get item details
                const itemResponse = await fetch(`/api/get-item.php?sku=${sku}`);
                const itemData = await itemResponse.json();
                
                if (!itemData.success) {
                    throw new Error('Item not found');
                }
                
                const item = itemData.item;
                
                // Add to cart with color
                cart.addItem({
                    sku: sku,
                    name: item.name,
                    price: parseFloat(item.retailPrice),
                    image: item.image,
                    quantity: quantity,
                    color: color
                });
                
                resultDiv.innerHTML = `Added ${quantity}x ${item.name} (${color}) to cart`;
                resultDiv.className = 'result success';
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        async function simulateCheckout() {
            const resultDiv = document.getElementById('cartResult');
            
            if (cart.items.length === 0) {
                resultDiv.innerHTML = 'Cart is empty. Add items first.';
                resultDiv.className = 'result error';
                return;
            }
            
            try {
                // Simulate checkout data
                const itemIds = cart.items.map(item => item.sku);
                const quantities = cart.items.map(item => item.quantity);
                const colors = cart.items.map(item => item.color || null);
                
                const response = await fetch('/api/add-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: 'TEST_USER',
                        itemIds: itemIds,
                        quantities: quantities,
                        colors: colors,
                        paymentMethod: 'Test',
                        shippingMethod: 'Customer Pickup',
                        total: cart.getTotal()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `Checkout successful! Order ID: ${data.orderId}<br>Stock levels should now be reduced.`;
                    resultDiv.className = 'result success';
                    cart.clearCart();
                } else {
                    resultDiv.innerHTML = `Checkout failed: ${data.error}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        function showCart() {
            const resultDiv = document.getElementById('cartDisplay');
            
            if (cart.items.length === 0) {
                resultDiv.innerHTML = 'Cart is empty';
                resultDiv.className = 'result';
                return;
            }
            
            let html = '<h4>Cart Contents:</h4>';
            cart.items.forEach((item, index) => {
                html += `
                    <div style="margin: 5px 0; padding: 5px; border: 1px solid #ddd;">
                        <strong>${item.name}</strong>
                        ${item.color ? ` (${item.color})` : ''}<br>
                        Quantity: ${item.quantity}, Price: $${item.price.toFixed(2)}
                    </div>
                `;
            });
            html += `<div style="margin-top: 10px; font-weight: bold;">Total: $${cart.getTotal().toFixed(2)}</div>`;
            
            resultDiv.innerHTML = html;
            resultDiv.className = 'result';
        }
        
        function clearCart() {
            cart.clearCart();
            document.getElementById('cartDisplay').innerHTML = 'Cart cleared';
            document.getElementById('cartDisplay').className = 'result';
        }
        
        async function testStockReduction() {
            const sku = document.getElementById('reduceSku').value;
            const color = document.getElementById('reduceColor').value;
            const quantity = parseInt(document.getElementById('reduceQuantity').value);
            const resultDiv = document.getElementById('reductionResult');
            
            try {
                const response = await fetch('/api/item_colors.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'reduce_stock_for_sale',
                        item_sku: sku,
                        color_name: color,
                        quantity: quantity
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `Success: ${data.message}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `Error: ${data.message}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test page loaded. Cart initialized:', cart);
        });
    </script>
</body>
</html> 