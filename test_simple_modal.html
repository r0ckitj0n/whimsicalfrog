<!DOCTYPE html>
<html>
<head>
    <title>Simple Modal Test</title>
    <link rel="stylesheet" href="/css/bundle.css">
    <link rel="stylesheet" href="/css/room-iframe.css">
    <style>
        body { margin: 0; padding: 20px; background: #f0f0f0; }
        .test-container {
            width: 1280px;
            height: 896px;
            border: 2px solid #000;
            position: relative;
            background: #fff;
            margin: 20px auto;
        }
        .debug-info {
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px auto;
            max-width: 1280px;
        }
    </style>
</head>
<body>
    <div class="debug-info">
        <h1>Simple Modal Test - Direct Content Loading</h1>
        <button onclick="loadAndTest()">Load Room Content Directly</button>
        <button onclick="testModalBackground()">Test Modal Background</button>
        <div id="status"></div>
    </div>

    <div class="test-container" id="testContainer">
        <p>Click "Load Room Content Directly" to test...</p>
    </div>

    <script>
        async function loadAndTest() {
            const container = document.getElementById('testContainer');
            const status = document.getElementById('status');
            
            try {
                // Load room content directly
                const response = await fetch('/api/load_room_content.php?room_number=1&modal=1');
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = data.content;
                    status.innerHTML = '<p style="color: green;">✅ Content loaded successfully</p>';
                    
                    // Analyze positioning immediately
                    setTimeout(() => {
                        analyzePositioning();
                    }, 1000);
                } else {
                    status.innerHTML = `<p style="color: red;">❌ Error: ${data.message}</p>`;
                }
            } catch (error) {
                status.innerHTML = `<p style="color: red;">❌ Fetch error: ${error.message}</p>`;
            }
        }

        function analyzePositioning() {
            const status = document.getElementById('status');
            const productIcons = document.querySelectorAll('.room-product-icon');
            const debugBanner = document.getElementById('debug-items-count');
            
            let analysis = '<h3>Analysis Results:</h3>';
            
            // Check debug banner
            if (debugBanner) {
                const bannerRect = debugBanner.getBoundingClientRect();
                analysis += `<p>✅ Debug banner visible: "${debugBanner.textContent.trim()}" at ${bannerRect.top}, ${bannerRect.left}</p>`;
            } else {
                analysis += '<p>❌ Debug banner not found</p>';
            }
            
            // Check product icons
            analysis += `<p>Product icons found: ${productIcons.length}</p>`;
            
            if (productIcons.length > 0) {
                let allSamePosition = true;
                let firstPosition = null;
                
                productIcons.forEach((icon, index) => {
                    const rect = icon.getBoundingClientRect();
                    const computedStyle = getComputedStyle(icon);
                    
                    if (index === 0) {
                        firstPosition = { top: rect.top, left: rect.left };
                    } else {
                        if (Math.abs(rect.top - firstPosition.top) > 5 || Math.abs(rect.left - firstPosition.left) > 5) {
                            allSamePosition = false;
                        }
                    }
                    
                    analysis += `
                        <div style="border: 1px solid #ddd; padding: 5px; margin: 5px 0;">
                            <strong>Icon ${index + 1}:</strong><br>
                            Inline style: ${icon.getAttribute('style')}<br>
                            Computed position: top: ${computedStyle.top}, left: ${computedStyle.left}<br>
                            Bounding rect: top: ${rect.top.toFixed(1)}, left: ${rect.left.toFixed(1)}<br>
                            Visible: ${rect.width > 0 && rect.height > 0 ? 'Yes' : 'No'}<br>
                            Debug data: ${icon.dataset.debugPosition || 'None'}
                        </div>
                    `;
                });
                
                if (allSamePosition) {
                    analysis += '<p style="color: red; font-weight: bold;">❌ ALL ICONS ARE AT THE SAME POSITION - STACKING ISSUE CONFIRMED</p>';
                } else {
                    analysis += '<p style="color: green; font-weight: bold;">✅ Icons are at different positions</p>';
                }
            }
            
            status.innerHTML = analysis;
        }

        async function testModalBackground() {
            const status = document.getElementById('status');
            
            try {
                // Test background API
                const response = await fetch('/api/get_background.php?room_type=room1');
                const data = await response.json();
                
                let bgAnalysis = '<h3>Background Test Results:</h3>';
                
                if (data.success && data.background) {
                    const bg = data.background;
                    bgAnalysis += `
                        <p>✅ Background API working</p>
                        <p>Background name: ${bg.background_name}</p>
                        <p>Image file: ${bg.image_filename}</p>
                        <p>WebP file: ${bg.webp_filename}</p>
                    `;
                    
                    // Test if image files exist
                    const imageUrl = `/images/backgrounds/${bg.webp_filename}`;
                    const img = new Image();
                    img.onload = () => {
                        bgAnalysis += `<p>✅ Background image loads: ${imageUrl}</p>`;
                        status.innerHTML = bgAnalysis;
                    };
                    img.onerror = () => {
                        bgAnalysis += `<p>❌ Background image failed to load: ${imageUrl}</p>`;
                        status.innerHTML = bgAnalysis;
                    };
                    img.src = imageUrl;
                } else {
                    bgAnalysis += '<p>❌ Background API failed</p>';
                }
                
                status.innerHTML = bgAnalysis;
            } catch (error) {
                status.innerHTML = `<p style="color: red;">❌ Background test error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
